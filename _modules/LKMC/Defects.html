<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>LKMC.Defects &mdash; LKMC 150623-1236-g1254817 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '150623-1236-g1254817',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="LKMC 150623-1236-g1254817 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">LKMC 150623-1236-g1254817 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for LKMC.Defects</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module to find defects in system (and surrounding atoms)</span>

<span class="sd">@author: Chris Scott</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">atoman.filtering.filters</span> <span class="k">import</span> <span class="n">base</span>
    <span class="kn">from</span> <span class="nn">atoman.filtering.filters</span> <span class="k">import</span> <span class="n">speciesFilter</span>
    <span class="kn">from</span> <span class="nn">atoman.filtering.filters</span> <span class="k">import</span> <span class="n">coordinationNumberFilter</span>
    <span class="n">VIS_LOADED</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">CDJSVis.filtering.filters</span> <span class="k">import</span> <span class="n">base</span>
        <span class="kn">from</span> <span class="nn">CDJSVis.filtering.filters</span> <span class="k">import</span> <span class="n">speciesFilter</span>
        <span class="kn">from</span> <span class="nn">CDJSVis.filtering.filters</span> <span class="k">import</span> <span class="n">coordinationNumberFilter</span>
        <span class="n">VIS_LOADED</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">VIS_LOADED</span> <span class="o">=</span> <span class="kc">False</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Input</span>
<span class="kn">from</span> <span class="nn">.clibs</span> <span class="k">import</span> <span class="n">defects</span> <span class="k">as</span> <span class="n">c_defects</span>
<span class="kn">from</span> <span class="nn">.Utilities</span> <span class="k">import</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Utilities</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Globals</span>
<span class="kn">from</span> <span class="nn">.clibs</span> <span class="k">import</span> <span class="n">utilities</span> <span class="k">as</span> <span class="n">c_utils</span>
<span class="kn">from</span> <span class="nn">.clibs</span> <span class="k">import</span> <span class="n">io_module</span> <span class="k">as</span> <span class="n">c_io</span>
<span class="kn">from</span> <span class="nn">.clibs</span> <span class="k">import</span> <span class="n">numpy_utils</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Vectors</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Rendering</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Graphs</span>
<span class="kn">from</span> <span class="nn">.Dummy</span> <span class="k">import</span> <span class="n">DummyLattice</span><span class="p">,</span> <span class="n">DummyLatticeMinimal</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Minimise</span>


<span class="c1">################################################################################</span>

<div class="viewcode-block" id="defectVolumeSeparation"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.defectVolumeSeparation">[docs]</a><span class="k">def</span> <span class="nf">defectVolumeSeparation</span><span class="p">(</span><span class="n">currentFullPos</span><span class="p">,</span> <span class="n">previousDefectPos</span><span class="p">,</span> <span class="n">cellDims</span><span class="p">,</span> <span class="n">defectAtoms</span><span class="p">,</span> <span class="n">getPos</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calc separation between defect volume in two states.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">getPos</span><span class="p">:</span>
        <span class="n">currentDefectPos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">defectAtoms</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">currentDefectPos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="n">cellDims3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">cellDims3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cellDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cellDims3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cellDims</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">cellDims3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cellDims</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>

    <span class="n">sep</span> <span class="o">=</span> <span class="n">c_defects</span><span class="o">.</span><span class="n">defectVolumeSeparation</span><span class="p">(</span><span class="n">currentFullPos</span><span class="p">,</span> <span class="n">previousDefectPos</span><span class="p">,</span> <span class="n">cellDims3</span><span class="p">,</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">,</span> <span class="n">defectAtoms</span><span class="p">,</span> <span class="n">currentDefectPos</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">getPos</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sep</span><span class="p">,</span> <span class="n">currentDefectPos</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sep</span></div>

<span class="c1">################################################################################</span>

<div class="viewcode-block" id="defectVolumeSeparationFull"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.defectVolumeSeparationFull">[docs]</a><span class="k">def</span> <span class="nf">defectVolumeSeparationFull</span><span class="p">(</span><span class="n">currentPos</span><span class="p">,</span> <span class="n">previousPos</span><span class="p">,</span> <span class="n">cellDims</span><span class="p">,</span> <span class="n">defectAtoms</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calc separation between defect volume in two states.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">sum</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">defectAtoms</span><span class="p">:</span>
        <span class="nb">sum</span> <span class="o">+=</span> <span class="n">c_utils</span><span class="o">.</span><span class="n">atomicSeparation2</span><span class="p">(</span><span class="n">currentPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="p">],</span> <span class="n">currentPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">currentPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span>
                                         <span class="n">previousPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="p">],</span> <span class="n">previousPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">previousPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span>
                                         <span class="n">cellDims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cellDims</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">cellDims</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
                                         <span class="nb">int</span><span class="p">(</span><span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="nb">print</span> <span class="s2">&quot;SUMFIN </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">sum</span>

    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span></div>

<span class="c1">################################################################################</span>
<div class="viewcode-block" id="TransitionObjectFull"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.TransitionObjectFull">[docs]</a><span class="k">class</span> <span class="nc">TransitionObjectFull</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stores information about a single transition.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cellDims</span><span class="p">,</span> <span class="n">specie</span><span class="p">,</span> <span class="n">specieList</span><span class="p">,</span> <span class="n">initialPos</span><span class="p">,</span> <span class="n">saddlePos</span><span class="p">,</span> <span class="n">finalPos</span><span class="p">,</span> <span class="n">barrier</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hashKey</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">volumeAtoms</span><span class="o">=</span><span class="p">[]):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">volumeAtoms</span><span class="p">):</span>
            <span class="n">NVolAtoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">volumeAtoms</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialPos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NVolAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saddlePos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NVolAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finalPos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NVolAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">specie</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">NVolAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">NVolAtoms</span><span class="p">):</span>
                <span class="n">index_tmp</span> <span class="o">=</span> <span class="n">volumeAtoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">specie</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">specie</span><span class="p">[</span><span class="n">index_tmp</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">initialPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index_tmp</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initialPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index_tmp</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initialPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index_tmp</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">saddlePos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">saddlePos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index_tmp</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">saddlePos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">saddlePos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index_tmp</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">saddlePos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">saddlePos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index_tmp</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">finalPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">finalPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index_tmp</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">finalPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">finalPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index_tmp</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">finalPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">finalPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index_tmp</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saddlePos</span> <span class="o">=</span> <span class="n">saddlePos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finalPos</span> <span class="o">=</span> <span class="n">finalPos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialPos</span> <span class="o">=</span> <span class="n">initialPos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">specie</span> <span class="o">=</span> <span class="n">specie</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span> <span class="o">=</span> <span class="n">barrier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hashKey</span> <span class="o">=</span> <span class="n">hashKey</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span> <span class="o">=</span> <span class="n">cellDims</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieList</span> <span class="o">=</span> <span class="n">specieList</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finalHashkey</span> <span class="o">=</span> <span class="kc">None</span></div>

<span class="c1">################################################################################</span>
<div class="viewcode-block" id="TransitionObject"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.TransitionObject">[docs]</a><span class="k">class</span> <span class="nc">TransitionObject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stores information about a single transition.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saddlePos</span><span class="p">,</span> <span class="n">finalPos</span><span class="p">,</span> <span class="n">barrier</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hashKey</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">volumeAtoms</span><span class="o">=</span><span class="p">[],</span> <span class="n">finalHashkey</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">volumeAtoms</span><span class="p">):</span>
            <span class="n">NVolAtoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">volumeAtoms</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saddlePos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NVolAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finalPos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NVolAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">NVolAtoms</span><span class="p">):</span>
                <span class="n">index_tmp</span> <span class="o">=</span> <span class="n">volumeAtoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="c1"># print i, index_tmp, 3*index_tmp</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">saddlePos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">saddlePos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index_tmp</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">saddlePos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">saddlePos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index_tmp</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">saddlePos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">saddlePos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index_tmp</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">finalPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">finalPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index_tmp</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">finalPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">finalPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index_tmp</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">finalPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">finalPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index_tmp</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saddlePos</span> <span class="o">=</span> <span class="n">saddlePos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finalPos</span> <span class="o">=</span> <span class="n">finalPos</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span> <span class="o">=</span> <span class="n">barrier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hashKey</span> <span class="o">=</span> <span class="n">hashKey</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">finalHashkey</span> <span class="o">=</span> <span class="n">finalHashkey</span>

<div class="viewcode-block" id="TransitionObject.setTransitionIndex"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.TransitionObject.setTransitionIndex">[docs]</a>    <span class="k">def</span> <span class="nf">setTransitionIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the index of this transition.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span></div></div>

<span class="c1">################################################################################</span>
<div class="viewcode-block" id="VolumeTransitionsObject"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.VolumeTransitionsObject">[docs]</a><span class="k">class</span> <span class="nc">VolumeTransitionsObject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stores all transitions for a given volume.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">moreSearch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">searchDone</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialPos</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specie</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transitionList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hashKey</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieList</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moreSearch</span> <span class="o">=</span> <span class="n">moreSearch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searchDone</span> <span class="o">=</span> <span class="n">searchDone</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Flag for basin method - if any single state with this hashkey is explored, this flag is set to True.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">explored</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">useBasin</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">explored</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">explored</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="VolumeTransitionsObject.setup"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.VolumeTransitionsObject.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volumeAtoms</span><span class="p">,</span> <span class="n">initialState</span><span class="p">,</span> <span class="n">hashKey</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup object (not required if running read).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hashKey</span> <span class="o">=</span> <span class="n">hashKey</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">volumeAtoms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieList</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">.</span><span class="n">specieList</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">.</span><span class="n">cellDims</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">specie</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialPos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">volumeAtoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">specie</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">.</span><span class="n">specie</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">debugBasin</span><span class="p">:</span>
            <span class="c1"># add hashkey consistency check when setting up volTransObj</span>
            <span class="n">consLattice</span> <span class="o">=</span> <span class="n">DummyLattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">specieList</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialPos</span><span class="p">)</span>
            <span class="n">consHashKey</span> <span class="o">=</span> <span class="n">Graphs</span><span class="o">.</span><span class="n">getHashKeyForAVolume</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">consLattice</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hashKey</span> <span class="o">!=</span> <span class="n">consHashKey</span><span class="p">:</span>
                <span class="n">consLattice</span> <span class="o">=</span> <span class="n">Graphs</span><span class="o">.</span><span class="n">prepareLatticeToBeTransf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">consLattice</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">noOfCoords</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">consHashKey</span> <span class="o">=</span> <span class="n">Graphs</span><span class="o">.</span><span class="n">getHashKeyForAVolume</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">consLattice</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hashKey</span> <span class="o">!=</span> <span class="n">consHashKey</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span><span class="s2">&quot;Inconsistent hashkeys: assigned key </span><span class="si">%s</span><span class="s2">, calculated key </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hashKey</span><span class="p">,</span> <span class="n">consHashKey</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Hashkey stored incorrectly in volTransObj setup&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="VolumeTransitionsObject.addTransition"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.VolumeTransitionsObject.addTransition">[docs]</a>    <span class="k">def</span> <span class="nf">addTransition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saddlePos</span><span class="p">,</span> <span class="n">finalPos</span><span class="p">,</span> <span class="n">barrier</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hashKey</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">volumeAtoms</span><span class="o">=</span><span class="p">[],</span><span class="n">finalHashkey</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a transition to the list.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="n">TransitionObject</span><span class="p">(</span><span class="n">saddlePos</span><span class="p">,</span> <span class="n">finalPos</span><span class="p">,</span> <span class="n">barrier</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">hashKey</span><span class="o">=</span><span class="n">hashKey</span><span class="p">,</span> <span class="n">volumeAtoms</span><span class="o">=</span><span class="n">volumeAtoms</span><span class="p">,</span><span class="n">finalHashkey</span><span class="o">=</span><span class="n">finalHashkey</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addTransitionObject</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span></div>

<div class="viewcode-block" id="VolumeTransitionsObject.addTransitionObject"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.VolumeTransitionsObject.addTransitionObject">[docs]</a>    <span class="k">def</span> <span class="nf">addTransitionObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transitionObject</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add transition object to the list. And calc finalHashkey as well.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">transitionObject</span><span class="o">.</span><span class="n">saddlePos</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialPos</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">transitionObject</span><span class="o">.</span><span class="n">finalHashkey</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;WARNING: finalHashkey is None&quot;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="c1"># #             from .Refine import DummyLattice</span>
<span class="c1">#             lattice = DummyLattice(self.NAtomsVolume, self.cellDims, self.specie, self.specieList, transitionObject.finalPos)</span>
<span class="c1">#             transitionObject.finalHashkey = Graphs.getHashKeyForAVolume(self.params, np.arange(self.NAtomsVolume, dtype=np.int32), lattice)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transitionList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transitionObject</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="VolumeTransitionsObject.merge"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.VolumeTransitionsObject.merge">[docs]</a>    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volTransObj</span><span class="p">,</span> <span class="n">er</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="s2">&quot;Other&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generally volTransObj should have moreSearch flag. This routine will merge transitions in volTransObj into self.</span>

<span class="sd">        volTransObj : volumeTransitionObject</span>
<span class="sd">            VTO to be merged into this one (self)</span>
<span class="sd">        er : bool</span>
<span class="sd">            Only set to true if calling from extraReuse code in saveResultsToBasin</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span> <span class="s2">&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;DEBUG: VTO Merge has been called.&quot;</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Merge volume transition objects (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hashKey</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="c1">#         from .Refine import DummyLattice, DummyLatticeMinimal</span>
        <span class="n">mergeNum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">identicalIndexList</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">transLattice</span> <span class="o">=</span> <span class="n">DummyLattice</span><span class="p">(</span><span class="n">volTransObj</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">volTransObj</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">volTransObj</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> <span class="n">volTransObj</span><span class="o">.</span><span class="n">specieList</span><span class="p">,</span> <span class="n">volTransObj</span><span class="o">.</span><span class="n">initialPos</span><span class="p">)</span>
        <span class="n">initialState</span> <span class="o">=</span> <span class="n">DummyLattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">specieList</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialPos</span><span class="p">)</span>
        <span class="c1"># calculate transformation matrix</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Calculating the transformation matrix&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">trnsfMatrix</span><span class="p">,</span> <span class="n">lattice1</span><span class="p">,</span> <span class="n">atomsList1</span><span class="p">,</span> <span class="n">lattice2</span><span class="p">,</span> <span class="n">atomsList2</span><span class="p">,</span> <span class="n">cntr1</span><span class="p">,</span> <span class="n">cntr2</span> <span class="o">=</span> <span class="n">Graphs</span><span class="o">.</span><span class="n">prepareTheMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">volTransObj</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                                                                                                            <span class="n">transLattice</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                                                                                                            <span class="n">initialState</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># output usefule debug info if isomorphism fails</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">er</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Could not compute isomorphism - VTOs not merged&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">debugBasin</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dumpLattices</span><span class="p">(</span><span class="n">transLattice</span><span class="p">,</span> <span class="n">initialState</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">note</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dumpLattices</span><span class="p">(</span><span class="n">transLattice</span><span class="p">,</span> <span class="n">initialState</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">note</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Could not compute isomorphism!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trnsfMatrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;&gt;&gt;&gt;&gt;Error in DreadNaut! Stop merge volume transition objects...&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">initialPrevious</span> <span class="o">=</span> <span class="n">DummyLattice</span><span class="p">(</span><span class="n">volTransObj</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">volTransObj</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">volTransObj</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> <span class="n">volTransObj</span><span class="o">.</span><span class="n">specieList</span><span class="p">,</span> <span class="n">lattice1</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">volTransObj</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)):</span>
            <span class="n">saddlePrevious</span> <span class="o">=</span> <span class="n">DummyLatticeMinimal</span><span class="p">(</span><span class="n">volTransObj</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">volTransObj</span><span class="o">.</span><span class="n">transitionList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">saddlePos</span><span class="p">)</span>
            <span class="n">finalPrevious</span> <span class="o">=</span> <span class="n">DummyLatticeMinimal</span><span class="p">(</span><span class="n">volTransObj</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">volTransObj</span><span class="o">.</span><span class="n">transitionList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">finalPos</span><span class="p">)</span>

            <span class="n">saddlePrevious</span> <span class="o">=</span> <span class="n">Graphs</span><span class="o">.</span><span class="n">prepareLatticeToBeTransf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">saddlePrevious</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">cntrOrig</span><span class="o">=</span><span class="n">cntr1</span><span class="p">)</span>
            <span class="n">finalPrevious</span> <span class="o">=</span> <span class="n">Graphs</span><span class="o">.</span><span class="n">prepareLatticeToBeTransf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">finalPrevious</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">cntrOrig</span><span class="o">=</span><span class="n">cntr1</span><span class="p">)</span>

            <span class="c1"># get final position</span>
            <span class="n">saddle</span> <span class="o">=</span> <span class="n">Graphs</span><span class="o">.</span><span class="n">doTheTransformation</span><span class="p">(</span><span class="n">initialPrevious</span><span class="p">,</span> <span class="n">saddlePrevious</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">atomsList1</span><span class="p">,</span> <span class="n">initialState</span><span class="p">,</span>
                                                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">atomsList2</span><span class="p">,</span> <span class="n">trnsfMatrix</span><span class="p">,</span> <span class="n">cntr1</span><span class="p">,</span> <span class="n">cntr2</span><span class="p">)</span>
            <span class="n">final</span> <span class="o">=</span> <span class="n">Graphs</span><span class="o">.</span><span class="n">doTheTransformation</span><span class="p">(</span><span class="n">initialPrevious</span><span class="p">,</span> <span class="n">finalPrevious</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">atomsList1</span><span class="p">,</span> <span class="n">initialState</span><span class="p">,</span>
                                               <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">atomsList2</span><span class="p">,</span> <span class="n">trnsfMatrix</span><span class="p">,</span> <span class="n">cntr1</span><span class="p">,</span> <span class="n">cntr2</span><span class="p">)</span>

            <span class="c1">#store transformed positions</span>
            <span class="n">volTransObj</span><span class="o">.</span><span class="n">transitionList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">saddlePos</span> <span class="o">=</span> <span class="n">saddle</span><span class="o">.</span><span class="n">pos</span>
            <span class="n">volTransObj</span><span class="o">.</span><span class="n">transitionList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">finalPos</span> <span class="o">=</span> <span class="n">final</span><span class="o">.</span><span class="n">pos</span>

            <span class="c1"># compare transitions</span>
            <span class="n">identical</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">newTrans</span> <span class="o">=</span> <span class="n">volTransObj</span><span class="o">.</span><span class="n">transitionList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># debug list of possible transitions</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">debugBasin</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)):</span>
                    <span class="n">transitionPrint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitionList</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="nb">print</span> <span class="s2">&quot;In merge transition.finalHashkey </span><span class="si">%d</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">transitionPrint</span><span class="o">.</span><span class="n">finalHashkey</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)):</span>
                <span class="n">transition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitionList</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

                <span class="c1"># check for identical hashkeys (that are not None)</span>
                <span class="k">if</span> <span class="n">transition</span><span class="o">.</span><span class="n">finalHashkey</span> <span class="o">==</span> <span class="n">newTrans</span><span class="o">.</span><span class="n">finalHashkey</span> <span class="ow">and</span> <span class="n">transition</span><span class="o">.</span><span class="n">finalHashkey</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Matching hashkey in merge:</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">transition</span><span class="o">.</span><span class="n">finalHashkey</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">sepF</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">newTrans</span><span class="o">.</span><span class="n">finalPos</span><span class="p">,</span> <span class="n">transition</span><span class="o">.</span><span class="n">finalPos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">sepF</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrUniqueMinSep</span><span class="p">:</span>
                        <span class="n">sepS</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">newTrans</span><span class="o">.</span><span class="n">saddlePos</span><span class="p">,</span> <span class="n">transition</span><span class="o">.</span><span class="n">saddlePos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">sepS</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrUniqueMinSep</span><span class="p">:</span>
                            <span class="n">identical</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">identicalIndexList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Separation in tolarance: sep finals: </span><span class="si">%f</span><span class="s2">, sep saddles: </span><span class="si">%f</span><span class="s2">. Match is </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sepF</span><span class="p">,</span> <span class="n">sepS</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                            <span class="k">break</span>

            <span class="c1"># if not identical, add transition</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">identical</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)</span>
                <span class="n">newTrans</span><span class="o">.</span><span class="n">setTransitionIndex</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transitionList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newTrans</span><span class="p">)</span>
                <span class="n">mergeNum</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">identicalIndexList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;New (reverse) transition added to volume </span><span class="si">%s</span><span class="s2">, trans num </span><span class="si">%d</span><span class="s2">, barrier </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hashKey</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">newTrans</span><span class="o">.</span><span class="n">barrier</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
                <span class="c1"># log(__name__, &quot;%f&quot; % newTrans.reverseBarrier, 2, 4)</span>

        <span class="c1"># update explored status</span>
        <span class="k">if</span> <span class="n">volTransObj</span><span class="o">.</span><span class="n">explored</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">explored</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">mergeNum</span><span class="p">,</span> <span class="n">identicalIndexList</span></div>

<div class="viewcode-block" id="VolumeTransitionsObject.dumpLattices"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.VolumeTransitionsObject.dumpLattices">[docs]</a>    <span class="k">def</span> <span class="nf">dumpLattices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transLattice</span><span class="p">,</span> <span class="n">initialState</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">note</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dumps lattices to file if isomorphism problem occurs during merge</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        transLattice : lattice object</span>
<span class="sd">            Initial lattice of the transition on the VTO being merged into &quot;self&quot;</span>
<span class="sd">        initialState : lattice object</span>
<span class="sd">            The lattice object for this VTO (i.e. &quot;self&quot;)</span>
<span class="sd">        step : int</span>
<span class="sd">            The current KMC step</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;isomorphismErrorDumps&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Step</span><span class="si">%d</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">note</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Isomorphism problem occured. Writing lattices and report to file in directory:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">transLattice</span><span class="o">.</span><span class="n">writeLattice</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;transLattice.dat&quot;</span><span class="p">))</span>
        <span class="n">initialState</span><span class="o">.</span><span class="n">writeLattice</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;initialState.dat&quot;</span><span class="p">))</span>

        <span class="n">isoReport</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;IsomorphismErrorReport&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">tLattice</span> <span class="o">=</span> <span class="n">Graphs</span><span class="o">.</span><span class="n">prepareLatticeToBeTransf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">transLattice</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">noOfCoords</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">iLattice</span> <span class="o">=</span> <span class="n">Graphs</span><span class="o">.</span><span class="n">prepareLatticeToBeTransf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">initialState</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">noOfCoords</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">isoReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Hashkeys</span><span class="se">\n</span><span class="s2">transLattice:    </span><span class="si">%s</span><span class="se">\n</span><span class="s2">initialState:    </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Graphs</span><span class="o">.</span><span class="n">getHashKeyForAVolume</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">tLattice</span><span class="p">),</span>
                                                                                  <span class="n">Graphs</span><span class="o">.</span><span class="n">getHashKeyForAVolume</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">iLattice</span><span class="p">)))</span>

        <span class="n">isoReport</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="VolumeTransitionsObject.read"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.VolumeTransitionsObject.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">currentState</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read in transitions from a file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tempdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>

        <span class="n">key</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hashKey</span> <span class="o">=</span> <span class="n">key</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Reading volume file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="n">NAtomsVol</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span> <span class="o">=</span> <span class="n">NAtomsVol</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">moreSearch</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">moreSearch</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># read in explored status. If an error occurs here, try updating DV files</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">explored</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">explored</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">NLines</span> <span class="o">=</span> <span class="n">Utilities</span><span class="o">.</span><span class="n">fileLineCount</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">NTrans</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">NLines</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">NAtomsVol</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">NAtomsVol</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> transitions&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NTrans</span><span class="p">,),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">NTrans</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">useBasin</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;WARNING: LOW NUMBER OF TRANSITIONS IN REUSE FILE!&quot;</span>

        <span class="c1"># read in volume transitions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">cellDims</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieList</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">specieList</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specie</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">NAtomsVol</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialPos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">NAtomsVol</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">sadPos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">NAtomsVol</span> <span class="o">*</span> <span class="n">NTrans</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">finPos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">NAtomsVol</span> <span class="o">*</span> <span class="n">NTrans</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">barriers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">NTrans</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="c1"># create a tempory file to store all final haskeys</span>
        <span class="n">tempPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempdir</span><span class="p">,</span> <span class="s2">&quot;tempKeys.txt&quot;</span><span class="p">)</span>

        <span class="c1"># read in volumes</span>
        <span class="n">c_io</span><span class="o">.</span><span class="n">readVolumeTransitionsFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">NAtomsVol</span><span class="p">,</span> <span class="n">NTrans</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">specieList</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialPos</span><span class="p">,</span> <span class="n">sadPos</span><span class="p">,</span> <span class="n">finPos</span><span class="p">,</span> <span class="n">barriers</span><span class="p">,</span> <span class="n">tempPath</span><span class="p">)</span>

        <span class="c1"># assign final hashkeys</span>
        <span class="n">tempHashFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">tempPath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Volume </span><span class="si">%s</span><span class="s2"> has transitions to the following hashkeys:&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">finalKeys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NTrans</span><span class="p">):</span>
            <span class="n">fKey</span> <span class="o">=</span> <span class="n">tempHashFile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="n">fKey</span> <span class="o">=</span> <span class="n">fKey</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\n\&quot;\&#39;</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">finalKeys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fKey</span><span class="p">)</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Final key </span><span class="si">%d</span><span class="s2">:</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">finalKeys</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Close temporary file and remove temporary directory</span>
        <span class="n">tempHashFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tempdir</span><span class="p">)</span>

        <span class="n">dim3</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">NAtomsVol</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">NTrans</span><span class="p">):</span>
            <span class="c1"># offset in full arrays</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">dim3</span>

            <span class="c1"># create structure</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addTransition</span><span class="p">(</span><span class="n">sadPos</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">dim3</span><span class="p">],</span> <span class="n">finPos</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">dim3</span><span class="p">],</span> <span class="n">barriers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">hashKey</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">finalHashkey</span><span class="o">=</span><span class="n">finalKeys</span><span class="p">[</span><span class="n">i</span><span class="p">])</span></div>

<div class="viewcode-block" id="VolumeTransitionsObject.write"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.VolumeTransitionsObject.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">appendFlag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the defect volume to file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">volumeDirectory</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.vol&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hashKey</span><span class="p">,))</span>

        <span class="c1"># append transitions into existing DV file</span>
        <span class="k">if</span> <span class="n">appendFlag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">useBasin</span><span class="p">:</span>
                    <span class="c1"># merge new transitions into existing DV to preserve order</span>
                    <span class="n">dummyCurrentState</span> <span class="o">=</span> <span class="n">DummyCurrentState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieList</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
                    <span class="n">tempVTO</span> <span class="o">=</span> <span class="n">VolumeTransitionsObject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
                    <span class="n">tempVTO</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dummyCurrentState</span><span class="p">)</span>
                    <span class="n">tempVTO</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

                    <span class="c1"># if len(self.transitionList) &gt; len(tempVTO.transitionList):</span>
                    <span class="c1">#     log(__name__, &quot;write VTO: WARNING! not all transitions are added to volume file &quot;, 1, 1)</span>

                    <span class="n">tempVTO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">appendFlag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">transitionList</span> <span class="o">=</span> <span class="n">tempVTO</span><span class="o">.</span><span class="n">transitionList</span>
                    <span class="k">return</span>

        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

        <span class="c1"># write header</span>
        <span class="n">ms</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moreSearch</span><span class="p">:</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">ex</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">explored</span><span class="p">:</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">ex</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieList</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">specie</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">],</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">initialPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]))</span>

        <span class="c1"># now loop over transitions</span>
        <span class="k">for</span> <span class="n">transition</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitionList</span><span class="p">:</span>
            <span class="c1"># write barrier</span>
            <span class="c1">#f.write(&quot;%f\n&quot; % transition.barrier)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2"> </span><span class="si">%r</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">transition</span><span class="o">.</span><span class="n">barrier</span><span class="p">,</span> <span class="n">transition</span><span class="o">.</span><span class="n">finalHashkey</span><span class="p">))</span>

            <span class="c1"># write saddle and final pos</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">transition</span><span class="o">.</span><span class="n">saddlePos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">],</span> <span class="n">transition</span><span class="o">.</span><span class="n">saddlePos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">transition</span><span class="o">.</span><span class="n">saddlePos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span>
                                                 <span class="n">transition</span><span class="o">.</span><span class="n">finalPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">],</span> <span class="n">transition</span><span class="o">.</span><span class="n">finalPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">transition</span><span class="o">.</span><span class="n">finalPos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]))</span>

        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Length of object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)</span>

<div class="viewcode-block" id="VolumeTransitionsObject.mergeTransition"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.VolumeTransitionsObject.mergeTransition">[docs]</a>    <span class="k">def</span> <span class="nf">mergeTransition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transitionObject</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge a single transition into this object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Merge transition object (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">hashKey</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="n">tobj</span> <span class="o">=</span> <span class="n">transitionObject</span>

        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">transitionObject</span><span class="p">)</span> <span class="ow">is</span> <span class="n">TransitionObjectFull</span>

        <span class="c1"># check same size first</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">transitionObject</span><span class="o">.</span><span class="n">saddlePos</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialPos</span><span class="p">)</span>

        <span class="c1"># setup lattice objects</span>
        <span class="n">transLattice</span> <span class="o">=</span> <span class="n">DummyLattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">tobj</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">tobj</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> <span class="n">tobj</span><span class="o">.</span><span class="n">specieList</span><span class="p">,</span> <span class="n">tobj</span><span class="o">.</span><span class="n">initialPos</span><span class="p">)</span>
        <span class="n">initialState</span> <span class="o">=</span> <span class="n">DummyLattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">tobj</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">specieList</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialPos</span><span class="p">)</span>

        <span class="c1"># calculate transformation matrix</span>
        <span class="n">trnsfMatrix</span><span class="p">,</span> <span class="n">lattice1</span><span class="p">,</span> <span class="n">atomsList1</span><span class="p">,</span> <span class="n">lattice2</span><span class="p">,</span> <span class="n">atomsList2</span><span class="p">,</span> <span class="n">cntr1</span><span class="p">,</span> <span class="n">cntr2</span> <span class="o">=</span> <span class="n">Graphs</span><span class="o">.</span><span class="n">prepareTheMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                                                                                                        <span class="n">transLattice</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                                                                                                        <span class="n">initialState</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trnsfMatrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Error in DreadNaut! Stop merge transition...&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">initialPrevious</span> <span class="o">=</span> <span class="n">DummyLattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">tobj</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">tobj</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> <span class="n">tobj</span><span class="o">.</span><span class="n">specieList</span><span class="p">,</span> <span class="n">lattice1</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="n">saddlePrevious</span> <span class="o">=</span> <span class="n">DummyLatticeMinimal</span><span class="p">(</span><span class="n">tobj</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">tobj</span><span class="o">.</span><span class="n">saddlePos</span><span class="p">)</span>
        <span class="n">finalPrevious</span> <span class="o">=</span> <span class="n">DummyLatticeMinimal</span><span class="p">(</span><span class="n">tobj</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">tobj</span><span class="o">.</span><span class="n">finalPos</span><span class="p">)</span>

        <span class="n">saddlePrevious</span> <span class="o">=</span> <span class="n">Graphs</span><span class="o">.</span><span class="n">prepareLatticeToBeTransf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">saddlePrevious</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">cntrOrig</span><span class="o">=</span><span class="n">cntr1</span><span class="p">)</span>
        <span class="n">finalPrevious</span> <span class="o">=</span> <span class="n">Graphs</span><span class="o">.</span><span class="n">prepareLatticeToBeTransf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">finalPrevious</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">cntrOrig</span><span class="o">=</span><span class="n">cntr1</span><span class="p">)</span>

        <span class="c1"># get final position</span>
        <span class="n">saddle</span> <span class="o">=</span> <span class="n">Graphs</span><span class="o">.</span><span class="n">doTheTransformation</span><span class="p">(</span><span class="n">initialPrevious</span><span class="p">,</span> <span class="n">saddlePrevious</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">atomsList1</span><span class="p">,</span> <span class="n">initialState</span><span class="p">,</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">atomsList2</span><span class="p">,</span> <span class="n">trnsfMatrix</span><span class="p">,</span> <span class="n">cntr1</span><span class="p">,</span> <span class="n">cntr2</span><span class="p">)</span>
        <span class="n">final</span> <span class="o">=</span> <span class="n">Graphs</span><span class="o">.</span><span class="n">doTheTransformation</span><span class="p">(</span><span class="n">initialPrevious</span><span class="p">,</span> <span class="n">finalPrevious</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">atomsList1</span><span class="p">,</span> <span class="n">initialState</span><span class="p">,</span>
                                           <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">atomsList2</span><span class="p">,</span> <span class="n">trnsfMatrix</span><span class="p">,</span> <span class="n">cntr1</span><span class="p">,</span> <span class="n">cntr2</span><span class="p">)</span>

        <span class="c1"># store transformed positions</span>
        <span class="n">tobj</span><span class="o">.</span><span class="n">saddlePos</span> <span class="o">=</span> <span class="n">saddle</span><span class="o">.</span><span class="n">pos</span>
        <span class="n">tobj</span><span class="o">.</span><span class="n">finalPos</span> <span class="o">=</span> <span class="n">final</span><span class="o">.</span><span class="n">pos</span>

        <span class="c1"># make new object</span>
        <span class="n">newTrans</span> <span class="o">=</span> <span class="n">TransitionObject</span><span class="p">(</span><span class="n">tobj</span><span class="o">.</span><span class="n">saddlePos</span><span class="p">,</span> <span class="n">tobj</span><span class="o">.</span><span class="n">finalPos</span><span class="p">,</span> <span class="n">barrier</span><span class="o">=</span><span class="n">tobj</span><span class="o">.</span><span class="n">barrier</span><span class="p">,</span> <span class="n">hashKey</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hashKey</span><span class="p">)</span>

        <span class="c1"># compare transitions</span>
        <span class="n">identical</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)):</span>
            <span class="n">transition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitionList</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

            <span class="n">sep</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">newTrans</span><span class="o">.</span><span class="n">saddlePos</span><span class="p">,</span> <span class="n">transition</span><span class="o">.</span><span class="n">saddlePos</span><span class="p">,</span> <span class="n">tobj</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sep</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrUniqueMinSep</span><span class="p">:</span>
                <span class="n">identical</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

        <span class="c1"># if not identical, add transition</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">identical</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)</span>
            <span class="n">newTrans</span><span class="o">.</span><span class="n">setTransitionIndex</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transitionList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newTrans</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;New transition merged into volume </span><span class="si">%s</span><span class="s2">; trans num </span><span class="si">%d</span><span class="s2">; barrier </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hashKey</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">newTrans</span><span class="o">.</span><span class="n">barrier</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">newTrans</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Could not merge transition into volume </span><span class="si">%s</span><span class="s2">; duplicate of another&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">hashKey</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

            <span class="c1"># return no zero status (duplicate)</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div></div>

<span class="c1">################################################################################</span>
<div class="viewcode-block" id="DummyCurrentState"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.DummyCurrentState">[docs]</a><span class="k">class</span> <span class="nc">DummyCurrentState</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dummy object to pass to currentState attributes from write to read</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specieList</span><span class="p">,</span> <span class="n">cellDims</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieList</span> <span class="o">=</span> <span class="n">specieList</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span> <span class="o">=</span> <span class="n">cellDims</span></div>

<span class="c1">################################################################################</span>
<div class="viewcode-block" id="forcedSpecies"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.forcedSpecies">[docs]</a><span class="k">def</span> <span class="nf">forcedSpecies</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">specieList</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return list of species that are automatically included</span>
<span class="sd">    in defect list.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">forceSpecieDefect</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)</span>
    <span class="n">forcedSpeciesList</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specieList</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">array</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>

            <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specieList</span><span class="p">)):</span>
                <span class="n">sym</span> <span class="o">=</span> <span class="n">specieList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">sym</span> <span class="o">==</span> <span class="n">item</span><span class="p">:</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">forcedSpeciesList</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">forcedSpeciesList</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">forcedSpeciesList</span></div>

<span class="c1">################################################################################</span>
<div class="viewcode-block" id="excludedSpecies"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.excludedSpecies">[docs]</a><span class="k">def</span> <span class="nf">excludedSpecies</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">inputSpecieList</span><span class="p">,</span> <span class="n">refSpecieList</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return lists of species that are excluded from defect search, ie</span>
<span class="sd">    they cannot be defects.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">excludeSpecieDefect</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)</span>
    <span class="n">inputExcludedSpecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inputSpecieList</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">refExcludedSpecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">refSpecieList</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">count2</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">array</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inputSpecieList</span><span class="p">)):</span>
                <span class="n">sym</span> <span class="o">=</span> <span class="n">inputSpecieList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">sym</span> <span class="o">==</span> <span class="n">item</span><span class="p">:</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">inputExcludedSpecs</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">refSpecieList</span><span class="p">)):</span>
                <span class="n">sym</span> <span class="o">=</span> <span class="n">refSpecieList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">sym</span> <span class="o">==</span> <span class="n">item</span><span class="p">:</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">refExcludedSpecs</span><span class="p">[</span><span class="n">count2</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">count2</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">inputExcludedSpecs</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
    <span class="n">refExcludedSpecs</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">count2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">inputExcludedSpecs</span><span class="p">,</span> <span class="n">refExcludedSpecs</span></div>

<span class="c1">################################################################################</span>

<div class="viewcode-block" id="checkForNeighbourVolumes"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.checkForNeighbourVolumes">[docs]</a><span class="k">def</span> <span class="nf">checkForNeighbourVolumes</span><span class="p">(</span><span class="n">volIndex</span><span class="p">,</span> <span class="n">groupIndex</span><span class="p">,</span> <span class="n">volumes</span><span class="p">,</span> <span class="n">volumeGroupID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Search for neighbouring vols.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vol1</span> <span class="o">=</span> <span class="n">volumes</span><span class="p">[</span><span class="n">volIndex</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">vol2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">volumes</span><span class="p">):</span>
        <span class="c1"># skip same vol or if already searched</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">volIndex</span> <span class="ow">or</span> <span class="n">volumeGroupID</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">vol1</span><span class="p">,</span> <span class="n">vol2</span><span class="p">)</span>

        <span class="c1"># if overlap then make them in same group</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vol1</span><span class="p">):</span>
            <span class="n">volumeGroupID</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">groupIndex</span>

            <span class="n">checkForNeighbourVolumes</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">groupIndex</span><span class="p">,</span> <span class="n">volumes</span><span class="p">,</span> <span class="n">volumeGroupID</span><span class="p">)</span></div>

<span class="c1">################################################################################</span>

<div class="viewcode-block" id="checkVolumesLinked"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.checkVolumesLinked">[docs]</a><span class="k">def</span> <span class="nf">checkVolumesLinked</span><span class="p">(</span><span class="n">volumes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks to see if defect volumes overlap</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">volumeGroupID</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">volumes</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">volumeGroupID</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">NGroups</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">vol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">volumes</span><span class="p">):</span>
        <span class="c1"># already done this group</span>
        <span class="k">if</span> <span class="n">volumeGroupID</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">volumeGroupID</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">NGroups</span>
        <span class="n">NGroups</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">checkForNeighbourVolumes</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">volumeGroupID</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">volumes</span><span class="p">,</span> <span class="n">volumeGroupID</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">volumeGroupID</span></div>

<span class="c1">################################################################################</span>

<div class="viewcode-block" id="constructCombinedVolumes"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.constructCombinedVolumes">[docs]</a><span class="k">def</span> <span class="nf">constructCombinedVolumes</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">volGroupCounter</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add combined volumes.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># local refs</span>
    <span class="n">currentState</span> <span class="o">=</span> <span class="n">lattice</span>

    <span class="c1"># initialise</span>
<span class="c1">#     currentState.combinedSearchIniVols = []</span>
<span class="c1">#     currentState.combinedSearchMoveVols = []</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">volGroupCounter</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">searchCombinedVolumes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Constructing combined volumes&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">NVolsIn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">groupID</span> <span class="ow">in</span> <span class="n">volGroupCounter</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">volGroupCounter</span><span class="p">[</span><span class="n">groupID</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">volIndex</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)</span>

            <span class="n">searchIniVolume</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">NVacancies</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">NAntisites</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">NInterstitials</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># build group</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">NVolsIn</span><span class="p">):</span>
                <span class="n">dv</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">currentState</span><span class="o">.</span><span class="n">volumeGroupID</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">groupID</span><span class="p">:</span>
                    <span class="c1"># part of combined vol</span>
                    <span class="n">dv</span><span class="o">.</span><span class="n">partOfCombinedVol</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="k">if</span> <span class="n">dv</span><span class="o">.</span><span class="n">NVacancies</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">NVacancies</span> <span class="o">+=</span> <span class="n">dv</span><span class="o">.</span><span class="n">NVacancies</span>
                        <span class="n">NAntisites</span> <span class="o">+=</span> <span class="n">dv</span><span class="o">.</span><span class="n">NAntisites</span>
                        <span class="n">NInterstitials</span> <span class="o">+=</span> <span class="n">dv</span><span class="o">.</span><span class="n">NInterstitials</span>

                    <span class="c1"># atom lists</span>
                    <span class="k">if</span> <span class="n">searchIniVolume</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># create</span>
                        <span class="n">searchIniVolume</span> <span class="o">=</span> <span class="n">dv</span><span class="o">.</span><span class="n">searchInitialVol</span>
                        <span class="n">searchMoveVolume</span> <span class="o">=</span> <span class="n">dv</span><span class="o">.</span><span class="n">searchMoveVol</span>
                        <span class="n">graphVolume</span> <span class="o">=</span> <span class="n">dv</span><span class="o">.</span><span class="n">graphVol</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># append</span>
                        <span class="n">searchIniVolume</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">searchIniVolume</span><span class="p">,</span> <span class="n">dv</span><span class="o">.</span><span class="n">searchInitialVol</span><span class="p">)</span>
                        <span class="n">searchMoveVolume</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">searchMoveVolume</span><span class="p">,</span> <span class="n">dv</span><span class="o">.</span><span class="n">searchMoveVol</span><span class="p">)</span>
                        <span class="n">graphVolume</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">graphVolume</span><span class="p">,</span> <span class="n">dv</span><span class="o">.</span><span class="n">graphVol</span><span class="p">)</span>

            <span class="c1"># remove duplicates</span>
            <span class="n">searchIniVolume</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">searchIniVolume</span><span class="p">)</span>
            <span class="n">searchMoveVolume</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">searchMoveVolume</span><span class="p">)</span>
            <span class="n">graphVolume</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">graphVolume</span><span class="p">)</span>

            <span class="c1"># graph key</span>
            <span class="c1">#hashKey = Graphs.getHashKeyForAVolume(params, graphVolume, lattice)</span>
            <span class="c1"># Also calculate the com and moment</span>
            <span class="n">com</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">moment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">hashKeyChar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">character</span><span class="p">)</span>
            <span class="n">cellDims3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">cellDims3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cellDims3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">cellDims3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">lattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>

            <span class="n">c_defects</span><span class="o">.</span><span class="n">calc_hash_key_and_com</span><span class="p">(</span><span class="n">searchIniVolume</span><span class="p">,</span> <span class="n">graphVolume</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">graphRadius</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">specieList</span><span class="p">),</span>
                                            <span class="n">lattice</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">hashKeyChar</span><span class="p">,</span> <span class="n">com</span><span class="p">,</span> <span class="n">cellDims3</span><span class="p">,</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">,</span> <span class="n">moment</span><span class="p">)</span>
            <span class="n">hashKey</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hashKeyChar</span><span class="p">)</span>

            <span class="c1"># object</span>
            <span class="n">volObj</span> <span class="o">=</span> <span class="n">DefectVolume</span><span class="p">(</span><span class="n">volIndex</span><span class="p">)</span>
            <span class="n">volObj</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="n">searchIniVolume</span><span class="p">,</span> <span class="n">searchMoveVolume</span><span class="p">,</span> <span class="n">graphVolume</span><span class="p">,</span> <span class="n">hashKey</span><span class="p">,</span> <span class="n">com</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="p">[</span><span class="n">NVacancies</span><span class="p">,</span> <span class="n">NInterstitials</span><span class="p">,</span> <span class="n">NAntisites</span><span class="p">],</span> <span class="n">moment</span><span class="p">,</span> <span class="n">combinedVol</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="n">lattice</span><span class="o">.</span><span class="n">defectVolumes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volObj</span><span class="p">)</span>
            <span class="n">lattice</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hashKey</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Volume </span><span class="si">%d</span><span class="s2">: </span><span class="si">%d</span><span class="s2"> / </span><span class="si">%d</span><span class="s2"> / </span><span class="si">%d</span><span class="s2"> atoms (key: </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volIndex</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">searchIniVolume</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">searchMoveVolume</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">graphVolume</span><span class="p">),</span> <span class="n">hashKey</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;COM: (</span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">), Moment: (</span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">com</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">com</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">com</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">moment</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">moment</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">moment</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></div>

            <span class="c1"># add to list</span>
<span class="c1">#             currentState.combinedSearchIniVols.append(searchIniVolume)</span>
<span class="c1">#             currentState.combinedSearchMoveVols.append(searchMoveVolume)</span>

<span class="c1">################################################################################</span>

<div class="viewcode-block" id="DefectVolume"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.DefectVolume">[docs]</a><span class="k">class</span> <span class="nc">DefectVolume</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Holds information about a single defect volume.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    volIndex : int</span>
<span class="sd">        The unique index of this volume.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    volIndex : int</span>
<span class="sd">        The unique index of this volume.</span>
<span class="sd">    searchInitialVol : `numpy.ndarray`</span>
<span class="sd">        Array containing the indices of the atoms in the search initial list.</span>
<span class="sd">    searchMoveVol : `numpy.ndarray`</span>
<span class="sd">        Array containing the indices of the atoms in the search move list.</span>
<span class="sd">    graphVol : `numpy.ndarray`</span>
<span class="sd">        Array containing the indices of the atoms in the graph list.</span>
<span class="sd">    graphKey : string</span>
<span class="sd">        The label generated by Nauty for this defect volume.</span>
<span class="sd">    NVacancies : int</span>
<span class="sd">        The number of vacancies in the defect volume.</span>
<span class="sd">    NInterstitials : int</span>
<span class="sd">        The number of interstitials in the defect volume.</span>
<span class="sd">    NAntisites : int</span>
<span class="sd">        The number of antisites in the defect volume.</span>
<span class="sd">    com : `numpy.ndarray`</span>
<span class="sd">        The centre of mass of the defect volume.</span>
<span class="sd">    moment : `numpy.ndarray`</span>
<span class="sd">        The moment of the defect volume.</span>
<span class="sd">    combinedVol : boolean</span>
<span class="sd">        True if the volume is a combined volume, False otherwise.</span>
<span class="sd">    partOfCombinedVol : boolean</span>
<span class="sd">        True if this volume forms part of a combined volume, False otherwise.</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volIndex</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># if initialised with multiple DefectVolumes we merge them into a new vol.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;params&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="s2">&quot;lattice&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;lattice&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combinedVol</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partOfCombinedVol</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volIndex</span> <span class="o">=</span> <span class="n">volIndex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">com_extent</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">NVacancies</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NInterstitials</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NAntisites</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixedRefine</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="DefectVolume.merge"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.DefectVolume.merge">[docs]</a>    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vols</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">lattice</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge defect volumes into one.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Merging defect volumes into one.&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">vols</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">DefectVolume</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;DefectVolume: WRONG TYPE IN CONSTRUCTOR: IGNORING&quot;</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NVacancies</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NAntisites</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NInterstitials</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># merge them...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">searchInitialVol</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">searchMoveVol</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graphVol</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">dv</span> <span class="ow">in</span> <span class="n">vols</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchInitialVol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">searchInitialVol</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">searchInitialVol</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">searchMoveVol</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">searchMoveVol</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">graphVol</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">graphVol</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">searchInitialVol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">searchInitialVol</span><span class="p">,</span> <span class="n">dv</span><span class="o">.</span><span class="n">searchInitialVol</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">searchMoveVol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">searchMoveVol</span><span class="p">,</span> <span class="n">dv</span><span class="o">.</span><span class="n">searchMoveVol</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">graphVol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graphVol</span><span class="p">,</span> <span class="n">dv</span><span class="o">.</span><span class="n">graphVol</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">dv</span><span class="o">.</span><span class="n">NVacancies</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">NVacancies</span> <span class="o">+=</span> <span class="n">dv</span><span class="o">.</span><span class="n">NVacancies</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">NAntisites</span> <span class="o">+=</span> <span class="n">dv</span><span class="o">.</span><span class="n">NAntisites</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">NInterstitials</span> <span class="o">+=</span> <span class="n">dv</span><span class="o">.</span><span class="n">NInterstitials</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">searchInitialVol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">searchInitialVol</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">searchMoveVol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">searchMoveVol</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graphVol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graphVol</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">com</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">moment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

            <span class="n">hashKeyChar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">character</span><span class="p">)</span>

            <span class="n">cellDims3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">cellDims3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cellDims3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">cellDims3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">lattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>

            <span class="c1"># recalc graph key and com</span>
            <span class="n">c_defects</span><span class="o">.</span><span class="n">calc_hash_key_and_com</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">searchInitialVol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphVol</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">graphRadius</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">specieList</span><span class="p">),</span>
                                            <span class="n">lattice</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">hashKeyChar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">com</span><span class="p">,</span> <span class="n">cellDims3</span><span class="p">,</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">moment</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">graphKey</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hashKeyChar</span><span class="p">)</span></div>

    <span class="c1"># rebuild the defect volume with given graphList. Assume moveList/initialList not change.</span>
<div class="viewcode-block" id="DefectVolume.rebuild"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.DefectVolume.rebuild">[docs]</a>    <span class="k">def</span> <span class="nf">rebuild</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graphList</span><span class="p">,</span> <span class="n">graphKey</span><span class="p">,</span> <span class="n">com</span><span class="p">,</span> <span class="n">moment</span><span class="p">):</span>
        <span class="c1"># backup old info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graphVolOld</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphVol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graphKeyOld</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphKey</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">graphVol</span> <span class="o">=</span> <span class="n">graphList</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graphKey</span> <span class="o">=</span> <span class="n">graphKey</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">com</span> <span class="o">=</span> <span class="n">com</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moment</span> <span class="o">=</span> <span class="n">moment</span></div>

<div class="viewcode-block" id="DefectVolume.construct"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.DefectVolume.construct">[docs]</a>    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initialList</span><span class="p">,</span> <span class="n">moveList</span><span class="p">,</span> <span class="n">graphList</span><span class="p">,</span> <span class="n">graphKey</span><span class="p">,</span> <span class="n">com</span><span class="p">,</span> <span class="n">com_extent_info</span><span class="p">,</span> <span class="n">defectCounter</span><span class="p">,</span> <span class="n">moment</span><span class="p">,</span> <span class="n">combinedVol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct defect volume.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searchInitialVol</span> <span class="o">=</span> <span class="n">initialList</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searchMoveVol</span> <span class="o">=</span> <span class="n">moveList</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graphVol</span> <span class="o">=</span> <span class="n">graphList</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graphKey</span> <span class="o">=</span> <span class="n">graphKey</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">com</span> <span class="o">=</span> <span class="n">com</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">com_extent_info</span> <span class="o">=</span> <span class="n">com_extent_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moment</span> <span class="o">=</span> <span class="n">moment</span>
        <span class="k">if</span> <span class="n">combinedVol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combinedVol</span> <span class="o">=</span> <span class="n">combinedVol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NVacancies</span> <span class="o">=</span> <span class="n">defectCounter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NInterstitials</span> <span class="o">=</span> <span class="n">defectCounter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NAntisites</span> <span class="o">=</span> <span class="n">defectCounter</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">searchInitialVol</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">com_extent_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># calculate com extent</span>
            <span class="c1"># based on num defects in vol and farthest primary atom from com</span>
            <span class="n">num_defects_vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">com_extent_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">primary_com_sep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">com_extent_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># if lots of atoms use full primary_com_sep as extent; otherwise</span>
            <span class="c1"># use a scaled down radius</span>
            <span class="n">min_factor</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">max_factor</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">min_factor_num</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">max_factor_num</span> <span class="o">=</span> <span class="mi">8</span>

            <span class="k">if</span> <span class="n">num_defects_vol</span> <span class="o">&lt;=</span> <span class="n">min_factor_num</span><span class="p">:</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="n">min_factor</span>

            <span class="k">elif</span> <span class="n">num_defects_vol</span> <span class="o">&gt;=</span> <span class="n">max_factor_num</span><span class="p">:</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="n">max_factor</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># linear scaling</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_factor</span> <span class="o">-</span> <span class="n">min_factor</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_factor_num</span> <span class="o">-</span> <span class="n">min_factor_num</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_defects_vol</span> <span class="o">-</span> <span class="n">min_factor_num</span><span class="p">)</span> <span class="o">+</span> <span class="n">min_factor</span>

            <span class="c1"># uncomment for DEBUGGING</span>
<span class="c1">#             factor = 1</span>

            <span class="c1"># calculate extent of COM</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">com_extent</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">primary_com_sep</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;COM EXTENT: </span><span class="si">%f</span><span class="s2">; FACTOR: </span><span class="si">%f</span><span class="s2">; PRIMARY_COM_SEP: </span><span class="si">%f</span><span class="s2">; N DEF: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">com_extent</span><span class="p">,</span> <span class="n">factor</span><span class="p">,</span> <span class="n">primary_com_sep</span><span class="p">,</span> <span class="n">num_defects_vol</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">com_extent</span> <span class="o">=</span> <span class="kc">None</span></div></div>

<span class="c1">################################################################################</span>

<div class="viewcode-block" id="CoordNumDefectFinder"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.CoordNumDefectFinder">[docs]</a><span class="k">class</span> <span class="nc">CoordNumDefectFinder</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify point defects in the given lattice by coordination number.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This requires the visualiser libraries be installed.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>

<div class="viewcode-block" id="CoordNumDefectFinder.findDefects"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.CoordNumDefectFinder.findDefects">[docs]</a>    <span class="k">def</span> <span class="nf">findDefects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputState</span><span class="p">,</span> <span class="n">refState</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identify point defects in the given lattice by finding under coordination atoms.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        inputLattice : Lattice.Lattice</span>
<span class="sd">            Input Lattice object.</span>
<span class="sd">        refLattice : Lattice.Lattice</span>
<span class="sd">            Reference Lattice object (though not used).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        defectsObj : Rendering.DefectsObject</span>
<span class="sd">            Object that contains information about defects, including indices of vacancies,</span>
<span class="sd">            interstitials, etc.</span>
<span class="sd">            - Under coordinated atom defects are treated as interstitials only.</span>
<span class="sd">            - Other information set to zero</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Finding defects using coordination number&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># check that the visualiser was loaded successfully</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">VIS_LOADED</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Could not load CDJSVis; check your PYTHONPATH and that CDJSVis is compiled.&quot;</span><span class="p">)</span>

        <span class="c1"># parameters</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

        <span class="c1"># max coordination for different species</span>
        <span class="n">symMaxCoord</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># check if a value is specified for each species</span>
        <span class="n">speciesCoordString</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">speciesCoordMax</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">speciesCoordString</span><span class="p">):</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">speciesCoordString</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="nb">print</span> <span class="n">array</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Parameter speciesCoordMax must have an even number of arguments&quot;</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
                <span class="n">sym</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">symMaxCoord</span><span class="p">[</span><span class="n">sym</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Max coordination for &#39;</span><span class="si">%s</span><span class="s2">&#39; is </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">val</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># use default value for those that weren&#39;t specified</span>
        <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">inputState</span><span class="o">.</span><span class="n">specieList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sym</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">symMaxCoord</span><span class="p">:</span>
                <span class="n">symMaxCoord</span><span class="p">[</span><span class="n">sym</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">coordMaxDefault</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Using default max coordination for &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">coordMaxDefault</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># adapt input lattice for visualiser</span>
        <span class="n">inputState</span><span class="o">.</span><span class="n">PBC</span> <span class="o">=</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span>
        <span class="n">cellDims</span> <span class="o">=</span> <span class="n">inputState</span><span class="o">.</span><span class="n">cellDims</span>
        <span class="n">inputState</span><span class="o">.</span><span class="n">cellDims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">inputState</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cellDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">inputState</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cellDims</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">inputState</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cellDims</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>

        <span class="c1"># loop over all all species</span>
        <span class="n">visibleAtoms</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">inputState</span><span class="o">.</span><span class="n">specieList</span><span class="p">:</span> <span class="c1">#TODO: instead of looping over species, loops over unique max coord nums</span>
            <span class="c1"># make visible atoms all the atoms to begin with</span>
            <span class="n">visibleAtoms_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">inputState</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

            <span class="c1"># create filter input</span>
            <span class="n">filterInput</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">FilterInput</span><span class="p">()</span>
            <span class="n">filterInput</span><span class="o">.</span><span class="n">visibleAtoms</span> <span class="o">=</span> <span class="n">visibleAtoms_tmp</span>
            <span class="n">filterInput</span><span class="o">.</span><span class="n">inputState</span> <span class="o">=</span> <span class="n">inputState</span>

            <span class="c1"># create settings for coordination number filter</span>
            <span class="n">settings</span> <span class="o">=</span> <span class="n">coordinationNumberFilter</span><span class="o">.</span><span class="n">CoordinationNumberFilterSettings</span><span class="p">()</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">updateSetting</span><span class="p">(</span><span class="s2">&quot;filteringEnabled&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">updateSetting</span><span class="p">(</span><span class="s2">&quot;minCoordNum&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">updateSetting</span><span class="p">(</span><span class="s2">&quot;maxCoordNum&quot;</span><span class="p">,</span> <span class="n">symMaxCoord</span><span class="p">[</span><span class="n">symbol</span><span class="p">])</span>

            <span class="c1"># run coordination number filter</span>
            <span class="n">coordFilter</span> <span class="o">=</span> <span class="n">coordinationNumberFilter</span><span class="o">.</span><span class="n">CoordinationNumberFilter</span><span class="p">(</span><span class="s2">&quot;Coordination number&quot;</span><span class="p">)</span>
            <span class="n">coordFilter</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">filterInput</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>

            <span class="c1"># create setting for species filter #TODO include multiple species in list</span>
            <span class="n">settings</span> <span class="o">=</span> <span class="n">speciesFilter</span><span class="o">.</span><span class="n">SpeciesFilterSettings</span><span class="p">()</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">updateSetting</span><span class="p">(</span><span class="s2">&quot;visibleSpeciesList&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">symbol</span><span class="p">])</span>

            <span class="c1"># run species filter</span>
            <span class="n">speciesFilter_</span> <span class="o">=</span> <span class="n">speciesFilter</span><span class="o">.</span><span class="n">SpeciesFilter</span><span class="p">(</span><span class="s2">&quot;Species&quot;</span><span class="p">)</span>
            <span class="n">speciesFilter_</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">filterInput</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>

            <span class="c1"># store visible atoms</span>
            <span class="k">if</span> <span class="n">visibleAtoms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">visibleAtoms</span> <span class="o">=</span> <span class="n">visibleAtoms_tmp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">visibleAtoms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">visibleAtoms</span><span class="p">,</span> <span class="n">visibleAtoms_tmp</span><span class="p">)</span>

            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> under coordinated </span><span class="si">%s</span><span class="s2"> atoms&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">visibleAtoms_tmp</span><span class="p">),</span> <span class="n">symbol</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> under coordinated atoms&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">visibleAtoms</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># cluster index for each atom</span>
        <span class="n">defectCluster</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">visibleAtoms</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="c1"># arrays for storing indices of defects</span>
        <span class="n">vacancies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">antisites</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">onAntisites</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">interstitials</span> <span class="o">=</span> <span class="n">visibleAtoms</span>

        <span class="c1"># construct result</span>
        <span class="n">defectsObj</span> <span class="o">=</span> <span class="n">Rendering</span><span class="o">.</span><span class="n">DefectsObject</span><span class="p">()</span>
        <span class="n">defectsObj</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">vacancies</span><span class="p">,</span> <span class="n">interstitials</span><span class="p">,</span> <span class="n">antisites</span><span class="p">,</span> <span class="n">onAntisites</span><span class="p">,</span> <span class="n">inputState</span><span class="p">,</span> <span class="n">refState</span><span class="p">,</span> <span class="n">NClusters</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">visibleAtoms</span><span class="p">),</span> <span class="n">cluster</span><span class="o">=</span><span class="n">defectCluster</span><span class="p">)</span>

        <span class="c1"># revert input lattice</span>
        <span class="n">inputState</span><span class="o">.</span><span class="n">PBC</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">inputState</span><span class="o">.</span><span class="n">cellDims</span> <span class="o">=</span> <span class="n">cellDims</span>

        <span class="k">return</span> <span class="n">defectsObj</span></div></div>

<span class="c1">################################################################################</span>

<div class="viewcode-block" id="PointDefectFinder"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.PointDefectFinder">[docs]</a><span class="k">class</span> <span class="nc">PointDefectFinder</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Locate point defects in a Lattice.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>

<div class="viewcode-block" id="PointDefectFinder.findDefects"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.PointDefectFinder.findDefects">[docs]</a>    <span class="k">def</span> <span class="nf">findDefects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputState</span><span class="p">,</span> <span class="n">refState</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identify point defects in the given lattice.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        inputLattice : Lattice.Lattice</span>
<span class="sd">            Input Lattice object.</span>
<span class="sd">        refLattice : Lattice.Lattice</span>
<span class="sd">            Reference Lattice object.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        defectsObj : Rendering.DefectsObject</span>
<span class="sd">            Object that contains information about defects, including indices of vacancies,</span>
<span class="sd">            interstitials, etc.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># parameters from input file</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">vacancyRadius</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">vacancyRadius</span>
        <span class="n">initialRadius</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">searchInitialRadius</span>
        <span class="n">debugDefects</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">debugDefects</span>

        <span class="c1"># separation for determining if defects are in the same volume</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">volumesConstructNew</span><span class="p">:</span>
            <span class="n">defectNeighbourRadius</span> <span class="o">=</span> <span class="n">initialRadius</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">defectNeighbourRadius</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">initialRadius</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;finding defect clusters&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># make temporary list to store defect cluster index</span>
        <span class="n">defectCluster</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">inputState</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="c1"># arrays for storing indices of defects</span>
        <span class="n">vacancies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">refState</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">antisites</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">refState</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">onAntisites</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">refState</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">interstitials</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">inputState</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">NDefectsByType</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="c1"># include/exclude by specie</span>
        <span class="n">forcedSpeciesList</span> <span class="o">=</span> <span class="n">forcedSpecies</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">inputState</span><span class="o">.</span><span class="n">specieList</span><span class="p">)</span>
        <span class="n">inputStateExclSpecs</span><span class="p">,</span> <span class="n">refExclSpecs</span> <span class="o">=</span> <span class="n">excludedSpecies</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">inputState</span><span class="o">.</span><span class="n">specieList</span><span class="p">,</span> <span class="n">refState</span><span class="o">.</span><span class="n">specieList</span><span class="p">)</span>

        <span class="c1"># what type of defects to search for</span>
        <span class="n">includeVacs</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">vacancyDefects</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">includeInts</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">interstitialDefects</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">includeAnts</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">antisiteDefects</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># temporary fix -- force correct type for specie arrays</span>
        <span class="n">inputState</span><span class="o">.</span><span class="n">specie</span> <span class="o">=</span> <span class="n">inputState</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">refState</span><span class="o">.</span><span class="n">specie</span> <span class="o">=</span> <span class="n">refState</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="c1"># cell dims array for passing to C lib</span>
        <span class="n">cellDims3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">cellDims3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">refState</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cellDims3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">refState</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">cellDims3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">refState</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>

        <span class="c1"># call C library to find defects and put them in clusters</span>
        <span class="n">NClusters</span> <span class="o">=</span> <span class="n">c_defects</span><span class="o">.</span><span class="n">findDefectClusters</span><span class="p">(</span><span class="n">includeVacs</span><span class="p">,</span> <span class="n">includeInts</span><span class="p">,</span> <span class="n">includeAnts</span><span class="p">,</span> <span class="n">defectCluster</span><span class="p">,</span> <span class="n">NDefectsByType</span><span class="p">,</span> <span class="n">vacancies</span><span class="p">,</span> <span class="n">interstitials</span><span class="p">,</span>
                                                 <span class="n">antisites</span><span class="p">,</span> <span class="n">onAntisites</span><span class="p">,</span> <span class="n">forcedSpeciesList</span><span class="p">,</span> <span class="n">inputStateExclSpecs</span><span class="p">,</span> <span class="n">refExclSpecs</span><span class="p">,</span> <span class="n">inputState</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span>
                                                 <span class="n">inputState</span><span class="o">.</span><span class="n">specieList</span><span class="p">,</span> <span class="n">inputState</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> <span class="n">inputState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">refState</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">refState</span><span class="o">.</span><span class="n">specieList</span><span class="p">,</span>
                                                 <span class="n">refState</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> <span class="n">refState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">cellDims3</span><span class="p">,</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">,</span> <span class="n">vacancyRadius</span><span class="p">,</span> <span class="n">defectNeighbourRadius</span><span class="p">,</span>
                                                 <span class="n">refState</span><span class="o">.</span><span class="n">minPos</span><span class="p">,</span> <span class="n">refState</span><span class="o">.</span><span class="n">maxPos</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">Globals</span><span class="o">.</span><span class="n">verboseLevel</span><span class="p">),</span> <span class="n">debugDefects</span><span class="p">)</span>

        <span class="c1"># resize arrays</span>
        <span class="n">NDef</span> <span class="o">=</span> <span class="n">NDefectsByType</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">NVac</span> <span class="o">=</span> <span class="n">NDefectsByType</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">NInt</span> <span class="o">=</span> <span class="n">NDefectsByType</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">NAnt</span> <span class="o">=</span> <span class="n">NDefectsByType</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">vacancies</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">NVac</span><span class="p">)</span>
        <span class="n">interstitials</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">NInt</span><span class="p">)</span>
        <span class="n">antisites</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">NAnt</span><span class="p">)</span>
        <span class="n">onAntisites</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">NAnt</span><span class="p">)</span>
        <span class="n">defectCluster</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">NDef</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;found </span><span class="si">%d</span><span class="s2"> defects (</span><span class="si">%d</span><span class="s2"> / </span><span class="si">%d</span><span class="s2"> / </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NDef</span><span class="p">,</span> <span class="n">NVac</span><span class="p">,</span> <span class="n">NInt</span><span class="p">,</span> <span class="n">NAnt</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;found </span><span class="si">%d</span><span class="s2"> defect clusters&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NClusters</span><span class="p">,),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># construct result</span>
        <span class="n">defectsObj</span> <span class="o">=</span> <span class="n">Rendering</span><span class="o">.</span><span class="n">DefectsObject</span><span class="p">()</span>
        <span class="n">defectsObj</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">vacancies</span><span class="p">,</span> <span class="n">interstitials</span><span class="p">,</span> <span class="n">antisites</span><span class="p">,</span> <span class="n">onAntisites</span><span class="p">,</span> <span class="n">inputState</span><span class="p">,</span> <span class="n">refState</span><span class="p">,</span> <span class="n">NClusters</span><span class="o">=</span><span class="n">NClusters</span><span class="p">,</span> <span class="n">cluster</span><span class="o">=</span><span class="n">defectCluster</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">defectsObj</span></div></div>

<span class="c1">################################################################################</span>

<div class="viewcode-block" id="DefectVolumesBuilder"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.DefectVolumesBuilder">[docs]</a><span class="k">class</span> <span class="nc">DefectVolumesBuilder</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build defects volumes from the identified defects.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    params : Input.InputParams</span>
<span class="sd">        The input parameters object.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>

<div class="viewcode-block" id="DefectVolumesBuilder.buildDefectVolumes"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.DefectVolumesBuilder.buildDefectVolumes">[docs]</a>    <span class="k">def</span> <span class="nf">buildDefectVolumes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputState</span><span class="p">,</span> <span class="n">refState</span><span class="p">,</span> <span class="n">defectsObj</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build defect volumes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        inputLattice : Lattice.Lattice</span>
<span class="sd">            Input Lattice object.</span>
<span class="sd">        refLattice : Lattice.Lattice</span>
<span class="sd">            Reference Lattice object.</span>
<span class="sd">        defectsObj : Rendering.DefectsObject</span>
<span class="sd">            Defects object for the input lattice.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        defectVolumes : list</span>
<span class="sd">            The list of defect volumes in the input lattice.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Building defect volumes&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># parameters from input file</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">initialRadius</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">searchInitialRadius</span>
        <span class="n">moveRadius</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">searchMoveRadius</span>
        <span class="n">graphRadius</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">graphRadius</span>

        <span class="c1"># unpack defects object</span>
        <span class="n">NClusters</span> <span class="o">=</span> <span class="n">defectsObj</span><span class="o">.</span><span class="n">NClusters</span>
        <span class="n">defectCluster</span> <span class="o">=</span> <span class="n">defectsObj</span><span class="o">.</span><span class="n">cluster</span>
        <span class="n">vacancies</span> <span class="o">=</span> <span class="n">defectsObj</span><span class="o">.</span><span class="n">vacancies</span>
        <span class="n">interstitials</span> <span class="o">=</span> <span class="n">defectsObj</span><span class="o">.</span><span class="n">interstitials</span>
        <span class="n">antisites</span> <span class="o">=</span> <span class="n">defectsObj</span><span class="o">.</span><span class="n">antisites</span>

        <span class="c1"># cell dims array for passing to C lib</span>
        <span class="n">cellDims3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">cellDims3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">refState</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cellDims3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">refState</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">cellDims3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">refState</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>

        <span class="c1"># sanity check</span>
        <span class="k">if</span> <span class="n">moveRadius</span> <span class="o">&lt;</span> <span class="n">initialRadius</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Warning: moveRadius less than initialRadius: setting equal&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">moveRadius</span> <span class="o">=</span> <span class="n">initialRadius</span>

        <span class="c1"># list for storing all defect atoms (ie from each volume)</span>
        <span class="n">defectList</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">inputState</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="c1"># now build defect volume for each cluster</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">inputState</span><span class="o">.</span><span class="n">NDefectVolumes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">inputState</span><span class="o">.</span><span class="n">defectVolumesKeys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">inputState</span><span class="o">.</span><span class="n">defectVolumes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">NClusters</span><span class="p">):</span>
            <span class="c1"># array for storing atoms in this volume</span>
            <span class="n">primaryAtoms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">inputState</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">secondaryAtoms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">inputState</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">graphAtoms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">inputState</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">centreMass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">moment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">usedPBCs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">NAtomsArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">hashKeyChar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">character</span><span class="p">)</span>
            <span class="n">com_extent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

            <span class="c1"># defect counter for this volume</span>
            <span class="n">defectCounter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

            <span class="c1"># call C lib to build this volume</span>
            <span class="n">c_defects</span><span class="o">.</span><span class="n">buildDefectVolume</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">defectCluster</span><span class="p">,</span> <span class="n">primaryAtoms</span><span class="p">,</span> <span class="n">secondaryAtoms</span><span class="p">,</span> <span class="n">graphAtoms</span><span class="p">,</span>
                                        <span class="n">defectList</span><span class="p">,</span> <span class="n">vacancies</span><span class="p">,</span> <span class="n">interstitials</span><span class="p">,</span> <span class="n">antisites</span><span class="p">,</span> <span class="n">inputState</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span>
                                        <span class="n">inputState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputState</span><span class="o">.</span><span class="n">specieList</span><span class="p">),</span> <span class="n">inputState</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span>
                                        <span class="n">refState</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">refState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">cellDims3</span><span class="p">,</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">,</span> <span class="n">initialRadius</span><span class="p">,</span>
                                        <span class="n">moveRadius</span><span class="p">,</span> <span class="n">graphRadius</span><span class="p">,</span> <span class="n">refState</span><span class="o">.</span><span class="n">minPos</span><span class="p">,</span> <span class="n">refState</span><span class="o">.</span><span class="n">maxPos</span><span class="p">,</span> <span class="n">usedPBCs</span><span class="p">,</span>
                                        <span class="n">NAtomsArray</span><span class="p">,</span> <span class="n">hashKeyChar</span><span class="p">,</span> <span class="n">centreMass</span><span class="p">,</span> <span class="n">com_extent</span><span class="p">,</span> <span class="n">defectCounter</span><span class="p">,</span> <span class="n">moment</span><span class="p">)</span>

            <span class="c1"># resize arrays</span>
            <span class="n">NAtomsPrimary</span> <span class="o">=</span> <span class="n">NAtomsArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">NAtomsSecondary</span> <span class="o">=</span> <span class="n">NAtomsArray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">NAtomsGraph</span> <span class="o">=</span> <span class="n">NAtomsArray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">primaryAtoms</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">NAtomsPrimary</span><span class="p">)</span>
            <span class="n">secondaryAtoms</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">NAtomsSecondary</span><span class="p">)</span>
            <span class="n">graphAtoms</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">NAtomsGraph</span><span class="p">)</span>

            <span class="c1"># total number of primary atoms</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">NAtomsPrimary</span>

            <span class="c1"># render volumes</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">renderDefectVolumes</span><span class="p">:</span>
                <span class="c1"># primary atoms</span>
                <span class="n">volumeObj</span> <span class="o">=</span> <span class="n">Rendering</span><span class="o">.</span><span class="n">AtomsObject</span><span class="p">()</span>
                <span class="n">volumeObj</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">primaryAtoms</span><span class="p">,</span> <span class="n">inputState</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">writer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">volumeObj</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;volumesPrimary</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,),</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">writerItem</span><span class="p">(</span><span class="s2">&quot;RENDER&quot;</span><span class="p">,</span> <span class="n">dataType</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">volumeObj</span><span class="p">,],</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">)</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;output&quot;</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;volumesPrimary</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,),)</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;outdir&quot;</span><span class="p">:</span> <span class="n">outdir</span><span class="p">}</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">])</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

                <span class="c1"># secondary atoms</span>
                <span class="n">volumeObj</span> <span class="o">=</span> <span class="n">Rendering</span><span class="o">.</span><span class="n">AtomsObject</span><span class="p">()</span>
                <span class="n">volumeObj</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">secondaryAtoms</span><span class="p">,</span> <span class="n">inputState</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">writer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">volumeObj</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;volumesSecondary</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,),</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">writerItem</span><span class="p">(</span><span class="s2">&quot;RENDER&quot;</span><span class="p">,</span> <span class="n">dataType</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">volumeObj</span><span class="p">,],</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">)</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;output&quot;</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;volumesSecondary</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,),)</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;outdir&quot;</span><span class="p">:</span> <span class="n">outdir</span><span class="p">}</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">])</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

                <span class="c1"># graph atoms</span>
                <span class="n">volumeObj</span> <span class="o">=</span> <span class="n">Rendering</span><span class="o">.</span><span class="n">AtomsObject</span><span class="p">()</span>
                <span class="n">volumeObj</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">graphAtoms</span><span class="p">,</span> <span class="n">inputState</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">writer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">volumeObj</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;volumesGraph</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">writerItem</span><span class="p">(</span><span class="s2">&quot;RENDER&quot;</span><span class="p">,</span> <span class="n">dataType</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">volumeObj</span><span class="p">,],</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">)</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;output&quot;</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;volumesGraph</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,),)</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">])</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

            <span class="c1"># hash key</span>
            <span class="n">hashkey</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hashKeyChar</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Volume </span><span class="si">%d</span><span class="s2">: </span><span class="si">%d</span><span class="s2"> vacs / </span><span class="si">%d</span><span class="s2"> ints / </span><span class="si">%d</span><span class="s2"> ants&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">defectCounter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">defectCounter</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">defectCounter</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Volume </span><span class="si">%d</span><span class="s2">: </span><span class="si">%d</span><span class="s2"> / </span><span class="si">%d</span><span class="s2"> / </span><span class="si">%d</span><span class="s2"> atoms (key: </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">NAtomsPrimary</span><span class="p">,</span> <span class="n">NAtomsSecondary</span><span class="p">,</span> <span class="n">NAtomsGraph</span><span class="p">,</span> <span class="n">hashkey</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">inputState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hashkey</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;COM: (</span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">), Moment: (</span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">centreMass</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">centreMass</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">centreMass</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">moment</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">moment</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">moment</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

            <span class="c1"># defect volume object</span>
            <span class="n">volObj</span> <span class="o">=</span> <span class="n">DefectVolume</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">volObj</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="n">primaryAtoms</span><span class="p">,</span> <span class="n">secondaryAtoms</span><span class="p">,</span> <span class="n">graphAtoms</span><span class="p">,</span> <span class="n">hashkey</span><span class="p">,</span> <span class="n">centreMass</span><span class="p">,</span> <span class="n">com_extent</span><span class="p">,</span> <span class="n">defectCounter</span><span class="p">,</span> <span class="n">moment</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="n">inputState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volObj</span><span class="p">)</span>

            <span class="n">inputState</span><span class="o">.</span><span class="n">NDefectVolumes</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">NSubSystem</span> <span class="o">=</span> <span class="n">c_defects</span><span class="o">.</span><span class="n">finaliseDefectList</span><span class="p">(</span><span class="n">defectList</span><span class="p">)</span>

        <span class="n">defectList</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">NSubSystem</span><span class="p">)</span>

        <span class="n">inputState</span><span class="o">.</span><span class="n">NDefects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">defectList</span><span class="p">)</span>
        <span class="n">inputState</span><span class="o">.</span><span class="n">NSubSystem</span> <span class="o">=</span> <span class="n">inputState</span><span class="o">.</span><span class="n">NDefects</span>
        <span class="n">inputState</span><span class="o">.</span><span class="n">defectList</span> <span class="o">=</span> <span class="n">defectList</span>
        <span class="n">inputState</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="n">defectList</span>

        <span class="c1"># IF NEW_WAY: check if defect volumes are near enough to be together</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">volumesConstructNew</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Begin new way calculate volumes&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">NVols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> volumes&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NVols</span><span class="p">,),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">com_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">NVols</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">extent_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">NVols</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inputState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">):</span>
                <span class="n">com_array</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dv</span><span class="o">.</span><span class="n">com</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">com_array</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dv</span><span class="o">.</span><span class="n">com</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">com_array</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dv</span><span class="o">.</span><span class="n">com</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">extent_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dv</span><span class="o">.</span><span class="n">com_extent</span>

            <span class="c1"># allocator</span>
            <span class="n">alloc</span> <span class="o">=</span> <span class="n">numpy_utils</span><span class="o">.</span><span class="n">Allocator</span><span class="p">(</span><span class="n">storeAsList</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># verbose level for C lib</span>
            <span class="n">c_verbose</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">Globals</span><span class="o">.</span><span class="n">verboseLevel</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">verbose</span>

            <span class="c1"># call clib</span>
            <span class="n">c_defects</span><span class="o">.</span><span class="n">fuse_volumes</span><span class="p">(</span><span class="n">NVols</span><span class="p">,</span> <span class="n">com_array</span><span class="p">,</span> <span class="n">extent_array</span><span class="p">,</span> <span class="n">cellDims3</span><span class="p">,</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">,</span> <span class="n">alloc</span><span class="o">.</span><span class="n">cfunc</span><span class="p">,</span> <span class="n">c_verbose</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;NUM VOLS NEW - OLD: </span><span class="si">%d</span><span class="s2"> - </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alloc</span><span class="o">.</span><span class="n">allocated_arrays</span><span class="p">),</span> <span class="n">NVols</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">NVolsNew</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">alloc</span><span class="o">.</span><span class="n">allocated_arrays</span><span class="p">)</span>

            <span class="n">newVols</span> <span class="o">=</span> <span class="n">alloc</span><span class="o">.</span><span class="n">allocated_arrays</span>
            <span class="n">allLenOne</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">newVols</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">allLenOne</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">NVolsNew</span> <span class="o">!=</span> <span class="n">NVols</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">allLenOne</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Recalculating volumes (</span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NVolsNew</span><span class="p">,</span> <span class="n">NVols</span><span class="p">,</span> <span class="n">allLenOne</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="n">defectVolumes</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">vol</span> <span class="ow">in</span> <span class="n">newVols</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vol</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">defectVolumes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inputState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                        <span class="n">defectVolumes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">volIndex</span> <span class="o">=</span> <span class="n">count</span>

                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Adding single volume (</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inputState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vol</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Merging volumes (</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

                        <span class="n">dv</span> <span class="o">=</span> <span class="n">DefectVolume</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">lattice</span><span class="o">=</span><span class="n">inputState</span><span class="p">)</span>

                        <span class="n">defectVolumes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dv</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;New hash key: </span><span class="si">%s</span><span class="s2">; COM: (</span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">graphKey</span><span class="p">,</span> <span class="n">dv</span><span class="o">.</span><span class="n">com</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dv</span><span class="o">.</span><span class="n">com</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dv</span><span class="o">.</span><span class="n">com</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">inputState</span><span class="o">.</span><span class="n">defectVolumes</span> <span class="o">=</span> <span class="n">defectVolumes</span>

                <span class="n">inputState</span><span class="o">.</span><span class="n">defectVolumesKeys</span> <span class="o">=</span> <span class="p">[</span><span class="n">dv</span><span class="o">.</span><span class="n">graphKey</span> <span class="k">for</span> <span class="n">dv</span> <span class="ow">in</span> <span class="n">inputState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># list of graph volumes</span>
        <span class="n">graphVols</span> <span class="o">=</span> <span class="p">[</span><span class="n">dv</span><span class="o">.</span><span class="n">graphVol</span> <span class="k">for</span> <span class="n">dv</span> <span class="ow">in</span> <span class="n">inputState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">]</span>

        <span class="c1"># check for overlapping volumes</span>
        <span class="n">inputState</span><span class="o">.</span><span class="n">volumeGroupID</span> <span class="o">=</span> <span class="n">checkVolumesLinked</span><span class="p">(</span><span class="n">graphVols</span><span class="p">)</span>
        <span class="n">inputState</span><span class="o">.</span><span class="n">NVolumeGroups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">inputState</span><span class="o">.</span><span class="n">volumeGroupID</span><span class="p">))</span>

        <span class="c1"># construct combined volumes</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="n">inputState</span><span class="o">.</span><span class="n">volumeGroupID</span><span class="p">)</span>
        <span class="n">constructCombinedVolumes</span><span class="p">(</span><span class="n">inputState</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">renderDefectVolumes</span><span class="p">:</span>
            <span class="n">subsystemObj</span> <span class="o">=</span> <span class="n">Rendering</span><span class="o">.</span><span class="n">AtomsObject</span><span class="p">()</span>
            <span class="n">subsystemObj</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">defectList</span><span class="p">,</span> <span class="n">inputState</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">writer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">subsystemObj</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;volumesSubsystem&quot;</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">writerItem</span><span class="p">(</span><span class="s2">&quot;RENDER&quot;</span><span class="p">,</span> <span class="n">dataType</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">subsystemObj</span><span class="p">,],</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">)</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;output&quot;</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;volumesSubsystem&quot;</span><span class="p">,)</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;outdir&quot;</span><span class="p">:</span> <span class="n">outdir</span><span class="p">}</span>
                <span class="n">item</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">])</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">inputState</span><span class="o">.</span><span class="n">defectVolumes</span></div></div>

<span class="c1">################################################################################</span>

<div class="viewcode-block" id="DefectVolumesFinder"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.DefectVolumesFinder">[docs]</a><span class="k">class</span> <span class="nc">DefectVolumesFinder</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find defects and construct defect volumes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    params : Input.InputParams</span>
<span class="sd">        The input parameters object.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The workflow is to first identify defects and then to construct the defect</span>
<span class="sd">    volumes. The method for identifying defects is set in the parameter file,</span>
<span class="sd">    for example it can be by comparison to a reference lattice or by looking</span>
<span class="sd">    for undercoordinated atoms.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>

        <span class="c1"># the defect identifier (depends on parameter choice)</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">defectMethod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">defectIdentifier</span> <span class="o">=</span> <span class="n">PointDefectFinder</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">params</span><span class="o">.</span><span class="n">defectMethod</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">defectIdentifier</span> <span class="o">=</span> <span class="n">CoordNumDefectFinder</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Defect method must be 0 or 1&quot;</span><span class="p">)</span>

        <span class="c1"># volume builder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volumeBuilder</span> <span class="o">=</span> <span class="n">DefectVolumesBuilder</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

<div class="viewcode-block" id="DefectVolumesFinder.findDefectVolumes"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.DefectVolumesFinder.findDefectVolumes">[docs]</a>    <span class="k">def</span> <span class="nf">findDefectVolumes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputState</span><span class="p">,</span> <span class="n">refState</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find defect volumes in the lattice.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        inputLattice : Lattice.Lattice</span>
<span class="sd">            Input Lattice object.</span>
<span class="sd">        refLattice : Lattice.Lattice</span>
<span class="sd">            Reference Lattice object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># find defects in the lattice (includes finding cluster index for each defect)</span>
        <span class="n">inputState</span><span class="o">.</span><span class="n">defectsObject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defectIdentifier</span><span class="o">.</span><span class="n">findDefects</span><span class="p">(</span><span class="n">inputState</span><span class="p">,</span> <span class="n">refState</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># build defect volumes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volumeBuilder</span><span class="o">.</span><span class="n">buildDefectVolumes</span><span class="p">(</span><span class="n">inputState</span><span class="p">,</span> <span class="n">refState</span><span class="p">,</span> <span class="n">inputState</span><span class="o">.</span><span class="n">defectsObject</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                                              <span class="n">writer</span><span class="o">=</span><span class="n">writer</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">inputState</span><span class="o">.</span><span class="n">defectsObject</span></div></div>

<span class="c1">################################################################################</span>
<span class="c1"># Create random vector with zero components for atoms outside defectSubSystem</span>
<span class="c1">################################################################################</span>
<div class="viewcode-block" id="randomVectorSubSystem"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.randomVectorSubSystem">[docs]</a><span class="k">def</span> <span class="nf">randomVectorSubSystem</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>

    <span class="n">randVec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">obj</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">debugSearch</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">:</span>
            <span class="n">randVec</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">randVec</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">randVec</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">:</span>
            <span class="n">randVec</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">randVec</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">randVec</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">normalise</span><span class="p">(</span><span class="n">randVec</span><span class="p">)</span></div>


<span class="c1">################################################################################</span>
<span class="c1"># Write subsystem to lattice file for debugging</span>
<span class="c1">################################################################################</span>
<div class="viewcode-block" id="visualiseSubSystem"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.visualiseSubSystem">[docs]</a><span class="k">def</span> <span class="nf">visualiseSubSystem</span><span class="p">(</span> <span class="n">filename</span><span class="p">,</span> <span class="n">lattice</span> <span class="p">):</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">)))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">lattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">8</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lattice</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lattice</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">],</span> <span class="n">lattice</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">lattice</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="n">lattice</span><span class="o">.</span><span class="n">charge</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<span class="c1">################################################################################</span>
<span class="c1"># Creates search area according to defect atom</span>
<span class="c1">################################################################################</span>
<span class="c1"># def createSearchArea(lattice, parameters, index=None):</span>
<span class="c1">#     log(__name__, &quot;Identifying search area&quot;, 2)</span>
<span class="c1">#</span>
<span class="c1">#     if len(lattice.defectList) &lt; 1:</span>
<span class="c1">#         print &quot;WARNING: no atoms in defectList&quot;</span>
<span class="c1">#         return</span>
<span class="c1">#</span>
<span class="c1">#     if not index:</span>
<span class="c1">#         # choose atom randomly from defect list</span>
<span class="c1">#         if parameters.debugSearch:</span>
<span class="c1">#             index = lattice.defectList[0]</span>
<span class="c1">#         else:</span>
<span class="c1">#             index = random.choice(lattice.defectList)</span>
<span class="c1">#</span>
<span class="c1">#     ax = lattice.pos[3*index]</span>
<span class="c1">#     ay = lattice.pos[3*index+1]</span>
<span class="c1">#     az = lattice.pos[3*index+2]</span>
<span class="c1">#</span>
<span class="c1">#     log(__name__, &quot;Chosen atom number %d&quot; % (index), 2, 1)</span>
<span class="c1">#</span>
<span class="c1">#     moveRadius = parameters.moveRadius</span>
<span class="c1">#     moveRadius2 = moveRadius * moveRadius</span>
<span class="c1">#</span>
<span class="c1">#     includeRadius = parameters.moveRadius + parameters.moveSkin</span>
<span class="c1">#     includeRadius2 = includeRadius * includeRadius</span>
<span class="c1">#</span>
<span class="c1">#     lattice.defectSubSystem = []</span>
<span class="c1">#</span>
<span class="c1">#     for index2 in xrange(lattice.NAtoms):</span>
<span class="c1">#</span>
<span class="c1">#         bx = lattice.pos[3*index2]</span>
<span class="c1">#         by = lattice.pos[3*index2+1]</span>
<span class="c1">#         bz = lattice.pos[3*index2+2]</span>
<span class="c1">#</span>
<span class="c1">#         # separation</span>
<span class="c1">#         sep2 = c_utils.atomicSeparation2(ax, ay, az, bx, by, bz, lattice.cellDims[0], lattice.cellDims[4], lattice.cellDims[8], int(Globals.PBC[0]), int(Globals.PBC[1]), int(Globals.PBC[2]))</span>
<span class="c1">#</span>
<span class="c1">#         # randomly displace this atom if close enough to chosen defect</span>
<span class="c1">#         if sep2 &lt; moveRadius2:</span>
<span class="c1">#             lattice.defectSubSystem.append(index2)</span>
<span class="c1">#</span>
<span class="c1">#         # store atom in sub-system list if within includeRadius</span>
<span class="c1">#         elif sep2 &lt; includeRadius2:</span>
<span class="c1">#             lattice.defectSubSystem.append(index2)</span>

<span class="c1">################################################################################</span>

<div class="viewcode-block" id="initiateDefectDisplacement"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.initiateDefectDisplacement">[docs]</a><span class="k">def</span> <span class="nf">initiateDefectDisplacement</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initiate search vector.</span>

<span class="sd">    Atoms that are:</span>
<span class="sd">        1) within &quot;localiseRadius&quot; of the chosen atom, AND</span>
<span class="sd">        2) on the primary defect list</span>
<span class="sd">    will be given an initial displacement.</span>

<span class="sd">    Atoms that are on the full defect list are included in the subsystem.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;initiating defect displacement&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">dv</span> <span class="o">=</span> <span class="n">lattice</span><span class="o">.</span><span class="n">currentDefectVolume</span>

    <span class="n">searchInitialAtoms</span> <span class="o">=</span> <span class="n">dv</span><span class="o">.</span><span class="n">searchInitialVol</span>
    <span class="n">searchMoveAtoms</span> <span class="o">=</span> <span class="n">dv</span><span class="o">.</span><span class="n">searchMoveVol</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">searchMoveAtoms</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">searchInitialAtoms</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;ERROR: currentSearchMoveVolume and/or currentSearchInitialVolume are empty&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lattice</span><span class="o">.</span><span class="n">displacementVector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># local references</span>
        <span class="n">localiseRadius</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">localiseSearchRadius</span>
        <span class="n">locRad2</span> <span class="o">=</span> <span class="n">localiseRadius</span> <span class="o">*</span> <span class="n">localiseRadius</span>

        <span class="c1"># pick atom from primary list</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">debugSearch</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">searchInitialAtoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">searchInitialAtoms</span><span class="p">)</span>

        <span class="c1"># not sure what this is for Tomas?</span>
    <span class="c1">#    lattice.saddleSearchInitDefectVolHash = lattice.currentDefectVolumeKey</span>

        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;randomly chosen atom number </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># position of chosen atom</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">lattice</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="p">]</span>
        <span class="n">ay</span> <span class="o">=</span> <span class="n">lattice</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">az</span> <span class="o">=</span> <span class="n">lattice</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># search for primary atoms within localiseRadius</span>
        <span class="n">moveList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index2</span> <span class="ow">in</span> <span class="n">searchInitialAtoms</span><span class="p">:</span>
            <span class="c1"># this atoms positions</span>
            <span class="n">bx</span> <span class="o">=</span> <span class="n">lattice</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index2</span><span class="p">]</span>
            <span class="n">by</span> <span class="o">=</span> <span class="n">lattice</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">bz</span> <span class="o">=</span> <span class="n">lattice</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index2</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>

            <span class="c1"># separation</span>
            <span class="n">sep2</span> <span class="o">=</span> <span class="n">c_utils</span><span class="o">.</span><span class="n">atomicSeparation2</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">,</span> <span class="n">az</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="n">bz</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">lattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

            <span class="k">if</span> <span class="n">sep2</span> <span class="o">&lt;</span> <span class="n">locRad2</span><span class="p">:</span>
                <span class="n">moveList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index2</span><span class="p">)</span>

        <span class="c1"># subsystem is just full list</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">defectSubSystemFull</span> <span class="o">=</span> <span class="n">searchMoveAtoms</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="n">searchMoveAtoms</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">defectSubSystemSmall</span> <span class="o">=</span> <span class="n">searchInitialAtoms</span>

        <span class="c1"># create displacement vector containing all atoms within subsystem (but</span>
        <span class="c1"># only moving those within localised radius)</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">NSubSystem</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">)</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">displacementVector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">lattice</span><span class="o">.</span><span class="n">NSubSystem</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="c1">#lattice.displacementVectorFull = lattice.displacementVector</span>
        <span class="c1">#lattice.displacementVectorSmall = np.zeros(3*len(lattice.defectSubSystemSmall), np.float64)</span>

        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">NSubSystem</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">lattice</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">moveList</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">debugSearch</span><span class="p">:</span>
                    <span class="n">rx</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="n">ry</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
                    <span class="n">rz</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">barrInitRandomType</span><span class="p">:</span>
                        <span class="c1"># use the Gaussian random number</span>
                        <span class="n">rx</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">ry</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">rz</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># use the uniform random number</span>
                        <span class="n">rx</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="n">ry</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="n">rz</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>

                <span class="n">lattice</span><span class="o">.</span><span class="n">displacementVector</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rx</span>
                <span class="n">lattice</span><span class="o">.</span><span class="n">displacementVector</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ry</span>
                <span class="n">lattice</span><span class="o">.</span><span class="n">displacementVector</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">rz</span>

<span class="c1">#                lattice.displacementVectorSmall[3*count] = rx</span>
<span class="c1">#                lattice.displacementVectorSmall[3*count+1] = ry</span>
<span class="c1">#                lattice.displacementVectorSmall[3*count+2] = rz</span>

                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># normalise the displacement vector</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">displacementVector</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">normalise</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">displacementVector</span><span class="p">)</span>
        <span class="c1">#lattice.displacementVectorSmall = Vectors.normalise(lattice.displacementVectorSmall)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">defectSubSystemFull</span> <span class="o">=</span> <span class="n">searchMoveAtoms</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="n">searchMoveAtoms</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">defectSubSystemSmall</span> <span class="o">=</span> <span class="n">searchInitialAtoms</span>

        <span class="c1"># create displacement vector containing all atoms within subsystem (but</span>
        <span class="c1"># only moving those within localised radius)</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">NSubSystem</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">)</span>

    <span class="n">moveCnt</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># now apply the displacement</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">NSubSystem</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">lattice</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">displacementVector</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">or</span>
            <span class="nb">abs</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">displacementVector</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">or</span>
            <span class="nb">abs</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">displacementVector</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">):</span>

            <span class="n">moveCnt</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">lattice</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">step</span> <span class="o">*</span> <span class="n">lattice</span><span class="o">.</span><span class="n">displacementVector</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">]</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">step</span> <span class="o">*</span> <span class="n">lattice</span><span class="o">.</span><span class="n">displacementVector</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">step</span> <span class="o">*</span> <span class="n">lattice</span><span class="o">.</span><span class="n">displacementVector</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> atoms initially displaced, </span><span class="si">%d</span><span class="s2"> atoms in subsystem&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">moveCnt</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>

<span class="c1">################################################################################</span>
<div class="viewcode-block" id="DefectRenderer"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.DefectRenderer">[docs]</a><span class="k">class</span> <span class="nc">DefectRenderer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Defect renderer.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputState</span><span class="p">,</span> <span class="n">refState</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputState</span> <span class="o">=</span> <span class="n">inputState</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refState</span> <span class="o">=</span> <span class="n">refState</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>

<div class="viewcode-block" id="DefectRenderer.render"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.DefectRenderer.render">[docs]</a>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Render.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># first find defects</span>
        <span class="n">volfinder</span> <span class="o">=</span> <span class="n">DefectVolumesFinder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="n">defectsObj</span> <span class="o">=</span> <span class="n">volfinder</span><span class="o">.</span><span class="n">findDefectVolumes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputState</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refState</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># now render</span>
        <span class="n">defectsObj</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">storePOV</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div></div>

<span class="c1">################################################################################</span>

<div class="viewcode-block" id="call_find_defects"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.call_find_defects">[docs]</a><span class="k">def</span> <span class="nf">call_find_defects</span><span class="p">(</span><span class="n">currentState</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Call clib</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># variables from input file</span>
    <span class="n">vacancyRadius</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">vacancyRadius</span>
    <span class="n">initialRadius</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">searchInitialRadius</span>
    <span class="n">moveRadius</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">searchMoveRadius</span>
    <span class="n">graphRadius</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">graphRadius</span>
    <span class="n">debugDefects</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">debugDefects</span>

    <span class="n">params</span> <span class="o">=</span> <span class="n">parameters</span>

    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">volumesConstructNew</span><span class="p">:</span>
        <span class="n">defectNeighbourRadius</span> <span class="o">=</span> <span class="n">initialRadius</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">defectNeighbourRadius</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">initialRadius</span>

    <span class="k">if</span> <span class="n">moveRadius</span> <span class="o">&lt;</span> <span class="n">initialRadius</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;WARNING: moveRadius less than initialRadius: setting equal&quot;</span>
        <span class="n">moveRadius</span> <span class="o">=</span> <span class="n">initialRadius</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;finding defect clusters&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># make temporary list to store defects</span>
    <span class="n">defectCluster</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="c1"># arrays for storing indexes of defects (only if visualising I guess)</span>
    <span class="n">vacancies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">antisites</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">onAntisites</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">interstitials</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">NDefectsByType</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="c1"># include/exclude by specie</span>
    <span class="n">forcedSpeciesList</span> <span class="o">=</span> <span class="n">forcedSpecies</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">currentState</span><span class="o">.</span><span class="n">specieList</span><span class="p">)</span>
    <span class="n">inputStateExclSpecs</span><span class="p">,</span> <span class="n">refExclSpecs</span> <span class="o">=</span> <span class="n">excludedSpecies</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">currentState</span><span class="o">.</span><span class="n">specieList</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">specieList</span><span class="p">)</span>

    <span class="c1"># what type of defects to search for</span>
    <span class="n">includeVacs</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">includeInts</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">includeAnts</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">parameters</span><span class="o">.</span><span class="n">vacancyDefects</span><span class="p">:</span>
        <span class="n">includeVacs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">parameters</span><span class="o">.</span><span class="n">interstitialDefects</span><span class="p">:</span>
        <span class="n">includeInts</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">parameters</span><span class="o">.</span><span class="n">antisiteDefects</span><span class="p">:</span>
        <span class="n">includeAnts</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># temporary fix</span>
    <span class="n">currentState</span><span class="o">.</span><span class="n">specie</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">ref</span><span class="o">.</span><span class="n">specie</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="n">cellDims3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">cellDims3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cellDims3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">cellDims3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>

    <span class="c1"># call C library to find defects and put them in clusters</span>
    <span class="n">NClusters</span> <span class="o">=</span> <span class="n">c_defects</span><span class="o">.</span><span class="n">findDefectClusters</span><span class="p">(</span> <span class="n">includeVacs</span><span class="p">,</span> <span class="n">includeInts</span><span class="p">,</span> <span class="n">includeAnts</span><span class="p">,</span> <span class="n">defectCluster</span><span class="p">,</span> <span class="n">NDefectsByType</span><span class="p">,</span> <span class="n">vacancies</span><span class="p">,</span> <span class="n">interstitials</span><span class="p">,</span>
                                              <span class="n">antisites</span><span class="p">,</span> <span class="n">onAntisites</span><span class="p">,</span> <span class="n">forcedSpeciesList</span><span class="p">,</span> <span class="n">inputStateExclSpecs</span><span class="p">,</span> <span class="n">refExclSpecs</span><span class="p">,</span> <span class="n">currentState</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span>
                                              <span class="n">currentState</span><span class="o">.</span><span class="n">specieList</span><span class="p">,</span> <span class="n">currentState</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> <span class="n">currentState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">specieList</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span>
                                              <span class="n">cellDims3</span><span class="p">,</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">,</span> <span class="n">vacancyRadius</span><span class="p">,</span> <span class="n">defectNeighbourRadius</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">minPos</span><span class="p">,</span>
                                              <span class="n">ref</span><span class="o">.</span><span class="n">maxPos</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">Globals</span><span class="o">.</span><span class="n">verboseLevel</span><span class="p">),</span> <span class="n">debugDefects</span> <span class="p">)</span>

    <span class="c1"># resize arrays</span>
    <span class="n">NDef</span> <span class="o">=</span> <span class="n">NDefectsByType</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">NVac</span> <span class="o">=</span> <span class="n">NDefectsByType</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">NInt</span> <span class="o">=</span> <span class="n">NDefectsByType</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">NAnt</span> <span class="o">=</span> <span class="n">NDefectsByType</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">vacancies</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">NVac</span><span class="p">)</span>
    <span class="n">interstitials</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">NInt</span><span class="p">)</span>
    <span class="n">antisites</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">NAnt</span><span class="p">)</span>
    <span class="n">onAntisites</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">NAnt</span><span class="p">)</span>
    <span class="n">defectCluster</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">NDef</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;found </span><span class="si">%d</span><span class="s2"> defects (</span><span class="si">%d</span><span class="s2"> / </span><span class="si">%d</span><span class="s2"> / </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NDef</span><span class="p">,</span> <span class="n">NVac</span><span class="p">,</span> <span class="n">NInt</span><span class="p">,</span> <span class="n">NAnt</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;found </span><span class="si">%d</span><span class="s2"> defect clusters&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NClusters</span><span class="p">,),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">vacancies</span><span class="p">,</span> <span class="n">interstitials</span><span class="p">,</span> <span class="n">antisites</span><span class="p">,</span> <span class="n">onAntisites</span><span class="p">,</span> <span class="n">defectCluster</span><span class="p">,</span> <span class="n">NClusters</span></div>


<div class="viewcode-block" id="fillDefectsExcludingVolume"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.fillDefectsExcludingVolume">[docs]</a><span class="k">def</span> <span class="nf">fillDefectsExcludingVolume</span><span class="p">(</span><span class="n">volumeToKeep</span><span class="p">,</span> <span class="n">inputLattice</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">storeSubSystem</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fill defects in other volumes</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">currentState</span> <span class="o">=</span>  <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">inputLattice</span><span class="p">)</span>

    <span class="n">vacancies</span><span class="p">,</span> <span class="n">interstitials</span><span class="p">,</span> <span class="n">antisites</span><span class="p">,</span> <span class="n">onAntisites</span><span class="p">,</span> <span class="n">defectCluster</span><span class="p">,</span> <span class="n">NClusters</span> <span class="o">=</span> <span class="n">call_find_defects</span><span class="p">(</span><span class="n">currentState</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

    <span class="n">NVac</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vacancies</span><span class="p">)</span>
    <span class="n">NInt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">interstitials</span><span class="p">)</span>
    <span class="n">NAnt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">antisites</span><span class="p">)</span>

    <span class="c1"># check same number of clusters!</span>


    <span class="c1"># swap antisite species</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">NAnt</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">defectCluster</span><span class="p">[</span><span class="n">NVac</span><span class="o">+</span><span class="n">NInt</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">volumeToKeep</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="nb">print</span> <span class="s2">&quot;SWAP ANT SPEC&quot;</span>

        <span class="n">antIndex</span> <span class="o">=</span> <span class="n">antisites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">onAntIndex</span> <span class="o">=</span> <span class="n">onAntisites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># ant index</span>
        <span class="n">ref_sym</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">atomSym</span><span class="p">(</span><span class="n">antIndex</span><span class="p">)</span>

        <span class="c1"># change</span>
        <span class="n">currentState</span><span class="o">.</span><span class="n">changeAtomSpecie</span><span class="p">(</span><span class="n">onAntIndex</span><span class="p">,</span> <span class="n">ref_sym</span><span class="p">)</span>

    <span class="c1"># fill vacancies</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">NVac</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">defectCluster</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">volumeToKeep</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="nb">print</span> <span class="s2">&quot;FILL VAC&quot;</span>

        <span class="n">vacIndex</span> <span class="o">=</span> <span class="n">vacancies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">vacSym</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">atomSym</span><span class="p">(</span><span class="n">vacIndex</span><span class="p">)</span>
        <span class="n">vacPos</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">atomPos</span><span class="p">(</span><span class="n">vacIndex</span><span class="p">)</span>
        <span class="n">vacCharge</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">charge</span><span class="p">[</span><span class="n">vacIndex</span><span class="p">]</span>

        <span class="n">currentState</span><span class="o">.</span><span class="n">addAtom</span><span class="p">(</span><span class="n">vacSym</span><span class="p">,</span> <span class="n">vacPos</span><span class="p">,</span> <span class="n">vacCharge</span><span class="p">)</span>

    <span class="c1"># remove interstitials</span>
    <span class="n">ints_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">interstitials</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;INTS&quot;</span><span class="p">,</span> <span class="n">ints_sorted</span>


    <span class="c1"># minimise</span>
    <span class="n">minimiser</span> <span class="o">=</span> <span class="n">Minimise</span><span class="o">.</span><span class="n">getMinimiser</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>

    <span class="n">status</span> <span class="o">=</span> <span class="n">minimiser</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">currentState</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ERROR: minimise isolated system failed</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">currentState</span><span class="o">.</span><span class="n">writeLattice</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;filled.dat&quot;</span><span class="p">))</span>

    <span class="n">vol_key_isolated</span> <span class="o">=</span> <span class="n">inputLattice</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volumeToKeep</span><span class="p">]</span><span class="o">.</span><span class="n">graphKey</span>

    <span class="c1"># run find defects again</span>
    <span class="n">findDefectVolumes</span><span class="p">(</span><span class="n">currentState</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">storeSubSystem</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s2">&quot;NVOL&quot;</span><span class="p">,</span>  <span class="nb">len</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="nb">print</span> <span class="s2">&quot;VOL KEY OLD&quot;</span><span class="p">,</span> <span class="n">vol_key_isolated</span>
    <span class="nb">print</span> <span class="s2">&quot;VOL KEY NEW&quot;</span><span class="p">,</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">graphKey</span></div>

<span class="c1">################################################################################</span>
<div class="viewcode-block" id="commandLineArgs"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.commandLineArgs">[docs]</a><span class="k">def</span> <span class="nf">commandLineArgs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse command line arguments</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">argparse</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Find defects in the system.&quot;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;inputFile&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The input state lattice file.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;refFile&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The reference state lattice file.&quot;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;paramFile&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;lkmcInput.IN&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;LKMC input file (default=lkmcInput.IN)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;outputOn&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Turn extended output on (default=off)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-P&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;profileCode&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Profile the code using the hotshot module (not for production) (default=False)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;statsFile&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;File for dumping profiling stats to (default=None)&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span></div>


<span class="c1">################################################################################</span>
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../LKMC/LKMC.Defects.html#LKMC.Defects.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">LKMC</span> <span class="k">import</span> <span class="n">Lattice</span>

    <span class="n">progargs</span> <span class="o">=</span> <span class="n">commandLineArgs</span><span class="p">()</span>

    <span class="n">params</span> <span class="o">=</span> <span class="n">Input</span><span class="o">.</span><span class="n">getLKMCParams</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">progargs</span><span class="o">.</span><span class="n">paramFile</span><span class="p">)</span>
    <span class="n">Input</span><span class="o">.</span><span class="n">readGlobals</span><span class="p">(</span><span class="n">progargs</span><span class="o">.</span><span class="n">paramFile</span><span class="p">)</span>

    <span class="n">inputState</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">readLattice</span><span class="p">(</span><span class="n">progargs</span><span class="o">.</span><span class="n">inputFile</span><span class="p">)</span>
    <span class="n">refState</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">readLattice</span><span class="p">(</span><span class="n">progargs</span><span class="o">.</span><span class="n">refFile</span><span class="p">)</span>

    <span class="c1"># find defects</span>
    <span class="n">defectsObj</span> <span class="o">=</span> <span class="n">findDefectVolumes</span><span class="p">(</span><span class="n">inputState</span><span class="p">,</span> <span class="n">refState</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">progargs</span><span class="o">.</span><span class="n">outputOn</span><span class="p">:</span>
        <span class="n">defectsObj</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;defects&quot;</span><span class="p">,</span> <span class="n">storePOV</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;Defects.log&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">defectsObj</span><span class="o">.</span><span class="n">NDefects</span><span class="p">,))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">LKMC 150623-1236-g1254817 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, Chris Scott, Tomas Lazauskas, Miao Yu.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.5.
    </div>
  </body>
</html>