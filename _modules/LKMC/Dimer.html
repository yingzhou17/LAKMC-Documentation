<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>LKMC.Dimer &mdash; LKMC 150623-1236-g1254817 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '150623-1236-g1254817',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="LKMC 150623-1236-g1254817 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">LKMC 150623-1236-g1254817 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for LKMC.Dimer</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Dimer method of Henkelman and Jonsson. </span>

<span class="sd">Copyright Chris Scott 2012</span>

<span class="sd">Combined with LBFGS/Lanczos method</span>
<span class="sd">        Tomas Lazauskas 2012</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">glob</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">ClientServerInterface</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Defects</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Forces</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Globals</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Input</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Lanczos</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Lattice</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Minimise</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">MinModeFollower</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Prefactor</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Timer</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Utilities</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Vectors</span>
<span class="kn">from</span> <span class="nn">.Utilities</span> <span class="k">import</span> <span class="n">log</span>

<span class="c1">################################################################################</span>
<span class="c1"># The Dimer class</span>
<span class="c1">################################################################################</span>
<div class="viewcode-block" id="Dimer"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer">[docs]</a><span class="k">class</span> <span class="nc">Dimer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dimer class.</span>
<span class="sd">    Input is the initial state.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobID</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returnSaddleBeforeLanczos</span> <span class="o">=</span> <span class="mi">0</span>
    
<div class="viewcode-block" id="Dimer.setParams"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.setParams">[docs]</a>    <span class="k">def</span> <span class="nf">setParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set params object.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Dimer.setJobID"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.setJobID">[docs]</a>    <span class="k">def</span> <span class="nf">setJobID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobID</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set job ID.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobID</span> <span class="o">=</span> <span class="n">jobID</span></div>
    
<div class="viewcode-block" id="Dimer.prepareRotationalMinParams"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.prepareRotationalMinParams">[docs]</a>    <span class="k">def</span> <span class="nf">prepareRotationalMinParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">defectFlag</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare params object for rotational minimiser.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotMinParams</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">rotMinParams</span><span class="o">.</span><span class="n">minimizationCriteria</span> <span class="o">=</span> <span class="s2">&quot;force&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotMinParams</span><span class="o">.</span><span class="n">minimizationTolerance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerTolR</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotMinParams</span><span class="o">.</span><span class="n">minimizationExclusion</span> <span class="o">=</span> <span class="n">defectFlag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotMinParams</span><span class="o">.</span><span class="n">minimisationLineSearchStep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerDeltaTheta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotMinParams</span><span class="o">.</span><span class="n">minimizationLineSearch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerLineSearch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotMinParams</span><span class="o">.</span><span class="n">minimizationType</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerRotationalMinimiser</span></div>
    
<div class="viewcode-block" id="Dimer.runRotation"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.runRotation">[docs]</a>    <span class="k">def</span> <span class="nf">runRotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initialState</span><span class="p">,</span> <span class="n">subSystem</span><span class="p">,</span> <span class="n">initialPos</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="n">inputState</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initialState</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">setupDimer</span><span class="p">(</span><span class="n">inputState</span><span class="p">,</span> <span class="n">defectFlag</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># defect subsystem</span>
        <span class="k">if</span> <span class="n">subSystem</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">subSystem</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="n">inputState</span><span class="o">.</span><span class="n">defectSubSystem</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="n">inputState</span><span class="o">.</span><span class="n">defectSubSystem</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="n">inputState</span><span class="o">.</span><span class="n">defectSubSystem</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">subSystem</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">subSystem</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">subSystem</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">initialPos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">Defects</span><span class="o">.</span><span class="n">randomVectorSubSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separationVectorSubSystem</span><span class="p">(</span><span class="n">initialPos</span><span class="p">,</span> <span class="n">initialState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">subSystem</span><span class="p">,</span> <span class="n">initialState</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fullList</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
<span class="c1">#        # create dimer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">pos</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltaR</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">pos</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltaR</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">stepType</span> <span class="o">=</span> <span class="s2">&quot;rotation&quot;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotationalMinimiser</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">latticeMin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertToLattice</span><span class="p">()</span>
            
            <span class="n">pos</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">curvature</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">totalEnergy</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">totalEnergy</span><span class="p">:</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">pos</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">pos</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">totalEnergy</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">totalEnergy</span><span class="p">:</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">pos</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">pos</span>
                    
            <span class="n">result</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separationVectorSubSystem</span><span class="p">(</span><span class="n">latticeMin</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> 
                <span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">,</span> <span class="n">latticeMin</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
            <span class="k">return</span> <span class="n">result</span></div>
    
    <span class="c1"># setup the dimer</span>
<div class="viewcode-block" id="Dimer.setupDimer"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.setupDimer">[docs]</a>    <span class="k">def</span> <span class="nf">setupDimer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initialState</span><span class="p">,</span> <span class="n">defectFlag</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup the dimer</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Statistics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elapsedTime</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">searchSteps</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">totWholeFEvals</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">totExclFEvals</span> <span class="o">=</span> <span class="mi">0</span>       
        
        <span class="bp">self</span><span class="o">.</span><span class="n">minExclFEvalsSteps</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minExclSubFEvals</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minExclTime</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">minWholeFEvalsSteps</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minWholeSubFEvals</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minWholeTime</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">rotWholeFEvals</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotExclFEvals</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">transWholeFEvals</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transExclFEvals</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># initialise some stuff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variableStepSize</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translationDirection</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">stepType</span> <span class="o">=</span> <span class="s2">&quot;rotation&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NMinimisationSteps</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxForceAtomNo</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saddleFound</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugDimerLineSearchCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storeEnergies</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saddleImageNo</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NRotationMins</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">maxMoveAtom</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">finalBarrier</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">stepCount</span> <span class="o">=</span> <span class="mi">0</span>
                
        <span class="c1"># separation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deltaR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerSeparation</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimerSeparation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerSeparation</span>
        
        <span class="c1"># copy data from initial state into object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">.</span><span class="n">NAtoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initialState</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specie</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initialState</span><span class="o">.</span><span class="n">specie</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initialState</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initialState</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initialState</span><span class="o">.</span><span class="n">force</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initialState</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defectList</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initialState</span><span class="o">.</span><span class="n">defectList</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NSubSystem</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">.</span><span class="n">NSubSystem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieList</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initialState</span><span class="o">.</span><span class="n">specieList</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieCount</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initialState</span><span class="o">.</span><span class="n">specieCount</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">KE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieMass</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initialState</span><span class="o">.</span><span class="n">specieMass</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieMassAMU</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initialState</span><span class="o">.</span><span class="n">specieMassAMU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieCovalentRadius</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initialState</span><span class="o">.</span><span class="n">specieCovalentRadius</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieRGB</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initialState</span><span class="o">.</span><span class="n">specieRGB</span><span class="p">)</span>
<span class="c1">#         self.searchInitialVols = initialState.searchInitialVols</span>
<span class="c1">#         self.searchMoveVols = initialState.searchMoveVols</span>
<span class="c1">#         self.currentSearchInitialVolume = initialState.currentSearchInitialVolume</span>
<span class="c1">#         self.currentSearchMoveVolume = initialState.currentSearchMoveVolume</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">.</span><span class="n">defectVolumes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumesKeys</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">.</span><span class="n">defectVolumesKeys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentDefectVolume</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">.</span><span class="n">currentDefectVolume</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resetLammps</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">.</span><span class="n">resetLammps</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">displacementVector</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#self.initialN = None</span>
        
        <span class="k">if</span> <span class="n">initialState</span><span class="o">.</span><span class="n">displacementNVector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initialState</span><span class="o">.</span><span class="n">displacementNVector</span><span class="p">)</span>
        
        <span class="c1"># store initial position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialPos</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initialState</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        
        <span class="c1"># create empty Lattice objects for holding the dimer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P1</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">Lattice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P2</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">Lattice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># shallow copy things that don&#39;t change</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">specie</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specie</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">specie</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specie</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">cellDims</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">cellDims</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">specieList</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieList</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">specieList</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieList</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">specieCount</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieCount</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">specieCount</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieCount</span><span class="p">)</span>
<span class="c1">#         self.P1.currentSearchMoveVolume = self.currentSearchMoveVolume</span>
<span class="c1">#         self.P2.currentSearchMoveVolume = self.currentSearchMoveVolume</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">currentDefectVolume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentDefectVolume</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">currentDefectVolume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentDefectVolume</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">specieMassAMU</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieMassAMU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">specieMassAMU</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieMassAMU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">resetLammps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resetLammps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">resetLammps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resetLammps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">NAtoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">NAtoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">NSubSystem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NSubSystem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">NSubSystem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NSubSystem</span>
        
        <span class="c1"># deep copy position and force arrays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">dispDotP1Force</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispDotP2Force</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="c1"># make rotational minimiser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepareRotationalMinParams</span><span class="p">(</span><span class="n">defectFlag</span><span class="o">=</span><span class="n">defectFlag</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotationalMinimiser</span> <span class="o">=</span> <span class="n">Minimise</span><span class="o">.</span><span class="n">getMinimiser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotMinParams</span><span class="p">,</span> <span class="n">jobID</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">normalMinimiser</span> <span class="o">=</span> <span class="n">Minimise</span><span class="o">.</span><span class="n">getMinimiser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">jobID</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">)</span>
        
        <span class="c1"># get translator too</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translator</span> <span class="o">=</span> <span class="n">getDimerTranslator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translator</span><span class="o">.</span><span class="n">setJobID</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">)</span>
        
        <span class="c1"># get Lanczos convergence minimisers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saddleFinder</span> <span class="o">=</span> <span class="n">Lanczos</span><span class="o">.</span><span class="n">LanczosLBFGSSaddleFinder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saddleFinder</span><span class="o">.</span><span class="n">setJobID</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">)</span>
        
        <span class="c1"># Lanczos parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doLanczos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">found1stNegCurv</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">found2ndNegCurv</span> <span class="o">=</span> <span class="mi">0</span>
        
        
        <span class="c1"># Test backwards parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testBackSep</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testBackTime</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testBackSuccess</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Sub-systems</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moveSubSytem</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">includeFSubSystem</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="n">status</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">.</span><span class="n">calcForce</span><span class="p">(</span><span class="n">correctTE</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialEnergy</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">.</span><span class="n">totalEnergy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failReason</span> <span class="o">=</span> <span class="s2">&quot;Dimer: initial force calculation failed&quot;</span>
            <span class="k">return</span> <span class="mi">1</span>
        
        <span class="k">return</span> <span class="mi">0</span></div>
            
    <span class="c1"># calculate forces on the dimer</span>
<div class="viewcode-block" id="Dimer.calcForce"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.calcForce">[docs]</a>    <span class="k">def</span> <span class="nf">calcForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">defectFlag</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">correctTE</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate forces on the dimer.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerStepDirectionMode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>    
            <span class="n">prevForce</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">)</span>
        
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcForceImages</span><span class="p">(</span><span class="n">defectFlag</span><span class="o">=</span><span class="n">defectFlag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        
        <span class="c1"># sum of energies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sumEnergy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">totalEnergy</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">totalEnergy</span>
        
        <span class="c1"># dot product of difference in force with N</span>
        <span class="n">forceDiffDotN</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">dotProduct</span><span class="p">(</span><span class="n">Vectors</span><span class="o">.</span><span class="n">subtractVectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">force</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">force</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        
        <span class="c1"># curvature of the potential along the dimer            </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curvature</span> <span class="o">=</span> <span class="n">forceDiffDotN</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimerSeparation</span>

        <span class="c1"># energy of the midpoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimerEnergy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sumEnergy</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltaR</span> <span class="o">/</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">forceDiffDotN</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">totalEnergy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimerEnergy</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">midPointForce</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">addVectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">force</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">force</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
        
        <span class="c1"># the force we store depends on the step</span>
        <span class="c1"># for rotational minimisation step we require the perpendicular component of F1 - F2</span>
        <span class="c1"># for the translation step we require FR, the average force</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepType</span> <span class="o">==</span> <span class="s2">&quot;rotation&quot;</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerKDimRotFlag</span><span class="p">:</span>
                
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;using k-dimer rotation forces&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">calcForce_isoPotential</span><span class="p">()</span>
            
            <span class="c1"># calculate perpendicular component of each </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">getForcePerpendicular</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">getForcePerpendicular</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">subtractVectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">force</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">force</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">maxForce</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepType</span> <span class="o">==</span> <span class="s2">&quot;translation&quot;</span><span class="p">:</span>
            <span class="c1"># calculate magnitude of rotational force</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">magRotF</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">Vectors</span><span class="o">.</span><span class="n">subtractVectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">getForcePerpendicular</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">getForcePerpendicular</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)))</span>
            
            <span class="c1"># calculate FR</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">midPointForce</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerUseLanczos</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dispDotP1Force</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">dotProduct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">force</span><span class="p">,</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separationVector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialPos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dispDotP2Force</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">dotProduct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">force</span><span class="p">,</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separationVector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialPos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">))</span>
            
            <span class="c1"># calculate effective force</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcEffectiveForce</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerStepDirectionMode</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepCount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">translationDirection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTranslationDirection</span><span class="p">(</span><span class="n">prevForce</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">translationDirection</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">translationDirection</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">normalise</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">)</span>
                            
            <span class="bp">self</span><span class="o">.</span><span class="n">maxForce</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">calcForceInfNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">)</span>        
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failReason</span> <span class="o">=</span> <span class="s2">&quot;Dimer: Unknown stepType&quot;</span>
            <span class="k">return</span> <span class="mi">1</span>
        
<span class="c1">#        print &quot;  MAG F&quot;, Vectors.magnitude(self.P1.force), Vectors.magnitude(self.P2.force), Vectors.magnitude(self.force)</span>
        
        <span class="c1"># handle inclusion/exclusion of defects here</span>
        <span class="k">if</span> <span class="n">defectFlag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Forces</span><span class="o">.</span><span class="n">_excludeDefects</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">defectFlag</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">Forces</span><span class="o">.</span><span class="n">_includeDefects</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="mi">0</span></div>
    
<div class="viewcode-block" id="Dimer.calcForce_isoPotential"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.calcForce_isoPotential">[docs]</a>    <span class="k">def</span> <span class="nf">calcForce_isoPotential</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A modified rotational force for k-dimer method.</span>
<span class="sd">        </span>
<span class="sd">        DOI:10.1063/1.4898664 Xiao, P., Wu, Q., &amp; Henkelman, G. (2014). Basin constrained κ-dimer method for saddle point finding. J. Chem. Phys., 141(16), 164111.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">subtractVectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">force</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">midPointForce</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">subtractVectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">force</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">midPointForce</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="Dimer.getTranslationDirection"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.getTranslationDirection">[docs]</a>    <span class="k">def</span> <span class="nf">getTranslationDirection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefEffForce</span><span class="p">,</span> <span class="n">currEffForce</span><span class="p">,</span> <span class="n">prevDirection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Polak-Ribiere formula:</span>
<span class="sd">        </span>
<span class="sd">        DOI:10.1137/100792743 Pedersen, A et al. &quot;Efficient sampling of saddle points with the minimum-mode following method&quot;</span>
<span class="sd">        </span>
<span class="sd">        Eq. 2.4</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="n">Vectors</span><span class="o">.</span><span class="n">dotProduct</span><span class="p">(</span><span class="n">currEffForce</span><span class="p">,</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">subtractVectors</span><span class="p">(</span><span class="n">currEffForce</span><span class="p">,</span> <span class="n">prefEffForce</span><span class="p">))</span> <span class="o">/</span> 
                <span class="n">Vectors</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">prefEffForce</span><span class="p">))</span>

        <span class="n">newDirection</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">normalise</span><span class="p">(</span><span class="n">Vectors</span><span class="o">.</span><span class="n">addVectors</span><span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">prevDirection</span><span class="p">,</span> <span class="n">currEffForce</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">newDirection</span></div>
    
<div class="viewcode-block" id="Dimer.calcForceImages"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.calcForceImages">[docs]</a>    <span class="k">def</span> <span class="nf">calcForceImages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">defectFlag</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates forces on the Dimer images.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">status1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">calcForce</span><span class="p">(</span><span class="n">defectFlag</span><span class="o">=</span><span class="n">defectFlag</span><span class="p">)</span>
        <span class="n">status2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">calcForce</span><span class="p">(</span><span class="n">defectFlag</span><span class="o">=</span><span class="n">defectFlag</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Globals</span><span class="o">.</span><span class="n">useSubLatticeForceCalc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">totWholeFEvals</span> <span class="o">+=</span> <span class="mi">2</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepType</span> <span class="o">==</span> <span class="s2">&quot;rotation&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rotWholeFEvals</span> <span class="o">+=</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepType</span> <span class="o">==</span> <span class="s2">&quot;translation&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transWholeFEvals</span> <span class="o">+=</span> <span class="mi">2</span>       
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">totExclFEvals</span> <span class="o">+=</span> <span class="mi">2</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepType</span> <span class="o">==</span> <span class="s2">&quot;rotation&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rotExclFEvals</span> <span class="o">+=</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepType</span> <span class="o">==</span> <span class="s2">&quot;translation&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transExclFEvals</span> <span class="o">+=</span> <span class="mi">2</span>
                    
        <span class="k">if</span> <span class="n">status1</span> <span class="ow">or</span> <span class="n">status2</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;DIMER FORCE CALC FAILED&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failReason</span> <span class="o">=</span> <span class="s2">&quot;Dimer: force calculation failed&quot;</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>    
            <span class="k">return</span> <span class="mi">0</span></div>
            
<div class="viewcode-block" id="Dimer.calcEffectiveForce"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.calcEffectiveForce">[docs]</a>    <span class="k">def</span> <span class="nf">calcEffectiveForce</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates effective force of a dimer, depending on curvature (Eq 21 from Dimer paper)</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">curvature</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">getForceParallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separationVector</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">getForceParallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">force</span></div>
    
<div class="viewcode-block" id="Dimer.converge2Saddle"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.converge2Saddle">[docs]</a>    <span class="k">def</span> <span class="nf">converge2Saddle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lanczosSaddle</span><span class="p">,</span> <span class="n">inputStateIni</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converges to a saddle point using LBFGS minimisation and Lanczos method.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        
        <span class="n">saddleFound</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lanczosContinue</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">debugDimerLanczos</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">lanczosSaddle</span>
        
        <span class="c1">#TODO: this test doesn&#39;t seem to do anything (should we remove it or make it exit if it failed!!!!)</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerStepBackTestBeforeLanczos</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stepBackwardsTest</span><span class="p">(</span><span class="n">inputStateIni</span><span class="p">,</span> <span class="n">lanczosSaddle</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">testBackSuccess</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Test backwards before Lanczos convergence results: sep = </span><span class="si">%lf</span><span class="s2">, time = </span><span class="si">%lf</span><span class="s2"> s.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testBackSep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">testBackTime</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Test backwards before Lanczos convergence results: FAILED to converge to something, time = </span><span class="si">%lf</span><span class="s2"> s.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testBackTime</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># minimise atoms that were held fixed during Dimer</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">lanczosMinOuterFirst</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Minimising atoms that were held fixed before Lanczos&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">prms</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="n">prms</span><span class="o">.</span><span class="n">minimizationType</span> <span class="o">=</span> <span class="n">prms</span><span class="o">.</span><span class="n">lanczosMinOuterType</span>
            <span class="n">prms</span><span class="o">.</span><span class="n">minimizationCriteria</span> <span class="o">=</span> <span class="n">prms</span><span class="o">.</span><span class="n">lanczosMinOuterCriteria</span>
            <span class="n">prms</span><span class="o">.</span><span class="n">minimizationTolerance</span> <span class="o">=</span> <span class="n">prms</span><span class="o">.</span><span class="n">lanczosMinOuterTol</span>
            <span class="n">prms</span><span class="o">.</span><span class="n">minimizationExclusion</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">prms</span><span class="o">.</span><span class="n">LBFGSTolerance</span> <span class="o">=</span> <span class="n">prms</span><span class="o">.</span><span class="n">lanczosMinOuterLBFGSTol</span>
            
            <span class="n">inipos</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">lanczosSaddle</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            
            <span class="n">outmin</span> <span class="o">=</span> <span class="n">Minimise</span><span class="o">.</span><span class="n">getMinimiser</span><span class="p">(</span><span class="n">prms</span><span class="p">,</span> <span class="n">jobID</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">outmin</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">lanczosSaddle</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Min outer atoms before Lanczos failed (</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">failReason</span> <span class="o">=</span> <span class="s2">&quot;Dimer: min outer atoms before Lanczos failed&quot;</span>
                <span class="k">return</span> <span class="kc">None</span>
            
            <span class="n">sep</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">inipos</span><span class="p">,</span> <span class="n">lanczosSaddle</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">lanczosSaddle</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Separation after minimising outer atoms after Lanczos = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sep</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
<span class="c1">#        if params.dimerUseSubLattLanczos and Globals.useSubLatticeForceCalc:</span>
        <span class="c1"># before the whole lattice lanczos method working, don&#39;t check global subLattice setting. otherwise would skip lanczos</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerUseSubLattLanczos</span><span class="p">:</span>
            <span class="c1"># prepare to call Lanczos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare4Convergence</span><span class="p">(</span><span class="n">lanczosSaddle</span><span class="p">)</span>
            
            <span class="c1"># call Lanczos</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saddleFinder</span><span class="o">.</span><span class="n">converge</span><span class="p">(</span><span class="n">lanczosSaddle</span><span class="p">)</span>
                     
            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Failed (Lanczos-LBFGS saddle finder)&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">lanczosContinue</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saddleFinder</span><span class="o">.</span><span class="n">failReason</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">failReason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saddleFinder</span><span class="o">.</span><span class="n">failReason</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">failReason</span> <span class="o">=</span> <span class="s2">&quot;Dimer: Lanczos saddle finder failed&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">saddleFound</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">lanczosSaddle</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">lanczosSaddle</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerUseWholeLattLanczos</span> <span class="ow">and</span> <span class="n">lanczosContinue</span><span class="p">:</span>
            <span class="n">saddleFound</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Failed!!! ATM WHOLE LATTICE LANCZOS ALGORITHM IS UNAVAILABLE!&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failReason</span> <span class="o">=</span> <span class="s2">&quot;Dimer: Whole lattice algorithm is unavailable&quot;</span>
            <span class="n">lanczosContinue</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">if</span> <span class="n">saddleFound</span> <span class="ow">and</span> <span class="n">lanczosContinue</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saddleFound</span> <span class="o">=</span> <span class="mi">1</span>
            
        <span class="k">return</span> <span class="n">lanczosSaddle</span></div>
     
<div class="viewcode-block" id="Dimer.calcStepSize"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.calcStepSize">[docs]</a>    <span class="k">def</span> <span class="nf">calcStepSize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates step size.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerDeltaT</span>
        <span class="n">deltaMax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerMaxStepSize</span>
        <span class="n">deltaMin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerMinStepSize</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerUseVarStepSize</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Estimates dimer step size according to Newton&#39;s formula</span>
<span class="sd">            </span>
<span class="sd">            DOI:10.1137/100792743 Pedersen, A et al. &quot;Efficient sampling of saddle points with the minimum-mode following method&quot;</span>
<span class="sd">            Algorithm 1</span>
<span class="sd">            </span>
<span class="sd">            &quot;&quot;&quot;</span>
                
            <span class="n">initialPos</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">initialForce</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">)</span>
    
            <span class="n">dfa</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">dotProduct</span><span class="p">(</span><span class="n">initialForce</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">addVectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">step</span> <span class="o">*</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">normalise</span><span class="p">(</span><span class="n">direction</span><span class="p">))</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltaR</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltaR</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
            
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcForceImages</span><span class="p">(</span><span class="n">defectFlag</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">addVectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">force</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">force</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcEffectiveForce</span><span class="p">()</span>
            
            <span class="n">dfb</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">dotProduct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
            
            <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfa</span> <span class="o">-</span> <span class="n">dfb</span><span class="p">)</span> <span class="o">/</span> <span class="n">step</span>
            
            <span class="n">delta</span> <span class="o">=</span> <span class="n">dfa</span> <span class="o">/</span> <span class="n">k</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">deltaMax</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">delta</span><span class="p">)):</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfa</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dfa</span><span class="p">))</span> <span class="o">*</span> <span class="n">deltaMax</span>
            <span class="k">elif</span> <span class="n">deltaMin</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">delta</span><span class="p">):</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfa</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dfa</span><span class="p">))</span> <span class="o">*</span> <span class="n">deltaMin</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initialPos</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initialForce</span><span class="p">)</span>
            
            <span class="c1">#self.variableStepSize = abs(delta)        </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variableStepSize</span> <span class="o">=</span> <span class="n">delta</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerUseVarStepSize</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Exponential scaling according to the curvature</span>
<span class="sd">            </span>
<span class="sd">            &quot;&quot;&quot;</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">variableStepSize</span> <span class="o">=</span> <span class="n">step</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curvature</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4.0</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">variableStepSize</span> <span class="o">&gt;</span> <span class="n">deltaMax</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">variableStepSize</span> <span class="o">=</span> <span class="n">deltaMax</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">variableStepSize</span> <span class="o">&lt;</span> <span class="n">deltaMin</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">variableStepSize</span> <span class="o">=</span> <span class="n">deltaMin</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Linear scaling according to the curvature</span>
<span class="sd">            </span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">variableStepSize</span> <span class="o">=</span> <span class="n">step</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">curvature</span> <span class="o">/</span> <span class="mf">2.0</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">variableStepSize</span> <span class="o">&gt;</span> <span class="n">deltaMax</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">variableStepSize</span> <span class="o">=</span> <span class="n">deltaMax</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">variableStepSize</span> <span class="o">&lt;</span> <span class="n">deltaMin</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">variableStepSize</span> <span class="o">=</span> <span class="n">deltaMin</span></div>

    <span class="c1"># rotate the dimer    </span>
<div class="viewcode-block" id="Dimer.rotate"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.rotate">[docs]</a>    <span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotate dimer by angle in plane defined by vectors N and theta</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># calculate new N  and theta vectors</span>
<span class="c1">#        self.N = Vectors.normalise(Vectors.addVectors(Vectors.scaleVector(N, math.cos(angle)), Vectors.scaleVector(theta, math.sin(angle))))</span>
<span class="c1">#        theta = Vectors.normalise(Vectors.subtractVectors(Vectors.scaleVector(theta, math.cos(angle)), Vectors.scaleVector(N, math.sin(angle))))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">addVectors</span><span class="p">(</span><span class="n">Vectors</span><span class="o">.</span><span class="n">scaleVector</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)),</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">scaleVector</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)))</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">subtractVectors</span><span class="p">(</span><span class="n">Vectors</span><span class="o">.</span><span class="n">scaleVector</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)),</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">scaleVector</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)))</span>

        <span class="c1">#TODO: put this as a C function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltaR</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltaR</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
        
        <span class="k">return</span> <span class="n">theta</span></div>
    
<div class="viewcode-block" id="Dimer.translate"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.translate">[docs]</a>    <span class="k">def</span> <span class="nf">translate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Translate the dimer.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerUseVarStepSize</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcStepSize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">translationDirection</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variableStepSize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerDeltaT</span>
        
        <span class="c1"># new position of mid-point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">addVectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variableStepSize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">translationDirection</span><span class="p">)</span>
        
        <span class="c1"># position of dimer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltaR</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltaR</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
        
        <span class="k">return</span> <span class="mi">0</span></div>
    
    <span class="c1"># return parallel component of force</span>
<div class="viewcode-block" id="Dimer.getForceParallel"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.getForceParallel">[docs]</a>    <span class="k">def</span> <span class="nf">getForceParallel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns array containing parallel component of force</span>
<span class="sd">        with respect to vector N</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">projection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span></div>
    
    <span class="c1"># return perpendicular component of force</span>
<div class="viewcode-block" id="Dimer.getForcePerpendicular"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.getForcePerpendicular">[docs]</a>    <span class="k">def</span> <span class="nf">getForcePerpendicular</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns array containing perpendicular component of force</span>
<span class="sd">        with respect to vector N</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">getForceParallel</span><span class="p">(</span><span class="n">N</span><span class="p">)</span></div>
    
    <span class="c1"># copy dimer centre position to Lattice object</span>
<div class="viewcode-block" id="Dimer.convertToLattice"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.convertToLattice">[docs]</a>    <span class="k">def</span> <span class="nf">convertToLattice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a lattice object from the centre point of the dimer</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">lattice</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">Lattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">)</span>
        
        <span class="n">lattice</span><span class="o">.</span><span class="n">saddleSearchStepCount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepCount</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">saddleSearchFEvalCount</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">totWholeFEvals</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">totExclFEvals</span><span class="p">)</span>
        
        <span class="n">lattice</span><span class="o">.</span><span class="n">specie</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specie</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saddleImageNo</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">lattice</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">lattice</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">force</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">saddleImageNo</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">lattice</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">lattice</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">force</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lattice</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">lattice</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">)</span>
        
        <span class="n">lattice</span><span class="o">.</span><span class="n">specieList</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieList</span><span class="p">)</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">specieMassAMU</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieMassAMU</span><span class="p">)</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">specieCount</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieCount</span><span class="p">)</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">cellDims</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">specieMass</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieMass</span><span class="p">)</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">specieRGB</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieRGB</span><span class="p">)</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">specieCovalentRadius</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieCovalentRadius</span><span class="p">)</span>
        
        <span class="n">lattice</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">)</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">currentDefectVolume</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentDefectVolume</span><span class="p">)</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">defectVolumes</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">defectVolumesKeys</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">)</span>
        
        <span class="n">lattice</span><span class="o">.</span><span class="n">saddleSearchBackTestSep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testBackSep</span>
                        
        <span class="k">return</span> <span class="n">lattice</span></div>
    
    <span class="c1"># write dimer mid point to file</span>
<div class="viewcode-block" id="Dimer.writeObject"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.writeObject">[docs]</a>    <span class="k">def</span> <span class="nf">writeObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the dimer centre point</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dimerCentre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertToLattice</span><span class="p">()</span>
        <span class="n">dimerCentre</span><span class="o">.</span><span class="n">writeObject</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div>
    
    <span class="c1"># dummy</span>
<div class="viewcode-block" id="Dimer.writeLattice"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.writeLattice">[docs]</a>    <span class="k">def</span> <span class="nf">writeLattice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeObject</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Dimer.stepBackwardsTest"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.stepBackwardsTest">[docs]</a>    <span class="k">def</span> <span class="nf">stepBackwardsTest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initialState</span><span class="p">,</span> <span class="n">saddleState</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs step backwards test in the direction of initial state from the</span>
<span class="sd">        saddle state. Uses searcher&#39;s mechanism to minimise.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">timeStepBack</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                            
        <span class="n">initialBackwards</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">pushSystem</span><span class="p">(</span><span class="n">initialState</span><span class="p">,</span> <span class="n">saddleState</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            
<span class="c1">#         initialBackwards.currentSearchInitialVolume = copy.deepcopy(initialState.currentSearchInitialVolume)</span>
        <span class="n">initialBackwards</span><span class="o">.</span><span class="n">currentDefectVolume</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initialState</span><span class="o">.</span><span class="n">currentDefectVolume</span><span class="p">)</span>
        <span class="n">initialBackwards</span><span class="o">.</span><span class="n">defectSubSystemFull</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initialState</span><span class="o">.</span><span class="n">defectSubSystemFull</span><span class="p">)</span>
        <span class="n">initialBackwards</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initialState</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">)</span>
        <span class="n">initialBackwards</span><span class="o">.</span><span class="n">defectSubSystemSmall</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initialState</span><span class="o">.</span><span class="n">defectSubSystemSmall</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalMinimiser</span><span class="o">.</span><span class="n">setJobID</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalMinimiser</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">initialBackwards</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">status</span><span class="p">:</span>                 
            <span class="bp">self</span><span class="o">.</span><span class="n">testBackSep</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">testBackTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">timeStepBack</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">testBackSuccess</span> <span class="o">=</span> <span class="mi">0</span>
                                
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">testBackSep</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">initialState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">initialBackwards</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">initialState</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>       
            <span class="bp">self</span><span class="o">.</span><span class="n">testBackTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">timeStepBack</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">testBackSuccess</span> <span class="o">=</span> <span class="mi">1</span></div>
    
<div class="viewcode-block" id="Dimer.prepare4Convergence"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.prepare4Convergence">[docs]</a>    <span class="k">def</span> <span class="nf">prepare4Convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lanczosSaddle</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares rVector and index lists.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lanczosSaddle</span><span class="o">.</span><span class="n">force</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">saddleConvergeRadius</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">mainIndexes</span> <span class="o">=</span> <span class="n">lanczosSaddle</span><span class="o">.</span><span class="n">buildSubLattice</span><span class="p">(</span><span class="n">lanczosSaddle</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">saddleConvergeRadius</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mainIndexes</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">lanczosSaddle</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">)</span>
                    
        <span class="n">includeAtoms</span> <span class="o">=</span> <span class="n">lanczosSaddle</span><span class="o">.</span><span class="n">buildSubLattice</span><span class="p">(</span><span class="n">mainIndexes</span><span class="p">,</span> <span class="n">Globals</span><span class="o">.</span><span class="n">subLatticeIncludeRadius</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">totalEnergy</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">totalEnergy</span><span class="p">:</span>
            <span class="n">rVector</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separationVectorSubSystem</span><span class="p">(</span><span class="n">lanczosSaddle</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">mainIndexes</span><span class="p">,</span> <span class="n">lanczosSaddle</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rVector</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separationVectorSubSystem</span><span class="p">(</span><span class="n">lanczosSaddle</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">mainIndexes</span><span class="p">,</span> <span class="n">lanczosSaddle</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    
        <span class="n">lanczosSaddle</span><span class="o">.</span><span class="n">rVector</span> <span class="o">=</span> <span class="n">rVector</span>
        <span class="n">lanczosSaddle</span><span class="o">.</span><span class="n">mainIndexes</span> <span class="o">=</span> <span class="n">mainIndexes</span>
        <span class="n">lanczosSaddle</span><span class="o">.</span><span class="n">includeAtoms</span> <span class="o">=</span> <span class="n">includeAtoms</span>
        
        <span class="k">return</span> <span class="n">lanczosSaddle</span></div>
    
<div class="viewcode-block" id="Dimer.run"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputState</span><span class="p">,</span> <span class="n">fixSearchObj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the dimer method.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">timeDimer</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runDimerWithTiming</span><span class="p">(</span><span class="n">inputState</span><span class="p">,</span> <span class="n">fixSearchObj</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runDimerWithoutTiming</span><span class="p">(</span><span class="n">inputState</span><span class="p">,</span> <span class="n">fixSearchObj</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span></div>
    
    <span class="nd">@Timer</span><span class="o">.</span><span class="n">timerProfile</span>
<div class="viewcode-block" id="Dimer.runDimerWithTiming"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.runDimerWithTiming">[docs]</a>    <span class="k">def</span> <span class="nf">runDimerWithTiming</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputState</span><span class="p">,</span> <span class="n">fixSearchObj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run dimer with timing.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runMain</span><span class="p">(</span><span class="n">inputState</span><span class="p">,</span> <span class="n">fixSearchObj</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span></div>
    
<div class="viewcode-block" id="Dimer.runDimerWithoutTiming"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.runDimerWithoutTiming">[docs]</a>    <span class="k">def</span> <span class="nf">runDimerWithoutTiming</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputState</span><span class="p">,</span> <span class="n">fixSearchObj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run dimer without timing.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runMain</span><span class="p">(</span><span class="n">inputState</span><span class="p">,</span> <span class="n">fixSearchObj</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span></div>
    
<div class="viewcode-block" id="Dimer.createListsForImages"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.createListsForImages">[docs]</a>    <span class="k">def</span> <span class="nf">createListsForImages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copies defectSubSystem from the main object to the images. Creates</span>
<span class="sd">        includeAtoms list.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defectSubSystem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">mainIndexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">defectSubSystem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">includeAtoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">buildSubLattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">,</span> 
            <span class="n">Globals</span><span class="o">.</span><span class="n">subLatticeIncludeRadius</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defectSubSystem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">mainIndexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">defectSubSystem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">includeAtoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">buildSubLattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">,</span> 
            <span class="n">Globals</span><span class="o">.</span><span class="n">subLatticeIncludeRadius</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Dimer.loadRerunFiles"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.loadRerunFiles">[docs]</a>    <span class="k">def</span> <span class="nf">loadRerunFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputState</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load N and displacementVector from files</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;dimer.input&quot;</span><span class="p">,</span> <span class="s2">&quot;rerun_N.dat&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Loading dimer rerun file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">,),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            
            <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">rerun_N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rerun_N</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="k">assert</span> <span class="n">count</span> <span class="o">==</span> <span class="n">num</span>
        
        <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;dimer.input&quot;</span><span class="p">,</span> <span class="s2">&quot;rerun_displacementVector.dat&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Loading dimer rerun file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">,),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            
            <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            
            <span class="n">inputState</span><span class="o">.</span><span class="n">displacementVector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">inputState</span><span class="o">.</span><span class="n">displacementVector</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="k">assert</span> <span class="n">count</span> <span class="o">==</span> <span class="n">num</span></div>
    
<div class="viewcode-block" id="Dimer.runMain"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.Dimer.runMain">[docs]</a>    <span class="k">def</span> <span class="nf">runMain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputStateIni</span><span class="p">,</span> <span class="n">fixSearchObj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main run method (not called directly).</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inputState</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">inputStateIni</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">failReason</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">debugInfo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rerun_N</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Running Dimer method&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>   
        
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;dimer.output&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -f dimer.output/*&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">inputState</span><span class="o">.</span><span class="n">NDefects</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;WARNING: no defects in lattice. Returning.&quot;</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Dimer: no defects in lattice&quot;</span>
        
        <span class="c1"># default dimer initial step size</span>
        <span class="n">initialStep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerInitialOffset</span>
        
        <span class="c1"># are we fixing the initial displacement?</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fixSearchObj</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Utilities</span><span class="o">.</span><span class="n">TransitionFix</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Fixing search&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rerun_N</span> <span class="o">=</span> <span class="n">fixSearchObj</span><span class="o">.</span><span class="n">NVector</span>
            <span class="n">inputState</span><span class="o">.</span><span class="n">displacementVector</span> <span class="o">=</span> <span class="n">fixSearchObj</span><span class="o">.</span><span class="n">displacementVector</span>
            <span class="n">initialStep</span> <span class="o">=</span> <span class="n">fixSearchObj</span><span class="o">.</span><span class="n">stepSize</span>
        
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;dimer.input&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loadRerunFiles</span><span class="p">(</span><span class="n">inputState</span><span class="p">)</span>
        
        <span class="c1"># initial displacment</span>
        <span class="n">inputState</span><span class="o">.</span><span class="n">initiateDefectDisplacement</span><span class="p">(</span><span class="n">initialStep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        
        <span class="c1"># do a few steps on a smaller volume before switching to normal</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerSmallSearchSteps</span><span class="p">:</span>
            <span class="n">inputState</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="n">inputState</span><span class="o">.</span><span class="n">defectSubSystemSmall</span>
            <span class="n">inputState</span><span class="o">.</span><span class="n">NSubSystem</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputState</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">)</span>

        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setupDimer</span><span class="p">(</span><span class="n">inputState</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;DIMFAILREASON&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">failReason</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">failReason</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">displacementVector</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">inputState</span><span class="o">.</span><span class="n">displacementVector</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="n">inputState</span><span class="o">.</span><span class="n">defectSubSystem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createListsForImages</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rerun_N</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rerun_N</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">Defects</span><span class="o">.</span><span class="n">randomVectorSubSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
                        
        <span class="bp">self</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">pos</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltaR</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">pos</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltaR</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
                
        <span class="c1"># calculate forces and store energyOrig</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcForce</span><span class="p">(</span><span class="n">correctTE</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failReason</span> <span class="o">=</span> <span class="s2">&quot;Dimer: initial force calculation failed&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saddleFoundFail</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">failReason</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">energyOrig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalEnergy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saddleFoundFail</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">stepCount</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">while</span> <span class="p">((</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">saddleFound</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">saddleFoundFail</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">doLanczos</span><span class="p">)):</span>

            <span class="c1"># rotational min</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stepType</span> <span class="o">=</span> <span class="s2">&quot;rotation&quot;</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotationalMinimiser</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">failReason</span> <span class="o">=</span> <span class="s2">&quot;Dimer: rotational minimiser failed&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">saddleFoundFail</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">break</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">NRotationMins</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="c1"># translation step</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stepType</span> <span class="o">=</span> <span class="s2">&quot;translation&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">translator</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                                                
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepCount</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerSmallSearchSteps</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="n">inputState</span><span class="o">.</span><span class="n">defectSubSystemFull</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">createListsForImages</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepCount</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ClientServerInterface</span><span class="o">.</span><span class="n">checkJobStatus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        
        <span class="c1"># if dimer finished before small search steps make sub system full</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepCount</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerSmallSearchSteps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="n">inputState</span><span class="o">.</span><span class="n">defectSubSystemFull</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createListsForImages</span><span class="p">()</span>
        
        <span class="c1"># saddle point</span>
        <span class="n">resultString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doLanczos</span><span class="p">:</span>
            <span class="c1"># convert Dimer to Lattice</span>
            <span class="n">saddle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertToLattice</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">returnSaddleBeforeLanczos</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">saddle</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            
            <span class="c1"># check barrier height before Lanczos</span>
            <span class="n">saddle</span><span class="o">.</span><span class="n">calcForce</span><span class="p">(</span><span class="n">correctTE</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">prebarr</span> <span class="o">=</span> <span class="n">saddle</span><span class="o">.</span><span class="n">totalEnergy</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialEnergy</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Barrier before Lanczos is </span><span class="si">%f</span><span class="s2"> eV&quot;</span> <span class="o">%</span> <span class="n">prebarr</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">prebarr</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerMaxBarrier</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Failed due to barrier height before Lanczos (</span><span class="si">%f</span><span class="s2"> &gt; </span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prebarr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerMaxBarrier</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">saddle</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">saddleFoundFail</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">failReason</span> <span class="o">=</span> <span class="s2">&quot;Dimer: Failed due to barrier height before Lanczos&quot;</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resultString</span> <span class="o">=</span> <span class="s2">&quot; (Lanczos) &quot;</span>
                <span class="n">saddle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converge2Saddle</span><span class="p">(</span><span class="n">saddle</span><span class="p">,</span> <span class="n">inputStateIni</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">saddle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertToLattice</span><span class="p">()</span>
        
        <span class="c1"># Checking the rank of the saddle point (moved to Search.py)</span>
<span class="c1">#         if self.doLanczos and self.saddleFound and not self.saddleFoundFail and not self.params.fixedPrefactor:</span>
<span class="c1">#             rankStatus, saddle = MinModeFollower.checkSaddleRank(self.params, saddle, self.params.dimerConv2Rank1Saddle)</span>
<span class="c1">#             </span>
<span class="c1">#             if rankStatus:</span>
<span class="c1">#                 self.saddleFound = 0</span>
<span class="c1">#             else:</span>
<span class="c1">#                 self.saddleFound = 1</span>
        
        <span class="c1"># Checking the barrier height</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saddleFound</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">saddleFoundFail</span><span class="p">:</span>
            <span class="n">saddle</span><span class="o">.</span><span class="n">calcForce</span><span class="p">(</span><span class="n">correctTE</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">barrier</span> <span class="o">=</span> <span class="n">saddle</span><span class="o">.</span><span class="n">totalEnergy</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialEnergy</span>
            
            <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">finalMaxMove</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">finalSep</span><span class="p">)</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">maxMovement</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialPos</span><span class="p">,</span> <span class="n">saddle</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">barrier</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerMaxBarrier</span> <span class="ow">or</span> <span class="n">barrier</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerMinBarrier</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Failed due to the barrier. Barrier = </span><span class="si">%f</span><span class="s2">; separation is </span><span class="si">%f</span><span class="s2">; max move is </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">barrier</span><span class="p">,</span> <span class="n">finalSep</span><span class="p">,</span> <span class="n">finalMaxMove</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">failReason</span> <span class="o">=</span> <span class="s2">&quot;Dimer: Failed due to the barrier&quot;</span>
                <span class="n">saddle</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">barrier</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">saddleFound</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Failed&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">saddle</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">barrier</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saddleFound</span> <span class="o">=</span> <span class="mi">0</span>
            
        <span class="c1"># Test Backwards</span>
        <span class="n">testBackString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saddleFound</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">saddleFoundFail</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerDoStepBackTest</span> <span class="ow">and</span> <span class="n">barrier</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerStepBackBarrCriteria</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stepBackwardsTest</span><span class="p">(</span><span class="n">inputStateIni</span><span class="p">,</span> <span class="n">saddle</span><span class="p">)</span>
                
                <span class="n">testBackString</span> <span class="o">=</span> <span class="s2">&quot; Test backwards (</span><span class="si">%f</span><span class="s2"> s.) = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testBackTime</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">testBackSep</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">testBackSuccess</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Failed (Step backwards could not converge). Barrier = </span><span class="si">%f</span><span class="s2">;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">barrier</span><span class="p">,</span> <span class="n">testBackString</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">failReason</span> <span class="o">=</span> <span class="s2">&quot;Dimer: step back test could not converge&quot;</span>
                    <span class="n">saddle</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">barrier</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">saddleFound</span> <span class="o">=</span> <span class="mi">0</span>
                    
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">testBackSep</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimerStepBackCheckTol</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Failed (Step backwards). Barrier = </span><span class="si">%f</span><span class="s2">;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">barrier</span><span class="p">,</span> <span class="n">testBackString</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">failReason</span> <span class="o">=</span> <span class="s2">&quot;Dimer: step back test failed&quot;</span>
                    <span class="n">saddle</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">barrier</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">saddleFound</span> <span class="o">=</span> <span class="mi">0</span>
                
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saddleFound</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">saddleFoundFail</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Success</span><span class="si">%s</span><span class="s2">: Barrier = </span><span class="si">%f</span><span class="s2">; separation is </span><span class="si">%f</span><span class="s2">; max move is </span><span class="si">%f</span><span class="s2">; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resultString</span><span class="p">,</span> <span class="n">barrier</span><span class="p">,</span> <span class="n">finalSep</span><span class="p">,</span> <span class="n">finalMaxMove</span><span class="p">,</span> <span class="n">testBackString</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">debugDimer</span><span class="p">:</span>
            <span class="n">dimerBarrier</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">elapsedTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span>
            
            <span class="k">if</span> <span class="n">saddle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dimerBarrier</span> <span class="o">=</span> <span class="n">barrier</span>                
            
            <span class="n">debugInfo</span> <span class="o">=</span> <span class="n">Utilities</span><span class="o">.</span><span class="n">SaddleSearchDebugInfo</span><span class="p">(</span><span class="s2">&quot;DIMER&quot;</span><span class="p">,</span> <span class="n">dimerBarrier</span><span class="p">,</span> 
                                                        <span class="n">elapsedTime</span><span class="p">,</span> <span class="n">searchSteps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stepCount</span><span class="p">,</span> 
                                                        <span class="n">dimerRotWholeFEvals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rotWholeFEvals</span><span class="p">,</span> 
                                                        <span class="n">dimerRotExclFEvals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rotExclFEvals</span><span class="p">,</span>
                                                        <span class="n">dimerTransWholeFEvals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transWholeFEvals</span><span class="p">,</span> 
                                                        <span class="n">dimerTransExclFEvals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transExclFEvals</span><span class="p">,</span>
                                                        <span class="n">minExclTime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">minExclTime</span><span class="p">,</span> <span class="n">minWholeTime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">minWholeTime</span><span class="p">,</span>
                                                        <span class="n">minExclFEvalsSteps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">minExclFEvalsSteps</span><span class="p">,</span> 
                                                        <span class="n">minExclSubFEvals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">minExclSubFEvals</span><span class="p">,</span> 
                                                        <span class="n">minWholeFEvalsSteps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">minWholeFEvalsSteps</span><span class="p">,</span> 
                                                        <span class="n">minWholeSubFEvals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">minWholeSubFEvals</span><span class="p">)</span>
        <span class="n">dimerTimingDict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;DIMER step count&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepCount</span><span class="p">,</span>
            <span class="s2">&quot;DIMER total force calls&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">transWholeFEvals</span><span class="p">,</span>
        <span class="p">}</span>   
        
        <span class="k">return</span> <span class="n">saddle</span><span class="p">,</span> <span class="n">barrier</span><span class="p">,</span> <span class="n">debugInfo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">failReason</span><span class="p">,</span> <span class="n">dimerTimingDict</span></div></div>
        
    
<span class="c1">################################################################################</span>

<div class="viewcode-block" id="getDimerTranslator"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.getDimerTranslator">[docs]</a><span class="k">def</span> <span class="nf">getDimerTranslator</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return selected translator.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerTranslator</span>
    
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;quickmin&quot;</span><span class="p">:</span>
        <span class="n">translator</span> <span class="o">=</span> <span class="n">QuickMinDimerTranslator</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;ERROR: unknown dimer translator: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span>
    
    <span class="k">return</span> <span class="n">translator</span></div>

<span class="c1">################################################################################</span>
<div class="viewcode-block" id="QuickMinDimerTranslator"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.QuickMinDimerTranslator">[docs]</a><span class="k">class</span> <span class="nc">QuickMinDimerTranslator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dimer quickmin translator.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobID</span> <span class="o">=</span> <span class="kc">None</span>
        
<div class="viewcode-block" id="QuickMinDimerTranslator.setJobID"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.QuickMinDimerTranslator.setJobID">[docs]</a>    <span class="k">def</span> <span class="nf">setJobID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">jobID</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobID</span> <span class="o">=</span> <span class="n">jobID</span></div>
    
<div class="viewcode-block" id="QuickMinDimerTranslator.checkIfContinue"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.QuickMinDimerTranslator.checkIfContinue">[docs]</a>    <span class="k">def</span> <span class="nf">checkIfContinue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimer</span><span class="p">):</span>
        
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        
        <span class="p">(</span><span class="n">maxMoveIndex</span><span class="p">,</span> <span class="n">maxMove</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">maxMovement</span><span class="p">(</span><span class="n">dimer</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">dimer</span><span class="o">.</span><span class="n">initialPos</span><span class="p">,</span> <span class="n">dimer</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">Globals</span><span class="o">.</span><span class="n">useSubLatticeForceCalc</span><span class="p">:</span>
            <span class="n">string</span><span class="o">=</span><span class="s2">&quot;(SUBLATTICE)&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                
        <span class="c1">#og(__name__, &quot;STEP %d: Stepsize: %lf; curvature: %lf; finalBarrier%s: %lf; maxMove: %lf.; RotForce: %lf; FEvalRot: %d/%d; FEvalTrans: %d/%d&quot; % (dimer.stepCount, dimer.variableStepSize, dimer.curvature, string, dimer.finalBarrier, maxMove, dimer.magRotF, dimer.rotExclFEvals, dimer.rotWholeFEvals, dimer.transExclFEvals, dimer.transWholeFEvals), 2, 1)</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;STEP </span><span class="si">%d</span><span class="s2">: Stepsize: </span><span class="si">%lf</span><span class="s2">; curvature: </span><span class="si">%lf</span><span class="s2">; fmaxMove: </span><span class="si">%lf</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dimer</span><span class="o">.</span><span class="n">stepCount</span><span class="p">,</span> <span class="n">dimer</span><span class="o">.</span><span class="n">variableStepSize</span><span class="p">,</span> <span class="n">dimer</span><span class="o">.</span><span class="n">curvature</span><span class="p">,</span> <span class="n">maxMove</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
           
        <span class="c1"># check for saddle found</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">maxMove</span> <span class="o">&gt;</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerMaxMoveDistance</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="n">dimer</span><span class="o">.</span><span class="n">totWholeFEvals</span> <span class="o">+</span> <span class="n">dimer</span><span class="o">.</span><span class="n">totExclFEvals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerMaxFuncEval</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">dimer</span><span class="o">.</span><span class="n">finalBarrier</span> <span class="o">&gt;</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerMaxBarrier</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">dimer</span><span class="o">.</span><span class="n">stepCount</span> <span class="o">&gt;</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerMaxSteps</span><span class="p">)):</span>
            
            <span class="k">if</span> <span class="n">maxMove</span> <span class="o">&gt;</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerMaxMoveDistance</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;Max move distance (</span><span class="si">%f</span><span class="s2"> &gt; </span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maxMove</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerMaxMoveDistance</span><span class="p">)</span>
                
            <span class="k">elif</span> <span class="p">(</span><span class="n">dimer</span><span class="o">.</span><span class="n">totWholeFEvals</span> <span class="o">+</span> <span class="n">dimer</span><span class="o">.</span><span class="n">totExclFEvals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerMaxFuncEval</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;Number of total FEvals (</span><span class="si">%f</span><span class="s2"> &gt; </span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dimer</span><span class="o">.</span><span class="n">totWholeFEvals</span> <span class="o">+</span> <span class="n">dimer</span><span class="o">.</span><span class="n">totExclFEvals</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerMaxFuncEval</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">dimer</span><span class="o">.</span><span class="n">finalBarrier</span> <span class="o">&gt;</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerMaxBarrier</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;Barrier height (</span><span class="si">%f</span><span class="s2"> &gt; </span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dimer</span><span class="o">.</span><span class="n">finalBarrier</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerMaxBarrier</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">dimer</span><span class="o">.</span><span class="n">stepCount</span> <span class="o">&gt;</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerMaxSteps</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;Step count (</span><span class="si">%f</span><span class="s2"> &gt; </span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dimer</span><span class="o">.</span><span class="n">stepCount</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerMaxSteps</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;Unspecified&quot;</span>
            
            <span class="c1"># dimer fail reason</span>
            <span class="n">dimer</span><span class="o">.</span><span class="n">failReason</span> <span class="o">=</span> <span class="s2">&quot;Dimer: &quot;</span> <span class="o">+</span> <span class="n">reason</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Quitting saddle point search! Barrier </span><span class="si">%f</span><span class="s2"> Steps: </span><span class="si">%d</span><span class="s2"> MaxMove </span><span class="si">%f</span><span class="s2"> FuncEval </span><span class="si">%d</span><span class="s2">. (Due to </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dimer</span><span class="o">.</span><span class="n">finalBarrier</span><span class="p">,</span> <span class="n">dimer</span><span class="o">.</span><span class="n">NRotationMins</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxMove</span><span class="p">,</span> <span class="p">(</span><span class="n">dimer</span><span class="o">.</span><span class="n">totWholeFEvals</span> <span class="o">+</span> <span class="n">dimer</span><span class="o">.</span><span class="n">totExclFEvals</span><span class="p">),</span> <span class="n">reason</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dimer</span><span class="o">.</span><span class="n">saddleFoundFail</span> <span class="o">=</span> <span class="mi">1</span>
    
        <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerUseLanczos</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dimer</span><span class="o">.</span><span class="n">dispDotP1Force</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">dimer</span><span class="o">.</span><span class="n">dispDotP2Force</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">and</span> 
              <span class="p">(</span><span class="n">maxMove</span> <span class="o">&gt;</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerMaxMoveCriteria</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dimer</span><span class="o">.</span><span class="n">finalBarrier</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                
            <span class="k">if</span> <span class="n">dimer</span><span class="o">.</span><span class="n">dispDotP1Force</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">dimer</span><span class="o">.</span><span class="n">saddleImageNo</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dimer</span><span class="o">.</span><span class="n">saddleImageNo</span> <span class="o">=</span> <span class="mi">2</span>
                
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;FOUND SADDLE. Barrier: </span><span class="si">%f</span><span class="s2"> Steps: </span><span class="si">%d</span><span class="s2"> MaxMove </span><span class="si">%f</span><span class="s2"> FuncEval </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dimer</span><span class="o">.</span><span class="n">finalBarrier</span><span class="p">,</span><span class="n">dimer</span><span class="o">.</span><span class="n">NRotationMins</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxMove</span><span class="p">,</span> <span class="p">(</span><span class="n">dimer</span><span class="o">.</span><span class="n">totWholeFEvals</span> <span class="o">+</span> <span class="n">dimer</span><span class="o">.</span><span class="n">totExclFEvals</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dimer</span><span class="o">.</span><span class="n">saddleFound</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">dimer</span><span class="o">.</span><span class="n">barrier</span> <span class="o">=</span> <span class="n">dimer</span><span class="o">.</span><span class="n">finalBarrier</span>
                
            <span class="c1"># saving max move atom index for final push over the saddle point</span>
            <span class="n">dimer</span><span class="o">.</span><span class="n">maxMoveAtom</span> <span class="o">=</span> <span class="n">maxMoveIndex</span>
            
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerUseLanczos</span> <span class="ow">and</span> <span class="n">dimer</span><span class="o">.</span><span class="n">stepCount</span> <span class="o">&gt;</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerMinStepBeforeLanczos</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerLookForNegEigenValue</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dimer</span><span class="o">.</span><span class="n">curvature</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerNegCurv</span><span class="p">:</span>
                    <span class="n">tempLattice</span> <span class="o">=</span> <span class="n">dimer</span><span class="o">.</span><span class="n">convertToLattice</span><span class="p">()</span>
                    
                    <span class="n">le_mainIndexes</span> <span class="o">=</span> <span class="n">dimer</span><span class="o">.</span><span class="n">defectSubSystem</span>
                    <span class="n">le_includeAtoms</span> <span class="o">=</span> <span class="n">tempLattice</span><span class="o">.</span><span class="n">buildSubLattice</span><span class="p">(</span><span class="n">le_mainIndexes</span><span class="p">,</span> <span class="n">Globals</span><span class="o">.</span><span class="n">subLatticeIncludeRadius</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">dimer</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">totalEnergy</span> <span class="o">&gt;</span> <span class="n">dimer</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">totalEnergy</span><span class="p">:</span>
                        <span class="n">le_rVector</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separationVectorSubSystem</span><span class="p">(</span><span class="n">tempLattice</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> 
                            <span class="n">dimer</span><span class="o">.</span><span class="n">P1</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">le_mainIndexes</span><span class="p">,</span> <span class="n">tempLattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">le_rVector</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separationVectorSubSystem</span><span class="p">(</span><span class="n">tempLattice</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">dimer</span><span class="o">.</span><span class="n">P2</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">le_mainIndexes</span><span class="p">,</span> 
                                                                       <span class="n">tempLattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    
                    <span class="n">_</span><span class="p">,</span> <span class="n">le_lle</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">iterCnt</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Lanczos</span><span class="o">.</span><span class="n">lanczosMethodForASystem</span><span class="p">(</span><span class="n">tempLattice</span><span class="p">,</span> <span class="n">le_mainIndexes</span><span class="p">,</span> 
                                                                                     <span class="n">le_rVector</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">normEigenVec</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                                                                     <span class="n">includeAtoms</span><span class="o">=</span><span class="n">le_includeAtoms</span><span class="p">,</span> <span class="n">returnMode</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">jobID</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">)</span>
                    
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Calculated lowest eigenvalue: </span><span class="si">%f</span><span class="s2"> (</span><span class="si">%d</span><span class="s2"> iterations)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">le_lle</span><span class="p">,</span> <span class="n">iterCnt</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">le_lle</span> <span class="o">&lt;=</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerMaxNegEigenValue</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">dimer</span><span class="o">.</span><span class="n">found1stNegCurv</span><span class="p">:</span>
                            <span class="n">dimer</span><span class="o">.</span><span class="n">found2ndNegCurv</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">dimer</span><span class="o">.</span><span class="n">n_neg_curvs</span> <span class="o">+=</span> <span class="mi">1</span>
                        
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">dimer</span><span class="o">.</span><span class="n">found1stNegCurv</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">dimer</span><span class="o">.</span><span class="n">n_neg_curvs</span> <span class="o">=</span> <span class="mi">1</span>
                        
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Negative eigenvalue region has been reached. LE = </span><span class="si">%f</span><span class="s2"> (</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> in a row)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">le_lle</span><span class="p">,</span> <span class="n">dimer</span><span class="o">.</span><span class="n">n_neg_curvs</span><span class="p">,</span> 
                                                                                                                 <span class="n">params</span><span class="o">.</span><span class="n">dimerNumStepsNegBeforeLanczos</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dimer</span><span class="o">.</span><span class="n">found1stNegCurv</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">dimer</span><span class="o">.</span><span class="n">found2ndNegCurv</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                        <span class="n">dimer</span><span class="o">.</span><span class="n">found1stNegCurv</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">dimer</span><span class="o">.</span><span class="n">found2ndNegCurv</span> <span class="o">=</span> <span class="mi">0</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dimer</span><span class="o">.</span><span class="n">curvature</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerNegCurv</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dimer</span><span class="o">.</span><span class="n">found1stNegCurv</span><span class="p">:</span>
                        <span class="n">dimer</span><span class="o">.</span><span class="n">found2ndNegCurv</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Negative curvature region has been reached&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dimer</span><span class="o">.</span><span class="n">found1stNegCurv</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dimer</span><span class="o">.</span><span class="n">found1stNegCurv</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">dimer</span><span class="o">.</span><span class="n">found2ndNegCurv</span> <span class="o">=</span> <span class="mi">0</span>
                    
            <span class="k">if</span> <span class="n">dimer</span><span class="o">.</span><span class="n">found2ndNegCurv</span> <span class="ow">and</span> <span class="n">dimer</span><span class="o">.</span><span class="n">n_neg_curvs</span> <span class="o">&gt;=</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerNumStepsNegBeforeLanczos</span><span class="p">:</span>
                <span class="n">dimer</span><span class="o">.</span><span class="n">doLanczos</span> <span class="o">=</span> <span class="mi">1</span></div>
    
<div class="viewcode-block" id="QuickMinDimerTranslator.run"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.QuickMinDimerTranslator.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run dimer translator.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failReason</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

        <span class="n">translate</span> <span class="o">=</span> <span class="mi">1</span>
    
        <span class="k">while</span> <span class="n">translate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dimer</span><span class="o">.</span><span class="n">saddleFound</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dimer</span><span class="o">.</span><span class="n">saddleFoundFail</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dimer</span><span class="o">.</span><span class="n">doLanczos</span><span class="p">:</span> <span class="c1"># and don&#39;t need a rotational step!?</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;dimer.output&quot;</span><span class="p">):</span>
                <span class="n">dimer</span><span class="o">.</span><span class="n">writeLattice</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;dimer.output&quot;</span><span class="p">,</span> <span class="s2">&quot;dimer</span><span class="si">%d</span><span class="s2">.dat&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dimer</span><span class="o">.</span><span class="n">stepCount</span><span class="p">,)))</span>
            
            <span class="n">dimer</span><span class="o">.</span><span class="n">stepCount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">dimer</span><span class="o">.</span><span class="n">stepCount</span> <span class="o">%</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerCheckStatusStep</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ClientServerInterface</span><span class="o">.</span><span class="n">checkJobStatus</span><span class="p">(</span><span class="n">dimer</span><span class="o">.</span><span class="n">jobID</span><span class="p">):</span>
                    <span class="k">break</span>
            
            <span class="n">status</span> <span class="o">=</span> <span class="n">dimer</span><span class="o">.</span><span class="n">calcForce</span><span class="p">(</span><span class="n">defectFlag</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                <span class="n">dimer</span><span class="o">.</span><span class="n">failReason</span> <span class="o">=</span> <span class="s2">&quot;Dimer: Quick min translator calc force failed&quot;</span>
                <span class="n">dimer</span><span class="o">.</span><span class="n">saddleFoundFail</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">return</span>
            
            <span class="k">if</span> <span class="n">Globals</span><span class="o">.</span><span class="n">taskStatus</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Globals</span><span class="o">.</span><span class="n">taskStatus</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                    <span class="n">dimer</span><span class="o">.</span><span class="n">saddleFoundFail</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">break</span>
                             
            <span class="n">status</span> <span class="o">=</span> <span class="n">dimer</span><span class="o">.</span><span class="n">translate</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                <span class="n">dimer</span><span class="o">.</span><span class="n">failReason</span> <span class="o">=</span> <span class="s2">&quot;Dimer: translate failed&quot;</span>
                <span class="n">dimer</span><span class="o">.</span><span class="n">saddleFoundFail</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">return</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Globals</span><span class="o">.</span><span class="n">useSubLatticeForceCalc</span><span class="p">:</span>
                <span class="n">dimer</span><span class="o">.</span><span class="n">finalBarrier</span> <span class="o">=</span> <span class="n">dimer</span><span class="o">.</span><span class="n">totalEnergy</span> <span class="o">-</span> <span class="n">dimer</span><span class="o">.</span><span class="n">energyOrig</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">dimer</span><span class="o">.</span><span class="n">magRotF</span> <span class="o">&gt;</span> <span class="n">params</span><span class="o">.</span><span class="n">dimerTolR</span><span class="p">):</span>
                <span class="n">translate</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">translate</span> <span class="o">=</span> <span class="mi">1</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">checkIfContinue</span><span class="p">(</span><span class="n">dimer</span><span class="p">)</span></div></div>

<span class="c1">################################################################################</span>
<div class="viewcode-block" id="commandLineArgs"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.commandLineArgs">[docs]</a><span class="k">def</span> <span class="nf">commandLineArgs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse command line arguments</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">argparse</span>
    
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the Dimer method.&quot;</span><span class="p">)</span>
    
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;inputFile&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The input lattice file.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;refFile&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The reference lattice file.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;paramFile&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;lkmcInput.IN&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;LKMC input file (default=lkmcInput.IN)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-P&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;profileCode&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Profile the code using the hotshot module (not for production) (default=False)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;statsFile&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;profile.dat&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;File for dumping profiling stats to (default=None)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-V&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;visPerform&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Visualise the profiling of the code&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span></div>


<span class="c1">################################################################################</span>
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    
    <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tryX</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="c1"># get command line args</span>
    <span class="n">progargs</span> <span class="o">=</span> <span class="n">commandLineArgs</span><span class="p">()</span>
    
    <span class="c1"># read parameters</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">Input</span><span class="o">.</span><span class="n">getLKMCParams</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">progargs</span><span class="o">.</span><span class="n">paramFile</span><span class="p">)</span>
    <span class="n">Input</span><span class="o">.</span><span class="n">readGlobals</span><span class="p">(</span><span class="n">progargs</span><span class="o">.</span><span class="n">paramFile</span><span class="p">)</span>
    <span class="c1">#params.printInputParameters()</span>
    
    <span class="c1"># read lattices</span>
    <span class="n">inputLattice</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">readLattice</span><span class="p">(</span><span class="n">progargs</span><span class="o">.</span><span class="n">inputFile</span><span class="p">)</span>
    <span class="n">refLattice</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">readLattice</span><span class="p">(</span><span class="n">progargs</span><span class="o">.</span><span class="n">refFile</span><span class="p">)</span>
    
    <span class="c1"># check input lattice is minimised</span>
    <span class="nb">print</span> <span class="s2">&quot;---------- MINIMISING INPUT LATTICE ----------&quot;</span>
    <span class="n">minimiser</span> <span class="o">=</span> <span class="n">Minimise</span><span class="o">.</span><span class="n">getMinimiser</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">minimiser</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">inputLattice</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;MIN FAILED...&quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">46</span><span class="p">)</span>
    
    <span class="c1"># find defects</span>
    <span class="nb">print</span> <span class="s2">&quot;---------- FINDING DEFECTS ----------&quot;</span>
    <span class="n">inputLattice</span><span class="o">.</span><span class="n">findDefects</span><span class="p">(</span><span class="n">refLattice</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    
    <span class="c1"># set current defect volume</span>
    <span class="n">inputLattice</span><span class="o">.</span><span class="n">currentDefectVolume</span> <span class="o">=</span> <span class="n">inputLattice</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">inputLattice</span><span class="o">.</span><span class="n">currentVolumeIndex</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">while</span> <span class="n">tryX</span><span class="p">:</span>
        <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -f Step*.dat&quot;</span><span class="p">)</span>
        
        <span class="n">inputLatticeCpy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">inputLattice</span><span class="p">)</span>
        <span class="c1"># run Dimer</span>
        <span class="nb">print</span> <span class="s2">&quot;---------- RUNNING DIMER ----------&quot;</span>
        <span class="n">dimer</span> <span class="o">=</span> <span class="n">Dimer</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">progargs</span><span class="o">.</span><span class="n">profileCode</span> <span class="ow">or</span> <span class="n">progargs</span><span class="o">.</span><span class="n">visPerform</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">Profiling</span>
            
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">inputLattice</span><span class="p">,)</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">stats</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">Profiling</span><span class="o">.</span><span class="n">profileMethod</span><span class="p">(</span><span class="n">dimer</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">printStats</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">statsFile</span><span class="o">=</span><span class="n">progargs</span><span class="o">.</span><span class="n">statsFile</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">progargs</span><span class="o">.</span><span class="n">visPerform</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;python ~/git/scripts/gprof2dot.py -f pstats </span><span class="si">%s</span><span class="s2"> | dot -Tpng -o output.png&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">progargs</span><span class="o">.</span><span class="n">statsFile</span><span class="p">))</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">progargs</span><span class="o">.</span><span class="n">profileCode</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">progargs</span><span class="o">.</span><span class="n">statsFile</span><span class="p">)</span>
            
            <span class="n">barrier</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="nb">print</span> <span class="n">cnt</span><span class="p">,</span> <span class="s2">&quot;BARRIER&quot;</span><span class="p">,</span> <span class="n">barrier</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">saddle</span><span class="p">,</span> <span class="n">barrier</span><span class="p">,</span> <span class="n">debugInfo</span><span class="p">,</span> <span class="n">failReason</span> <span class="o">=</span> <span class="n">dimer</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">inputLatticeCpy</span><span class="p">)</span>
            <span class="nb">print</span> <span class="n">cnt</span><span class="p">,</span> <span class="s2">&quot;BARRIER&quot;</span><span class="p">,</span> <span class="n">barrier</span>
            
            <span class="k">if</span> <span class="n">saddle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">saddle</span><span class="o">.</span><span class="n">writeLattice</span><span class="p">(</span><span class="s2">&quot;saddle</span><span class="si">%d</span><span class="s2">.dat&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cnt</span><span class="p">))</span>
                
                <span class="kn">from</span> <span class="nn">LKMC</span> <span class="k">import</span> <span class="n">Search</span>
            
                <span class="n">searcher</span> <span class="o">=</span> <span class="n">Search</span><span class="o">.</span><span class="n">TransitionSearcher</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                <span class="n">searcher</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
                
                <span class="n">final</span> <span class="o">=</span> <span class="n">searcher</span><span class="o">.</span><span class="n">stepForwards</span><span class="p">(</span><span class="n">inputLattice</span><span class="p">,</span> <span class="n">saddle</span><span class="p">)</span>
                <span class="n">sep</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">inputLattice</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">final</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">final</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
                
                <span class="nb">print</span> <span class="s2">&quot;Step forward sep = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sep</span><span class="p">)</span>
                
                <span class="n">final</span><span class="o">.</span><span class="n">writeLattice</span><span class="p">(</span><span class="s2">&quot;final</span><span class="si">%d</span><span class="s2">.dat&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cnt</span><span class="p">))</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;FAIL REASON:&quot;</span><span class="p">,</span> <span class="n">failReason</span>
                <span class="nb">print</span> <span class="s2">&quot;STATUS:&quot;</span><span class="p">,</span> <span class="n">status</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">barrier</span> <span class="o">&lt;</span> <span class="mf">5.5</span> <span class="ow">and</span> <span class="n">saddle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">tryX</span> <span class="o">=</span> <span class="mi">0</span></div>

<span class="c1">################################################################################</span>
<div class="viewcode-block" id="DimerTransitionFix"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.DimerTransitionFix">[docs]</a><span class="k">class</span> <span class="nc">DimerTransitionFix</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Object that stores data for fixing Dimer transition search</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">displacementVector</span><span class="p">,</span> <span class="n">NVector</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displacementVector</span> <span class="o">=</span> <span class="n">displacementVector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NVector</span> <span class="o">=</span> <span class="n">NVector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span></div>

<span class="c1">################################################################################</span>
<div class="viewcode-block" id="loadDimerFixFiles"><a class="viewcode-back" href="../../LKMC/LKMC.Dimer.html#LKMC.Dimer.loadDimerFixFiles">[docs]</a><span class="k">def</span> <span class="nf">loadDimerFixFiles</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load dimer fix files</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">OWD</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fixFiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.fix&quot;</span><span class="p">)</span>
        
        <span class="n">volDict</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">fixFiles</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;LOADING FIX FILE: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fn</span>
            
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            
            <span class="n">NSearches</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
            <span class="nb">print</span> <span class="s2">&quot;  NSEARCHES: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">NSearches</span>
            
            <span class="n">transFixList</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">NSearches</span><span class="p">:</span>
                <span class="c1"># displacement vector</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                
                <span class="n">dispVec</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span>
                <span class="n">dispVec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dispVec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                
                <span class="c1"># dimer orientation vector</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                
                <span class="n">NVec</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span>
                <span class="n">NVec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">NVec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                
                <span class="c1"># create object</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">DimerTransitionFix</span><span class="p">(</span><span class="n">dispVec</span><span class="p">,</span> <span class="n">NVec</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
                
                <span class="n">transFixList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="c1"># put in vol dict</span>
            <span class="n">volKey</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">volDict</span><span class="p">[</span><span class="n">volKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">transFixList</span>
    
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">OWD</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">volDict</span></div>






</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">LKMC 150623-1236-g1254817 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, Chris Scott, Tomas Lazauskas, Miao Yu.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.5.
    </div>
  </body>
</html>