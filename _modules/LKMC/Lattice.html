<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>LKMC.Lattice &mdash; LKMC 150623-1236-g1254817 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '150623-1236-g1254817',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="LKMC 150623-1236-g1254817 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">LKMC 150623-1236-g1254817 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for LKMC.Lattice</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains the Lattice class and associated methods.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Atoms</span>
<span class="kn">from</span> <span class="nn">.clibs</span> <span class="k">import</span> <span class="n">graphs</span> <span class="k">as</span> <span class="n">c_graphs</span>
<span class="kn">from</span> <span class="nn">.Utilities</span> <span class="k">import</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Utilities</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Forces</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Defects</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Globals</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Vectors</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Constants</span>
<span class="kn">from</span> <span class="nn">.clibs</span> <span class="k">import</span> <span class="n">io_module</span> <span class="k">as</span> <span class="n">c_io</span>
<span class="kn">from</span> <span class="nn">.clibs</span> <span class="k">import</span> <span class="n">lattice</span> <span class="k">as</span> <span class="n">c_lattice</span>

<span class="c1">################################################################################</span>

<div class="viewcode-block" id="Lattice"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice">[docs]</a><span class="k">class</span> <span class="nc">Lattice</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The `Lattice` class holds information about the state of a system.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    NAtoms : integer</span>
<span class="sd">        The number of atoms to initialise the system with (note this </span>
<span class="sd">        can be set to 0 if you want to add atoms one at a time (eg. </span>
<span class="sd">        using the `Lattice.addAtom` method).</span>
<span class="sd">    storeEnergies : bool, optional</span>
<span class="sd">        Set this to &#39;True&#39; if you want to store potential (``Lattice.PE``)</span>
<span class="sd">        and kinetic (``Lattice.KE``) energies for each atom. If set</span>
<span class="sd">        to &#39;False&#39; this will only store the total energy of the `Lattice`.</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    NAtoms : integer</span>
<span class="sd">        The number of atoms in the system.</span>
<span class="sd">    cellDims : ndarray</span>
<span class="sd">        Dimensions of the simulations cell.</span>
<span class="sd">    specieList : ndarray</span>
<span class="sd">        Array containing two character species symbols found in the the </span>
<span class="sd">        `Lattice`.</span>
<span class="sd">    specieCount : ndarray</span>
<span class="sd">        List of counters indicating the number of atoms of each species</span>
<span class="sd">        (from the `Lattice.specieList`).</span>
<span class="sd">    specie : ndarray</span>
<span class="sd">        Array of integers, indicating the species of each atom in the </span>
<span class="sd">        `Lattice` (i.e. the index of their symbol in the </span>
<span class="sd">        `Lattice.specieList`).</span>
<span class="sd">    pos : ndarray</span>
<span class="sd">        The positions of the atoms in the `Lattice`. Positions are stored </span>
<span class="sd">        like this [xpos_0, ypos_0, zpos_0, xpos_1, ypos_1, ...]. The </span>
<span class="sd">        length of the array is ``3 x NAtoms``.</span>
<span class="sd">    charge : ndarray</span>
<span class="sd">        The charges of the atoms.</span>
<span class="sd">    force : ndarray</span>
<span class="sd">        The forces acting on the atoms. The structure is the same as </span>
<span class="sd">        the `Lattice.pos` array.</span>
<span class="sd">    totalEnergy : float</span>
<span class="sd">        The total energy of the system.</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">NAtoms</span><span class="p">,</span> <span class="n">storeEnergies</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objectid</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">mainIndexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">includeAtoms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">rVector</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rVectorIndexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lanczosEigenVals</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">LBFGSConvTask</span> <span class="o">=</span> <span class="mi">0</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span> <span class="o">=</span> <span class="n">NAtoms</span>
        <span class="c1"># initialise arrays for storing lattice data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specie</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minPos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxPos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">totalEnergy</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxForce</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxForceAtomNo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NMinimisationSteps</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimisationTime</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defectList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defectSubSystemSmall</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defectSubSystemFull</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NDefects</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NSubSystem</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stepType</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">funcEval</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">resetLammps</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="nb">str</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieList</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieCount</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieMass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieMassAMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieCovalentRadius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieRGB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">displacementVector</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displacementNVector</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># defect volumes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NDefectVolumes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumesKeys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentVolumeIndex</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">volumeGroupID</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NVolumeGroups</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentDefectVolume</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># saddle search</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saddleSearchStepBackPos</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saddleSearchStepCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saddleSearchFEvalCount</span> <span class="o">=</span> <span class="mi">0</span>
        
<span class="c1">#        self.saddleSearchInitDefectVolHash = []</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">saddleSearchBackTestSep</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">storeEnergies</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">storeEnergies</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">storeEnergies</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">KE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">KE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">rVector</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">specieListForced</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Globals</span><span class="o">.</span><span class="n">lammpsForceSpecieList</span><span class="p">):</span>
<span class="c1">#             if Globals.MDType != &quot;LAMMPS&quot;:</span>
<span class="c1">#                 print &quot;*&quot;*80</span>
<span class="c1">#                 print &quot;WARNING: FORCING SPECIE LIST BUT YOU&#39;RE NOT USING LAMMPS&quot;</span>
<span class="c1">#                 print &quot;         ARE YOU SURE YOU KNOW WHAT YOU&#39;RE DOING!!!&quot;</span>
<span class="c1">#                 print &quot;*&quot;*80</span>
<span class="c1">#                 time.sleep(5)</span>
            
            <span class="n">spec_list</span> <span class="o">=</span> <span class="n">Globals</span><span class="o">.</span><span class="n">lammpsForceSpecieList</span>
<span class="c1">#             print &quot;DEBUG: FORCING SPEC LIST&quot;, spec_list</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">specieListForced</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="c1"># add atoms then remove them, specie list will remain</span>
            <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">spec_list</span><span class="p">:</span>
                <span class="n">indx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">addAtom</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">removeAtom</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span>
<span class="c1">#                 print &quot;DEBUG: ADD&quot;, sym, self.specieList</span>
    
<div class="viewcode-block" id="Lattice.getIndicesFromPositions"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.getIndicesFromPositions">[docs]</a>    <span class="k">def</span> <span class="nf">getIndicesFromPositions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputPos</span><span class="p">,</span> <span class="n">maxSep</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds the atoms within the Lattice that correspond to the input positions.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        inputPos : np.ndarray</span>
<span class="sd">            The positions that you want to associate with atoms in the `Lattice`.</span>
<span class="sd">        maxSep : float, optional</span>
<span class="sd">            The maximum separation allowed for a site to be associated with one of the</span>
<span class="sd">            input positions. Defaults to 0.1.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        indices : np.ndarray</span>
<span class="sd">            The indices of the atoms that correspond to the `inputPos` positions. Note,</span>
<span class="sd">            if no atom was found to correspond to a position then we return -1 in its</span>
<span class="sd">            place. It is up to the user what they do with this information.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If `maxSep` is zero or negative.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check maxSep parameter</span>
        <span class="k">if</span> <span class="n">maxSep</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Max separation cannot be zero or negative&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputPos</span><span class="p">):</span>
            <span class="c1"># if no input positions are specified return an empty array</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># create array for storing the result</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inputPos</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            
            <span class="c1"># cell dims array</span>
            <span class="n">cellDims3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">cellDims3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cellDims3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">cellDims3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
            
            <span class="c1"># call C library</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">c_lattice</span><span class="o">.</span><span class="n">getIndicesFromPositions</span><span class="p">(</span><span class="n">inputPos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">maxSep</span><span class="p">,</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">,</span>
                                                       <span class="n">cellDims3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minPos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxPos</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;getIndicesFromPositions failed with status </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">status</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">indices</span></div>
    
<div class="viewcode-block" id="Lattice.setCellDims"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.setCellDims">[docs]</a>    <span class="k">def</span> <span class="nf">setCellDims</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimsArray</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the `Lattice` cell dimensions.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dimsArray : array_like[9]</span>
<span class="sd">            Array-like object of length 9, containing the dimensions</span>
<span class="sd">            you want to set. Does nothing if this array is the </span>
<span class="sd">            wrong length.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dimsArray</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">):</span>
            <span class="k">return</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">dimsArray</span><span class="p">[:]</span></div>
    
<div class="viewcode-block" id="Lattice.findNeighbours"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.findNeighbours">[docs]</a>    <span class="k">def</span> <span class="nf">findNeighbours</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atomIndex</span><span class="p">,</span> <span class="n">maxSeparation</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the neighbours of an atom.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        atomIndex : int</span>
<span class="sd">            The index of the atom whose neighbours you want to find</span>
<span class="sd">        maxSeparation : float</span>
<span class="sd">            Atoms within this distance of the selected atom are classed as</span>
<span class="sd">            neighbours</span>
<span class="sd">        sort : boolean, optional</span>
<span class="sd">            Sort the neighbours by separation, default is to return them</span>
<span class="sd">            unsorted</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        neighbours : ndarray</span>
<span class="sd">            Array containing the indexes of the atoms neighbours</span>
<span class="sd">        neighbourSeparations : ndarray</span>
<span class="sd">            Array containing the separations to the atoms neighbours</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        IndexError</span>
<span class="sd">            If the selected atom index is out of range</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">atomIndex</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">atomIndex</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Atom index out of range: </span><span class="si">%d</span><span class="s2"> &gt;= </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atomIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">))</span>
        
        <span class="c1">#TODO: allocate from C</span>
        <span class="n">nebs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">nebSeps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        
        <span class="n">dims3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">dims3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dims3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">dims3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
        
        <span class="c1"># call</span>
        <span class="n">numNebs</span> <span class="o">=</span> <span class="n">c_lattice</span><span class="o">.</span><span class="n">findAtomsNeighbours</span><span class="p">(</span><span class="n">atomIndex</span><span class="p">,</span> <span class="n">maxSeparation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minPos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxPos</span><span class="p">,</span> 
                                                <span class="n">dims3</span><span class="p">,</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">,</span> <span class="n">nebs</span><span class="p">,</span> <span class="n">nebSeps</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">sort</span><span class="p">))</span>
        
        <span class="c1"># resize (change this to allocate in C)</span>
        <span class="n">nebs</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">numNebs</span><span class="p">)</span>
        <span class="n">nebSeps</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">numNebs</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">nebs</span><span class="p">,</span> <span class="n">nebSeps</span></div>
    
<div class="viewcode-block" id="Lattice.calcTemperature"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.calcTemperature">[docs]</a>    <span class="k">def</span> <span class="nf">calcTemperature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">NMoving</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the temperature of the `Lattice`.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        NMoving : int, optional</span>
<span class="sd">            The number of moving atoms in the `Lattice` (defaults to all atoms).</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        temperature : float</span>
<span class="sd">            The temperature of the `Lattice` in K.</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This assumes that all the atoms in the system are &#39;moving&#39;. If you have</span>
<span class="sd">        fixed atoms then this will give a different result to the MD code.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">storeEnergies</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="n">NMoving</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">NMoving</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span>
        
        <span class="n">keSum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KE</span><span class="p">)</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">keSum</span> <span class="o">/</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">boltzmann</span> <span class="o">*</span> <span class="n">NMoving</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">temperature</span></div>
    
<div class="viewcode-block" id="Lattice.calcForce"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.calcForce">[docs]</a>    <span class="k">def</span> <span class="nf">calcForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">MDPath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">defectFlag</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">correctTE</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">includeAtoms</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> 
                  <span class="n">mainIndexes</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate forces acting on the `Lattice`.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        correctTE : bool, optional</span>
<span class="sd">            Compute the correct total energy, i.e. ignore `defectFlag`.</span>
<span class="sd">        defectFlag : {0, 1, 2}, optional</span>
<span class="sd">            Calculate forces on defect sub-system.</span>
<span class="sd">            </span>
<span class="sd">            * Set to 0 to do a normal force calculation (default)</span>
<span class="sd">            * Set to 1 to zero the forces on atoms within the sub-system</span>
<span class="sd">            * Set to 2 to zero the forces on atoms outside the sub-system</span>
<span class="sd">        mainIndexes : ndarray, optional</span>
<span class="sd">            Specify the main atoms to use in the `defectFlag` calculation.  </span>
<span class="sd">            These atoms make up the defect sub-system. If not specified it defaults </span>
<span class="sd">            to `Lattice.defectSubSystem`.</span>
<span class="sd">        includeAtoms : ndarray, optional</span>
<span class="sd">            Specify the atoms to include in the force calculation to make </span>
<span class="sd">            sure the energies and forces on the main atoms are correct. If not </span>
<span class="sd">            specified then these atoms are determined by building a sub-lattice (see </span>
<span class="sd">            `Lattice.buildSubLattice`) around the main atoms using the parameter: </span>
<span class="sd">            *subLatticeIncludeRadius*.</span>
<span class="sd">        </span>
<span class="sd">        MDPath : str</span>
<span class="sd">            Deprecated! This setting will likely be removed in a future release!</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        status : integer</span>
<span class="sd">            0 means success, anything else is a failure.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if lattice object has defined includeAtoms and mainIndexes lists, they</span>
        <span class="c1">#   should be used within forces calculation</span>
        <span class="k">if</span> <span class="n">correctTE</span><span class="p">:</span>
            <span class="n">mainIndexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">includeAtoms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">includeAtoms</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">mainIndexes</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainIndexes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">includeAtoms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mainIndexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainIndexes</span>
                <span class="n">includeAtoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">includeAtoms</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">funcEval</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">Forces</span><span class="o">.</span><span class="n">calcForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">MDPath</span><span class="o">=</span><span class="n">MDPath</span><span class="p">,</span> <span class="n">defectFlag</span><span class="o">=</span><span class="n">defectFlag</span><span class="p">,</span> <span class="n">correctTE</span><span class="o">=</span><span class="n">correctTE</span><span class="p">,</span> 
                                  <span class="n">includeAtoms</span><span class="o">=</span><span class="n">includeAtoms</span><span class="p">,</span> <span class="n">mainIndexes</span><span class="o">=</span><span class="n">mainIndexes</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Lattice force calculation failed! (</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">status</span></div>
    
<div class="viewcode-block" id="Lattice.getSpecieIndices"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.getSpecieIndices">[docs]</a>    <span class="k">def</span> <span class="nf">getSpecieIndices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sym</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return list of indices of all atoms with the given symbol.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sym : str</span>
<span class="sd">            Two character symbol representing species.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        atoms : ndarray</span>
<span class="sd">            NumPy array containing indices of atoms with the given</span>
<span class="sd">            symbol. This will be empty if the given symbol was not </span>
<span class="sd">            in `Lattice.specieList`.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">sym</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specieList</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomSym</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="n">sym</span><span class="p">:</span>
                    <span class="n">atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">atoms</span></div>
    
<div class="viewcode-block" id="Lattice.getMinSepList"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.getMinSepList">[docs]</a>    <span class="k">def</span> <span class="nf">getMinSepList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputPos</span><span class="p">,</span> <span class="n">atomList</span><span class="p">,</span> <span class="n">maxSpacing</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">atomListSize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns minimum separation between `inputPos` and an atom from `atomList`.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        inputPos : np.ndarray[3]</span>
<span class="sd">            The position you want to check.</span>
<span class="sd">        atomList : np.ndarray</span>
<span class="sd">            The indices of the atoms from the `Lattice` you want to check against.</span>
<span class="sd">        maxSpacing : float</span>
<span class="sd">            The maximum spacing between atoms in the lattice. This is used for domain</span>
<span class="sd">            decomposition; if set too small could result in there being no points near</span>
<span class="sd">            `inputPos`. You can check if this has happened since `minSep` will be larger</span>
<span class="sd">            than `maxSpacing`.</span>
<span class="sd">        atomListSize : int, optional</span>
<span class="sd">            The size of `atomList`. If this parameter is not set then we use the full</span>
<span class="sd">            array (i.e. this parameter can be used if wish to only consider the first</span>
<span class="sd">            `atomListSize` elements ofe the `atomList` array).</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        minSep : float or None</span>
<span class="sd">            The minimum separation found between `inputPos` and an atom from `atomList`.</span>
<span class="sd">            If no atom was found within `maxSpacing` of the `inputPos` then retun None.</span>
<span class="sd">        minSepIndex : int or None</span>
<span class="sd">            The index of the site within `atomList` that was closest to `inputPos` or</span>
<span class="sd">            None if no atom was found within `maxSpacing`. Note this is not the index</span>
<span class="sd">            within the Lattice but is the index within `atomList`, i.e.</span>
<span class="sd">            `0 &lt;= index &lt; len(atomList)`.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If atomListSize is specified and it is out of range (bigger than</span>
<span class="sd">            `len(atomList)` or negative).</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check atomListSize</span>
        <span class="n">atomListLen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atomList</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">atomListSize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">atomListSize</span> <span class="o">=</span> <span class="n">atomListLen</span>
        <span class="k">elif</span> <span class="n">atomListSize</span> <span class="o">&gt;</span> <span class="n">atomListLen</span> <span class="ow">or</span> <span class="n">atomListSize</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;atomListSize out of range (</span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atomListSize</span><span class="p">,</span> <span class="n">atomListLen</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">atomListSize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># return None if there are no atoms to compare</span>
            <span class="n">minSep</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">minSepIndex</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># array for storing result</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            
            <span class="c1"># cell dims array</span>
            <span class="n">cellDims3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">cellDims3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cellDims3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">cellDims3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
            
            <span class="c1"># call C library to do the work</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">c_lattice</span><span class="o">.</span><span class="n">findMinSepPosList</span><span class="p">(</span><span class="n">atomListSize</span><span class="p">,</span> <span class="n">atomList</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">inputPos</span><span class="p">,</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">,</span> <span class="n">cellDims3</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">minPos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxPos</span><span class="p">,</span> <span class="n">maxSpacing</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Lattice.getMinSepList failed with status </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">status</span><span class="p">)</span>
            
            <span class="c1"># unpack result</span>
            <span class="n">minSep</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">minSepIndex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            
            <span class="c1"># check if we found an atom within maxSpacing of inputPos</span>
            <span class="k">if</span> <span class="n">minSep</span> <span class="o">&gt;</span> <span class="n">maxSpacing</span><span class="p">:</span>
                <span class="n">minSep</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">minSepIndex</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">return</span> <span class="n">minSep</span><span class="p">,</span> <span class="n">minSepIndex</span></div>
    
<div class="viewcode-block" id="Lattice.atomSeparation"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.atomSeparation">[docs]</a>    <span class="k">def</span> <span class="nf">atomSeparation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index1</span><span class="p">,</span> <span class="n">index2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the separation between two atoms.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index1, index2 : integer</span>
<span class="sd">            Indexes of the atoms you want to calculate the separation</span>
<span class="sd">            between.</span>

<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        atomSeparation : float</span>
<span class="sd">            The separation between the two atoms. This function will</span>
<span class="sd">            return &#39;None&#39; if the indexes are out of range.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        IndexError</span>
<span class="sd">            If the specified indexes are too large.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">index1</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span> <span class="ow">and</span> <span class="n">index2</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">:</span>
            <span class="n">atomSeparation</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atomPos</span><span class="p">(</span><span class="n">index1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomPos</span><span class="p">(</span><span class="n">index2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Atom index(es) out of range: (</span><span class="si">%d</span><span class="s2"> or </span><span class="si">%d</span><span class="s2">) &gt;= </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index1</span><span class="p">,</span> <span class="n">index2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">atomSeparation</span></div>
    
<div class="viewcode-block" id="Lattice.atomPos"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.atomPos">[docs]</a>    <span class="k">def</span> <span class="nf">atomPos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the position of the given atom.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : integer</span>
<span class="sd">            The index of the atom whose position you require.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        atomPos : ndarray</span>
<span class="sd">            The position of the selected atom.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        IndexError</span>
<span class="sd">            If the specified index is too large.</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The returned array is a pointer to the atoms position in the </span>
<span class="sd">        `Lattice.pos` array. Modifying the position in the returned</span>
<span class="sd">        array will modify the atoms position in the `Lattice`.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">:</span>
            <span class="n">atomPos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Atom index out of range: </span><span class="si">%d</span><span class="s2"> &gt;= </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">atomPos</span></div>
    
<div class="viewcode-block" id="Lattice.changeAtomSpecie"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.changeAtomSpecie">[docs]</a>    <span class="k">def</span> <span class="nf">changeAtomSpecie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">sym</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change the species of the given atom. This method updates the</span>
<span class="sd">        species list and species counter arrays.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : integer</span>
<span class="sd">            The index of the atom whose species you want to change.</span>
<span class="sd">        </span>
<span class="sd">        sym : str[2]</span>
<span class="sd">            Two character symbol representing the species to change</span>
<span class="sd">            the given atom to.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        IndexError</span>
<span class="sd">            If the specified indexes are too large.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># current species index</span>
            <span class="n">cur_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specie</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># if the atom is already set to the required species we have nothing to do</span>
                <span class="k">if</span> <span class="n">cur_spec</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">specieIndex</span><span class="p">(</span><span class="n">sym</span><span class="p">):</span>
                    <span class="k">return</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1"># if the species does not exist in the species list then we add it</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">addSpecie</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
            
            <span class="c1"># remove atom from current species</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">specieCount</span><span class="p">[</span><span class="n">cur_spec</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">specieCount</span><span class="p">[</span><span class="n">cur_spec</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">specieListForced</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">removeSpecie</span><span class="p">(</span><span class="n">cur_spec</span><span class="p">)</span>
            
            <span class="c1"># add atom to new species</span>
            <span class="n">specInd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specieIndex</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">specieCount</span><span class="p">[</span><span class="n">specInd</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">specie</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">specInd</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Atom index out of range: </span><span class="si">%d</span><span class="s2"> &gt;= </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="Lattice.atomSym"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.atomSym">[docs]</a>    <span class="k">def</span> <span class="nf">atomSym</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the symbol of the given atom.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : integer</span>
<span class="sd">            The index of the atom.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        atomSym : str[2]</span>
<span class="sd">            The two character symbol representing the species of the atom.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        IndexError</span>
<span class="sd">            If the specified index is too large.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">:</span>
            <span class="n">atomSym</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specieList</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">specie</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Atom index out of range: </span><span class="si">%d</span><span class="s2"> &gt;= </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">atomSym</span></div>
    
<div class="viewcode-block" id="Lattice.wrapLattice"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.wrapLattice">[docs]</a>    <span class="k">def</span> <span class="nf">wrapLattice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrap atoms that have left the box (if using periodic boundaries).</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wrapAtoms</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="Lattice.wrapAtoms"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.wrapAtoms">[docs]</a>    <span class="k">def</span> <span class="nf">wrapAtoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrap atoms that have left the box (if using periodic boundaries).</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="k">return</span>
        
        <span class="n">c_lattice</span><span class="o">.</span><span class="n">wrapLattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Lattice.removeOutBoundary"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.removeOutBoundary">[docs]</a>    <span class="k">def</span> <span class="nf">removeOutBoundary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check and remove atoms that out of boundaries.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">removeFlag</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">if</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Expect non-periodic in only one direction</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">flagA</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">flagB</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">flagA</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">flagB</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">flagA</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">flagB</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">flagA</span><span class="p">]</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="n">flagB</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">flagA</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)):</span>
                <span class="n">removeFlag</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="nb">print</span> <span class="s2">&quot;Remove &quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">flagA</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">removeAtom</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">removeFlag</span><span class="p">:</span>    
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> out-of-boundary atoms removed&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">removeFlag</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Lattice.findDefects"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.findDefects">[docs]</a>    <span class="k">def</span> <span class="nf">findDefects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">overlayMode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find defects in the lattice.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ref : `Lattice`</span>
<span class="sd">            The reference `Lattice` object.</span>
<span class="sd">        parameters : `Input.InputParams`</span>
<span class="sd">            The `Input.InputParams` instance containing the desired parameters.</span>
<span class="sd">        overlayMode : bool, optional</span>
<span class="sd">            Not sure if this does anything (CDJS 07/10/14)</span>
<span class="sd">        writer : `Writer.LKMCWriter`, optional</span>
<span class="sd">            Instance of `Writer.LKMCWriter`. Not sure what this does...</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        defectsObject</span>
<span class="sd">            Instance of `Rendering.DefectsObject` containing information about the </span>
<span class="sd">            defects.</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method calls `Defects.findDefectVolumes`. This method modifies the </span>
<span class="sd">        `Lattice.defectVolumes`, etc. attributes with the new defect information.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">defectVolumeFinder</span> <span class="o">=</span> <span class="n">Defects</span><span class="o">.</span><span class="n">DefectVolumesFinder</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
        <span class="n">defectVolumeFinder</span><span class="o">.</span><span class="n">findDefectVolumes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="n">writer</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">defectsObject</span></div>
        
<div class="viewcode-block" id="Lattice.initiateDefectDisplacement"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.initiateDefectDisplacement">[docs]</a>    <span class="k">def</span> <span class="nf">initiateDefectDisplacement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initiate displacement around a defect atom.</span>
<span class="sd">        </span>
<span class="sd">        Randomly pick a defect atom and move surrounding atoms by a</span>
<span class="sd">        random amount (determined by `step`). A list of atoms in the </span>
<span class="sd">        surrounding area is stored in the `Lattice.defectSubSystem` array.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        step : float</span>
<span class="sd">            The step size to move the selected atoms by.</span>
<span class="sd">        parameters : `Input.InputParams`</span>
<span class="sd">            Parameters instance.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Defects</span><span class="o">.</span><span class="n">initiateDefectDisplacement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Lattice.initiateAtomsDisplacement"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.initiateAtomsDisplacement">[docs]</a>    <span class="k">def</span> <span class="nf">initiateAtomsDisplacement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atomList</span><span class="p">,</span> <span class="n">displ</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initiate atom displacement...</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">atomListLen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atomList</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">atomListLen</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">if</span> <span class="n">atomListLen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Vectors</span><span class="o">.</span><span class="n">applyPartialDisplacement</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">displ</span><span class="p">,</span> <span class="n">atomList</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Vectors</span><span class="o">.</span><span class="n">addVectorsInplace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">displ</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Lattice.getForceParallel"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.getForceParallel">[docs]</a>    <span class="k">def</span> <span class="nf">getForceParallel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the parallel component of `Lattice.force` with respect to</span>
<span class="sd">        the vector `N`.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        N : ndarray</span>
<span class="sd">            Input vector; assumed to be of the same length as </span>
<span class="sd">            `Lattice.force`.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        paraForce : ndarray</span>
<span class="sd">            Returns array containing the parallel component of </span>
<span class="sd">            `Lattice.force` with respect to vector `N`.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">paraForce</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">projection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">paraForce</span></div>
    
<div class="viewcode-block" id="Lattice.getForcePerpendicular"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.getForcePerpendicular">[docs]</a>    <span class="k">def</span> <span class="nf">getForcePerpendicular</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the perpendicular component of `Lattice.force` with </span>
<span class="sd">        respect to the vector `N`.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        N : ndarray</span>
<span class="sd">            Input vector; assumed to be of the same length as </span>
<span class="sd">            `Lattice.force`.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        perpForce : ndarray</span>
<span class="sd">            Returns array containing the perpendicular component of </span>
<span class="sd">            `Lattice.force` with respect to vector `N`.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">getForceParallel</span><span class="p">(</span><span class="n">N</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Lattice.getSpecieIndex"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.getSpecieIndex">[docs]</a>    <span class="k">def</span> <span class="nf">getSpecieIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the index of the given symbol in `Lattice.specieList`.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        check : str[2]</span>
<span class="sd">            The input symbol.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        index</span>
<span class="sd">            The index of the given symbol in `Lattice.specieList`.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the symbol does not exist in `Lattice.specieList`.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">specieIndex</span><span class="p">(</span><span class="n">check</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Lattice.specieIndex"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.specieIndex">[docs]</a>    <span class="k">def</span> <span class="nf">specieIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the index of the given symbol in `Lattice.specieList`.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        check : str[2]</span>
<span class="sd">            The input symbol.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        index</span>
<span class="sd">            The index of the given symbol in `Lattice.specieList`.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the symbol does not exist in `Lattice.specieList`.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specieList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sym</span> <span class="o">==</span> <span class="n">check</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">count</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> not found in specie list: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">check</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieList</span><span class="p">)))</span>
        
        <span class="k">return</span> <span class="n">index</span></div>
    
<div class="viewcode-block" id="Lattice.addSpecie"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.addSpecie">[docs]</a>    <span class="k">def</span> <span class="nf">addSpecie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sym</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a new species to `Lattice.specieList`.</span>
<span class="sd">        </span>
<span class="sd">        If `sym` already exists in `Lattice.specieList` and `count` is</span>
<span class="sd">        specified, then the count for the given species is updated.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sym : str[2]</span>
<span class="sd">            The symbol of the species to add.</span>
<span class="sd">        count : int, optional</span>
<span class="sd">            The initial count to place into *Lattice.specieCount*.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if sym already exists in specie list we still update count if</span>
        <span class="c1"># it was specified</span>
        <span class="k">if</span> <span class="n">sym</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specieList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">specInd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specieIndex</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">specieCount</span><span class="p">[</span><span class="n">specInd</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>
            
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># append to specie list/count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieList</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieList</span><span class="p">,</span> <span class="n">sym</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieCount</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieCount</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">count</span><span class="p">))</span>
        
        <span class="c1"># also add to specie property arrays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieMass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieMass</span><span class="p">,</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">atomicMass</span><span class="p">(</span><span class="n">sym</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieMassAMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieMassAMU</span><span class="p">,</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">atomicMassAMU</span><span class="p">(</span><span class="n">sym</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieCovalentRadius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieCovalentRadius</span><span class="p">,</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">covalentRadius</span><span class="p">(</span><span class="n">sym</span><span class="p">))</span>
        <span class="n">rgbtemp</span> <span class="o">=</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">RGB</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
        <span class="n">rgbnew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">rgbnew</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgbtemp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rgbnew</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgbtemp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">rgbnew</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgbtemp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieRGB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieRGB</span><span class="p">,</span> <span class="n">rgbnew</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Lattice.addAtom"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.addAtom">[docs]</a>    <span class="k">def</span> <span class="nf">addAtom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sym</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">charge</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add an atom to the `Lattice`.</span>
<span class="sd">        </span>
<span class="sd">        This method updates the `Lattice.specieList` and</span>
<span class="sd">        `Lattice.specieCount` arrays and is the safest way to add</span>
<span class="sd">        additional atoms to the `Lattice`.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sym : str[2]</span>
<span class="sd">            The species of the new atom, eg. &#39;Au&#39;.</span>
<span class="sd">        pos : array_like[3]</span>
<span class="sd">            The position of new atom.</span>
<span class="sd">        charge : float</span>
<span class="sd">            The charge of the new atom.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sym</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specieList</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addSpecie</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
        
        <span class="n">specInd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specieIndex</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">specieCount</span><span class="p">[</span><span class="n">specInd</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">specie</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">specInd</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">charge</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">storeEnergies</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">KE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KE</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PE</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resetLammps</span> <span class="o">=</span> <span class="mi">1</span></div>
    
<div class="viewcode-block" id="Lattice.removeAtom"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.removeAtom">[docs]</a>    <span class="k">def</span> <span class="nf">removeAtom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Safely remove an atom from the `Lattice`.</span>
<span class="sd">        </span>
<span class="sd">        This method updates the `Lattice.specieList` and </span>
<span class="sd">        `Lattice.specieCount` arrays and is the safest way to remove </span>
<span class="sd">        atoms from the `Lattice`.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : integer</span>
<span class="sd">            The index of the atom you want to remove</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">specInd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specie</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specie</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span> <span class="o">-=</span> <span class="mi">1</span>
        
        <span class="c1"># modify specie list / counter if required</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieCount</span><span class="p">[</span><span class="n">specInd</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">specieCount</span><span class="p">[</span><span class="n">specInd</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">specieListForced</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">removeSpecie</span><span class="p">(</span><span class="n">specInd</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">storeEnergies</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">KE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KE</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PE</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">resetLammps</span> <span class="o">=</span> <span class="mi">1</span></div>
        
<div class="viewcode-block" id="Lattice.removeSputter"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.removeSputter">[docs]</a>    <span class="k">def</span> <span class="nf">removeSputter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refState</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove sputtered atoms from the `Lattice`.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        refState : `Lattice`</span>
<span class="sd">            The reference lattice object.</span>
<span class="sd">        params : `Input.InputParams`</span>
<span class="sd">            Parameters instance.</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Sputtered atoms are detected by finding defect volumes with </span>
<span class="sd">        2nd_radius=cutoff and to see if there&#39;re other atoms in this </span>
<span class="sd">        distance. </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">removeFlag</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># make a copy of params with 2nd_radius=cutoff, graphRadius=0</span>
        <span class="n">params2</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">params2</span><span class="o">.</span><span class="n">graphRadius</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">params2</span><span class="o">.</span><span class="n">searchMoveRadius</span> <span class="o">=</span> <span class="n">params2</span><span class="o">.</span><span class="n">depoCutoff</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">findDefects</span><span class="p">(</span><span class="n">refState</span><span class="p">,</span> <span class="n">params2</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">dv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">:</span>
            <span class="c1"># ignore combined Volumes</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dv</span><span class="o">.</span><span class="n">combinedVol</span><span class="p">:</span>
                <span class="c1"># graphVol = defect atoms, searchMoveVol = volumes around defects with radius=cutoff</span>
                <span class="c1"># if no other atoms within radius of cutoff, then remove this dv</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">graphVol</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">searchMoveVol</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">atomid</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">graphVol</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">removeAtom</span><span class="p">(</span><span class="n">atomid</span><span class="p">)</span>
                        <span class="n">removeFlag</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">removeFlag</span><span class="p">:</span>    
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> sputtered atoms removed&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">removeFlag</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span> <span class="c1"># is del necessary here?? why not &#39;self.defectVolumes = []&#39;</span></div>
            
<div class="viewcode-block" id="Lattice.removeSpecie"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.removeSpecie">[docs]</a>    <span class="k">def</span> <span class="nf">removeSpecie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove a species from the species list.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : integer</span>
<span class="sd">            The index of the species to remove.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        IndexError</span>
<span class="sd">            If `index` is out of range.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieList</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Species index is out of range: </span><span class="si">%d</span><span class="s2"> &gt;= </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieList</span><span class="p">)))</span>
        
        <span class="c1"># remove from specie arrays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieCount</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieCount</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieList</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieList</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieCovalentRadius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieCovalentRadius</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieMass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieMass</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieMassAMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieMassAMU</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieRGB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieRGB</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># adjust specie indices of atoms</span>
        <span class="c1">#TODO: this should be written in C</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">specie</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">index</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">specie</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span></div>
        
<span class="c1">#        if index != len(self.specieList):</span>
<span class="c1">#            c_io.adjustSpecieArray(self.NAtoms, int(index), self.specie)</span>
    
<div class="viewcode-block" id="Lattice.totalCharge"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.totalCharge">[docs]</a>    <span class="k">def</span> <span class="nf">totalCharge</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the net charge of the system.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        totalCharge : float</span>
<span class="sd">            The net charge of the system.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Lattice.writeLattice"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.writeLattice">[docs]</a>    <span class="k">def</span> <span class="nf">writeLattice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zipfile</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the `Lattice` to a file.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            The name of the file to write the `Lattice` to.</span>
<span class="sd">        append : bool, optional</span>
<span class="sd">            Append the lattice onto the end of the given file. This</span>
<span class="sd">            creates a &#39;combined lattice file&#39;.</span>
<span class="sd">        zipfile : bool, optional</span>
<span class="sd">            Use gzip to compress the file after writing it.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_writeLattice</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">append</span><span class="p">,</span> <span class="n">zipfile</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Lattice.writeObject"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.writeObject">[docs]</a>    <span class="k">def</span> <span class="nf">writeObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zipfile</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the `Lattice` to a file.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            The name of the file to write the `Lattice` to.</span>
<span class="sd">        append : bool, optional</span>
<span class="sd">            Append the lattice onto the end of the given file. This</span>
<span class="sd">            creates a &#39;combined lattice file&#39;.</span>
<span class="sd">        zipfile : bool, optional</span>
<span class="sd">            Use gzip to compress the file after writing it.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeLattice</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="n">append</span><span class="p">,</span> <span class="n">zipfile</span><span class="o">=</span><span class="n">zipfile</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Lattice.volume"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.volume">[docs]</a>    <span class="k">def</span> <span class="nf">volume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the volume of the `Lattice`.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            volume : float</span>
<span class="sd">                The volume of the `Lattice`.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span></div>
    
<div class="viewcode-block" id="Lattice.getHashKey"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.getHashKey">[docs]</a>    <span class="k">def</span> <span class="nf">getHashKey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nebRad</span><span class="o">=</span><span class="mf">3.5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the Nauty hash key of the `Lattice`.</span>
<span class="sd">        </span>
<span class="sd">        .. note:: Deprecated.</span>
<span class="sd">                  Untested and likely to be removed in the future</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str, optional</span>
<span class="sd">            File to write the connectivity information to. If not </span>
<span class="sd">            specified then a temporary file is created.</span>
<span class="sd">        nebRad : float</span>
<span class="sd">            Neighbour radius to use when building connectivity between</span>
<span class="sd">            atoms.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cellDims3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">cellDims3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cellDims3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">cellDims3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fd</span><span class="p">,</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="s2">&quot;/tmp&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">filename</span>
        
        <span class="n">c_graphs</span><span class="o">.</span><span class="n">makeGraphFileFromLattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieList</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span>
                                          <span class="n">nebRad</span><span class="p">,</span> <span class="n">cellDims3</span><span class="p">,</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minPos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxPos</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
        
        <span class="c1"># close descriptor</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
        
        <span class="n">hashkey</span> <span class="o">=</span> <span class="n">Utilities</span><span class="o">.</span><span class="n">runDreadnaut</span><span class="p">(</span><span class="n">graphFile</span><span class="o">=</span><span class="n">fn</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">hashkey</span></div>
    
<div class="viewcode-block" id="Lattice.buildSubLattice"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.buildSubLattice">[docs]</a>    <span class="k">def</span> <span class="nf">buildSubLattice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mainAtoms</span><span class="p">,</span> <span class="n">includeRadius</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a sub-lattice of atoms around the main atoms.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mainAtoms : ndarray</span>
<span class="sd">            A NumPy array containing the indexes of the atoms around which</span>
<span class="sd">            we will build the sub-lattice.</span>
<span class="sd">        includeRadius</span>
<span class="sd">            The radius (or skin) to place around the `mainAtoms`. All </span>
<span class="sd">            atoms within this distance of an atom in the `mainAtoms` list </span>
<span class="sd">            will be included in the sub-system.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        subsystem : ndarray</span>
<span class="sd">            A NumPy array containing the indexes of the atoms in the sub-system.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dims3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">dims3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dims3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">dims3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
        
        <span class="c1"># make sure min/max pos is correct if not using PBCs (for boxing)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">minPos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">maxPos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">includeRadius</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">subsystem</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">mainAtoms</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subsystem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">NAtomsSubLattice</span> <span class="o">=</span> <span class="n">c_lattice</span><span class="o">.</span><span class="n">buildSubLattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">mainAtoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">dims3</span><span class="p">,</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">,</span> <span class="n">includeRadius</span><span class="p">,</span> <span class="n">subsystem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minPos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxPos</span><span class="p">)</span>
            
            <span class="c1">#log(__name__, &quot;Built sub-lattice containing %d atoms&quot; % (NAtomsSubLattice,), 2)</span>
            
            <span class="n">subsystem</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">NAtomsSubLattice</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">subsystem</span></div>
    
<div class="viewcode-block" id="Lattice.countNumIndividualVolumes"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.countNumIndividualVolumes">[docs]</a>    <span class="k">def</span> <span class="nf">countNumIndividualVolumes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Count the number of individual defect volumes (i.e. excluding </span>
<span class="sd">        combined volumes).</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        count : integer</span>
<span class="sd">            The number of individual defect volumes in the `Lattice`.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)):</span>
            <span class="n">dv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dv</span><span class="o">.</span><span class="n">combinedVol</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">countIndividualVolumes</span> <span class="o">=</span> <span class="n">count</span>
        <span class="k">return</span> <span class="n">count</span></div>

<div class="viewcode-block" id="Lattice.findMovedAtoms"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.Lattice.findMovedAtoms">[docs]</a>    <span class="k">def</span> <span class="nf">findMovedAtoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compareLattice</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find atoms that have moved between this `Lattice` and </span>
<span class="sd">        `compareLattice`.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        compareLattice : `Lattice`</span>
<span class="sd">            Input `Lattice` to check against for movement.</span>
<span class="sd">        threshold : float, optional</span>
<span class="sd">            Only classify an atom as &#39;moved&#39; if it as moved at least this</span>
<span class="sd">            distance.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        movedIndexes : ndarray</span>
<span class="sd">            Array containing the indexes of the atoms that have moved.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If the numbers of atoms in `Lattice` and `compareLattice` do</span>
<span class="sd">            not match.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span> <span class="o">!=</span> <span class="n">compareLattice</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot compare two Lattices with different numbers of atoms (</span><span class="si">%d</span><span class="s2"> != </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> 
                                                                                                           <span class="n">compareLattice</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">))</span>
        
        <span class="c1"># array for moved indexes</span>
        <span class="n">movedIndexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        
        <span class="c1"># call C lib</span>
        <span class="n">NMoved</span> <span class="o">=</span> <span class="n">c_lattice</span><span class="o">.</span><span class="n">findMovedAtoms</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">compareLattice</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> 
                                          <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">,</span> <span class="n">movedIndexes</span><span class="p">)</span>
        
        <span class="c1"># resize array</span>
        <span class="n">movedIndexes</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">NMoved</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">movedIndexes</span></div></div>

<span class="c1">################################################################################</span>

<div class="viewcode-block" id="readLattice"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.readLattice">[docs]</a><span class="k">def</span> <span class="nf">readLattice</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">storeEnergies</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read a file into a `Lattice` object.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        The name of the file to read in.</span>
<span class="sd">        </span>
<span class="sd">    storeEnergies : bool, optional</span>
<span class="sd">        Set to True to create arrays for storing kinetic and</span>
<span class="sd">        potential energies. False by default. See the `storeEnergies` option</span>
<span class="sd">        on the `Lattice` object.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lattice : `Lattice`</span>
<span class="sd">        The `Lattice` object read in from the file.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lattice</span> <span class="o">=</span> <span class="n">readLatticeLBOMD</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">storeEnergies</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">lattice</span></div>

<span class="c1">################################################################################</span>

<div class="viewcode-block" id="readLatticeLBOMD"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.readLatticeLBOMD">[docs]</a><span class="k">def</span> <span class="nf">readLatticeLBOMD</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">storeEnergies</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read a LBOMD &#39;lattice&#39; format file into a `Lattice` object.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        The name of the file to read in.</span>
<span class="sd">        </span>
<span class="sd">    storeEnergies : bool</span>
<span class="sd">        Set to True to create arrays for storing kinetic and</span>
<span class="sd">        potential energies. See the `storeEnergies` option</span>
<span class="sd">        on the `Lattice` object.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lattice : `Lattice`</span>
<span class="sd">        The `Lattice` object read in from the file.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">verboseLevel</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">##### TEMPORARY: should be set in Input.py</span>
    
    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;reading lattice file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,),</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="n">zipFlag</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">Utilities</span><span class="o">.</span><span class="n">checkForZipped</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    
    <span class="c1"># read header in here</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">__name__</span><span class="o">+</span><span class="s2">&quot;: ERROR: cannot open file: &quot;</span><span class="o">+</span><span class="n">filename</span><span class="p">)</span>
    
    <span class="c1"># number of atoms</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">NAtoms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    
    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> atoms&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NAtoms</span><span class="p">,),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># create lattice class instance</span>
    <span class="n">lattice</span> <span class="o">=</span> <span class="n">Lattice</span><span class="p">(</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">storeEnergies</span><span class="o">=</span><span class="n">storeEnergies</span><span class="p">)</span>
    
    <span class="c1"># dimensions</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">lattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">lattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">lattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="c1"># need temporary specie list and counter arrays</span>
    <span class="k">if</span> <span class="n">lattice</span><span class="o">.</span><span class="n">specieListForced</span><span class="p">:</span>
        <span class="n">maxNumSpecies</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">specieList</span><span class="p">)</span>
        <span class="n">specieListTemp</span> <span class="o">=</span> <span class="n">lattice</span><span class="o">.</span><span class="n">specieList</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">specieCount</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">specieCountTemp</span> <span class="o">=</span> <span class="n">lattice</span><span class="o">.</span><span class="n">specieCount</span>
        
    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">maxNumSpecies</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="nb">str</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">specieListTemp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span> <span class="n">maxNumSpecies</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dt</span> <span class="p">)</span> 
        <span class="n">specieCountTemp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">maxNumSpecies</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span> <span class="p">)</span>
    
    <span class="c1"># call c lib</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">c_io</span><span class="o">.</span><span class="n">readLatticeLBOMD</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">maxNumSpecies</span><span class="p">,</span> <span class="n">specieListTemp</span><span class="p">,</span> <span class="n">specieCountTemp</span><span class="p">,</span> 
                                   <span class="n">lattice</span><span class="o">.</span><span class="n">maxPos</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">minPos</span><span class="p">,</span> <span class="n">verboseLevel</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">specieListForced</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;ERROR: readLatticeLBOMD clib exited with status </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">status</span><span class="p">)</span>
    
    <span class="c1"># build specie list and counter in lattice object</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">lattice</span><span class="o">.</span><span class="n">specieListForced</span><span class="p">:</span>
        <span class="n">NSpecies</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">maxNumSpecies</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">specieListTemp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;XX&#39;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">NSpecies</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">NSpecies</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">specieList</span><span class="p">)</span>
    
    <span class="c1"># add species to specie lists</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">NSpecies</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lattice</span><span class="o">.</span><span class="n">specieListForced</span><span class="p">:</span>
            <span class="n">lattice</span><span class="o">.</span><span class="n">addSpecie</span><span class="p">(</span><span class="n">specieListTemp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">count</span><span class="o">=</span><span class="n">specieCountTemp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">) atoms&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">specieCountTemp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">specieListTemp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">atomName</span><span class="p">(</span><span class="n">specieListTemp</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">zipFlag</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">lattice</span></div>

<span class="c1">################################################################################</span>

<div class="viewcode-block" id="readLatticeLAMMPS"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.readLatticeLAMMPS">[docs]</a><span class="k">def</span> <span class="nf">readLatticeLAMMPS</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">storeEnergies</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read a LAMMPS dump file into a `Lattice` object.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        The name of the file to read in.</span>
<span class="sd">        </span>
<span class="sd">    storeEnergies : bool</span>
<span class="sd">        Set to True to create arrays for storing kinetic and</span>
<span class="sd">        potential energies. See the `storeEnergies` option</span>
<span class="sd">        on the `Lattice` object.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lattice : `Lattice`</span>
<span class="sd">        The `Lattice` object read in from the file.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">verboseLevel</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1">##### TEMPORARY: should be set in Input.py</span>
    
    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;reading lattice file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,),</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="n">zipFlag</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">Utilities</span><span class="o">.</span><span class="n">checkForZipped</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    
    <span class="c1"># read header in here</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">__name__</span><span class="o">+</span><span class="s2">&quot;: ERROR: cannot open file: &quot;</span><span class="o">+</span><span class="n">filename</span><span class="p">)</span>
    
    <span class="c1"># number of atoms</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">NAtoms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> atoms&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NAtoms</span><span class="p">,),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># create lattice class instance</span>
    <span class="n">lattice</span> <span class="o">=</span> <span class="n">Lattice</span><span class="p">(</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">storeEnergies</span><span class="o">=</span><span class="n">storeEnergies</span><span class="p">)</span>
    
    <span class="c1"># dimensions</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">lattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">lattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">lattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="c1"># need temporary specie list and counter arrays</span>
    <span class="n">maxNumSpecies</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="nb">str</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">specieListTemp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span> <span class="n">maxNumSpecies</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span> <span class="p">)</span> 
    <span class="n">specieCountTemp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">maxNumSpecies</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span> <span class="p">)</span>
    
    <span class="c1"># call c lib</span>
    <span class="n">c_io</span><span class="o">.</span><span class="n">readLatticeLAMMPS</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">specieListTemp</span><span class="p">,</span> <span class="n">specieCountTemp</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">maxPos</span><span class="p">,</span> 
                           <span class="n">lattice</span><span class="o">.</span><span class="n">minPos</span><span class="p">,</span> <span class="n">verboseLevel</span><span class="p">)</span>
    
    <span class="c1"># build specie list and counter in lattice object</span>
    <span class="n">NSpecies</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">maxNumSpecies</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">specieListTemp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">5</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">NSpecies</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="c1"># allocate specieList/Counter arrays</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="nb">str</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">lattice</span><span class="o">.</span><span class="n">specieList</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">NSpecies</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">lattice</span><span class="o">.</span><span class="n">specieCount</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">NSpecies</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">lattice</span><span class="o">.</span><span class="n">specieMass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">NSpecies</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">lattice</span><span class="o">.</span><span class="n">specieMassAMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">NSpecies</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">lattice</span><span class="o">.</span><span class="n">specieCovalentRadius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">NSpecies</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">lattice</span><span class="o">.</span><span class="n">specieRGB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">NSpecies</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">NSpecies</span><span class="p">):</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">addSpecie</span><span class="p">(</span><span class="n">specieListTemp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">count</span><span class="o">=</span><span class="n">specieCountTemp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">) atoms&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">specieCountTemp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">specieListTemp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">atomName</span><span class="p">(</span><span class="n">specieListTemp</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">zipFlag</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">lattice</span></div>

<span class="c1">################################################################################</span>

<span class="k">def</span> <span class="nf">_writeLattice</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">append</span><span class="p">,</span> <span class="n">zipfile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write `Lattice` to file.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># temporary fix</span>
    <span class="n">lattice</span><span class="o">.</span><span class="n">specie</span> <span class="o">=</span> <span class="n">lattice</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    
    <span class="c1"># write file</span>
    <span class="n">_writeLatticeLBOMD</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">append</span><span class="p">,</span> <span class="n">zipfile</span><span class="p">)</span>

<span class="c1">################################################################################</span>

<span class="k">def</span> <span class="nf">_writeLatticeLBOMD</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">append</span><span class="p">,</span> <span class="n">zipfile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write `Lattice` to LBOMD &#39;lattice&#39; format file.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;writing lattice file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,),</span> <span class="mi">3</span><span class="p">)</span>
    
    <span class="n">c_io</span><span class="o">.</span><span class="n">writeLatticeLBOMD</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">specieList</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> 
                           <span class="n">lattice</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">append</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">zipfile</span><span class="p">:</span>
        <span class="n">Utilities</span><span class="o">.</span><span class="n">doZip</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="c1">################################################################################</span>

<span class="k">def</span> <span class="nf">_writeLatticeLAMMPS</span><span class="p">(</span> <span class="n">filename</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">append</span><span class="p">,</span> <span class="n">zipfile</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write `Lattice` to LAMMPS format file.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="p">(</span> <span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;writing lammps data file using c library: &quot;</span><span class="o">+</span><span class="n">filename</span><span class="p">,</span> <span class="mi">3</span> <span class="p">)</span>
    
    <span class="n">lattice</span><span class="o">.</span><span class="n">specieMassAMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">specieList</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">specieList</span><span class="p">)):</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">specieMassAMU</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">atomicMassAMU</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">specieList</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    
    <span class="n">c_io</span><span class="o">.</span><span class="n">writeLammpsAtomDataFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">specieList</span><span class="p">),</span> <span class="n">lattice</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> 
                                 <span class="n">lattice</span><span class="o">.</span><span class="n">specieMassAMU</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">append</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">zipfile</span><span class="p">:</span>
        <span class="n">Utilities</span><span class="o">.</span><span class="n">doZip</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>


<span class="c1">################################################################################</span>
<div class="viewcode-block" id="readCombinedLatticeFile"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.readCombinedLatticeFile">[docs]</a><span class="k">def</span> <span class="nf">readCombinedLatticeFile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read combined Lattice file.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        The name of the file containing the combined lattice.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    latticeList : list</span>
<span class="sd">        A list of `Lattice` objects that were read in from the file.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Reading combined lattice file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,),</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="n">zipFlag</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">Utilities</span><span class="o">.</span><span class="n">checkForZipped</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    
    <span class="c1"># get NAtoms</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">NAtoms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">dimsArray</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="c1"># get length of file</span>
    <span class="n">lineCount</span> <span class="o">=</span> <span class="n">Utilities</span><span class="o">.</span><span class="n">fileLineCount</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    
    <span class="c1"># how many (complete) lattice in the file</span>
    <span class="n">NLattices</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lineCount</span> <span class="o">/</span> <span class="p">(</span><span class="n">NAtoms</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>    
    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Detected </span><span class="si">%d</span><span class="s2"> lattices in the file&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NLattices</span><span class="p">,),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">NLattices</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    
    <span class="c1"># allocate arrays</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">NAtoms</span> <span class="o">*</span> <span class="n">NLattices</span>
    <span class="n">posArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">chargeArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">specieArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    
    <span class="c1"># need temporary specie list and counter arrays</span>
    <span class="n">maxNumSpecies</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="nb">str</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">specieListTemp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span> <span class="n">maxNumSpecies</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dt</span> <span class="p">)</span> 
    <span class="n">specieCountTemp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span> <span class="n">maxNumSpecies</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span> <span class="p">)</span>
    
    <span class="c1"># call c lib</span>
    <span class="n">c_io</span><span class="o">.</span><span class="n">readCombinedLattice</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">NAtoms</span><span class="p">,</span> <span class="n">NLattices</span><span class="p">,</span> <span class="n">specieArray</span><span class="p">,</span> <span class="n">posArray</span><span class="p">,</span> 
                             <span class="n">chargeArray</span><span class="p">,</span> <span class="n">maxNumSpecies</span><span class="p">,</span> <span class="n">specieListTemp</span><span class="p">,</span> <span class="n">specieCountTemp</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">zipFlag</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    
    <span class="c1"># build specie list and counter in lattice object</span>
    <span class="n">log</span><span class="p">(</span> <span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;building specie list&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>
    <span class="n">NSpecies</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">maxNumSpecies</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">specieListTemp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;XX&#39;</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">NSpecies</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="c1"># allocate specieList/Counter arrays</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="nb">str</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">specieList</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">NSpecies</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">specieCount</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">NSpecies</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">specieMass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">NSpecies</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">specieCovalentRadius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">NSpecies</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">specieRGB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">NSpecies</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">NSpecies</span><span class="p">):</span>
        <span class="n">specieList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">specieListTemp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">specieCount</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">specieCountTemp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="n">specieMass</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">atomicMass</span><span class="p">(</span><span class="n">specieList</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">specieCovalentRadius</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">covalentRadius</span><span class="p">(</span><span class="n">specieList</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">rgbtemp</span> <span class="o">=</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">RGB</span><span class="p">(</span><span class="n">specieList</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">specieRGB</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgbtemp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">specieRGB</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgbtemp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">specieRGB</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgbtemp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;new specie: &quot;</span> <span class="o">+</span> <span class="n">specieListTemp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">atomName</span><span class="p">(</span><span class="n">specieListTemp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">specieCountTemp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">atomName</span><span class="p">(</span><span class="n">specieListTemp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; atoms&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    
    <span class="c1"># now create lattice objects</span>
    <span class="n">latticeList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">appendLattice</span> <span class="o">=</span> <span class="n">latticeList</span><span class="o">.</span><span class="n">append</span>
    <span class="n">dim3</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">NAtoms</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">NLattices</span><span class="p">):</span>
        
        <span class="n">offset</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">dim3</span>
        
        <span class="c1"># create empty lattice object</span>
        <span class="n">lattice</span> <span class="o">=</span> <span class="n">Lattice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># copy stuff</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">NAtoms</span> <span class="o">=</span> <span class="n">NAtoms</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dimsArray</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dimsArray</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dimsArray</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        
        <span class="n">lattice</span><span class="o">.</span><span class="n">specie</span> <span class="o">=</span> <span class="n">specieArray</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">chargeArray</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">specieList</span> <span class="o">=</span> <span class="n">specieList</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">specieCount</span> <span class="o">=</span> <span class="n">specieCount</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">specieMass</span> <span class="o">=</span> <span class="n">specieMass</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">specieCovalentRadius</span> <span class="o">=</span> <span class="n">specieCovalentRadius</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">specieRGB</span> <span class="o">=</span> <span class="n">specieRGB</span>
        
        <span class="n">lattice</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">posArray</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">dim3</span><span class="p">]</span>
        
        <span class="c1"># allocate the correct size force array</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dim3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        
        <span class="c1"># add to lattice list</span>
        <span class="n">appendLattice</span><span class="p">(</span><span class="n">lattice</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">latticeList</span></div>

<span class="c1">################################################################################</span>

<div class="viewcode-block" id="checkLatticeFileIntegrity"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.checkLatticeFileIntegrity">[docs]</a><span class="k">def</span> <span class="nf">checkLatticeFileIntegrity</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check the integrity of a lattice file.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        The name of the file to check.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fileOK : {0, 1}</span>
<span class="sd">        1 means the file is OK, 0 means it is not.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Currently this just checks the line count of the file against the number of atoms.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># check existence</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s2">&quot;.gz&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s2">&quot;.bz2&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>
    
    <span class="c1"># read number of atoms</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">zipFlag</span><span class="p">,</span> <span class="n">filename</span>  <span class="o">=</span> <span class="n">Utilities</span><span class="o">.</span><span class="n">checkForZipped</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">NAtoms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">zipFlag</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    
    <span class="c1"># get line count</span>
    <span class="n">lineCount</span> <span class="o">=</span> <span class="n">Utilities</span><span class="o">.</span><span class="n">fileLineCount</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">lineCount</span> <span class="o">!=</span> <span class="n">NAtoms</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="checkLAMMPSLatticeFileIntegrity"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.checkLAMMPSLatticeFileIntegrity">[docs]</a><span class="k">def</span> <span class="nf">checkLAMMPSLatticeFileIntegrity</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check integrity of lattice file.</span>
<span class="sd">    Currently just does line count and check</span>
<span class="sd">    it matches number of atoms.</span>
<span class="sd">    Returns 1 if file ok, 0 otherwise.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># check existence</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s2">&quot;.gz&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s2">&quot;.bz2&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>
    
    <span class="c1"># read number of atoms</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">zipFlag</span><span class="p">,</span> <span class="n">filename</span>  <span class="o">=</span> <span class="n">Utilities</span><span class="o">.</span><span class="n">checkForZipped</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">NAtoms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">zipFlag</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    
    <span class="c1"># get line count</span>
    <span class="n">lineCount</span> <span class="o">=</span> <span class="n">Utilities</span><span class="o">.</span><span class="n">fileLineCount</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">lineCount</span> <span class="o">!=</span> <span class="n">NAtoms</span> <span class="o">+</span> <span class="mi">13</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span></div>

<span class="c1">################################################################################</span>

<div class="viewcode-block" id="pushSystem"><a class="viewcode-back" href="../../LKMC/LKMC.Lattice.html#LKMC.Lattice.pushSystem">[docs]</a><span class="k">def</span> <span class="nf">pushSystem</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">saddle</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">stepBackPos</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Push a system (typically a saddle point) in the given direction.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    initial : `Lattice`</span>
<span class="sd">        The initial state (from the saddle search).</span>
<span class="sd">    saddle : `Lattice`</span>
<span class="sd">        The saddle point (the `Lattice` that will be &#39;pushed&#39;).</span>
<span class="sd">    params : `Input.InputParams`</span>
<span class="sd">        The parameters object.</span>
<span class="sd">    direction : {0, 1}</span>
<span class="sd">        If 1 we push forwards (away from the initial). If 0 we push back towards</span>
<span class="sd">        the initial.</span>
<span class="sd">    stepBackPos : ndarray, optional</span>
<span class="sd">        If specified this is the position array that will be copied onto the </span>
<span class="sd">        `Lattice` object.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pushedSaddle : `Lattice`</span>
<span class="sd">        The pushed saddle.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">stepBackPos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">barrPushUsingEigenvector</span> <span class="ow">and</span> <span class="p">(</span><span class="n">saddle</span><span class="o">.</span><span class="n">rVector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> 
                <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">saddle</span><span class="o">.</span><span class="n">rVectorIndexes</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">saddle</span><span class="o">.</span><span class="n">rVector</span><span class="p">))):</span>
            
            <span class="c1"># use eigenvector to push</span>
            <span class="n">sepVector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">saddle</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">rVector</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">normalise</span><span class="p">(</span><span class="n">saddle</span><span class="o">.</span><span class="n">rVector</span><span class="p">)</span>
            
            <span class="n">maxMag</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rVector</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">):</span>
                <span class="n">mag</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">rVector</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">mag</span> <span class="o">&gt;</span> <span class="n">maxMag</span><span class="p">:</span>
                    <span class="n">maxMag</span> <span class="o">=</span> <span class="n">mag</span>
            
            <span class="n">sep</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">pushCount</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">saddle</span><span class="o">.</span><span class="n">rVectorIndexes</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">saddle</span><span class="o">.</span><span class="n">currentDefectVolume</span><span class="o">.</span><span class="n">searchMoveVol</span><span class="p">:</span>
                    <span class="n">sepVector</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">rVector</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">sepVector</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rVector</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">sepVector</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">rVector</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
                    
                    <span class="n">pushCount</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># use separation between initial and saddle</span>
            <span class="n">maxMoveIndex</span><span class="p">,</span> <span class="n">maxMove</span><span class="p">,</span> <span class="n">avgMove</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">maxMovement</span><span class="p">(</span><span class="n">initial</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">saddle</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">initial</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
            <span class="n">sepVector</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separationVector</span><span class="p">(</span><span class="n">initial</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">saddle</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">initial</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
            
            <span class="c1"># zero components that haven&#39;t moved far</span>
            <span class="n">pushCount</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">maxMag</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">initial</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sepVector</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sepVector</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sepVector</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                
                <span class="c1"># mag of this atoms movement</span>
                <span class="n">mag</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">sepVector</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
                
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">barrMinFracMaxMoveToPush</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">barrMinFracMaxMoveToPush</span> <span class="o">=</span> <span class="mf">1.0</span>
                
                <span class="n">minMovePush</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">barrMinFracMaxMoveToPush</span> <span class="o">*</span> <span class="n">maxMove</span>
                
                <span class="k">if</span> <span class="n">mag</span> <span class="o">&lt;</span> <span class="n">minMovePush</span><span class="p">:</span>
                    <span class="n">sepVector</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                
                <span class="k">else</span><span class="p">:</span>
<span class="c1">#                     print &quot;DEBUG: PUSH ATOM %d: %f &gt;= %f&quot; % (i, mag, minMovePush)</span>
                    <span class="n">pushCount</span> <span class="o">+=</span> <span class="mi">1</span>
                    
                    <span class="k">if</span> <span class="n">mag</span> <span class="o">&gt;</span> <span class="n">maxMag</span><span class="p">:</span>
                        <span class="n">maxMag</span> <span class="o">=</span> <span class="n">mag</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pushCount</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;WARNING: no atoms to push&quot;</span>
            <span class="k">return</span> <span class="n">saddle</span>
        
<span class="c1">#        sepVector = Vectors.normalise(sepVector)</span>
        
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="c1">#            step = params.barrStepForward #* sep</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">barrStepForwardMethod</span><span class="p">:</span>
                <span class="n">step</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">barrStepForward</span> <span class="o">/</span> <span class="n">maxMag</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">step</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">barrStepForward</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">barrStepBackwards</span> <span class="o">*</span> <span class="n">sep</span>
        
        <span class="n">sepVector</span> <span class="o">*=</span> <span class="n">step</span>
        
        <span class="n">pushMag</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">sepVector</span><span class="p">)</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Pushed </span><span class="si">%d</span><span class="s2"> atoms (mag: </span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pushCount</span><span class="p">,</span> <span class="n">pushMag</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="n">pushedSaddle</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">saddle</span><span class="p">)</span>
        
        <span class="n">Vectors</span><span class="o">.</span><span class="n">addVectorsInplace</span><span class="p">(</span><span class="n">pushedSaddle</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">sepVector</span><span class="p">)</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pushedSaddle</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">saddle</span><span class="p">)</span>
        <span class="n">pushedSaddle</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">stepBackPos</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">pushedSaddle</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">LKMC 150623-1236-g1254817 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, Chris Scott, Tomas Lazauskas, Miao Yu.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.5.
    </div>
  </body>
</html>