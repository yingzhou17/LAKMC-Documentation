<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>LKMC.Images &mdash; LKMC 150623-1236-g1254817 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '150623-1236-g1254817',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="LKMC 150623-1236-g1254817 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">LKMC 150623-1236-g1254817 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for LKMC.Images</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Contains the Images class and associated methods.</span>

<span class="sd">@author: Chris Scott</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">Queue</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Forces</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Utilities</span>
<span class="kn">from</span> <span class="nn">.Utilities</span> <span class="k">import</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Vectors</span>
<span class="kn">from</span> <span class="nn">.clibs</span> <span class="k">import</span> <span class="n">vectors</span> <span class="k">as</span> <span class="n">c_vectors</span>
<span class="kn">from</span> <span class="nn">.clibs</span> <span class="k">import</span> <span class="n">neb</span> <span class="k">as</span> <span class="n">c_neb</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Globals</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Plot</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Lattice</span>


<span class="c1">################################################################################</span>
<span class="c1"># Images class</span>
<span class="c1">################################################################################</span>
<div class="viewcode-block" id="Images"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images">[docs]</a><span class="k">class</span> <span class="nc">Images</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Images class contains a number of images (or states) of a system.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    params : Input.InputParams</span>
<span class="sd">        The input parameters object.</span>
<span class="sd">    numProcs : int, optional</span>
<span class="sd">        The number of processors to use for the force calculation. Defaults</span>
<span class="sd">        to 1.</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    NAtoms : int</span>
<span class="sd">        The total number of atoms in all the (moving) images.</span>
<span class="sd">    imageNAtoms : int</span>
<span class="sd">        The number of atoms in a single image.</span>
<span class="sd">    pos : ndarray</span>
<span class="sd">        The positions of all the atoms from all the images.</span>
<span class="sd">    fixedEndPoints : bool</span>
<span class="sd">        Whether the end points of the band are fixed or not.</span>
<span class="sd">    interpolationMethod : str</span>
<span class="sd">        The method that was used to interpolate the band.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">numProcs</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># non default type? (eg. NEB, Dimer)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calcForceNProcs</span> <span class="o">=</span> <span class="n">numProcs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobID</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixedEndPoints</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failedReason</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NForceCalls</span> <span class="o">=</span> <span class="mi">0</span>
    
<div class="viewcode-block" id="Images.setJobID"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.setJobID">[docs]</a>    <span class="k">def</span> <span class="nf">setJobID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobID</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the job ID.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobID</span> <span class="o">=</span> <span class="n">jobID</span></div>
    
<div class="viewcode-block" id="Images.setParams"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.setParams">[docs]</a>    <span class="k">def</span> <span class="nf">setParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the parameters object.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span></div>
    
<div class="viewcode-block" id="Images.interpolateImages"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.interpolateImages">[docs]</a>    <span class="k">def</span> <span class="nf">interpolateImages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initialState</span><span class="p">,</span> <span class="n">finalState</span><span class="p">,</span> <span class="n">NImages</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">saddleState</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">fixedEndPoints</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stepSize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Interpolate a number of images between initial and final states.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        initialState : `Lattice.Lattice`</span>
<span class="sd">            The initial state for the band of images.</span>
<span class="sd">        finalState : `Lattice.Lattice`</span>
<span class="sd">            The final state for the band of images.</span>
<span class="sd">        NImages : int</span>
<span class="sd">            The number of images to create in total, including the initial and</span>
<span class="sd">            final.</span>
<span class="sd">        method : str, optional</span>
<span class="sd">            The method to use for the interpolation. Currently only support</span>
<span class="sd">            &quot;linear&quot; (&quot;cubicspl&quot; should be added at some point).</span>
<span class="sd">        saddleState : `Lattice.Lattice`, optional</span>
<span class="sd">            If this argument is provided we interpolate from the initial to</span>
<span class="sd">            here and then from here to the final.</span>
<span class="sd">        fixedEndPoints : bool, optional</span>
<span class="sd">            If True then the end points (initial and final) of the band are</span>
<span class="sd">            fixed (i.e. they cannot move). Defaults to True.</span>
<span class="sd">        stepSize : float, optional</span>
<span class="sd">            If `fixedEndPoints` is `False` and this kwarg is set then we step</span>
<span class="sd">            either side of the saddle (towards initial/final) by this amount</span>
<span class="sd">            and use those points as the end points.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#TODO: if we get passed the saddle point and we have moving end points we </span>
        <span class="c1">#      interpolate around the saddle, not all the way to the end points??</span>
        
        
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Setting up images&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">fixedEndPoints</span> <span class="o">=</span> <span class="n">fixedEndPoints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpolationMethod</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storeEnergies</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stepCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stepType</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        
        <span class="c1"># total number of images (NImages becomes number of moving images...)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span> <span class="o">=</span> <span class="n">NImages</span>
        
        <span class="c1"># number of moving images</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixedEndPoints</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NImages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NImages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span>
        
        <span class="c1"># shallow copy (should insert references??)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixedEndPoints</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span> <span class="o">=</span> <span class="n">initialState</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finalState</span> <span class="o">=</span> <span class="n">finalState</span>
                
        <span class="c1"># store the number of minimisation steps here (incremented in minimise module)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NMinimisationSteps</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># number of atoms in each image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">.</span><span class="n">NAtoms</span>
        
        <span class="c1"># symbol and charge arrays stored once, assumed same between images</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specie</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">.</span><span class="n">specie</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">.</span><span class="n">charge</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">.</span><span class="n">cellDims</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieList</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">.</span><span class="n">specieList</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieCount</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">.</span><span class="n">specieCount</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieMass</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">.</span><span class="n">specieMass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieMassAMU</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">.</span><span class="n">specieMassAMU</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieCovalentRadius</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">.</span><span class="n">specieCovalentRadius</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specieRGB</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">.</span><span class="n">specieRGB</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">KE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        
        <span class="c1"># number of &quot;moving&quot; atoms (initial and final states are fixed)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImages</span>
        
        <span class="c1"># create arrays for storing positions, forces and energies of the images</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImages</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">totalEnergy</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxForce</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imageMaxForce</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImages</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxEnergyImage</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxEnergy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resetLammps</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">barrierEstTime</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="c1"># defects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defectList</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">initialState</span><span class="o">.</span><span class="n">defectList</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">initialState</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">NDefects</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">initialState</span><span class="o">.</span><span class="n">NDefects</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NSubSystem</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">initialState</span><span class="o">.</span><span class="n">NSubSystem</span><span class="p">)</span>
            
    
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixedEndPoints</span><span class="p">:</span>
            <span class="c1"># now get the total energy of initial and final states</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;calculating forces on initial and final states&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">calcForce</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Initial state force calculation failed.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalState</span><span class="o">.</span><span class="n">calcForce</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Final state force calculation failed&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">totalEnergy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalState</span><span class="o">.</span><span class="n">totalEnergy</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># all images are moving so we store every image in the same array</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finalState</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="k">if</span> <span class="n">saddleState</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">stepSize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;DEBUG: interpolating moving string end points from saddle (step size: </span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">stepSize</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                
                <span class="c1"># first image</span>
                <span class="n">iniSadSepVec</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separationVector</span><span class="p">(</span><span class="n">saddleState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">initialState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">getImagePos</span><span class="p">(</span><span class="mi">0</span><span class="p">)[:]</span> <span class="o">=</span> <span class="n">saddleState</span><span class="o">.</span><span class="n">pos</span><span class="p">[:]</span> <span class="o">+</span> <span class="n">stepSize</span> <span class="o">*</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">normalise</span><span class="p">(</span><span class="n">iniSadSepVec</span><span class="p">)[:]</span>
                <span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getImagePos</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">saddleState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepSize</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">5</span>
                <span class="c1">#TODO: couple of step minimisation (constrained step size?)</span>
                
                <span class="c1"># last image</span>
                <span class="n">sadFinSepVec</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separationVector</span><span class="p">(</span><span class="n">saddleState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">finalState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">getImagePos</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)[:]</span> <span class="o">=</span> <span class="n">saddleState</span><span class="o">.</span><span class="n">pos</span><span class="p">[:]</span> <span class="o">+</span> <span class="n">stepSize</span> <span class="o">*</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">normalise</span><span class="p">(</span><span class="n">sadFinSepVec</span><span class="p">)[:]</span>
                <span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getImagePos</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">saddleState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepSize</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">5</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># first image - initial state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[:</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">.</span><span class="n">pos</span><span class="p">[:]</span>
                
                <span class="c1"># last image - final state</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">offset</span><span class="p">:]</span> <span class="o">=</span> <span class="n">finalState</span><span class="o">.</span><span class="n">pos</span><span class="p">[:]</span>
        
        <span class="c1"># now we interpolate the intermediate images</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolationMethod</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interpolateImagesLinear</span><span class="p">(</span><span class="n">saddleState</span><span class="o">=</span><span class="n">saddleState</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolationMethod</span> <span class="o">==</span> <span class="s2">&quot;IDPP&quot;</span><span class="p">:</span>
            <span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_interpolateImagesIDPP</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">status</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Unrecognised interpolation method: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolationMethod</span><span class="p">)</span></div>
        
    <span class="k">def</span> <span class="nf">_interpolateImagesIDPP</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This should be overriden.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Images._interpolateImagesIDPP has not been implemented&quot;</span><span class="p">)</span> 
       
    <span class="k">def</span> <span class="nf">_interpolateImagesLinear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saddleState</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Linear interpolation of the images.&quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Interpolating images (linear)&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixedEndPoints</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">saddleState</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># get vector separating initial and final configurations</span>
                <span class="n">sepVec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageSeparationVector</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initialLength</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">sepVec</span><span class="p">)</span>
                
                <span class="c1"># separation between images</span>
                <span class="n">imageSepVec</span> <span class="o">=</span> <span class="n">sepVec</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">idealImageSpacing</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">imageSepVec</span><span class="p">)</span>
                
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Initial to final separation: </span><span class="si">%f</span><span class="s2">. Interimage separation: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialLength</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">idealImageSpacing</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                
                <span class="c1">#TODO: write in C</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Image </span><span class="si">%d</span><span class="s2"> separation from initial: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">imageSepVec</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span>  <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span>  <span class="p">]</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">imageSepVec</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">imageSepVec</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">imageSepVec</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>        
            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Interpolating moving end point Images to saddle and down...&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                
                <span class="c1"># the index of the given saddle point</span>
                <span class="n">saddleIndex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImages</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Saddle index is </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%d</span><span class="s2"> images)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">saddleIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImages</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="c1"># add saddle positions</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">getImagePos</span><span class="p">(</span><span class="n">saddleIndex</span><span class="p">)[:]</span> <span class="o">=</span> <span class="n">saddleState</span><span class="o">.</span><span class="n">pos</span><span class="p">[:]</span>
                
                <span class="c1"># separation between initial and saddle</span>
                <span class="n">sepVec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageSeparationVector</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">saddleIndex</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initialLength</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">sepVec</span><span class="p">)</span>
                <span class="n">imageSepVec</span> <span class="o">=</span> <span class="n">sepVec</span> <span class="o">/</span> <span class="n">saddleIndex</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Separation between initial and saddle: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialLength</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="c1"># initial position</span>
                <span class="n">iniPos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getImagePos</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                
                <span class="c1"># interpolate up to saddle</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">saddleIndex</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">getImagePos</span><span class="p">(</span><span class="n">i</span><span class="p">)[:]</span> <span class="o">=</span> <span class="n">iniPos</span><span class="p">[:]</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">imageSepVec</span><span class="p">[:]</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Image </span><span class="si">%d</span><span class="s2"> separation from initial: </span><span class="si">%f</span><span class="s2"> (expected </span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageSeparation</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
                                                                                          <span class="n">Vectors</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">imageSepVec</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="c1"># separation between saddle and final</span>
                <span class="n">numImages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImages</span> <span class="o">-</span> <span class="n">saddleIndex</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">sepVec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageSeparationVector</span><span class="p">(</span><span class="n">saddleIndex</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initialLength</span> <span class="o">+=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">sepVec</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">idealImageSpacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialLength</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">imageSepVec</span> <span class="o">=</span> <span class="n">sepVec</span> <span class="o">/</span> <span class="n">numImages</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Separation between saddle and final: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">sepVec</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="c1"># saddle position</span>
                <span class="n">sadPos</span> <span class="o">=</span> <span class="n">saddleState</span><span class="o">.</span><span class="n">pos</span>
                
                <span class="c1"># interpolate from saddle to final</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">saddleIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">getImagePos</span><span class="p">(</span><span class="n">i</span><span class="p">)[:]</span> <span class="o">=</span> <span class="n">sadPos</span> <span class="o">+</span> <span class="n">count</span> <span class="o">*</span> <span class="n">imageSepVec</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Image </span><span class="si">%d</span><span class="s2"> separation from saddle: </span><span class="si">%f</span><span class="s2"> (expected </span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageSeparation</span><span class="p">(</span><span class="n">saddleIndex</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
                                                                                         <span class="n">Vectors</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="n">imageSepVec</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">saddleState</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># get vector separating initial and final configurations</span>
                <span class="n">sepVec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageSeparationVector</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initialLength</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">sepVec</span><span class="p">)</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Initial to final separation: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialLength</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    
                <span class="c1"># separation between images</span>
                <span class="n">imageSepVec</span> <span class="o">=</span> <span class="n">sepVec</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">idealImageSpacing</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">imageSepVec</span><span class="p">)</span>
                    
                <span class="c1"># now interpolate intermediate images</span>
                <span class="c1">#TODO: write this in C</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImages</span><span class="p">):</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Image </span><span class="si">%d</span><span class="s2"> separation from initial: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">imageSepVec</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">imageSepVec</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">imageSepVec</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">imageSepVec</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># calculating separation between initial and saddle states</span>
                <span class="n">sepIniToSad</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">saddleState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
               
                <span class="c1"># calculating separation between saddle and final states</span>
                <span class="n">sepSadToFin</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">saddleState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
                
                <span class="c1"># total separation</span>
                <span class="n">sepInToFin</span> <span class="o">=</span> <span class="n">sepIniToSad</span> <span class="o">+</span> <span class="n">sepSadToFin</span>
                
                <span class="c1"># number of seps between initial and saddle lattices</span>
                <span class="n">sepCntIniToSad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NImages</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">sepIniToSad</span> <span class="o">/</span> <span class="n">sepInToFin</span><span class="p">))</span>
                
                <span class="c1"># check minimum and maximum values</span>
                <span class="k">if</span> <span class="n">sepCntIniToSad</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">sepCntIniToSad</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">sepCntIniToSad</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImages</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">sepCntIniToSad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImages</span>
                
                <span class="c1"># number of seps between saddle and final lattices</span>
                <span class="n">sepCntSadToFin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImages</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sepCntIniToSad</span>
                
                <span class="c1"># getting saddle point&#39;s image number</span>
                <span class="n">saddleImageNo</span> <span class="o">=</span> <span class="n">sepCntIniToSad</span>
                
                <span class="c1"># creating first part of images (from initial lattice to saddle point)  </span>
                <span class="n">sepVec</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separationVector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">saddleState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initialLength</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">sepVec</span><span class="p">)</span>
                
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;INI TO SADDLE SEPARATION IS: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialLength</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">imageSepVec</span> <span class="o">=</span> <span class="n">sepVec</span> <span class="o">/</span> <span class="n">sepCntIniToSad</span>
                
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">sepCntIniToSad</span><span class="p">):</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;IMAGE </span><span class="si">%d</span><span class="s2"> SEP FROM INI: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">imageSepVec</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span>  <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span>  <span class="p">]</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">imageSepVec</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span>  <span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">imageSepVec</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">imageSepVec</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
                
                <span class="c1"># putting saddle point positions</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;IMAGE </span><span class="si">%d</span><span class="s2"> SADDLE POINT&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">saddleImageNo</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">saddleImageNo</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span>
                
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span><span class="p">):</span>                
                    <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">saddleState</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">saddleState</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">saddleState</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
                
                <span class="c1"># creating second half of images</span>
                <span class="n">sepVec</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separationVector</span><span class="p">(</span><span class="n">saddleState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initialLength</span> <span class="o">+=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">sepVec</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">idealImageSpacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialLength</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;SADDLE TO FIN SEPARATION IS: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">sepVec</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                
                <span class="n">imageSepVec</span> <span class="o">=</span> <span class="n">sepVec</span> <span class="o">/</span> <span class="p">(</span><span class="n">sepCntSadToFin</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">sepCntSadToFin</span><span class="p">):</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">saddleImageNo</span> <span class="o">+</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span>
                    
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;IMAGE </span><span class="si">%d</span><span class="s2"> SEP FROM SADDLE: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">saddleImageNo</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="n">Vectors</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">imageSepVec</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span>  <span class="p">]</span> <span class="o">=</span> <span class="n">saddleState</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span>  <span class="p">]</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">imageSepVec</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span>  <span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">saddleState</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">imageSepVec</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">saddleState</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">imageSepVec</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
                         
            <span class="c1">#TODO: check for bad interpolation</span>
                  
        
<div class="viewcode-block" id="Images.returnImageAsLattice"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.returnImageAsLattice">[docs]</a>    <span class="k">def</span> <span class="nf">returnImageAsLattice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imageNumber</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return one of the images as a lattice object.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        imageNumber : int</span>
<span class="sd">            The index of the image to return (includes fixed images if any).</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        imageLattice : Lattice.Lattice</span>
<span class="sd">            The image as a `Lattice` object.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        IndexError</span>
<span class="sd">            If the specified image index is out of range.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">imageNumber</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">imageNumber</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImages</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Bad image index&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixedEndPoints</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">imageNumber</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span>
            
            <span class="k">elif</span> <span class="n">imageNumber</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalState</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">offset1</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span> <span class="o">*</span> <span class="p">(</span><span class="n">imageNumber</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">offset2</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span> <span class="o">*</span> <span class="n">imageNumber</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">offset1</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span> <span class="o">*</span> <span class="n">imageNumber</span>
            <span class="n">offset2</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span> <span class="o">*</span> <span class="p">(</span><span class="n">imageNumber</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># make a new Lattice object</span>
        <span class="n">imageLattice</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">Lattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span><span class="p">)</span>
        <span class="n">imageLattice</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">[:]</span>
        <span class="n">imageLattice</span><span class="o">.</span><span class="n">charge</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">[:]</span>
        <span class="n">imageLattice</span><span class="o">.</span><span class="n">specie</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specie</span><span class="p">[:]</span>
        <span class="n">imageLattice</span><span class="o">.</span><span class="n">specieList</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieList</span><span class="p">)</span>
        <span class="n">imageLattice</span><span class="o">.</span><span class="n">specieCount</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieCount</span><span class="p">)</span>
        <span class="n">imageLattice</span><span class="o">.</span><span class="n">totalEnergy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">imageNumber</span><span class="p">]</span>
        <span class="n">imageLattice</span><span class="o">.</span><span class="n">specieMass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specieMass</span>
        <span class="n">imageLattice</span><span class="o">.</span><span class="n">specieCovalentRadius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specieCovalentRadius</span>
        <span class="n">imageLattice</span><span class="o">.</span><span class="n">specieRGB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specieRGB</span>     
        <span class="n">imageLattice</span><span class="o">.</span><span class="n">pos</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">offset1</span><span class="p">:</span><span class="n">offset2</span><span class="p">]</span>
        <span class="n">imageLattice</span><span class="o">.</span><span class="n">force</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">[</span><span class="n">offset1</span><span class="p">:</span><span class="n">offset2</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">imageLattice</span></div>
    
<div class="viewcode-block" id="Images.getMaxEnergyImage"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.getMaxEnergyImage">[docs]</a>    <span class="k">def</span> <span class="nf">getMaxEnergyImage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the image with the highest energy.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        maxEnergyImage : Lattice</span>
<span class="sd">            The Lattice containing the images with the highest energy.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">returnImageAsLattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxEnergyImage</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Images.normaliseForce"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.normaliseForce">[docs]</a>    <span class="k">def</span> <span class="nf">normaliseForce</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Normalise the force vector.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">normalise</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Images.calcForce"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.calcForce">[docs]</a>    <span class="k">def</span> <span class="nf">calcForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">NProcs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">defectFlag</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the forces acting on each image.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        NProcs : int, optional</span>
<span class="sd">            The number of processors to use for the force calculation. If set</span>
<span class="sd">            it overrides `self.calcForceNProcs`.</span>
<span class="sd">        </span>
<span class="sd">        defectFlag : int, optional</span>
<span class="sd">            Gets passed directly to `Forces.calcForce`.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;calculating forces on moving images&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        
        <span class="c1"># number of processors to use</span>
        <span class="k">if</span> <span class="n">NProcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">NProcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcForceNProcs</span>
        
        <span class="c1"># we calculate forces separately for each image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">totalEnergy</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxEnergy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxEnergyImage</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxForce</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">energySum</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="c1"># serial</span>
        <span class="k">if</span> <span class="n">NProcs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImages</span><span class="p">):</span>
                <span class="c1"># calc force</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">Forces</span><span class="o">.</span><span class="n">calcForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">defectFlag</span><span class="o">=</span><span class="n">defectFlag</span><span class="p">)</span>
                <span class="c1">#self.NForceCalls += 1</span>
                <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;NEB FORCE CALC FAILED ON IMAGE&quot;</span><span class="p">,</span> <span class="n">i</span>
                    <span class="k">return</span> <span class="n">status</span>
                
                <span class="c1"># store useful data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalEnergy</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixedEndPoints</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalEnergy</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalEnergy</span>
                <span class="n">energySum</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalEnergy</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imageMaxForce</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxForce</span>
        
        <span class="c1"># parallel</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">jobQ</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
            <span class="n">resultQ</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
            
            <span class="c1"># add jobs</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImages</span><span class="p">):</span>
                <span class="n">imageIndex</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixedEndPoints</span> <span class="k">else</span> <span class="n">i</span>
                <span class="n">jobQ</span><span class="o">.</span><span class="n">put</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">returnImageAsLattice</span><span class="p">(</span><span class="n">imageIndex</span><span class="p">)])</span>
            
            <span class="c1"># add exit commands</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">NProcs</span><span class="p">):</span>
                <span class="n">jobQ</span><span class="o">.</span><span class="n">put</span><span class="p">([</span><span class="s2">&quot;EXIT&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
            
            <span class="c1"># start workers</span>
            <span class="n">workers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">NProcs</span><span class="p">):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_imagesCalcForceWorker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">jobQ</span><span class="p">,</span> <span class="n">resultQ</span><span class="p">))</span>
                <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="n">workers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            
            <span class="c1"># get results</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImages</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">resultQ</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                
                <span class="n">status</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;NEB FORCE CALC FAILED ON IMAGE&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">workers</span><span class="p">:</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">workers</span><span class="p">:</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">status</span>
                
                <span class="n">index</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">totalEnergy</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">maxForce</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergy</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">totalEnergy</span>
                <span class="n">energySum</span> <span class="o">+=</span> <span class="n">totalEnergy</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixedEndPoints</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">totalEnergy</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">totalEnergy</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imageMaxForce</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxForce</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">index</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">workers</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">totalEnergy</span> <span class="o">=</span> <span class="n">energySum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxForce</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageMaxForce</span><span class="p">)</span>
        
        <span class="c1"># find maximum energy image and max force</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxEnergy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxEnergyImage</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxEnergy</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">maxEnergy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">maxEnergyImage</span> <span class="o">=</span> <span class="n">i</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxForce</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageMaxForce</span><span class="p">)</span>
        
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;total energy is </span><span class="si">%lf</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">totalEnergy</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">postCalcForceUpdate</span><span class="p">()</span></div>

        
<div class="viewcode-block" id="Images.postCalcForceUpdate"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.postCalcForceUpdate">[docs]</a>    <span class="k">def</span> <span class="nf">postCalcForceUpdate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is called at the end of calcForce and </span>
<span class="sd">        should be subclassed if required (eg. in NEB).</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
    
<div class="viewcode-block" id="Images.specieIndex"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.specieIndex">[docs]</a>    <span class="k">def</span> <span class="nf">specieIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sym</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return index of given symbol in the species list.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sym : str[2]</span>
<span class="sd">            The two-character symbol of the species to locate.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        specieIndex : int</span>
<span class="sd">            The index of the given species in `Images.specieList`.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If the species list is empty.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieList</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Species list is empty&quot;</span><span class="p">)</span>
        
        <span class="n">match</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specieList</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">sym</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">specieList</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">specieIndex</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not find symbol &#39;</span><span class="si">%s</span><span class="s2">&#39; in species list&quot;</span> <span class="o">%</span> <span class="n">sym</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">specieIndex</span></div>
    
<div class="viewcode-block" id="Images.getForcePerpendicular"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.getForcePerpendicular">[docs]</a>    <span class="k">def</span> <span class="nf">getForcePerpendicular</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This method is for compatability only, it does nothing.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
    
<div class="viewcode-block" id="Images.imageSeparationVector"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.imageSeparationVector">[docs]</a>    <span class="k">def</span> <span class="nf">imageSeparationVector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image1</span><span class="p">,</span> <span class="n">image2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the separation vector between two images.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        image1 : int</span>
<span class="sd">            The index of the first image (0 &lt;= `image1` &lt; `self.NImagesTotal`).</span>
<span class="sd">        image2 : int</span>
<span class="sd">            The index of the first image (0 &lt;= `image2` &lt; `self.NImagesTotal`).</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        sepVec : ndarray</span>
<span class="sd">            The separation vectors between the two images.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If image1 and image2 are not numbered correctly.</span>
<span class="sd">        </span>
<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        This calculates image2 - image1. The indexes (image1 and image2)</span>
<span class="sd">        include the fixed images (if any).</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">image1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">image1</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span>
        <span class="k">if</span> <span class="n">image2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">image2</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span>
        
        <span class="k">if</span> <span class="n">image1</span> <span class="o">&gt;</span> <span class="n">image2</span> <span class="ow">or</span> <span class="n">image1</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">image2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad values for images (</span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">image1</span><span class="p">,</span> <span class="n">image2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">image1</span> <span class="o">==</span> <span class="n">image2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        
        <span class="c1"># there are a number of cases we must deal with...</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixedEndPoints</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">image1</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">image2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># both fixed points</span>
                <span class="n">sepVec</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separationVector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">image1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># image one is initial state</span>
                <span class="n">sepVec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                <span class="n">c_vectors</span><span class="o">.</span><span class="n">imageSeparationVector_fixed</span><span class="p">(</span><span class="n">sepVec</span><span class="p">,</span> <span class="n">image1</span><span class="p">,</span> <span class="n">image2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">image2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># image two is final state</span>
                <span class="n">sepVec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                <span class="n">c_vectors</span><span class="o">.</span><span class="n">imageSeparationVector_fixed</span><span class="p">(</span><span class="n">sepVec</span><span class="p">,</span> <span class="n">image1</span><span class="p">,</span> <span class="n">image2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># both moving images (we modify the index because the end points are not in pos)</span>
                <span class="n">sepVec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                <span class="n">c_vectors</span><span class="o">.</span><span class="n">imageSeparationVector</span><span class="p">(</span><span class="n">sepVec</span><span class="p">,</span> <span class="n">image1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">image2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No matter what, calculate both images as moving ones</span>
            <span class="n">sepVec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">c_vectors</span><span class="o">.</span><span class="n">imageSeparationVector</span><span class="p">(</span><span class="n">sepVec</span><span class="p">,</span> <span class="n">image1</span><span class="p">,</span> <span class="n">image2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">sepVec</span></div>
    
<div class="viewcode-block" id="Images.imageSeparation"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.imageSeparation">[docs]</a>    <span class="k">def</span> <span class="nf">imageSeparation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image1</span><span class="p">,</span> <span class="n">image2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return magnitude of separation vector between two images.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        image1 : int</span>
<span class="sd">            The index of the first image (0 &lt;= `image1` &lt; self.NImagesTotal).</span>
<span class="sd">        image2 : int</span>
<span class="sd">            The index of the first image (0 &lt;= `image2` &lt; self.NImagesTotal).</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mag : float</span>
<span class="sd">            The magnitude of the separation between the two images.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If image1 and image2 are not numbered correctly.</span>
<span class="sd">        </span>
<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        This calculates |image2 - image1|. The indexes (image1 and image2)</span>
<span class="sd">        include the fixed images (if any).</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">image1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">image1</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span>
        <span class="k">if</span> <span class="n">image2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">image2</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span>
        
        <span class="k">if</span> <span class="n">image1</span> <span class="o">&gt;</span> <span class="n">image2</span> <span class="ow">or</span> <span class="n">image1</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">image2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad values for images (</span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">image1</span><span class="p">,</span> <span class="n">image2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">image1</span> <span class="o">==</span> <span class="n">image2</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        
        <span class="c1"># there are a number of cases we must deal with...</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixedEndPoints</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">image1</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">image2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># separation between the fixed end points</span>
                <span class="n">mag</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
                
            <span class="k">elif</span> <span class="n">image1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># image one is initial state</span>
                <span class="n">mag</span> <span class="o">=</span> <span class="n">c_vectors</span><span class="o">.</span><span class="n">imageSeparationMagnitude_fixed</span><span class="p">(</span><span class="n">image1</span><span class="p">,</span> <span class="n">image2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">image2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># image two is final state</span>
                <span class="n">mag</span> <span class="o">=</span> <span class="n">c_vectors</span><span class="o">.</span><span class="n">imageSeparationMagnitude_fixed</span><span class="p">(</span><span class="n">image1</span><span class="p">,</span> <span class="n">image2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># both moving images (we modify the index because the end points are not in pos)</span>
                <span class="n">mag</span> <span class="o">=</span> <span class="n">c_vectors</span><span class="o">.</span><span class="n">imageSeparationMagnitude</span><span class="p">(</span><span class="n">image1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">image2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># all images are moving</span>
            <span class="n">mag</span> <span class="o">=</span> <span class="n">c_vectors</span><span class="o">.</span><span class="n">imageSeparationMagnitude</span><span class="p">(</span><span class="n">image1</span><span class="p">,</span> <span class="n">image2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">Globals</span><span class="o">.</span><span class="n">PBC</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">mag</span></div>
    
<div class="viewcode-block" id="Images.calculateTangentVector"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.calculateTangentVector">[docs]</a>    <span class="k">def</span> <span class="nf">calculateTangentVector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the normalised tangent vector at the given image.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        image : int</span>
<span class="sd">            The index of the image to calculate the tangent vector at</span>
<span class="sd">            (0 &lt;= `image` &lt; `self.NImagesTotal`).</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tau : ndarray</span>
<span class="sd">            The tangent vector at the image.</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        We use the method from http://dx.doi.org/10.1063/1.1323224</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># estimate the tangent vector, tau, at this image</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">image</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">image</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">image</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">normalise</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageSeparationVector</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">image</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">image</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">image</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">image</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">normalise</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageSeparationVector</span><span class="p">(</span><span class="n">image</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">image</span><span class="p">))</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># tangent is weighted by energy when close to extrema, to smoothly switch between above cases</span>
            <span class="n">energyDiffForward</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">image</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">image</span><span class="p">])</span> 
            <span class="n">energyDiffBackward</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">image</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">image</span><span class="p">])</span>
            
            <span class="n">VMax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">energyDiffForward</span><span class="p">,</span> <span class="n">energyDiffBackward</span><span class="p">)</span>
            <span class="n">VMin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">energyDiffForward</span><span class="p">,</span> <span class="n">energyDiffBackward</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">image</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">image</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="n">tau</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">normalise</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageSeparationVector</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">image</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">VMax</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageSeparationVector</span><span class="p">(</span><span class="n">image</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span> <span class="o">*</span> <span class="n">VMin</span><span class="p">)</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tau</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">normalise</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageSeparationVector</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">image</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">VMin</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageSeparationVector</span><span class="p">(</span><span class="n">image</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span> <span class="o">*</span> <span class="n">VMax</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">tau</span></div>
    
<div class="viewcode-block" id="Images.plotBarrierImage"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.plotBarrierImage">[docs]</a>    <span class="k">def</span> <span class="nf">plotBarrierImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">useInterp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">initialEnergy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the relative energies of the images against image numbers.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            The name of the file to save the graph to (without suffix!).</span>
<span class="sd">        label : str, optional</span>
<span class="sd">            Add this label for the points on the graph (eg. &quot;NEB&quot; or &quot;String&quot;).</span>
<span class="sd">        ymax : index, optional</span>
<span class="sd">            Specify the index of the max image (deprecated).</span>
<span class="sd">        useInterp : bool, optional</span>
<span class="sd">            Draw a curve between the points using Stineman interpolation.</span>
<span class="sd">            Defaults to True.</span>
<span class="sd">        initialEnergy : float, optional</span>
<span class="sd">            If set this is used for the relative energy calculation.</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If the end points are not fixed it is important to either set the</span>
<span class="sd">        `Images.initialEnergy` attribute or the `initialEnergy` kwarg so that</span>
<span class="sd">        the relative energies are calculated correctly.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initial state energy (default to first image if not set)</span>
        <span class="k">if</span> <span class="n">initialEnergy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialEnergy</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;initialEnergy&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">initialEnergy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">initialEnergy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># calculate relative energies</span>
        <span class="n">barriers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="p">):</span>
            <span class="n">barriers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">initialEnergy</span>
        
        <span class="c1"># plot</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">linePlot</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="p">),</span> <span class="s2">&quot;Image&quot;</span><span class="p">,</span> <span class="n">barriers</span><span class="p">,</span> <span class="s2">&quot;Relative energy (eV)&quot;</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                      <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Forward barrier = </span><span class="si">%f</span><span class="s2"> eV&quot;</span> <span class="o">%</span> <span class="nb">max</span><span class="p">(</span><span class="n">barriers</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">useInterp</span><span class="o">=</span><span class="n">useInterp</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Images.plotBarrierSeparation"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.plotBarrierSeparation">[docs]</a>    <span class="k">def</span> <span class="nf">plotBarrierSeparation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">useInterp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">initialEnergy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                              <span class="n">initialPos</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the relative energies of the images against image separation.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            The name of the file to save the graph to (without suffix!).</span>
<span class="sd">        label : str, optional</span>
<span class="sd">            Add this label for the points on the graph (eg. &quot;NEB&quot; or &quot;String&quot;).</span>
<span class="sd">        ymax : index, optional</span>
<span class="sd">            Specify the index of the max image (deprecated).</span>
<span class="sd">        useInterp : bool, optional</span>
<span class="sd">            Draw a curve between the points using Stineman interpolation.</span>
<span class="sd">            Defaults to True.</span>
<span class="sd">        initialEnergy : float, optional</span>
<span class="sd">            If set this is used for the relative energy calculation.</span>
<span class="sd">        initialPos : ndarray, optional</span>
<span class="sd">            If set we use this array for the separation calculation.</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If the end points are not fixed it is important to either set the</span>
<span class="sd">        `Images.initialEnergy` attribute or the `initialEnergy` kwarg so that</span>
<span class="sd">        the relative energies are calculated correctly.</span>
<span class="sd">        </span>
<span class="sd">        Image separation is the piecewise linear separation from the initial</span>
<span class="sd">        image. If the `Images.initialPos` attribute or the `initialPos` kwarg</span>
<span class="sd">        is set we use that for the separation calculation. </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initial state energy</span>
        <span class="k">if</span> <span class="n">initialEnergy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialEnergy</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;initialEnergy&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">initialEnergy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">initialEnergy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># initial state position</span>
        <span class="k">if</span> <span class="n">initialPos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialPos</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;initialPos&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">initialPos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">initialPos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getImagePos</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># calculate separations and relative energies</span>
        <span class="n">barriers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">seps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="p">):</span>
            <span class="c1"># barrier</span>
            <span class="n">barriers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">initialEnergy</span>
            
            <span class="c1"># separation</span>
            <span class="n">seps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">initialPos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getImagePos</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">seps</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageSeparation</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        
        <span class="c1"># plot</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">linePlot</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">seps</span><span class="p">,</span> <span class="s2">ur&quot;Image separation (\u00c5)&quot;</span><span class="p">,</span> <span class="n">barriers</span><span class="p">,</span> <span class="s2">&quot;Relative energy (eV)&quot;</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                      <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Forward barrier = </span><span class="si">%f</span><span class="s2"> eV&quot;</span> <span class="o">%</span> <span class="nb">max</span><span class="p">(</span><span class="n">barriers</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">useInterp</span><span class="o">=</span><span class="n">useInterp</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Images.analysePathway"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.analysePathway">[docs]</a>    <span class="k">def</span> <span class="nf">analysePathway</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyse the pathway (looking for multiple minima).</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tolerance : float</span>
<span class="sd">            The tolerance used for detecting if a minima is significant. A</span>
<span class="sd">            typical value might be 0.1. (TODO: this needs explaining...)</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        transOK : bool</span>
<span class="sd">            True if the transitions pathway of acceptable; False if there are</span>
<span class="sd">            multiple (significant) minima along the path.</span>
<span class="sd">        firstMinIndex : int</span>
<span class="sd">            If TransOK is False then this is the index of the image that is the</span>
<span class="sd">            first minimum along the path.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># first image</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">mins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;MIN&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;MAX&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        
        <span class="c1"># intermediate images</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;MAX&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
            
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">mins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;MIN&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
        
        <span class="c1"># final image</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">mins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;MIN&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;MAX&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="c1"># find maximum energy change</span>
        <span class="n">maxEChange</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">EChange</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">transOK</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">extreme</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">extremeNext</span><span class="p">,</span> <span class="n">indexNext</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                
                <span class="n">leftChange</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">rightChange</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">indexNext</span><span class="p">])</span>
                
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">extreme</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">extremePrev</span><span class="p">,</span> <span class="n">indexPrev</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                
                <span class="n">leftChange</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">indexPrev</span><span class="p">])</span>
                <span class="n">rightChange</span> <span class="o">=</span> <span class="mf">0.0</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">extreme</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">extremePrev</span><span class="p">,</span> <span class="n">indexPrev</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">extremeNext</span><span class="p">,</span> <span class="n">indexNext</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                
                <span class="n">leftChange</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">indexPrev</span><span class="p">])</span>
                <span class="n">rightChange</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">indexNext</span><span class="p">])</span>
            
            <span class="n">extPointMaxEChange</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">leftChange</span><span class="p">,</span> <span class="n">rightChange</span><span class="p">)</span>
            <span class="n">maxEChange</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxEChange</span><span class="p">,</span> <span class="n">extPointMaxEChange</span><span class="p">)</span>
            
            <span class="n">EChange</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">leftChange</span><span class="p">,</span> <span class="n">rightChange</span><span class="p">))</span>
            
            <span class="nb">print</span> <span class="n">i</span><span class="p">,</span> <span class="n">extreme</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">leftChange</span><span class="p">,</span> <span class="n">rightChange</span><span class="p">,</span> <span class="n">extPointMaxEChange</span><span class="p">,</span> <span class="n">maxEChange</span>
        
        <span class="n">maxEChange</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxEChange</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">maxEnergyImage</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
            <span class="n">extreme</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">EChngRatio</span> <span class="o">=</span> <span class="mf">0.0</span>
            
            <span class="k">if</span> <span class="n">extreme</span> <span class="o">==</span> <span class="s2">&quot;MIN&quot;</span><span class="p">:</span>
                <span class="n">leftChange</span><span class="p">,</span> <span class="n">rightChange</span> <span class="o">=</span> <span class="n">EChange</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxEnergyImage</span><span class="p">:</span>
                    <span class="n">EChngRatio</span> <span class="o">=</span> <span class="n">leftChange</span> <span class="o">/</span> <span class="n">maxEChange</span>
                
                <span class="k">elif</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxEnergyImage</span><span class="p">:</span>
                    <span class="n">EChngRatio</span> <span class="o">=</span> <span class="n">rightChange</span> <span class="o">/</span> <span class="n">maxEChange</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">EChngRatio</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">leftChange</span> <span class="o">/</span> <span class="n">maxEChange</span><span class="p">,</span> <span class="n">rightChange</span> <span class="o">/</span> <span class="n">maxEChange</span><span class="p">)</span>
              
                <span class="k">if</span> <span class="n">EChngRatio</span> <span class="o">&gt;</span> <span class="n">tolerance</span><span class="p">:</span>
                    <span class="n">transOK</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
        
        <span class="c1"># also find first minimum not 0</span>
        <span class="n">firstMinIndex</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">transOK</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
                <span class="n">extreme</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">extreme</span> <span class="o">==</span> <span class="s2">&quot;MIN&quot;</span><span class="p">:</span>
                    <span class="n">leftChange</span><span class="p">,</span> <span class="n">rightChange</span> <span class="o">=</span> <span class="n">EChange</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxEnergyImage</span><span class="p">:</span>
                        <span class="n">EChngRatio</span> <span class="o">=</span> <span class="n">leftChange</span> <span class="o">/</span> <span class="n">maxEChange</span>
                    
                    <span class="k">elif</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxEnergyImage</span><span class="p">:</span>
                        <span class="n">EChngRatio</span> <span class="o">=</span> <span class="n">rightChange</span> <span class="o">/</span> <span class="n">maxEChange</span>
                    
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">EChngRatio</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">leftChange</span> <span class="o">/</span> <span class="n">maxEChange</span><span class="p">,</span> <span class="n">rightChange</span> <span class="o">/</span> <span class="n">maxEChange</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">EChngRatio</span> <span class="o">&gt;</span> <span class="n">tolerance</span><span class="p">:</span>
                        <span class="n">firstMinIndex</span> <span class="o">=</span> <span class="n">index</span>
                        <span class="k">break</span>
        
        <span class="k">return</span> <span class="n">transOK</span><span class="p">,</span> <span class="n">firstMinIndex</span></div>
    
<div class="viewcode-block" id="Images.getBarrier"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.getBarrier">[docs]</a>    <span class="k">def</span> <span class="nf">getBarrier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initialEnergy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the forward barrier of the transition.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        initialEnergy : float, optional</span>
<span class="sd">            If set this is used for the relative energy calculation.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        barrier : float</span>
<span class="sd">            The energy barrier.</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If the end points are not fixed it is important to either set the</span>
<span class="sd">        `Images.initialEnergy` attribute or the `initialEnergy` kwarg so that</span>
<span class="sd">        the relative energy is calculated correctly.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">initialEnergy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialEnergy</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;initialEnergy&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">initialEnergy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">initialEnergy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">barrier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">maxEnergyImage</span><span class="p">]</span> <span class="o">-</span> <span class="n">initialEnergy</span>
        
        <span class="k">return</span> <span class="n">barrier</span></div>
    
<div class="viewcode-block" id="Images.getReverseBarrier"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.getReverseBarrier">[docs]</a>    <span class="k">def</span> <span class="nf">getReverseBarrier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">finalEnergy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the reverse barrier of the transition.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        finalEnergy : float, optional</span>
<span class="sd">            If set this is used for the relative energy calculation.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        barrier : float</span>
<span class="sd">            The reverse energy barrier.</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If the end points are not fixed it is important to either set the</span>
<span class="sd">        `Images.finalEnergy` attribute or the `finalEnergy` kwarg so that</span>
<span class="sd">        the relative energy is calculated correctly.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">finalEnergy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">finalEnergy</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;finalEnergy&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">finalEnergy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">finalEnergy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">barrier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">maxEnergyImage</span><span class="p">]</span> <span class="o">-</span> <span class="n">finalEnergy</span>
        
        <span class="k">return</span> <span class="n">barrier</span></div>
    
<div class="viewcode-block" id="Images.writeBarrierSeparation"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.writeBarrierSeparation">[docs]</a>    <span class="k">def</span> <span class="nf">writeBarrierSeparation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">initialEnergy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initialPos</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write csv file containing details of the images.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            The name of the file to create.</span>
<span class="sd">        initialEnergy : float, optional</span>
<span class="sd">            If set this is used for the relative energy calculation.</span>
<span class="sd">        initialPos : ndarray, optional</span>
<span class="sd">            If set we use this array for the separation calculation.</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If the end points are not fixed it is important to either set the</span>
<span class="sd">        `Images.initialEnergy` attribute or the `initialEnergy` kwarg so that</span>
<span class="sd">        the relative energies are calculated correctly.</span>
<span class="sd">        </span>
<span class="sd">        Image separation is the piecewise linear separation from the initial</span>
<span class="sd">        image. If the `Images.initialPos` attribute or the `initialPos` kwarg</span>
<span class="sd">        is set we use that for the separation calculation. </span>
<span class="sd">        </span>
<span class="sd">        The file will contain the image number, the piecewise linear separation</span>
<span class="sd">        of the image from the initial image, the total energy of the image and</span>
<span class="sd">        the relative energy of the image with respect to the initial energy.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initial state energy</span>
        <span class="k">if</span> <span class="n">initialEnergy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialEnergy</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;initialEnergy&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">initialEnergy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">initialEnergy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># initial state position</span>
        <span class="k">if</span> <span class="n">initialPos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialPos</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;initialPos&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">initialPos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">initialPos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getImagePos</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># first calculate relative energies and separations</span>
        <span class="n">barriers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">seps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="p">):</span>
            <span class="n">barriers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">initialEnergy</span>
            <span class="n">seps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">initialPos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getImagePos</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> 
                                         <span class="bp">self</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">seps</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageSeparation</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        
        <span class="c1"># write to file     </span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s2">&quot;.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Image, Separation (A), Energy (eV), Relative energy (eV)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">, </span><span class="si">%lf</span><span class="s2">, </span><span class="si">%lf</span><span class="s2">, </span><span class="si">%lf</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">seps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageEnergyAll</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">barriers</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span></div>
    
<div class="viewcode-block" id="Images.visualisePathway"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.visualisePathway">[docs]</a>    <span class="k">def</span> <span class="nf">visualisePathway</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dozip</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Output the Images as a sequence of Lattice files.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dozip : bool, optional</span>
<span class="sd">            Zip the files, default is True.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualisePathwayLattice</span><span class="p">(</span><span class="n">dozip</span><span class="o">=</span><span class="n">dozip</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Images.visualisePathwayLattice"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.visualisePathwayLattice">[docs]</a>    <span class="k">def</span> <span class="nf">visualisePathwayLattice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dozip</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Output the Images as a sequence of Lattice files.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dozip : bool, optional</span>
<span class="sd">            Zip the files, default is True.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;image</span><span class="si">%d</span><span class="s2">.dat&quot;</span> <span class="o">%</span> <span class="n">i</span>
            <span class="n">lattice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returnImageAsLattice</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">lattice</span><span class="o">.</span><span class="n">writeLattice</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">zipfile</span><span class="o">=</span><span class="n">dozip</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Images.writeLattice"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.writeLattice">[docs]</a>    <span class="k">def</span> <span class="nf">writeLattice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For compatability, does nothing.&quot;&quot;&quot;</span>
        <span class="k">pass</span> </div>
    
<div class="viewcode-block" id="Images.writeObject"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.writeObject">[docs]</a>    <span class="k">def</span> <span class="nf">writeObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For compatability, does nothing.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
    
<div class="viewcode-block" id="Images.writeNebPerlOutput"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.writeNebPerlOutput">[docs]</a>    <span class="k">def</span> <span class="nf">writeNebPerlOutput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">initialEnergy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an output file like the old Perl KMC code (deprecated).</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            The name of the file to create.</span>
<span class="sd">        initialEnergy : float, optional</span>
<span class="sd">            If set this is used for the relative energy calculation.</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If the end points are not fixed it is important to either set the</span>
<span class="sd">        `Images.initialEnergy` attribute or the `initialEnergy` kwarg so that</span>
<span class="sd">        the energy barrier is calculated correctly.</span>
<span class="sd">            </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># calculate the barrier</span>
        <span class="n">barrier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBarrier</span><span class="p">(</span><span class="n">initialEnergy</span><span class="o">=</span><span class="n">initialEnergy</span><span class="p">)</span>
        
        <span class="c1"># write to file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2"> </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">barrier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxEnergyImage</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="Images.getLength"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.getLength">[docs]</a>    <span class="k">def</span> <span class="nf">getLength</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the length of the band of images.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        length : float</span>
<span class="sd">            The sum of the linear separations between images.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">length</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="p">):</span>
            <span class="n">length</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageSeparation</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">length</span></div>
    
<div class="viewcode-block" id="Images.getImagePos"><a class="viewcode-back" href="../../LKMC/LKMC.Images.html#LKMC.Images.Images.getImagePos">[docs]</a>    <span class="k">def</span> <span class="nf">getImagePos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the position of the given image.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        image : int</span>
<span class="sd">            The index of the image.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        imagePos : ndarray</span>
<span class="sd">            The vector containing the images position.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        IndexError</span>
<span class="sd">            If the specified index is out of range.</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This returns a reference to the images position not a copy.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># negative indexing starts from the end</span>
        <span class="k">if</span> <span class="n">image</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span>
        
        <span class="c1"># check for index error</span>
        <span class="k">if</span> <span class="n">image</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">image</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Specified image is out of range (</span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span><span class="p">))</span>
        
        <span class="c1"># handle fixed end points</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixedEndPoints</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">image</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># return initial state position</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">pos</span>
            <span class="k">elif</span> <span class="n">image</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NImagesTotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># return final state position</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalState</span><span class="o">.</span><span class="n">pos</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># subtract one from image (initial state not in self.pos)</span>
                <span class="n">image</span> <span class="o">-=</span> <span class="mi">1</span>
        
        <span class="c1"># offsets in self.pos</span>
        <span class="n">offset1</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span> <span class="o">*</span> <span class="n">image</span>
        <span class="n">offset2</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageNAtoms</span> <span class="o">*</span> <span class="p">(</span><span class="n">image</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># return slice</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">offset1</span><span class="p">:</span><span class="n">offset2</span><span class="p">]</span></div></div>

<span class="c1">################################################################################</span>

<span class="k">def</span> <span class="nf">_imagesCalcForceWorker</span><span class="p">(</span><span class="n">jobQ</span><span class="p">,</span> <span class="n">resultQ</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate force on one image (worker process).</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># get a job from the Queue</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">jobQ</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        
        <span class="c1"># &quot;posion pill&quot;</span>
        <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;EXIT&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="c1"># unpack the job</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lattice</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># calculate the forces</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">lattice</span><span class="o">.</span><span class="n">calcForce</span><span class="p">()</span>
        
        <span class="c1"># return the result</span>
        <span class="n">resultQ</span><span class="o">.</span><span class="n">put</span><span class="p">([</span><span class="n">status</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">totalEnergy</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">force</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">maxForce</span><span class="p">])</span>
        

</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">LKMC 150623-1236-g1254817 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, Chris Scott, Tomas Lazauskas, Miao Yu.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.5.
    </div>
  </body>
</html>