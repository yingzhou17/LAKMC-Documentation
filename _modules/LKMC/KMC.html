<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>LKMC.KMC &mdash; LKMC 150623-1236-g1254817 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '150623-1236-g1254817',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="LKMC 150623-1236-g1254817 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">LKMC 150623-1236-g1254817 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for LKMC.KMC</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">KMC master script.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">glob</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Lattice</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Minimise</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Server</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Utilities</span>
<span class="kn">from</span> <span class="nn">.Utilities</span> <span class="k">import</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Prefactor</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Results</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Search</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Refine</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Defects</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Cascades</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Deposition</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Status</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">ClientServerInterface</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Input</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Basin</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Vectors</span>
<span class="kn">from</span> <span class="nn">.hooks</span> <span class="k">import</span> <span class="n">hook_utils</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Dummy</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Rates</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Graphs</span>


<span class="c1">################################################################################</span>

<div class="viewcode-block" id="KMCRunner"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner">[docs]</a><span class="k">class</span> <span class="nc">KMCRunner</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    KMC runner object.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refState</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reuseStats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lastCascTime</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thisCascTime</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perfectLattice</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1">#back up of currentState</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oldState</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># hooks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postSelectEventHookList</span> <span class="o">=</span> <span class="n">hook_utils</span><span class="o">.</span><span class="n">makeHookList</span><span class="p">(</span><span class="s2">&quot;postSelectEventHooks&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

        <span class="c1"># Start time of simulation - used for Basin Report</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

        <span class="c1"># Transfer volume information to fix current DV problem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempDVRef</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempBasinRef</span> <span class="o">=</span> <span class="kc">None</span>


<span class="c1">#############################################################</span>
<div class="viewcode-block" id="KMCRunner.makeVisualiserLink"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.makeVisualiserLink">[docs]</a>    <span class="k">def</span> <span class="nf">makeVisualiserLink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kmcIndex</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a link in the Visualiser directory to KMC file with index `kmcIndex`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># source file</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;KMC&quot;</span><span class="p">,</span> <span class="s2">&quot;KMC</span><span class="si">%d</span><span class="s2">.dat.gz&quot;</span> <span class="o">%</span> <span class="n">kmcIndex</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Visualiser&quot;</span><span class="p">))</span>

        <span class="c1"># link name</span>
        <span class="n">linkName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Visualiser&quot;</span><span class="p">,</span> <span class="s2">&quot;Vis</span><span class="si">%d</span><span class="s2">.dat.gz&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualiserIndex</span><span class="p">)</span>

        <span class="c1"># if link name exists, delete it</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">lexists</span><span class="p">(</span><span class="n">linkName</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">linkName</span><span class="p">)</span>

        <span class="c1"># make the link</span>
        <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">linkName</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">visualiserIndex</span> <span class="o">+=</span> <span class="mi">1</span></div>

<span class="c1">#############################################################</span>
<div class="viewcode-block" id="KMCRunner.run"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputState</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refState</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">simulationTime</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">KMCStep</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">storeSearchResults</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">server_init</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run KMC.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
<span class="c1">#         self.basinFlag = False</span>

        <span class="n">iniMinimised</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">inputState</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">refState</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">inputState</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refState</span> <span class="o">=</span> <span class="n">refState</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span> <span class="o">=</span> <span class="n">simulationTime</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span> <span class="o">=</span> <span class="n">KMCStep</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">jobStatus</span> <span class="o">==</span> <span class="s2">&quot;BEGIN&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">refState</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">readLattice</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">,</span> <span class="s2">&quot;ref.dat&quot;</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">depoOn</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">depoAtFirstStep</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refState</span><span class="p">)</span>
                    <span class="n">depoRunner</span> <span class="o">=</span> <span class="n">Deposition</span><span class="o">.</span><span class="n">DepositionRunner</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refState</span><span class="p">)</span>
                    <span class="n">status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">depoRunner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Depo at first step failed...&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">return</span> <span class="mi">55</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">readLattice</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">,</span> <span class="s2">&quot;launch.dat&quot;</span><span class="p">))</span>

                <span class="c1"># set up output dirs</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">server_init</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Server</span><span class="o">.</span><span class="n">LKMCServer</span> <span class="ow">and</span> <span class="n">server_init</span><span class="o">.</span><span class="n">initialised</span><span class="p">):</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Output directory exists: overwriting&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1">#            time.sleep(10)</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;KMC&quot;</span><span class="p">)):</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;KMC&quot;</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Visualiser&quot;</span><span class="p">)):</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Visualiser&quot;</span><span class="p">))</span>

                    <span class="n">kmcdirs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Step*&quot;</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">dn</span> <span class="ow">in</span> <span class="n">kmcdirs</span><span class="p">:</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dn</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Defects&quot;</span><span class="p">)):</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Defects&quot;</span><span class="p">))</span>

                <span class="c1"># make sure initial lattice is minimised</span>
                <span class="n">minimiser</span> <span class="o">=</span> <span class="n">Minimise</span><span class="o">.</span><span class="n">getMinimiser</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">minimiser</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;ERROR: Initial minimisation failed&quot;</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span>
                <span class="n">iniMinimised</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;KMC&quot;</span><span class="p">))</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Visualiser&quot;</span><span class="p">))</span>

                <span class="c1"># write initial lattice</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;KMC&quot;</span><span class="p">,</span> <span class="s2">&quot;KMC0.dat&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">writeLattice</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">zipfile</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># add link in vis dir</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visualiserIndex</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">makeVisualiserLink</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">params</span><span class="o">.</span><span class="n">jobStatus</span> <span class="o">==</span> <span class="s2">&quot;CNTIN&quot;</span><span class="p">:</span>
                <span class="c1"># make sure the output directory exists</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Cannot coninue a simulation if the output directory does not exist!&quot;</span><span class="p">)</span>

                <span class="c1"># read reference lattice</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">refState</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">readLattice</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">,</span> <span class="s2">&quot;ref.dat&quot;</span><span class="p">))</span>

                <span class="c1"># visualiser files (for use with the basin method mainly)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Visualiser&quot;</span><span class="p">)):</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;WARNING: continuing simulation with no &#39;Visualiser&#39; directory!&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Visualiser&quot;</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">visualiserIndex</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">prepareToResume</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;ERROR: unrecognised jobStatus (BEGIN or CNTIN)&quot;</span><span class="p">)</span>

        <span class="n">refState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refState</span>

        <span class="c1"># create status object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">LKMCStatusObject</span><span class="p">(</span><span class="s2">&quot;LKMCStatus.html&quot;</span><span class="p">,</span> <span class="s2">&quot;KMC&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="n">params</span><span class="p">,</span> <span class="n">reuseStats</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reuseStats</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">iniMinimised</span><span class="p">:</span>
            <span class="c1"># minimise initial?</span>
            <span class="n">minimiser</span> <span class="o">=</span> <span class="n">Minimise</span><span class="o">.</span><span class="n">getMinimiser</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">minimiser</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;ERROR: Initial minimisation failed&quot;</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span>

        <span class="c1"># set up server</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">server_init</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Server</span><span class="o">.</span><span class="n">LKMCServer</span> <span class="ow">and</span> <span class="n">server_init</span><span class="o">.</span><span class="n">initialised</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server_init</span>
            <span class="n">finaliseServer</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">Server</span><span class="o">.</span><span class="n">LKMCServer</span><span class="p">(</span><span class="n">lkmcParams</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">statusObj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">initiate</span><span class="p">()</span>
            <span class="n">finaliseServer</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># local reference to writer</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">writer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="n">writer</span>

        <span class="c1"># write initial status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">setWriter</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">updateKMCStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">writeStatus</span><span class="p">()</span>

        <span class="c1"># if use basin method, print the low barrier criteria</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="nb">print</span> <span class="s2">&quot;~&quot;</span><span class="o">*</span><span class="mi">80</span>
            <span class="nb">print</span> <span class="s2">&quot;SUPER-BASIN METHOD IS ACTIVE IN THIS SIMULATION.&quot;</span>
            <span class="nb">print</span> <span class="s2">&quot;~&quot;</span><span class="o">*</span><span class="mi">80</span>
            <span class="nb">print</span> <span class="s2">&quot;Low barrier criteria </span><span class="si">%.3f</span><span class="s2"> eV, Sub-Low barrier criteria </span><span class="si">%.3f</span><span class="s2"> eV&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">basinLowBarrier</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">basinSubLowBarrier</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;Implementation by Miao Yu &amp; Mark James Wootton (C) 2016&quot;</span>
            <span class="nb">print</span> <span class="s2">&quot;Based on papers by:&quot;</span>
            <span class="nb">print</span> <span class="s2">&quot;* L.K. Beland, P. Brommer, F. El-Mellouhi, J.-F. Joly and N. Mousseau, 2011&quot;</span>
            <span class="nb">print</span> <span class="s2">&quot;* B. Puchala, M.L. Falk and K. Garikipati, 2010&quot;</span>
            <span class="nb">print</span> <span class="s2">&quot;* K.A. Fichthorn and Y. Lin, 2013&quot;</span>
            <span class="nb">print</span> <span class="s2">&quot;~&quot;</span><span class="o">*</span><span class="mi">80</span>
            <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># read known defect hash keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readDefectVolumes</span><span class="p">()</span>

        <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># main loop</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># check stop conditions</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span> <span class="o">&gt;=</span> <span class="n">params</span><span class="o">.</span><span class="n">KMCMaxSteps</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">KMCMaxTime</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span> <span class="o">&gt;=</span> <span class="n">params</span><span class="o">.</span><span class="n">KMCMaxTime</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c1"># start of new step</span>
            <span class="nb">print</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Starting step </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span>

            <span class="c1"># clear searchResults</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># output directory</span>
            <span class="n">taskOutputDir</span> <span class="o">=</span> <span class="s2">&quot;Step</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,)</span>

            <span class="c1"># find / calculate transitions</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="n">taskOutputDir</span><span class="p">)):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="n">taskOutputDir</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="n">taskOutputDir</span><span class="p">))</span>

            <span class="c1"># first calculate defects in current lattice</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">wrapAtoms</span><span class="p">()</span> <span class="c1"># probably not the right place to do this but I don&#39;t like sending unwrapped atoms to defects (when using PBCs)</span>
            <span class="n">defectsObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">findDefects</span><span class="p">(</span><span class="n">refState</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="n">writer</span><span class="p">,</span>
                    <span class="n">outdir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="n">taskOutputDir</span><span class="p">))</span>

            <span class="c1"># store a back up for currentState</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">useBasin</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">oldState</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="p">)</span>

            <span class="c1"># if no defects stop?</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">NDefects</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">cascOn</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">perfectLattice</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;System contains no defects, proceeding to next cascade, with a clock adjustment of </span><span class="si">%f</span><span class="s2"> s&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastCascTime</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;ERROR: no defects in system: cannot proceed&quot;</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="k">break</span>

            <span class="c1"># basin method requires to refine finals</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">refineFinal</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;Params ERROR: Basin method requires one to refine finals (see parameter, refineFinal)&quot;</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">44</span>
                <span class="k">break</span>

            <span class="c1"># basin method requires to store all transitions found during searches</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span> <span class="ow">and</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">refineSuccessFracForStorage</span> <span class="o">&gt;</span> <span class="mf">0.01</span> <span class="ow">or</span> <span class="n">params</span><span class="o">.</span><span class="n">refineSavedFracForStorage</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">):</span>
                <span class="nb">print</span> <span class="s2">&quot;Params ERROR: Basin method requires store all transitions found during searches. Set refineSuccessFracForStorage and refineSavedFracForStorage to be very small (0).&quot;</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">44</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">searchCombinedVolumes</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;Params ERROR: Operating LAKMC with searchCombinedVolumes on is not compatible with the basin method.&quot;</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">45</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">fixedPrefactor</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;Params ERROR: Calculated pre-factors are not yet compatible with the Basin method&quot;</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">46</span>
                <span class="k">break</span>

            <span class="c1"># render?</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">writePOVDefectsChosen</span> <span class="ow">or</span> <span class="n">params</span><span class="o">.</span><span class="n">renderPOVDefectsChosen</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">writerItem</span><span class="p">(</span><span class="s2">&quot;WRITE&quot;</span><span class="p">,</span> <span class="n">dataType</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">defectsObj</span><span class="p">,],</span> <span class="n">outdir</span><span class="o">=</span><span class="s2">&quot;Defects&quot;</span><span class="p">)</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;output&quot;</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;defects</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,),)</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;storePOV&quot;</span><span class="p">:</span> <span class="n">params</span><span class="o">.</span><span class="n">writePOVDefectsChosen</span><span class="p">,</span>
                          <span class="s2">&quot;renderPOV&quot;</span><span class="p">:</span> <span class="n">params</span><span class="o">.</span><span class="n">renderPOVDefectsChosen</span><span class="p">,</span>
                          <span class="s2">&quot;renderClusters&quot;</span><span class="p">:</span> <span class="n">params</span><span class="o">.</span><span class="n">renderPOVVolumesChosen</span><span class="p">}</span>
                <span class="n">item</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">])</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

            <span class="c1"># results object</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span> <span class="o">=</span> <span class="n">Results</span><span class="o">.</span><span class="n">KMCStepResults</span><span class="p">(</span><span class="n">taskOutputDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">writer</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">statusObj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="p">,</span>
                                                        <span class="n">KMCStep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,</span> <span class="n">initialState</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="p">,</span> <span class="n">refState</span><span class="o">=</span><span class="n">refState</span><span class="p">,</span>
                                                        <span class="n">ratesListLock</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">ratesLock</span><span class="p">,</span> <span class="n">ratesListProxy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">ratesListProxy</span><span class="p">)</span>
            <span class="c1"># store old state for future use</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">useBasin</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">oldState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldState</span>

                <span class="c1"># Verify current DVs</span>
                <span class="k">for</span> <span class="n">bNum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span>
                    <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verifyBasinCurrentDV</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">bNum</span><span class="p">],</span> <span class="n">fatal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1"># Update map</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mapDVsToBasins</span><span class="p">()</span>
                <span class="c1"># Remove unused basins</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">purgeBasins</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">writeRouletteHeader</span><span class="p">()</span>

            <span class="c1"># transition searches</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTransitions</span><span class="p">()</span>

            <span class="c1"># basin report</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">useBasin</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">debugBasin</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">verboseLevel</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">tempPath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinReport</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

                <span class="n">keepPICReport</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">basin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="n">cDV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">correction</span> <span class="o">=</span> <span class="n">basin</span><span class="o">.</span><span class="n">integrityCheck</span><span class="p">(</span><span class="n">dvi</span><span class="o">=</span><span class="n">cDV</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">correction</span><span class="p">:</span>
                            <span class="n">keepPICReport</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">debugBasin</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">debugBasin</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">verboseLevel</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">keepPICReport</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tempPath</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">basinReport</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">consistentBasinReuseCheck</span><span class="p">()</span>

                <span class="c1"># check consistency of defectVolumes in file and basin</span>


            <span class="c1"># error?</span>
            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;ERROR: getTransitions exited with status&quot;</span><span class="p">,</span> <span class="n">status</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">9</span>
                <span class="k">break</span>

            <span class="c1"># Add external event to roulette list</span>
            <span class="c1"># Cascades</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">cascOn</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">addEventRateToDict</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">cascRate</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">eventIndex</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">writeRouletteEvent</span><span class="p">(</span><span class="n">eventIndex</span><span class="p">)</span>
            <span class="c1"># Depositions</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">depoOn</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">addEventRateToDict</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">depoRate</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">eventIndex</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">writeRouletteEvent</span><span class="p">(</span><span class="n">eventIndex</span><span class="p">)</span>

            <span class="c1"># choose an event</span>
            <span class="c1"># if basin method, save results and update rates</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">useBasin</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">numList</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1">#                 if self.basinFlag:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">):</span>
                    <span class="c1"># self.stripOutBasinTransitions()</span>

                    <span class="c1"># status, info = self.verifyBasin()</span>
                    <span class="c1"># if status:</span>
                    <span class="c1">#     print &quot;ERROR in verify Basin, Cannot fix linkage of existing basins.&quot;, info</span>
                    <span class="c1">#     break</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">updateRates</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="s2">&quot;ERROR in mean rate calculation&quot;</span>
                        <span class="k">break</span>

                    <span class="c1"># re-write roulette</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">writeRouletteHeaderBasin</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">])):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">writeRouletteEvent</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">verboseLevel</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;PRE-SELECT DEBUG: basinList#:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">printout</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span>
                    <span class="n">basinI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;In basin # </span><span class="si">%d</span><span class="s2"> : </span><span class="si">%d</span><span class="s2"> volumes&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)),</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># ensure all current states in basin are set to explored</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span>
                    <span class="n">basinI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">curDV</span> <span class="o">=</span> <span class="n">basinI</span><span class="o">.</span><span class="n">currentDV</span>
                    <span class="k">if</span> <span class="n">curDV</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">basinCurrentDV</span> <span class="o">=</span> <span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">curDV</span><span class="p">]</span>
                        <span class="n">basinCurrentDV</span><span class="o">.</span><span class="n">explored</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># stop if no event found</span>
            <span class="c1"># need to generalise for external events</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;ERROR: no events found: cannot proceed&quot;</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="nb">print</span> <span class="s2">&quot;totalRate&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">totalRate</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="n">key</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="n">key</span><span class="p">])):</span>
                        <span class="nb">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                <span class="k">break</span>

            <span class="n">eventTime</span><span class="p">,</span> <span class="n">chosenIndex</span><span class="p">,</span> <span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">,</span> <span class="n">dupFlag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectEvent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tempDVRef</span> <span class="o">=</span> <span class="n">volumeNum</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tempBasinRef</span> <span class="o">=</span> <span class="n">basinNum</span>

            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Pre-event map:&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="se">\t\t</span><span class="s2">[</span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">, </span><span class="si">%r</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="mi">2</span><span class="p">]),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="se">\t\t</span><span class="s2">[None]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Lenth of basin list: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;chosenIndex </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">chosenIndex</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span> <span class="ow">and</span> <span class="n">chosenIndex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volIndxs&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">]</span>
                <span class="c1"># log(__name__, &quot;Found index, %d&quot;%index, 3, 0)</span>

                <span class="k">if</span> <span class="n">basinNum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;DEBUG: chosenIndex </span><span class="si">%d</span><span class="s2">, basinNum </span><span class="si">%s</span><span class="s2">, volumeNum </span><span class="si">%s</span><span class="s2">, transNum </span><span class="si">%s</span><span class="s2">, barrier </span><span class="si">%f</span><span class="s2">, flag </span><span class="si">%s</span><span class="s2">,&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">chosenIndex</span><span class="p">,</span> <span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">currentTrans</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinFlag&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">]),</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                    <span class="c1"># check &quot;newInBuildRev&quot; flag. If selected event belongs to a basin which is newly built in buildReverseTrans, set newInBuildRev=False</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">newInBuildRev</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">newInBuildRev</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;DEBUG: chosenIndex </span><span class="si">%d</span><span class="s2">, basinNum </span><span class="si">%s</span><span class="s2">, volumeNum </span><span class="si">%s</span><span class="s2">, transNum None, barrier </span><span class="si">%f</span><span class="s2">, flag </span><span class="si">%s</span><span class="s2">,&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">chosenIndex</span><span class="p">,</span> <span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinFlag&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">]),</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                <span class="c1"># select an ordinary event</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinFlag&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># if this event belongs to an existing basin, exit this basin</span>
                    <span class="k">if</span> <span class="n">basinNum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">removeBasin</span><span class="p">(</span><span class="n">basinNum</span><span class="p">)</span>

                <span class="c1"># if select external event, reset basins</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">basinFlag</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># select a low barrier event</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># if volume number changes, exit basin</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinFlag&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Selected transition&#39;s final&#39;s number of DV different from initial&#39;s.&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">basinNum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">removeBasin</span><span class="p">(</span><span class="n">basinNum</span><span class="p">)</span>
<span class="c1">#                             # if there is no existing basin, quit basin method</span>
<span class="c1">#                             if not len(self.basinList):</span>
<span class="c1">#                                 self.basinFlag = 0</span>
<span class="c1">#                         if basinNum is None:</span>
<span class="c1">#                             self.storeBasinResult(chosenIndex)</span>
<span class="c1">#                             self.basinFlag = 1</span>

<span class="c1">#                 # not using basin method on last KMC step</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     if params.debugBasin:</span>
<span class="c1">#                         log(__name__, &quot;DEBUG: chosenIndex %d, flag: %s, barrier %f, reverseBarrier %s&quot;%(chosenIndex, self.searchResults.resultsDict[&quot;basinFlag&quot;][chosenIndex],</span>
<span class="c1">#                                                                                                 self.searchResults.resultsDict[&quot;barriers&quot;][chosenIndex],</span>
<span class="c1">#                                                                                                 self.searchResults.resultsDict[&quot;reverseBarriers&quot;][chosenIndex]),2,2)</span>
<span class="c1">#                     self.numList = []</span>
<span class="c1">#                     # select a low barrier event</span>
<span class="c1">#                     if self.searchResults.resultsDict[&quot;basinFlag&quot;][chosenIndex] != 0:</span>
<span class="c1">#                         if self.searchResults.resultsDict[&quot;basinFlag&quot;][chosenIndex] == -1:</span>
<span class="c1">#                             log(__name__, &quot;Selected transition&#39;s final&#39;s number of DV different from initial&#39;s.&quot;,2,1)</span>
<span class="c1">#                         #start basin method</span>
<span class="c1">#                         self.basinFlag = 1</span>
<span class="c1">#                         self.storeBasinResult(chosenIndex)</span>

                <span class="c1"># loop over all basins, delete any basin with newInBuildRev flag</span>
                <span class="k">for</span> <span class="n">basinIndex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">basinTmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinIndex</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">basinTmp</span><span class="o">.</span><span class="n">newInBuildRev</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Deleting unselected basin </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">basinIndex</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">removeBasin</span><span class="p">(</span><span class="n">basinIndex</span><span class="p">)</span>


                <span class="c1"># write out basin file</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">):</span>
                    <span class="n">Basin</span><span class="o">.</span><span class="n">writeBasin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">verboseLevel</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;POST-SELECT DEBUG: basinList#:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">printout</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span>
                    <span class="n">basinI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;In basin # </span><span class="si">%d</span><span class="s2"> : </span><span class="si">%d</span><span class="s2"> volumes&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)),</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">eventTime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="k">break</span>

            <span class="c1"># run any post choose event hooks</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postSelectEventHookList</span><span class="p">):</span>
                <span class="nb">print</span> <span class="s2">&quot;RUNNING POST SELECT HOOKS&quot;</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;currentState&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="p">,</span>
                          <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                          <span class="s2">&quot;refState&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">refState</span><span class="p">}</span>

                <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">postSelectEventHookList</span><span class="p">:</span>
                    <span class="n">hook</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># Clock adjustment for perfect lattices</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">perfectLattice</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastCascTime</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">cascDuration</span><span class="o">*</span><span class="mi">1</span><span class="n">E</span><span class="o">-</span><span class="mi">15</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">eventTime</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Attention: KMC simulated time since last cascade, </span><span class="si">%.15f</span><span class="s2">, is greater than eventTime </span><span class="si">%.15f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastCascTime</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">cascDuration</span><span class="o">*</span><span class="mi">1</span><span class="n">E</span><span class="o">-</span><span class="mi">15</span><span class="p">),</span> <span class="n">eventTime</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;To avoid time travel (i.e. non-linear clock progression), we are increasing eventTime to match the simulated time since last the last cascade.&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">eventTime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastCascTime</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">cascDuration</span><span class="o">*</span><span class="mi">1</span><span class="n">E</span><span class="o">-</span><span class="mi">15</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;eventTime is now set to </span><span class="si">%.15f</span><span class="s2"> s.&quot;</span><span class="o">%</span><span class="n">eventTime</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastCascTime</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">cascDuration</span><span class="o">*</span><span class="mi">1</span><span class="n">E</span><span class="o">-</span><span class="mi">15</span>

            <span class="c1"># Time Incrementation</span>
            <span class="c1"># If we&#39;re not using cascade events in this simulation, advance the clock as normal.</span>
            <span class="c1"># If the lattice has defects, and we are using cascades, advance the clock as normal.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">cascOn</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">perfectLattice</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span> <span class="o">+=</span> <span class="n">eventTime</span>
            <span class="c1"># If the lattice has no defects, but we&#39;re on step 0, we do not want to add any KMC step time to the clock.</span>
            <span class="c1"># If we&#39;re not on step 0, advance the clock as normal.</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">perfectLattice</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;At the beginging of this step (Step </span><span class="si">%d</span><span class="s2">), the system had healed from a previous cascade, thus a new event was introduced.&quot;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;As such, we are advancing the clock by the event time, </span><span class="si">%.15f</span><span class="s2"> s, in relation to the previous cascade, which occurred at </span><span class="si">%.15f</span><span class="s2"> s&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">eventTime</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastCascTime</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span> <span class="o">+=</span> <span class="n">eventTime</span>
            <span class="c1"># Update lastCascTime with most recent event &amp; reset perfectLattice flag.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastCascTime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thisCascTime</span>
            <span class="c1"># Un-flag perfectLattice</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">perfectLattice</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># write roulette file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">writeRouletteFooter</span><span class="p">(</span><span class="n">chosenIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span><span class="p">)</span>

            <span class="c1"># write selected final</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">writeSelectedFinal</span><span class="p">(</span><span class="n">chosenIndex</span><span class="p">,</span> <span class="s2">&quot;KMC/KMC</span><span class="si">%d</span><span class="s2">.dat&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,),</span> <span class="n">latticeIn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="p">)</span>

            <span class="c1"># visualiser file</span>
            <span class="n">isBasinEvent</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">useBasin</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinFlag&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isBasinEvent</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">makeVisualiserLink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;End of step </span><span class="si">%d</span><span class="s2">. Simulation time is </span><span class="si">%.15g</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># update status</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">updateKMCStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">resetSearches</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">writeStatus</span><span class="p">()</span>

            <span class="c1"># Check writer process is still alive; cannot proceed if not</span>
            <span class="n">writerStatus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">checkAlive</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">writerStatus</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Error: Writer process has died (</span><span class="si">%d</span><span class="s2">); cannot continue&quot;</span> <span class="o">%</span> <span class="n">writerStatus</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">4</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">storeSearchResults</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">finaliseServer</span><span class="p">:</span>
            <span class="c1"># shutdown server</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">finalise</span><span class="p">()</span>

        <span class="c1"># flush STDOUT</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;ERROR: terminated due to no events found&quot;</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;ERROR: terminated due to no defects found&quot;</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;ERROR: terminated due to selectEvent failure&quot;</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">44</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;PARAMS ERROR: Basin method requires refine finals, as well as store all transitions. Review lkmcInput.IN.&quot;</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">45</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;PARAMS ERROR: Basin method requires that searchCombinedVolumes is disabled. Review lkmcInput.IN.&quot;</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">46</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;PARAMS ERROR: Use of calculated prefactors is not yet compatable with the Basin Method. Review lkmcInput.IN.&quot;</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;ERROR: terminated due Writer dying&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Simulation finished&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">status</span></div>

<span class="c1">#############################################################</span>


<div class="viewcode-block" id="KMCRunner.getLastCascTime"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.getLastCascTime">[docs]</a>    <span class="k">def</span> <span class="nf">getLastCascTime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the time of the last cascade event from cascAttributes.out.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">timeDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;lastCascTime.OUT&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastCascTime</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">timeDir</span><span class="p">):</span>
            <span class="n">lastCascTimeFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">timeDir</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lastCascTimeFile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastCascTime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>

<div class="viewcode-block" id="KMCRunner.prepareToResume"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.prepareToResume">[docs]</a>    <span class="k">def</span> <span class="nf">prepareToResume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare to resume KMC simulation.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

        <span class="c1"># for now we just read in the latest stored KMC lattice</span>
        <span class="c1"># and start the step corresponding to that</span>
        <span class="n">KMCLatticeDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;KMC&quot;</span><span class="p">)</span>

        <span class="c1"># find KMC lattice file to resume from</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">KMCLatticeDir</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># find latest KMC file</span>
            <span class="n">lastKMCFile</span><span class="p">,</span> <span class="n">lastKMCFileIndex</span> <span class="o">=</span> <span class="n">Utilities</span><span class="o">.</span><span class="n">findLastKMCLattice</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">KMCLookFrom</span><span class="p">)</span>

            <span class="c1"># check integrity</span>
            <span class="n">fileIntegrity</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">checkLatticeFileIntegrity</span><span class="p">(</span><span class="n">lastKMCFile</span><span class="p">)</span>

            <span class="k">while</span> <span class="ow">not</span> <span class="n">fileIntegrity</span><span class="p">:</span>
                <span class="n">lastKMCFileIndex</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">lastKMCFileIndex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;ERROR: prepareToResume: backtracked too far&quot;</span><span class="p">)</span>

                <span class="n">lastKMCFile</span> <span class="o">=</span> <span class="s2">&quot;KMC</span><span class="si">%d</span><span class="s2">.dat&quot;</span> <span class="o">%</span> <span class="n">lastKMCFileIndex</span>
                <span class="n">fileIntegrity</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">checkLatticeFileIntegrity</span><span class="p">(</span><span class="n">lastKMCFile</span><span class="p">)</span>

            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Resuming with KMC file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">lastKMCFile</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span> <span class="o">=</span> <span class="n">lastKMCFileIndex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">readLattice</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;KMC&quot;</span><span class="p">,</span> <span class="n">lastKMCFile</span><span class="p">))</span>

        <span class="c1"># Retrieve the time of the last cascade, if appropriate.</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">cascOn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getLastCascTime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">)</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Retrieving time of last cascade: </span><span class="si">%.15f</span><span class="s2"> s.&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">lastCascTime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># find visualiser file associated with last KMC file</span>
        <span class="n">kmcVisDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Visualiser&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">kmcVisDir</span><span class="p">):</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Attempting to locate last visualiser file (last KMC file index is </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">lastKMCFileIndex</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">kmcVisDir</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># look for vis file that links to chosen kmc file</span>
                <span class="c1"># note we do not check if the links are valid</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">vfn</span> <span class="o">=</span> <span class="s2">&quot;Vis</span><span class="si">%d</span><span class="s2">.dat.gz&quot;</span> <span class="o">%</span> <span class="n">count</span>
                <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">vfn</span><span class="p">):</span>
                    <span class="n">linkedFn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">vfn</span><span class="p">))</span>
                    <span class="n">linkedIndex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">linkedFn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">:])</span>
                    <span class="k">if</span> <span class="n">linkedIndex</span> <span class="o">&gt;</span> <span class="n">lastKMCFileIndex</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">vfn</span> <span class="o">=</span> <span class="s2">&quot;Vis</span><span class="si">%d</span><span class="s2">.dat.gz&quot;</span> <span class="o">%</span> <span class="n">count</span>

                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Found next visualiser index: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">count</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visualiserIndex</span> <span class="o">=</span> <span class="n">count</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">kmcVisDir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visualiserIndex</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># read current simulation time from relevant roulette file</span>
        <span class="n">rouletteStepIndex</span> <span class="o">=</span> <span class="n">lastKMCFileIndex</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">rouletteStepIndex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Step</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rouletteStepIndex</span><span class="p">,),</span> <span class="s2">&quot;Roulette.OUT&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">gotTime</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Simulation time&quot;</span><span class="p">):</span>
                        <span class="n">array</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
                        <span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">gotTime</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">gotTime</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;ERROR: prepareToResume: resume screwed up trying to retrieve time&quot;</span><span class="p">)</span>

        <span class="c1"># read stored basin</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">basinReset</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Step</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rouletteStepIndex</span><span class="p">,),</span> <span class="s2">&quot;basinList.bsn&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Utilities</span><span class="o">.</span><span class="n">checkForFile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Reading saved basin list from: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">filename</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">Basin</span><span class="o">.</span><span class="n">readBasin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
<span class="c1">#                 self.basinFlag = 1</span>

                <span class="c1"># print resume basin info</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">verboseLevel</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">printout</span><span class="p">()</span>

                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span>
                        <span class="n">basinI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;In basin # </span><span class="si">%d</span><span class="s2"> : </span><span class="si">%d</span><span class="s2"> volumes&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)),</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

                <span class="c1"># Restore add-type information</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)):</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">transitions</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">finalDV</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">partOfPair</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">partOfPair</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span></div>

<span class="c1">#############################################################</span>
<div class="viewcode-block" id="KMCRunner.selectEvent"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.selectEvent">[docs]</a>    <span class="k">def</span> <span class="nf">selectEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select event from results.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Calling selectEvent&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span>
        <span class="n">currentState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span>
        <span class="n">defectVolumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

        <span class="n">basinNum</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">volumeNum</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dupFlag</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">attempts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">attempts2</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># number of deposition attempts</span>
        <span class="n">xContinue</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">xSuccess</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">resultsLen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">debugBasin</span><span class="p">:</span>
            <span class="c1">#write out all events</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeAllTrans</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">xContinue</span> <span class="ow">and</span> <span class="n">attempts</span> <span class="o">&lt;</span> <span class="n">resultsLen</span> <span class="ow">and</span> <span class="n">attempts2</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">attempts</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># random number between 0 and totalRate</span>
            <span class="n">randnum</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="n">results</span><span class="o">.</span><span class="n">totalRate</span>

            <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">totalRate</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="n">E</span><span class="o">-</span><span class="mi">10</span><span class="p">:</span>
                <span class="n">xSuccess</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>

<span class="c1">#            # Debug the rate thing!!!</span>
<span class="c1">#            rates = results.resultsDict[&quot;rates&quot;]</span>
<span class="c1">#            print &quot;DEBUG EVENT SELECT:\n    TOTAL RATE: &quot;,results.totalRate,&quot;\n    %d RATES: &quot;%len(rates),</span>
<span class="c1">#            for i in xrange(len(rates)):</span>
<span class="c1">#                print rates[i], &quot; &quot;,</span>
<span class="c1">#            print &quot;\n    RANDOM NUMBER: &quot;,randnum</span>

            <span class="c1"># now sum rates until exceed randnum</span>
            <span class="n">ratesum</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">rates</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rates</span><span class="p">)):</span>
                <span class="n">ratesum</span> <span class="o">+=</span> <span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">ratesum</span> <span class="o">&gt;</span> <span class="n">randnum</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="c1"># time associated with event</span>
            <span class="n">randnum</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
            <span class="n">eventTime</span> <span class="o">=</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">randnum</span><span class="p">)</span> <span class="o">/</span> <span class="n">results</span><span class="o">.</span><span class="n">totalRate</span>

            <span class="c1"># print &quot;len(rates)&quot;, len(rates)</span>
            <span class="c1"># print &quot;i =&quot;, i</span>

            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Selected event </span><span class="si">%d</span><span class="s2">: volume index </span><span class="si">%r</span><span class="s2">; rate </span><span class="si">%g</span><span class="s2">; barrier </span><span class="si">%g</span><span class="s2"> eV; event time </span><span class="si">%g</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volIndxs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">eventTime</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;DEBUG: Selected event barrierOrigin is </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">newInputState</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finals&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">xContinue</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">xSuccess</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">elif</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finals&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">originInfo</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;reuseInfo&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">workingVol</span><span class="p">,</span> <span class="n">originHashKey</span><span class="p">,</span> <span class="n">originTransNo</span> <span class="o">=</span> <span class="n">originInfo</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>

                    <span class="n">workingVol</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">workingVol</span><span class="p">)</span>
                    <span class="n">originTransNo</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">originTransNo</span><span class="p">)</span>

                    <span class="nb">print</span> <span class="s2">&quot;REUSING FINAL STATE OF SELECTED EVENT&quot;</span><span class="p">,</span> <span class="n">workingVol</span><span class="p">,</span> <span class="n">originHashKey</span><span class="p">,</span> <span class="n">originTransNo</span>

<span class="c1">#                    volfile = os.path.join(params.volumeDirectory,</span>
<span class="c1">#                        &quot;%s.vol&quot; % originHashKey)</span>

                    <span class="n">graphVolume</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">workingVol</span><span class="p">]</span><span class="o">.</span><span class="n">graphVol</span>

<span class="c1">#                     print &quot;VOLUME FILE %s&quot; % (volfile)</span>

                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;originHashKey \&amp; graphVolume:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">verboseLevel</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="n">originHashKey</span><span class="p">,</span> <span class="n">graphVolume</span>

<span class="c1">#                     transitions = readVolumeTransitionsFile(volfile, currentState, graphVolume,</span>
<span class="c1">#                         hashKey=graphVolume)</span>

<span class="c1">#                     currentState.currentGraphVolume = currentState.graphVols[workingVol]</span>
                    <span class="n">currentState</span><span class="o">.</span><span class="n">currentDefectVolume</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">workingVol</span><span class="p">]</span>

<span class="c1">#                     transIniPos = transitions[0]</span>
<span class="c1">#                     transSpecie = transitions[1]</span>
<span class="c1">#                     transList = transitions[2]</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">transitions</span> <span class="o">=</span> <span class="n">defectVolumes</span><span class="p">[</span><span class="n">originHashKey</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;ERROR: Volume transitions </span><span class="si">%s</span><span class="s2"> not found. &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">originHashKey</span><span class="p">,),</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">,</span> <span class="n">dupFlag</span>

                    <span class="n">transIniPos</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">.</span><span class="n">initialPos</span>
                    <span class="n">transSpecie</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">.</span><span class="n">specie</span>
                    <span class="n">transList</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">.</span><span class="n">transitionList</span>

                    <span class="n">transitionRefiner</span> <span class="o">=</span> <span class="n">Refine</span><span class="o">.</span><span class="n">TransitionRefiner</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refState</span><span class="p">)</span>
                    <span class="n">transitionRefiner</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">currentState</span><span class="p">)</span>

                    <span class="n">trans</span> <span class="o">=</span> <span class="n">transList</span><span class="p">[</span><span class="n">originTransNo</span><span class="p">]</span>

                    <span class="n">newInputState</span><span class="p">,</span> <span class="n">resultInfo</span> <span class="o">=</span> <span class="n">transitionRefiner</span><span class="o">.</span><span class="n">refineFinalState</span><span class="p">(</span><span class="n">transIniPos</span><span class="p">,</span> <span class="n">transSpecie</span><span class="p">,</span> <span class="n">graphVolume</span><span class="p">,</span> <span class="n">volumeTransitionObject</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">newInputState</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">xContinue</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">xSuccess</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">totalRate</span> <span class="o">-=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">xContinue</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">xSuccess</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1">#print newInputState, resultInfo</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xContinue</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">xSuccess</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">newInputState</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finals&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># if external event, do deposition/cascade</span>
            <span class="k">elif</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">currentState_backup</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mf">3.1</span><span class="p">:</span>
                    <span class="c1"># Make note of time at which this cascade begins.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">thisCascTime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span>
                    <span class="c1"># Create cascade object</span>
                    <span class="n">cascRunner</span> <span class="o">=</span> <span class="n">Cascades</span><span class="o">.</span><span class="n">CascadeRunner</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refState</span><span class="p">)</span>
                    <span class="c1"># Run cascade</span>
                    <span class="n">statusEvent</span><span class="p">,</span> <span class="n">newInputState</span> <span class="o">=</span> <span class="n">cascRunner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">currentState</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,</span> <span class="n">clock</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mf">3.2</span><span class="p">:</span>
                    <span class="n">depoRunner</span> <span class="o">=</span> <span class="n">Deposition</span><span class="o">.</span><span class="n">DepositionRunner</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refState</span><span class="p">)</span>
                    <span class="n">statusEvent</span><span class="p">,</span> <span class="n">newInputState</span> <span class="o">=</span> <span class="n">depoRunner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">currentState</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Unknown barrierOrigin for external event&quot;</span><span class="p">)</span>

                <span class="n">xContinue</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">xSuccess</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">statusEvent</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mf">3.1</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Cascade event failed!&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mf">3.2</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Deposition event failed!&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                    <span class="n">xContinue</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">xSuccess</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">attempts</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="n">attempts2</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Restoring pre-event state&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">currentState_backup</span><span class="p">)</span>

            <span class="c1"># if select an basin event</span>
            <span class="k">elif</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="c1"># if self.params.verboseLevel &gt; 0:</span>
                <span class="c1">#     print &quot;-&quot;*80</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;A basin event has been selected&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="n">index</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volIndxs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Event volIndxs is </span><span class="si">%r</span><span class="s2"> (</span><span class="si">%d</span><span class="s2"> defect volumes in the current state)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                <span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">,</span> <span class="n">dupFlag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBasinDetails</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">tempDVRef</span> <span class="o">=</span> <span class="n">volumeNum</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tempBasinRef</span> <span class="o">=</span> <span class="n">basinNum</span>

                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Selected event belongs to Basin </span><span class="si">%r</span><span class="s2"> Volume </span><span class="si">%r</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">basinNum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">volumeNum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># self.verifyBasinCurrentDV(self.basinList[basinNum])</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Attempt transition from Current DV: </span><span class="si">%r</span><span class="s2"> to DV: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">currentDV</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dupFlag</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Selected event from a duplicate basin state, can&#39;t refine.&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">DVbackup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">currentDV</span>
                        <span class="n">currentState_backup</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="p">)</span>

                        <span class="n">status</span><span class="p">,</span> <span class="n">currentState2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">performTranslation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">currentDV</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;transIndex&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Error! Cannot reuse current basin event, try to reselect...&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>

                    <span class="n">workingVol</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volIndxs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">originHashKey</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeHashkey&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">originTransNo</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;transIndex&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Selected event has:</span><span class="se">\n</span><span class="s2">workingVol = </span><span class="si">%r</span><span class="se">\n</span><span class="s2">originHashKey = </span><span class="si">%r</span><span class="se">\n</span><span class="s2">originTransNo = </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">workingVol</span><span class="p">,</span> <span class="n">originHashKey</span><span class="p">,</span> <span class="n">originTransNo</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                    <span class="c1"># check validity of vorkingVol.</span>
                    <span class="k">if</span> <span class="n">workingVol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">workingVol</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">currentState2</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">):</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;selectEvent: workingVol is greater than len(currentState2.defectVolumes). Resetting to None&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="n">workingVol</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">elif</span> <span class="n">currentState2</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">workingVol</span><span class="p">]</span><span class="o">.</span><span class="n">graphKey</span> <span class="o">!=</span> <span class="n">originHashKey</span><span class="p">:</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;selectEvent: workingVol&#39;s graphKey does not match originHashKey. Resetting to None&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="n">workingVol</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">elif</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeCOM&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">currentState2</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">workingVol</span><span class="p">]</span><span class="o">.</span><span class="n">com</span><span class="p">,</span> <span class="n">currentState2</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">basinCOMTol</span><span class="p">:</span>
                            <span class="n">workingVol</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;selectEvent: workingVol COM does not match results object volumeCOM. Resetting to None&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="c1"># try to find the right workingVol</span>
                    <span class="k">if</span> <span class="n">workingVol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Warning: workingVol for selected event is None (result index </span><span class="si">%d</span><span class="s2">). Attempting to fix&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">tmpList</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">currentState2</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">currentState2</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">graphKey</span> <span class="o">==</span> <span class="n">originHashKey</span> <span class="ow">or</span> <span class="n">currentState2</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">graphKey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volumeNum</span><span class="p">]</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">:</span>
                                <span class="n">tmpList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmpList</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmpList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">workingVol</span> <span class="o">=</span> <span class="n">tmpList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">elif</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeCOM&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">tmpList2</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="n">tmpList</span><span class="p">:</span>
                                    <span class="n">tmpList2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeCOM&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">currentState2</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span><span class="o">.</span><span class="n">com</span><span class="p">,</span> <span class="n">currentState2</span><span class="o">.</span><span class="n">cellDims</span><span class="p">))</span>
                                <span class="n">workingVol</span> <span class="o">=</span> <span class="n">tmpList</span><span class="p">[</span><span class="n">tmpList2</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">tmpList2</span><span class="p">))]</span>

                    <span class="k">if</span> <span class="n">workingVol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                        <span class="c1"># store selected transition&#39;s index</span>
                        <span class="n">volumeij</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volumeNum</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">volumeij</span><span class="o">.</span><span class="n">transitions</span><span class="p">)):</span>
                            <span class="n">transijk</span> <span class="o">=</span> <span class="n">volumeij</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">transijk</span><span class="o">.</span><span class="n">reuseIndex</span> <span class="o">==</span> <span class="n">originTransNo</span><span class="p">:</span>
<span class="c1">#                                 self.basinList[basinNum].currentTrans = pp</span>
                                <span class="k">break</span>

                        <span class="nb">print</span> <span class="s2">&quot;REUSING FINAL STATE OF SELECTED EVENT&quot;</span><span class="p">,</span> <span class="n">workingVol</span><span class="p">,</span> <span class="n">originHashKey</span><span class="p">,</span> <span class="n">originTransNo</span><span class="p">,</span>
                        <span class="nb">print</span> <span class="s2">&quot;Basin </span><span class="si">%d</span><span class="s2"> Volume </span><span class="si">%d</span><span class="s2"> Trans </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">,</span> <span class="n">pp</span><span class="p">)</span>

                        <span class="n">graphVolume</span> <span class="o">=</span> <span class="n">currentState2</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">workingVol</span><span class="p">]</span><span class="o">.</span><span class="n">graphVol</span>

                        <span class="n">currentState2</span><span class="o">.</span><span class="n">currentDefectVolume</span> <span class="o">=</span> <span class="n">currentState2</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">workingVol</span><span class="p">]</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">transitions</span> <span class="o">=</span> <span class="n">defectVolumes</span><span class="p">[</span><span class="n">originHashKey</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;ERROR: Volume transitions </span><span class="si">%s</span><span class="s2"> not found. &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">originHashKey</span><span class="p">,),</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">currentState_backup</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">DVbackup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">selectEvent attempted to revert a basin&#39;s currentDV to None&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">currentDV</span> <span class="o">=</span> <span class="n">DVbackup</span>
<span class="c1">#                             self.basinList[basinNum].currentTrans = None</span>
                            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">,</span> <span class="n">dupFlag</span>

                        <span class="c1"># check if in correct state for current basin DV (check duplicates)</span>
                        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span><span class="p">:</span>
                            <span class="n">correctHashkey</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">transitions</span><span class="o">.</span><span class="n">hashKey</span> <span class="o">!=</span> <span class="n">currentState2</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">workingVol</span><span class="p">]</span><span class="o">.</span><span class="n">graphKey</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="c1"># check primary hashkey</span>
                                    <span class="n">bDV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volumeNum</span><span class="p">]</span>
                                    <span class="n">bDVHashkey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volumeNum</span><span class="p">]</span><span class="o">.</span><span class="n">hashkey</span>
                                    <span class="n">dupRef</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="k">if</span> <span class="n">transitions</span><span class="o">.</span><span class="n">hashKey</span> <span class="o">!=</span> <span class="n">bDVHashkey</span><span class="p">:</span>

                                        <span class="c1"># check duplicate hashkeys</span>
                                        <span class="k">for</span> <span class="n">dups</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bDV</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">)):</span>
                                            <span class="n">bDVHashkey</span> <span class="o">=</span> <span class="n">bDV</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">[</span><span class="n">dups</span><span class="p">]</span>
                                            <span class="k">if</span> <span class="n">transitions</span><span class="o">.</span><span class="n">hashKey</span> <span class="o">==</span> <span class="n">bDVHashkey</span><span class="p">:</span>
                                                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;selectEvent: found match </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2"> with duplicate </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">transitions</span><span class="o">.</span><span class="n">hashKey</span><span class="p">,</span><span class="n">bDVHashkey</span><span class="p">,</span><span class="n">dup</span><span class="p">),</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                                                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;selectEvent: corrected graphVolume to duplicate graph atoms&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                                                <span class="n">graphVolume</span> <span class="o">=</span> <span class="n">bDV</span><span class="o">.</span><span class="n">dupVolAtoms</span><span class="p">[</span><span class="n">dups</span><span class="p">]</span>
                                                <span class="n">correctHashkey</span> <span class="o">=</span> <span class="kc">True</span>
                                                <span class="n">dupRef</span> <span class="o">=</span> <span class="n">dups</span>
                                                <span class="k">break</span>

                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">correctHashkey</span><span class="p">:</span>
                                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;ERROR: could not correct graphVolume in selectEvent (1)&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                                            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">,</span> <span class="n">dupFlag</span>

                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="c1"># primary hashkey is fine</span>
                                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;selectEvent: found match </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2"> with primary&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">transitions</span><span class="o">.</span><span class="n">hashKey</span><span class="p">,</span><span class="n">bDVHashkey</span><span class="p">),</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;selectEvent: corrected graphVolume to primary graph atoms&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                                        <span class="n">graphVolume</span> <span class="o">=</span> <span class="n">bDV</span><span class="o">.</span><span class="n">graphVol</span>

                                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Correting atom positions&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                                    <span class="n">pos</span> <span class="o">=</span> <span class="p">[]</span>
                                    <span class="k">if</span> <span class="n">dupRef</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                        <span class="n">pos</span> <span class="o">=</span> <span class="n">bDV</span><span class="o">.</span><span class="n">dvPos</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">pos</span> <span class="o">=</span> <span class="n">bDV</span><span class="o">.</span><span class="n">dupPos</span><span class="p">[</span><span class="n">dupRef</span><span class="p">]</span>
                                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">graphVolume</span><span class="p">)):</span>
                                        <span class="n">atom</span> <span class="o">=</span> <span class="n">graphVolume</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                                        <span class="n">currentState2</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">atom</span><span class="p">]</span>   <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">a</span><span class="p">]</span>
                                        <span class="n">currentState2</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">atom</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                                        <span class="n">currentState2</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">atom</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">a</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>

                                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;ERROR: could not correct graphVolume in selectEvent (2)&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

                        <span class="n">transIniPos</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">.</span><span class="n">initialPos</span>
                        <span class="n">transSpecie</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">.</span><span class="n">specie</span>
                        <span class="n">transList</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">.</span><span class="n">transitionList</span>

                        <span class="n">transitionRefiner</span> <span class="o">=</span> <span class="n">Refine</span><span class="o">.</span><span class="n">TransitionRefiner</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refState</span><span class="p">)</span>
                        <span class="n">transitionRefiner</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">currentState2</span><span class="p">)</span>

                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Chosen transition </span><span class="si">%d</span><span class="s2"> of </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">originTransNo</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">transList</span><span class="p">)),</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">trans</span> <span class="o">=</span> <span class="n">transList</span><span class="p">[</span><span class="n">originTransNo</span><span class="p">]</span>

                        <span class="n">newInputState</span><span class="p">,</span> <span class="n">resultInfo</span> <span class="o">=</span> <span class="n">transitionRefiner</span><span class="o">.</span><span class="n">refineFinalState</span><span class="p">(</span><span class="n">transIniPos</span><span class="p">,</span> <span class="n">transSpecie</span><span class="p">,</span> <span class="n">graphVolume</span><span class="p">,</span> <span class="n">volumeTransitionObject</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">newInputState</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Basin event newInputState is None!&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">xContinue</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">xSuccess</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">currentState_backup</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">DVbackup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">selectEvent attempted to revert a basin&#39;s currentDV to None&quot;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">currentDV</span> <span class="o">=</span> <span class="n">DVbackup</span>
<span class="c1">#                                 self.basinList[basinNum].currentTrans = None</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="n">results</span><span class="o">.</span><span class="n">totalRate</span> <span class="o">-=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                            <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># store final hashkey into basin</span>
                            <span class="k">if</span> <span class="n">transijk</span><span class="o">.</span><span class="n">finalHashkey</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="c1"># which DV in the final state?</span>
                                <span class="n">tmpList2</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">newInputState</span><span class="o">.</span><span class="n">NDefectVolumes</span><span class="p">):</span>
                                    <span class="n">tmpList2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">newInputState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span><span class="o">.</span><span class="n">com</span><span class="p">,</span> <span class="n">currentState2</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">workingVol</span><span class="p">]</span><span class="o">.</span><span class="n">com</span><span class="p">,</span> <span class="n">currentState2</span><span class="o">.</span><span class="n">cellDims</span><span class="p">))</span>
                                <span class="n">NumVol</span> <span class="o">=</span> <span class="n">tmpList2</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">tmpList2</span><span class="p">))</span>

                                <span class="n">transijk</span><span class="o">.</span><span class="n">finalHashkey</span> <span class="o">=</span> <span class="n">newInputState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">[</span><span class="n">NumVol</span><span class="p">]</span>
                                <span class="n">transijk</span><span class="o">.</span><span class="n">finalCOM</span> <span class="o">=</span> <span class="n">newInputState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">NumVol</span><span class="p">]</span><span class="o">.</span><span class="n">com</span>
                                <span class="n">transijk</span><span class="o">.</span><span class="n">moment</span> <span class="o">=</span> <span class="n">newInputState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">NumVol</span><span class="p">]</span><span class="o">.</span><span class="n">moment</span>
                                <span class="n">transijk</span><span class="o">.</span><span class="n">storeFinalDVInfo</span><span class="p">(</span><span class="n">newInputState</span><span class="p">,</span> <span class="n">NumVol</span><span class="p">)</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">currentTrans</span> <span class="o">=</span> <span class="n">pp</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">previousDV</span> <span class="o">=</span> <span class="n">volumeNum</span>
                            <span class="k">if</span> <span class="n">DVbackup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">selectEvent attempted to update a basin&#39;s currentDV to </span><span class="se">\&#39;</span><span class="s2">None</span><span class="se">\&#39;</span><span class="s2"> (transijk.finalDV)&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">transijk</span><span class="o">.</span><span class="n">finalDV</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Basin event: Current DV of basin </span><span class="si">%d</span><span class="s2"> moving from defect volume </span><span class="si">%d</span><span class="s2"> to </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">basinNum</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">currentDV</span><span class="p">,</span> <span class="n">transijk</span><span class="o">.</span><span class="n">finalDV</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Basin evetn: Escaping basin </span><span class="si">%d</span><span class="s2"> from defect volume </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">basinNum</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">currentDV</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">currentDV</span> <span class="o">=</span> <span class="n">transijk</span><span class="o">.</span><span class="n">finalDV</span>
                            <span class="n">xContinue</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">xSuccess</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Warning: Attempt to fix selectEvent&#39;s workingVol was unsuccessful. Event cannot be used!&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">xContinue</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">xSuccess</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">currentState_backup</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">DVbackup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">selectEvent attempted to revert a basin&#39;s currentDV to None&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">currentDV</span> <span class="o">=</span> <span class="n">DVbackup</span>
<span class="c1">#                             self.basinList[basinNum].currentTrans = None</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">totalRate</span> <span class="o">-=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xSuccess</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">xContinue</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">currentState_backup</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">DVbackup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">selectEvent attempted to revert a basin&#39;s currentDV to None&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">currentDV</span> <span class="o">=</span> <span class="n">DVbackup</span>
<span class="c1">#                         self.basinList[basinNum].currentTrans = None</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">totalRate</span> <span class="o">-=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;ERROR: Selected an event with unknown origin&quot;</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">xSuccess</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">newInputState</span>
            <span class="k">return</span> <span class="n">eventTime</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">,</span> <span class="n">dupFlag</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Cannot select an event...&quot;</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">,</span> <span class="n">dupFlag</span></div>


<span class="c1">#############################################################</span>
<div class="viewcode-block" id="KMCRunner.getBasinDetails"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.getBasinDetails">[docs]</a>    <span class="k">def</span> <span class="nf">getBasinDetails</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts the correct basin information from the map for a given transition event.</span>
<span class="sd">        Code lifted from now defunct method belong2Basin (see old versions of the repository)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            Index of the selected event in the results dictionary</span>
<span class="sd">        self.searchResults : KMCStepResults object</span>
<span class="sd">            Has attribute resultsDict -- a dictionary object containing information about available transitions.</span>
<span class="sd">        self.basinList : list</span>
<span class="sd">            A list of al the basin objects created.</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        basinNum : int</span>
<span class="sd">            The basinList index of the basin corresponding to the event.</span>
<span class="sd">        volumeNum : int</span>
<span class="sd">            The index of the selected volume within the basin.</span>
<span class="sd">        dupFlag : bool</span>
<span class="sd">            Denotes whether the volume selected is a duplcate state (True means duplicate).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span>
        <span class="n">basins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span>

        <span class="n">chosenHashkey</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeHashkey&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        <span class="n">chosenCOM</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeCOM&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        <span class="n">basinNum</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">volumeNum</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">transNum</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dupFlag</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">chosenHashkey</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;WARNING: getBasinDetails received blank result. Cannot extract basin details.&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">,</span> <span class="n">dupFlag</span>

        <span class="c1"># store defects in current dv</span>
        <span class="c1"># if this trans from previous basin volume</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span> <span class="n">dupFlag</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinNum&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">i</span><span class="o">=</span><span class="n">j</span><span class="o">=</span><span class="n">dupFlag</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">j</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">basins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">lattice</span> <span class="o">=</span> <span class="n">Dummy</span><span class="o">.</span><span class="n">DummyLatticeBasin</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>
            <span class="n">currentVolIndex</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># if this trans from current step searches</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lattice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldState</span>

            <span class="n">currentVolIndex</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volIndxs&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">currentVolIndex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;WARNING: </span><span class="si">%s</span><span class="s2"> not found in currentState defectVolumes&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">chosenHashkey</span><span class="p">,),</span> <span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">,</span> <span class="n">dupFlag</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span> <span class="n">dupFlag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinNum&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">i</span><span class="o">=</span><span class="n">j</span><span class="o">=</span><span class="n">dupFlag</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">basinNum</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">volumeNum</span> <span class="o">=</span> <span class="n">j</span>

        <span class="c1"># if basinNum not stored in resultsDict</span>
        <span class="k">if</span> <span class="n">basinNum</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">volumeNum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basins</span><span class="p">)):</span>
                <span class="n">basinI</span> <span class="o">=</span> <span class="n">basins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">volumeNum</span><span class="p">,</span> <span class="n">dupFlag</span> <span class="o">=</span> <span class="n">basinI</span><span class="o">.</span><span class="n">whichDV</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">currentVolIndex</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">volumeNum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">basinNum</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="k">break</span>


        <span class="k">if</span> <span class="n">basinNum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;WARNING: Could not find basin state corresponding to selected event!&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">,</span> <span class="n">dupFlag</span></div>

<span class="c1">#############################################################</span>
<div class="viewcode-block" id="KMCRunner.addSearches"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.addSearches">[docs]</a>    <span class="k">def</span> <span class="nf">addSearches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volumeIndex</span><span class="p">,</span> <span class="n">storeTransIfSearching</span><span class="p">,</span> <span class="n">transObjDict</span><span class="p">,</span> <span class="n">fixSearchDict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">volTransObject</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add searches on volume.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Calling addSearches&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># local refs</span>
        <span class="n">currentState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span>
        <span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

        <span class="c1"># defect volume</span>
        <span class="n">dv</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span>

        <span class="c1"># number of fixed barrier refinements done for this volume</span>
        <span class="n">fixedRefineNum</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span><span class="o">.</span><span class="n">fixedRefine</span><span class="p">)</span>

        <span class="c1"># store transitions for reuse</span>
        <span class="k">if</span> <span class="n">dv</span><span class="o">.</span><span class="n">combinedVol</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">reuseCombinedVolumes</span><span class="p">:</span>
            <span class="n">storeForReuse</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">elif</span> <span class="n">dv</span><span class="o">.</span><span class="n">partOfCombinedVol</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">combinedVolStoreIndividual</span><span class="p">:</span>
            <span class="n">storeForReuse</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">elif</span> <span class="n">dv</span><span class="o">.</span><span class="n">combinedVol</span> <span class="ow">or</span> <span class="n">dv</span><span class="o">.</span><span class="n">partOfCombinedVol</span><span class="p">:</span>
            <span class="n">storeForReuse</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">storeForReuse</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">volTransObject</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">append</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">storeForReuse</span><span class="p">:</span>
                <span class="c1"># transitions object</span>
                <span class="n">volTransObject</span> <span class="o">=</span> <span class="n">Defects</span><span class="o">.</span><span class="n">VolumeTransitionsObject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
                <span class="n">volTransObject</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">graphVol</span><span class="p">,</span> <span class="n">currentState</span><span class="p">,</span> <span class="n">dv</span><span class="o">.</span><span class="n">graphKey</span><span class="p">)</span>

                <span class="n">transObjDict</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">volTransObject</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">volTransObject</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">append</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">transObjDict</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">volTransObject</span>

        <span class="c1"># are we fixing search input</span>
        <span class="k">if</span> <span class="n">fixSearchDict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fixList</span> <span class="o">=</span> <span class="n">fixSearchDict</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span>

        <span class="c1"># number of searches</span>
        <span class="n">NSearches</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">kmcNoSearch</span> <span class="o">+</span> <span class="n">fixedRefineNum</span>

        <span class="c1"># check fix list</span>
        <span class="n">extraJobsPerc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">extraJobs</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extraJobsPerc</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">extraJobsPerc</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="n">NSearchesToAdd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">extraJobsPerc</span><span class="p">)</span> <span class="o">*</span> <span class="n">NSearches</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fixSearchDict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fixList</span><span class="p">)</span> <span class="o">==</span> <span class="n">NSearchesToAdd</span><span class="p">,</span> <span class="s2">&quot;ERROR: fixList wrong length </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fixList</span><span class="p">),</span> <span class="n">NSearchesToAdd</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dv</span><span class="o">.</span><span class="n">combinedVol</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Adding searches on combined volume </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%d</span><span class="s2"> atoms, </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%d</span><span class="s2">) searches)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span>
                                                                                                  <span class="nb">len</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">searchInitialVol</span><span class="p">),</span>
                                                                                                  <span class="n">NSearches</span><span class="p">,</span> <span class="n">NSearchesToAdd</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Adding searches on volume </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%d</span><span class="s2"> atoms, </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%d</span><span class="s2">) searches)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span>
                                                                                         <span class="nb">len</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">searchInitialVol</span><span class="p">),</span>
                                                                                         <span class="n">NSearches</span><span class="p">,</span>
                                                                                         <span class="n">NSearchesToAdd</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># unique id for this job</span>
        <span class="n">jobID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;JobID: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">jobID</span><span class="p">),),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># tell results about this volume</span>
        <span class="k">if</span> <span class="n">append</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">modifyVolumeNItems</span><span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">NSearches</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">addVolume</span><span class="p">(</span><span class="n">jobID</span><span class="p">,</span> <span class="n">volumeIndex</span><span class="p">,</span> <span class="n">NSearches</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">volTransObject</span><span class="o">=</span><span class="n">volTransObject</span><span class="p">)</span>

        <span class="c1"># update status obj</span>
        <span class="k">if</span> <span class="n">append</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fixedRefineNum</span><span class="p">:</span>
                <span class="n">statusNumSearches</span> <span class="o">=</span> <span class="n">NSearches</span> <span class="o">*</span> <span class="mf">2.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">statusNumSearches</span> <span class="o">=</span> <span class="n">NSearches</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">statusNumSearches</span> <span class="o">=</span> <span class="n">NSearches</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">updateSearchInfo</span><span class="p">(</span><span class="n">NSearches</span><span class="o">=</span><span class="p">{</span><span class="n">volumeIndex</span><span class="p">:</span> <span class="n">statusNumSearches</span><span class="p">,})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">writeStatus</span><span class="p">()</span>

        <span class="c1"># searcher</span>
        <span class="n">searcher</span> <span class="o">=</span> <span class="n">Search</span><span class="o">.</span><span class="n">TransitionSearcher</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">storeTransForReuse</span><span class="o">=</span><span class="n">storeForReuse</span><span class="p">)</span>
        <span class="n">searcher</span><span class="o">.</span><span class="n">setJobID</span><span class="p">(</span><span class="n">jobID</span><span class="p">)</span>
        <span class="n">searcher</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

        <span class="c1"># current data ID</span>
        <span class="n">currentDataID</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">currentDataID</span>

        <span class="k">if</span> <span class="n">fixSearchDict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># job</span>
            <span class="n">jobItem</span> <span class="o">=</span> <span class="n">ClientServerInterface</span><span class="o">.</span><span class="n">JobQueueItem</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">jobID</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">searcher</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;run&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">volumeIndex</span><span class="p">,),</span> <span class="n">dataID</span><span class="o">=</span><span class="n">currentDataID</span><span class="p">)</span>

            <span class="c1"># add jobs</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">NSearchesToAdd</span><span class="p">):</span>
                <span class="n">server</span><span class="o">.</span><span class="n">addJob</span><span class="p">(</span><span class="n">jobItem</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># add jobs</span>
            <span class="k">for</span> <span class="n">fixObj</span> <span class="ow">in</span> <span class="n">fixList</span><span class="p">:</span>
                <span class="c1"># fix object passed as kwarg</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fixSearchObj&quot;</span><span class="p">:</span> <span class="n">fixObj</span><span class="p">}</span>

                <span class="c1"># job item</span>
                <span class="n">jobItem</span> <span class="o">=</span> <span class="n">ClientServerInterface</span><span class="o">.</span><span class="n">JobQueueItem</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">jobID</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">searcher</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;run&quot;</span><span class="p">,</span>
                                                             <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">volumeIndex</span><span class="p">,),</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">dataID</span><span class="o">=</span><span class="n">currentDataID</span><span class="p">)</span>

                <span class="c1"># add job</span>
                <span class="n">server</span><span class="o">.</span><span class="n">addJob</span><span class="p">(</span><span class="n">jobItem</span><span class="p">)</span></div>

<span class="c1">#############################################################</span>
<div class="viewcode-block" id="KMCRunner.addIniEigenValCalcs"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.addIniEigenValCalcs">[docs]</a>    <span class="k">def</span> <span class="nf">addIniEigenValCalcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobID</span><span class="p">,</span> <span class="n">iniEVList</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add initial eigenvalue calculations on volumes</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Calling addIniEigenValCalcs&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># local refs</span>
        <span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span>
        <span class="n">currentState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

        <span class="n">NItems</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">iniEVList</span><span class="p">)</span>

        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Adding initial eigenvalue calculations on volumes: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NItems</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">calculator</span> <span class="o">=</span> <span class="n">Prefactor</span><span class="o">.</span><span class="n">PrefactorCalculator</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="c1"># current data ID</span>
        <span class="n">currentDataID</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">currentDataID</span>

        <span class="n">results</span><span class="o">.</span><span class="n">addIniEigenValCalcs</span><span class="p">(</span><span class="n">jobID</span><span class="p">,</span> <span class="n">iniEVList</span><span class="p">)</span>

        <span class="c1"># add to queue</span>
        <span class="k">for</span> <span class="n">volumeIndex</span> <span class="ow">in</span> <span class="n">iniEVList</span><span class="p">:</span>
            <span class="n">jobItem</span> <span class="o">=</span> <span class="n">ClientServerInterface</span><span class="o">.</span><span class="n">JobQueueItem</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">jobID</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">calculator</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;calculate&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="p">),</span> <span class="n">dataID</span><span class="o">=</span><span class="n">currentDataID</span><span class="p">)</span>

            <span class="n">server</span><span class="o">.</span><span class="n">addJob</span><span class="p">(</span><span class="n">jobItem</span><span class="p">)</span></div>

<span class="c1">#############################################################</span>
<div class="viewcode-block" id="KMCRunner.addRefinement"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.addRefinement">[docs]</a>    <span class="k">def</span> <span class="nf">addRefinement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volumeIndex</span><span class="p">,</span> <span class="n">transObjDict</span><span class="p">,</span><span class="n">repeat</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add refinement on volume.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Calling addRefinement&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># local refs</span>
        <span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span>
        <span class="n">currentState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

        <span class="c1"># graph volume</span>
        <span class="n">graphVolume</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span><span class="o">.</span><span class="n">graphVol</span>
        <span class="n">graphKey</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span>
        <span class="n">fixedRefine</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span><span class="o">.</span><span class="n">fixedRefine</span>

        <span class="c1"># get transitions</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">transitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span>

            <span class="n">transObjDict</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">transitions</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;ERROR: volume does not exist in reuse dict (</span><span class="si">%s</span><span class="s2">): we should search but I haven&#39;t implemented it yet&quot;</span> <span class="o">%</span> <span class="n">graphKey</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="n">NItems</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">transitions</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)</span>

        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Adding refinement on volume </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%d</span><span class="s2"> atoms, </span><span class="si">%d</span><span class="s2"> transitions)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">graphVolume</span><span class="p">),</span> <span class="n">NItems</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># unique id for this job</span>
        <span class="n">jobID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;JobID: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">jobID</span><span class="p">),),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># tell results about this volume</span>
        <span class="n">results</span><span class="o">.</span><span class="n">addVolume</span><span class="p">(</span><span class="n">jobID</span><span class="p">,</span> <span class="n">volumeIndex</span><span class="p">,</span> <span class="n">NItems</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">volTransObject</span><span class="o">=</span><span class="n">transitions</span><span class="p">,</span> <span class="n">fixedRefineNum</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fixedRefine</span><span class="p">))</span>

        <span class="c1"># if empty job, set to finished</span>
        <span class="k">if</span> <span class="n">NItems</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">finished</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">NItems</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">fixedRefine</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">finished</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># update status obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">updateSearchInfo</span><span class="p">(</span><span class="n">NSearches</span><span class="o">=</span><span class="p">{</span><span class="n">volumeIndex</span><span class="p">:</span> <span class="n">NItems</span><span class="p">,},</span><span class="n">fixedRefineNum</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">fixedRefine</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">writeStatus</span><span class="p">()</span>

        <span class="n">transIniPos</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">.</span><span class="n">initialPos</span>
        <span class="n">transSpecie</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">.</span><span class="n">specie</span>
        <span class="n">transList</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">.</span><span class="n">transitionList</span>

        <span class="k">if</span> <span class="n">transIniPos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;ERROR: transIniPos is None&quot;</span>
            <span class="k">return</span> <span class="mi">2</span>

        <span class="c1"># refiner object</span>
        <span class="n">refiner</span> <span class="o">=</span> <span class="n">Refine</span><span class="o">.</span><span class="n">TransitionRefiner</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refState</span><span class="p">)</span>
        <span class="n">refiner</span><span class="o">.</span><span class="n">setJobID</span><span class="p">(</span><span class="n">jobID</span><span class="p">)</span>
        <span class="n">refiner</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

        <span class="c1"># current data ID</span>
        <span class="n">currentDataID</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">currentDataID</span>

        <span class="c1"># add to queue</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">transList</span><span class="p">)):</span>
            <span class="c1"># Do not do refinements on transitions already used in fixed barrier refinement</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fixedRefine</span><span class="p">:</span>
                <span class="n">trans</span> <span class="o">=</span> <span class="n">transList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">jobItem</span> <span class="o">=</span> <span class="n">ClientServerInterface</span><span class="o">.</span><span class="n">JobQueueItem</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">jobID</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">refiner</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;run&quot;</span><span class="p">,</span>
                                                         <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">transIniPos</span><span class="p">,</span> <span class="n">transSpecie</span><span class="p">,</span> <span class="n">graphVolume</span><span class="p">),</span>
                                                         <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;reuseWorkVolId&quot;</span><span class="p">:</span> <span class="n">volumeIndex</span><span class="p">,</span> <span class="s2">&quot;volumeTransitionObject&quot;</span><span class="p">:</span> <span class="n">trans</span><span class="p">},</span>
                                                         <span class="n">dataID</span><span class="o">=</span><span class="n">currentDataID</span><span class="p">)</span>
                <span class="n">server</span><span class="o">.</span><span class="n">addJob</span><span class="p">(</span><span class="n">jobItem</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reuseStats</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reuseStats</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span></div>

<span class="c1">#############################################################</span>
<div class="viewcode-block" id="KMCRunner.addRefinementsAndSearches"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.addRefinementsAndSearches">[docs]</a>    <span class="k">def</span> <span class="nf">addRefinementsAndSearches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volumeIndex</span><span class="p">,</span> <span class="n">storeTransIfSearching</span><span class="p">,</span> <span class="n">transObjDict</span><span class="p">,</span> <span class="n">fixSearchDict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">volTransObject</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add refinement and searches on volume when a volume is not fully explored.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        volumeIndex : int</span>
<span class="sd">            The index for the defect volume in the current state</span>
<span class="sd">        storeTransIfSearching: bool</span>
<span class="sd">            Option to store transitions for reuse later on</span>
<span class="sd">        transObjDict: dictionary</span>
<span class="sd">            Dictionary of  transition objects for current state</span>
<span class="sd">        fixSearchDict :</span>
<span class="sd">            Dictionary of fixed transition directions</span>
<span class="sd">        volTransObject: volumeTransitionObject</span>
<span class="sd">            An existing VTO for this defect volume. Default = None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Calling addRefinementsAndSearches&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># local refs</span>
        <span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span>
        <span class="n">currentState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

        <span class="c1"># graph volume</span>
        <span class="n">graphVolume</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span><span class="o">.</span><span class="n">graphVol</span>
        <span class="n">graphKey</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span>
        <span class="n">fixedRefine</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span><span class="o">.</span><span class="n">fixedRefine</span>

        <span class="c1"># get transitions</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">transitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span>

            <span class="n">transObjDict</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">transitions</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;ERROR: volume does not exist in reuse dict (</span><span class="si">%s</span><span class="s2">): we should search but I haven&#39;t implemented it yet&quot;</span> <span class="o">%</span> <span class="n">graphKey</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="n">NItems</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">transitions</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)</span>

        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Adding refinement on volume </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%d</span><span class="s2"> atoms, </span><span class="si">%d</span><span class="s2"> transitions)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">graphVolume</span><span class="p">),</span> <span class="n">NItems</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># unique id for this job</span>
        <span class="n">jobID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;JobID: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">jobID</span><span class="p">),),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># tell results about this volume</span>
        <span class="n">results</span><span class="o">.</span><span class="n">addVolume</span><span class="p">(</span><span class="n">jobID</span><span class="p">,</span> <span class="n">volumeIndex</span><span class="p">,</span> <span class="n">NItems</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">volTransObject</span><span class="o">=</span><span class="n">transitions</span><span class="p">,</span> <span class="n">fixedRefineNum</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fixedRefine</span><span class="p">))</span>

        <span class="c1"># if empty job, set to finished</span>
        <span class="k">if</span> <span class="n">NItems</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;WARNING: attempting refinement on 0 transitions&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># update status obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">updateSearchInfo</span><span class="p">(</span><span class="n">NSearches</span><span class="o">=</span><span class="p">{</span><span class="n">volumeIndex</span><span class="p">:</span> <span class="n">NItems</span><span class="p">,},</span><span class="n">fixedRefineNum</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">fixedRefine</span><span class="p">))</span>

        <span class="n">transIniPos</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">.</span><span class="n">initialPos</span>
        <span class="n">transSpecie</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">.</span><span class="n">specie</span>
        <span class="n">transList</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">.</span><span class="n">transitionList</span>

        <span class="k">if</span> <span class="n">transIniPos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;ERROR: transIniPos is None&quot;</span>
            <span class="k">return</span> <span class="mi">2</span>

        <span class="c1"># refiner object</span>
        <span class="n">refiner</span> <span class="o">=</span> <span class="n">Refine</span><span class="o">.</span><span class="n">TransitionRefiner</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refState</span><span class="p">)</span>
        <span class="n">refiner</span><span class="o">.</span><span class="n">setJobID</span><span class="p">(</span><span class="n">jobID</span><span class="p">)</span>
        <span class="n">refiner</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

        <span class="c1"># current data ID</span>
        <span class="n">currentDataID</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">currentDataID</span>

        <span class="c1"># add to queue</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">transList</span><span class="p">)):</span>
            <span class="c1"># Do not do refinements on transitions already used in fixed barrier refinement</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fixedRefine</span><span class="p">:</span>
                <span class="n">trans</span> <span class="o">=</span> <span class="n">transList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">jobItem</span> <span class="o">=</span> <span class="n">ClientServerInterface</span><span class="o">.</span><span class="n">JobQueueItem</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">jobID</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">refiner</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;run&quot;</span><span class="p">,</span>
                                                         <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">transIniPos</span><span class="p">,</span> <span class="n">transSpecie</span><span class="p">,</span> <span class="n">graphVolume</span><span class="p">),</span>
                                                         <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;reuseWorkVolId&quot;</span><span class="p">:</span> <span class="n">volumeIndex</span><span class="p">,</span> <span class="s2">&quot;volumeTransitionObject&quot;</span><span class="p">:</span> <span class="n">trans</span><span class="p">},</span>
                                                         <span class="n">dataID</span><span class="o">=</span><span class="n">currentDataID</span><span class="p">)</span>
                <span class="n">server</span><span class="o">.</span><span class="n">addJob</span><span class="p">(</span><span class="n">jobItem</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reuseStats</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reuseStats</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>


        <span class="c1"># add searches</span>
        <span class="n">NSearches</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">kmcNoSearch</span>

        <span class="n">results</span><span class="o">.</span><span class="n">modifyVolumeNItems</span><span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">NSearches</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">updateSearchInfo</span><span class="p">(</span><span class="n">NSearches</span><span class="o">=</span><span class="p">{</span><span class="n">volumeIndex</span><span class="p">:</span> <span class="n">NSearches</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">transList</span><span class="p">),},</span><span class="n">fixedRefineNum</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">fixedRefine</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">writeStatus</span><span class="p">()</span>

        <span class="c1"># searcher</span>
        <span class="n">searcher</span> <span class="o">=</span> <span class="n">Search</span><span class="o">.</span><span class="n">TransitionSearcher</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">storeTransForReuse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">searcher</span><span class="o">.</span><span class="n">setJobID</span><span class="p">(</span><span class="n">jobID</span><span class="p">)</span>
        <span class="n">searcher</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>


        <span class="c1"># job</span>
        <span class="n">jobItem</span> <span class="o">=</span> <span class="n">ClientServerInterface</span><span class="o">.</span><span class="n">JobQueueItem</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">jobID</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">searcher</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;run&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">volumeIndex</span><span class="p">,),</span> <span class="n">dataID</span><span class="o">=</span><span class="n">currentDataID</span><span class="p">)</span>

        <span class="c1"># add jobs</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">NSearches</span><span class="p">):</span>
            <span class="n">server</span><span class="o">.</span><span class="n">addJob</span><span class="p">(</span><span class="n">jobItem</span><span class="p">)</span></div>




<span class="c1">#############################################################</span>
<div class="viewcode-block" id="KMCRunner.loadTransitionFixFiles"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.loadTransitionFixFiles">[docs]</a>    <span class="k">def</span> <span class="nf">loadTransitionFixFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load fix files</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Calling loadTransitionFixFiles&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Loading transition fix files from: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">dirname</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">OWD</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fixFiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.fix*&quot;</span><span class="p">)</span>

            <span class="n">volDict</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">fixFiles</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Loading fix file: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="n">zipFlag</span><span class="p">,</span> <span class="n">fn2</span> <span class="o">=</span> <span class="n">Utilities</span><span class="o">.</span><span class="n">checkForZipped</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn2</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">NSearches</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Number of searches: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">NSearches</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

                    <span class="n">transFixList</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">NSearches</span><span class="p">:</span>
                        <span class="c1"># step size</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">stepSize</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                        <span class="c1"># displacement vector</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">dispVec</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span>
                        <span class="n">dispVec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dispVec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

                        <span class="c1"># dimer orientation vector</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">NVec</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span>
                        <span class="n">NVec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">NVec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

                        <span class="c1"># lanczos initial vector</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">rVec</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span>
                        <span class="n">rVec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rVec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

                        <span class="c1"># create object</span>
                        <span class="n">obj</span> <span class="o">=</span> <span class="n">Utilities</span><span class="o">.</span><span class="n">TransitionFix</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">stepSize</span><span class="p">,</span> <span class="n">dispVec</span><span class="p">,</span> <span class="n">NVec</span><span class="p">,</span> <span class="n">rVec</span><span class="p">)</span>

                        <span class="n">transFixList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

                        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># remove unzipped</span>
                <span class="k">if</span> <span class="n">zipFlag</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">fn2</span><span class="p">)</span>

                <span class="c1"># put in vol dict</span>
                <span class="n">volKey</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">volDict</span><span class="p">[</span><span class="n">volKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">transFixList</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">OWD</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">volDict</span></div>

<span class="c1">#############################################################</span>
<div class="viewcode-block" id="KMCRunner.getTransitions"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.getTransitions">[docs]</a>    <span class="k">def</span> <span class="nf">getTransitions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get trans new.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Calling getTransitions&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Finding transitions&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># local refs</span>
        <span class="n">currentState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span>
        <span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span>

        <span class="c1"># store full defect list</span>
        <span class="n">fullDefectList</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectList</span>

        <span class="c1"># counter for number of volumes in each each volume group</span>
        <span class="n">volGroupCounter</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">volumeGroupID</span><span class="p">)</span>

        <span class="c1"># do we store transitions (if searching) for each volume</span>
        <span class="n">storeTransIfSearching</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">volumeIndex</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">)):</span>

            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span><span class="p">:</span>
                <span class="n">storeTransIfSearching</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">elif</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span><span class="o">.</span><span class="n">combinedVol</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">reuseCombinedVolumes</span><span class="p">:</span>
                    <span class="n">storeTransIfSearching</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">storeTransIfSearching</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># is this volume part of a larger group?</span>
                <span class="n">groupID</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">volumeGroupID</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span>
                <span class="n">numInGroup</span> <span class="o">=</span> <span class="n">volGroupCounter</span><span class="p">[</span><span class="n">groupID</span><span class="p">]</span>

                <span class="c1"># if it is don&#39;t store transitions</span>
                <span class="k">if</span> <span class="n">numInGroup</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">combinedVolStoreIndividual</span><span class="p">:</span>
                    <span class="n">storeTransIfSearching</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">storeTransIfSearching</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>


        <span class="c1"># job IDs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobIDsSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># what to do with vols</span>
        <span class="n">defectVolumesSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">currentVolsSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">)</span>
        <span class="n">searchList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reuseList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">iniEVList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reuseListFull</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fixedJobIDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">))</span>
        <span class="n">fixedBarVTO</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">reuseDepDict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># volumes that still need to search</span>
        <span class="n">extraReuse</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">tmpDV</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">dv</span> <span class="ow">in</span> <span class="n">tmpDV</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">currentVolsSet</span> <span class="ow">and</span> <span class="n">dv</span><span class="o">.</span><span class="n">moreSearch</span><span class="p">:</span>
                <span class="n">extraReuse</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>


        <span class="n">extraReuseSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">extraReuse</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="n">ignoreVolKeys</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">barrIgnoreVolKeys</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>


        <span class="c1">########################################################################</span>
        <span class="c1"># fixed barrier refinement</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span><span class="p">:</span>
            <span class="n">refine</span> <span class="o">=</span> <span class="n">Refine</span><span class="o">.</span><span class="n">TransitionRefiner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refState</span><span class="p">)</span>
            <span class="n">refine</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="p">)</span>
            <span class="c1"># setup lists for unique final checks</span>
            <span class="n">refine</span><span class="o">.</span><span class="n">setTransitionsLists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">finalsLock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">finalsListProxy</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">barriersListProxy</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">volKey</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">):</span>

                <span class="c1"># Add extraReuse results into</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">basin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">bdv</span> <span class="o">=</span> <span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="n">fixedRefine</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bdv</span><span class="o">.</span><span class="n">transitions</span><span class="p">)):</span>
                        <span class="n">bTrans</span> <span class="o">=</span> <span class="n">bdv</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">bTrans</span><span class="o">.</span><span class="n">dupRef</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">volKey</span> <span class="o">==</span> <span class="n">bdv</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">[</span><span class="n">bTrans</span><span class="o">.</span><span class="n">dupRef</span><span class="p">]:</span>
                                <span class="c1"># Duplicate initial</span>
                                <span class="n">fixedRefine</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bTrans</span><span class="o">.</span><span class="n">reuseIndex</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">bTrans</span><span class="o">.</span><span class="n">dupRef</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># Primary initial</span>
                            <span class="n">fixedRefine</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bTrans</span><span class="o">.</span><span class="n">reuseIndex</span><span class="p">)</span>

                    <span class="c1"># Fixed barrier refinement of transitions in fixedRefine</span>
                    <span class="n">allTransAreFixedRefine</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">explored</span> <span class="ow">and</span> <span class="n">volKey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignoreVolKeys</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">dv</span> <span class="o">=</span> <span class="n">extraReuse</span><span class="p">[</span><span class="n">volKey</span><span class="p">]</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Adding fixed barrier refinement for extraReuse transitions from volume </span><span class="si">%d</span><span class="s2"> with key </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">volKey</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="n">addVolFlag</span> <span class="o">=</span> <span class="mi">1</span>

                            <span class="c1"># check if all transitions in volume are fixed barrier refinements</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">fixedRefine</span><span class="p">):</span>
                                <span class="n">allTransAreFixedRefine</span> <span class="o">=</span> <span class="kc">True</span>

                            <span class="k">for</span> <span class="n">t2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)):</span>
                                <span class="k">if</span> <span class="n">t2</span> <span class="ow">in</span> <span class="n">fixedRefine</span><span class="p">:</span>
                                    <span class="n">trans</span> <span class="o">=</span> <span class="n">dv</span><span class="o">.</span><span class="n">transitionList</span><span class="p">[</span><span class="n">t2</span><span class="p">]</span>
                                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;--Adding transition </span><span class="si">%d</span><span class="s2">, to hashkey </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">trans</span><span class="o">.</span><span class="n">finalHashkey</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                                    <span class="c1"># add volume only once</span>
                                    <span class="k">if</span> <span class="n">addVolFlag</span><span class="p">:</span>
                                        <span class="c1"># create VTO for fixed barrier refinements</span>
                                        <span class="n">fixedBarVTOtemp</span> <span class="o">=</span> <span class="n">Defects</span><span class="o">.</span><span class="n">VolumeTransitionsObject</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                                        <span class="n">fixedBarVTOtemp</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">graphVol</span><span class="p">,</span> <span class="n">currentState</span><span class="p">,</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">graphKey</span><span class="p">)</span>
                                        <span class="n">fixedBarVTO</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixedBarVTOtemp</span>

                                        <span class="c1"># create job ID</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">jobIDsSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                        <span class="n">jobID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                        <span class="n">fixedJobIDs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;JobID: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">jobID</span><span class="p">),),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                                        <span class="c1"># add volume</span>
                                        <span class="n">results</span><span class="o">.</span><span class="n">addVolume</span><span class="p">(</span><span class="n">jobID</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">volTransObject</span><span class="o">=</span><span class="n">fixedBarVTO</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                        <span class="n">refine</span><span class="o">.</span><span class="n">setJobID</span><span class="p">(</span><span class="n">jobID</span><span class="p">)</span>

                                    <span class="n">barriers</span> <span class="o">=</span> <span class="p">[</span><span class="n">trans</span><span class="o">.</span><span class="n">barrier</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>

                                    <span class="c1"># run refinement</span>
                                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;(1) run refine&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                                    <span class="n">extraResult</span> <span class="o">=</span> <span class="n">refine</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dv</span><span class="o">.</span><span class="n">initialPos</span><span class="p">,</span> <span class="n">dv</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">graphVol</span><span class="p">,</span> <span class="n">reuseWorkVolId</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">volumeTransitionObject</span><span class="o">=</span><span class="n">trans</span><span class="p">,</span> <span class="n">fixedBarrier</span><span class="o">=</span><span class="n">barriers</span><span class="p">)</span>
                                    <span class="n">extraResult</span><span class="o">.</span><span class="n">transitionObject</span> <span class="o">=</span> <span class="n">trans</span>
                                    <span class="n">extraResult</span><span class="o">.</span><span class="n">job</span> <span class="o">=</span> <span class="s2">&quot;FIXEDREFINE&quot;</span>

                                    <span class="c1"># add to results dict and volumeTransitionsDict</span>
                                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;(2) process result&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                                    <span class="c1"># results.processResult(extraResult)</span>
                                    <span class="n">results</span><span class="o">.</span><span class="n">processSearchRefineResult</span><span class="p">(</span><span class="n">extraResult</span><span class="p">)</span>

                                    <span class="c1"># remove because it is a basin event and will be update later</span>
                                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;(3) remove from dict&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                                    <span class="n">results</span><span class="o">.</span><span class="n">removeFromDict</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                                    <span class="n">results</span><span class="o">.</span><span class="n">NStoredTot</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">NStoredTot</span> <span class="o">-</span> <span class="mi">1</span>

                                    <span class="c1"># set up reuseStats</span>
                                    <span class="k">if</span> <span class="n">volKey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reuseStats</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">reuseStats</span><span class="p">[</span><span class="n">volKey</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                                    <span class="n">addVolFlag</span> <span class="o">=</span> <span class="mi">0</span>
                                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;--transition </span><span class="si">%d</span><span class="s2">, to hashkey </span><span class="si">%r</span><span class="s2"> correctly added &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">trans</span><span class="o">.</span><span class="n">finalHashkey</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;No fixed barrier refinement for transition </span><span class="si">%d</span><span class="s2"> on volume </span><span class="si">%s</span><span class="s2"> (different duplicate initial)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">volKey</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;No fixed barrier refinement for </span><span class="si">%s</span><span class="s2"> (not in extraReuse)&quot;</span> <span class="o">%</span> <span class="n">volKey</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Number of fixed barrier refinements: </span><span class="si">%d</span><span class="s2"> for volume </span><span class="si">%d</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fixedRefine</span><span class="p">),</span><span class="n">i</span><span class="p">,</span><span class="n">volKey</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="c1"># update fixedRefine on currentDVs</span>
                    <span class="k">if</span> <span class="n">allTransAreFixedRefine</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fixedRefine</span> <span class="o">=</span> <span class="s2">&quot;FullFixedRefine&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fixedRefine</span> <span class="o">=</span> <span class="n">fixedRefine</span>

        <span class="c1">########################################################################</span>


        <span class="c1"># discount ignored keys</span>
        <span class="k">for</span> <span class="n">volKey</span> <span class="ow">in</span> <span class="n">currentVolsSet</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">volKey</span> <span class="ow">in</span> <span class="n">ignoreVolKeys</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Vol </span><span class="si">%s</span><span class="s2"> is in ignored volumes list. Skipping searches/reuse.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volKey</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># TODO: delete if not needed</span>
            <span class="c1"># rebuild defect volumes</span>
            <span class="c1"># if params.useBasin and len(self.basinList):</span>
            <span class="c1">#     log(__name__, &quot;Beginning defect volume rebuild code in getTransitions (volKey = %s).&quot;%volKey,2,3)</span>
            <span class="c1">#     for i, volumeKey in enumerate(currentState.defectVolumesKeys):</span>
            <span class="c1">#         DVnum = None</span>
            <span class="c1">#</span>
            <span class="c1">#         # find which basin DV it belongs to</span>
            <span class="c1">#         # for ii in range(len(self.basinList)):</span>
            <span class="c1">#         #     DVnum, dupFlag, _ = self.basinList[ii].whichDV(currentState, i, explored = True)</span>
            <span class="c1">#         #     if DVnum is not None:</span>
            <span class="c1">#         #         break</span>
            <span class="c1">#</span>
            <span class="c1">#         # Use map to find which basin DV it belongs to</span>
            <span class="c1">#         DVnum   = self.map[i][0]</span>
            <span class="c1">#         dupFlag = self.map[i][1]</span>
            <span class="c1">#</span>
            <span class="c1">#         if DVnum is not None and dupFlag:</span>
            <span class="c1">#             DV = self.basinList[ii].defectVolumes[DVnum]</span>
            <span class="c1">#             log(__name__, &quot;Rebuilding defect volume %d in basin %d. Defect volume index = %d&quot; % (i, ii, DVnum), 2, 1)</span>
            <span class="c1">#             currentState.defectVolumes[i].rebuild(DV.graphVol, DV.hashkey, DV.COM, DV.moment)</span>
            <span class="c1">#</span>
            <span class="c1">#             defectVolumesSet = set(self.defectVolumes.keys())</span>


            <span class="k">if</span> <span class="n">volKey</span> <span class="ow">in</span> <span class="n">defectVolumesSet</span><span class="p">:</span>
                <span class="c1"># reuse</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">volumeKey</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">volumeKey</span> <span class="o">==</span> <span class="n">volKey</span><span class="p">:</span>
                        <span class="n">statusTmp</span> <span class="o">=</span> <span class="mi">0</span>

                        <span class="c1"># Although we have accounted for duplicate basin states, we still wish to skip reuse for states already visited</span>
                        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">):</span>
                            <span class="n">DVnum</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span> <span class="c1"># These lines could probably re replaced by a map call</span>
                                <span class="n">DVnum</span><span class="p">,</span> <span class="n">dupFlag</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">whichDV</span><span class="p">(</span><span class="n">currentState</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">explored</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="c1">#                                 if DVnum is not None and not dupFlag:</span>
                                <span class="k">if</span> <span class="n">DVnum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="k">break</span>
                            <span class="k">if</span> <span class="n">DVnum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">DVnum</span><span class="p">]</span><span class="o">.</span><span class="n">explored</span><span class="p">:</span>
                                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Vol </span><span class="si">%d</span><span class="s2"> [</span><span class="si">%s</span><span class="s2">] is a basin state that has been visited. Skipping reuse.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">volKey</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1">#                                 tmpFlag = 1</span>
                                <span class="n">statusTmp</span> <span class="o">=</span> <span class="mi">1</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">statusTmp</span><span class="p">:</span>
                            <span class="c1"># add jobs for refinement</span>

                            <span class="c1"># if all transitions are included in fixed barrier refinements, skip</span>
                            <span class="n">iniEVList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fixedRefine</span> <span class="o">==</span> <span class="s2">&quot;FullFixedRefine&quot;</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">reuseList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="n">reuseListFull</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">jobIDsSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="c1"># check is DV is fully explored or not</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">explored</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volKey</span><span class="p">]</span><span class="o">.</span><span class="n">explored</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Volume </span><span class="si">%s</span><span class="s2"> has explored status: </span><span class="si">%r</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volKey</span><span class="p">,</span> <span class="n">explored</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">explored</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">explored</span><span class="p">:</span>
                <span class="c1"># if kmcNoSearch is zero, skip searches</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">kmcNoSearch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Skip searching on Vol </span><span class="si">%s</span><span class="s2">, since number of search is ZERO.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volKey</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># list of all volumes with this key</span>
                <span class="n">volIndicesTmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">)</span> <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">volKey</span><span class="p">]</span>

                <span class="c1"># rearrange so all storeTrue volumes are first (two passes)</span>
                <span class="n">volIndices</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">foundStoreTrue</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">volIndicesTmp</span><span class="p">:</span>
<span class="c1">#                     if storeTransIfSearching[index]:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">partOfCombinedVol</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">combinedVolStoreIndividual</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">combinedVol</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">reuseCombinedVolumes</span><span class="p">):</span>
                        <span class="k">pass</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">volIndices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                        <span class="n">foundStoreTrue</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">volIndicesTmp</span><span class="p">:</span>
<span class="c1">#                     if not storeTransIfSearching[index]:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">partOfCombinedVol</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">combinedVolStoreIndividual</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">combinedVol</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">reuseCombinedVolumes</span><span class="p">):</span>
                        <span class="n">volIndices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

                <span class="c1"># now decide what to do</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">volIndex</span> <span class="ow">in</span> <span class="n">volIndices</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># always search the first one</span>

                        <span class="n">searchList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volIndex</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">fixedJobIDs</span><span class="p">[</span><span class="n">volIndex</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">volIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">jobIDsSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">volIndex</span><span class="p">])</span>

                        <span class="n">iniEVList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volIndex</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">foundStoreTrue</span><span class="p">:</span>
                            <span class="c1"># if we&#39;re storing (at least) the first one then reuse the rest</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">reuseDepDict</span><span class="p">[</span><span class="n">volKey</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volIndex</span><span class="p">)</span>
                                <span class="n">reuseListFull</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volIndex</span><span class="p">)</span>
                                <span class="n">iniEVList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volIndex</span><span class="p">)</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">fixedJobIDs</span><span class="p">[</span><span class="n">volIndex</span><span class="p">]:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">volIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">jobIDsSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">volIndex</span><span class="p">])</span>

                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="n">reuseDepDict</span><span class="p">[</span><span class="n">volKey</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">volIndex</span><span class="p">,]</span>
                                <span class="n">reuseListFull</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volIndex</span><span class="p">)</span>
                                <span class="n">iniEVList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volIndex</span><span class="p">)</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">fixedJobIDs</span><span class="p">[</span><span class="n">volIndex</span><span class="p">]:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">volIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">jobIDsSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">volIndex</span><span class="p">])</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># otherwise search the rest too</span>
                            <span class="n">searchList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volIndex</span><span class="p">)</span>
                            <span class="n">iniEVList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volIndex</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">fixedJobIDs</span><span class="p">[</span><span class="n">volIndex</span><span class="p">]:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">volIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">jobIDsSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">volIndex</span><span class="p">])</span>

                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># return if nothing to do</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">reuseList</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">searchList</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="c1"># better ordering of searches (put first ones that have dependencies, otherwise random...)</span>
        <span class="c1">#TODO: at some point ordering should depend on size?</span>
        <span class="n">searchListOrdered</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">volIndex</span> <span class="ow">in</span> <span class="n">searchList</span><span class="p">:</span>
            <span class="n">volKey</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">[</span><span class="n">volIndex</span><span class="p">]</span>

            <span class="c1"># if other volumes depend on this volume, put it first</span>
            <span class="k">if</span> <span class="n">volKey</span> <span class="ow">in</span> <span class="n">reuseDepDict</span><span class="p">:</span>
                <span class="n">searchListOrdered</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">volIndex</span><span class="p">)</span>
            <span class="c1"># otherwise just append</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">searchListOrdered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volIndex</span><span class="p">)</span>

        <span class="n">searchList</span> <span class="o">=</span> <span class="n">searchListOrdered</span>

        <span class="c1"># external events</span>
        <span class="n">externalList</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1">#        print &quot;SEARCH LIST:&quot;, searchList</span>
<span class="c1">#        print &quot;REUSE LIST:&quot;, reuseList</span>
<span class="c1">#        print &quot;REUSE DEP DICT:&quot;, reuseDepDict</span>
<span class="c1">#        print &quot;COMBINED LIST&quot;, combinedList</span>
<span class="c1">#        print &quot;EXTERNAL EVENT LIST&quot;, externalList</span>
<span class="c1">#        print &quot;JOB IDS&quot;, self.jobIDs</span>

        <span class="c1"># server set data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;initialState&#39;</span><span class="p">:</span> <span class="n">currentState</span><span class="p">,</span> <span class="s1">&#39;refState&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">refState</span><span class="p">}</span>

        <span class="n">server</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">fixedPrefactor</span><span class="p">:</span>
        <span class="c1"># job ID for eigenvql cqlcs</span>
            <span class="n">eigValJobID</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobIDsSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">eigValJobID</span><span class="p">)</span>

        <span class="c1"># server set job ids</span>
        <span class="n">server</span><span class="o">.</span><span class="n">setJobIDs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobIDsSet</span><span class="p">)</span>

        <span class="c1"># if in reuse and search, move to new list</span>
        <span class="n">removeList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reuseAndSearchList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">reuseList</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reuseList</span><span class="p">)):</span>
                <span class="n">volumeIndexRL</span> <span class="o">=</span> <span class="n">reuseList</span><span class="p">[</span><span class="n">rl</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">searchList</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">sl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">searchList</span><span class="p">)):</span>
                        <span class="n">volumeIndexSL</span> <span class="o">=</span> <span class="n">searchList</span><span class="p">[</span><span class="n">sl</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">volumeIndexSL</span> <span class="o">==</span> <span class="n">volumeIndexRL</span><span class="p">:</span>
                            <span class="n">removeList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">sl</span><span class="p">,</span><span class="n">rl</span><span class="p">])</span>
                            <span class="n">reuseAndSearchList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volumeIndexRL</span><span class="p">)</span>
                            <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;WARNING: searchList was None. You may wish to delete the defect volume files&quot;</span> <span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;WARNING: reuseList was None. You may wish to delete the defect volume files&quot;</span> <span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># remove from search/reuse lists</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">removeList</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">rem</span> <span class="o">=</span> <span class="n">removeList</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="n">searchList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">rem</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">reuseList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">rem</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># if remove from a one element list, list then becomes empty list</span>
        <span class="k">if</span> <span class="n">searchList</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">searchList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">reuseList</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reuseList</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#TODO: check that null jobs aren&#39;t added!</span>
        <span class="c1"># status object</span>
        <span class="n">statusObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span>
        <span class="n">statusObj</span><span class="o">.</span><span class="n">resetSearches</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="n">currentState</span><span class="o">=</span><span class="n">currentState</span><span class="p">)</span>
        <span class="n">statusObj</span><span class="o">.</span><span class="n">updateSearchInfo</span><span class="p">(</span><span class="n">searchList</span><span class="o">=</span><span class="n">searchList</span><span class="p">,</span> <span class="n">reuseList</span><span class="o">=</span><span class="n">reuseListFull</span><span class="p">,</span> <span class="n">reuseAndSearchList</span><span class="o">=</span><span class="n">reuseAndSearchList</span><span class="p">)</span>

        <span class="c1"># check if fixing dimer input</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;fix.input.dir&quot;</span><span class="p">):</span>
            <span class="n">fixSearchDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadTransitionFixFiles</span><span class="p">(</span><span class="s2">&quot;fix.input.dir&quot;</span><span class="p">)</span>

            <span class="c1"># do some checks</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fixSearchDict</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">fixSearchDict</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># dict for storing transition object</span>
        <span class="n">transObjDict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># add initial state eigenvalues</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">fixedPrefactor</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addIniEigenValCalcs</span><span class="p">(</span><span class="n">eigValJobID</span><span class="p">,</span> <span class="n">iniEVList</span><span class="p">)</span>

        <span class="c1"># write tempory basin report</span>
        <span class="n">tempBRP</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">debugBasin</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">useBasin</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">:</span>
            <span class="n">tempBRP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinReport</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

        <span class="c1"># add reuse</span>
        <span class="k">for</span> <span class="n">volumeIndex</span> <span class="ow">in</span> <span class="n">reuseList</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addRefinement</span><span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">transObjDict</span><span class="p">)</span>

        <span class="c1"># add searches to server</span>
        <span class="k">for</span> <span class="n">volumeIndex</span> <span class="ow">in</span> <span class="n">searchList</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">addSearches</span><span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">storeTransIfSearching</span><span class="p">,</span> <span class="n">transObjDict</span><span class="p">,</span> <span class="n">fixSearchDict</span><span class="o">=</span><span class="n">fixSearchDict</span><span class="p">,</span> <span class="n">volTransObject</span><span class="o">=</span><span class="n">fixedBarVTO</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">addSearches</span><span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">storeTransIfSearching</span><span class="p">,</span> <span class="n">transObjDict</span><span class="p">,</span> <span class="n">fixSearchDict</span><span class="o">=</span><span class="n">fixSearchDict</span><span class="p">)</span>

        <span class="c1"># add search and refinements for a single volume (basin only)</span>
        <span class="k">for</span> <span class="n">volumeIndex</span> <span class="ow">in</span> <span class="n">reuseAndSearchList</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addRefinementsAndSearches</span><span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">storeTransIfSearching</span><span class="p">,</span> <span class="n">transObjDict</span><span class="p">,</span> <span class="n">fixSearchDict</span><span class="o">=</span><span class="n">fixSearchDict</span><span class="p">)</span>

        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Waiting for results&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Max idle time: </span><span class="si">%.1f</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="n">params</span><span class="o">.</span><span class="n">maxIdleTime</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># get results</span>
        <span class="n">lastStatusUpdate</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">lastResultTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">statusUpdateInterval</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">statusUpdateInterval</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># get result (timeout of 10 seconds)</span>
            <span class="n">result</span><span class="p">,</span> <span class="n">empty</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">getResult</span><span class="p">()</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Result:</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">result</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># check if result or timeout</span>
            <span class="k">if</span> <span class="n">empty</span> <span class="ow">or</span> <span class="p">(</span><span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;EMPTYJOB&quot;</span><span class="p">):</span>
                <span class="c1"># if timeout we check how long since the last result was received</span>
                <span class="n">timeSinceLastResult</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">lastResultTime</span>

                <span class="c1"># if time since last result if big we should terminate with an error message for now</span>
                <span class="k">if</span> <span class="n">timeSinceLastResult</span> <span class="o">&gt;</span> <span class="n">params</span><span class="o">.</span><span class="n">maxIdleTime</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;CRITICAL ERROR: we have not received a result for more than </span><span class="si">%.1f</span><span class="s2"> seconds (normal searches)&quot;</span> <span class="o">%</span> <span class="n">params</span><span class="o">.</span><span class="n">maxIdleTime</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">server</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">88</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># store time we received this result</span>
                <span class="n">lastResultTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">tmp1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">])</span>
                <span class="c1"># log(__name__, &quot;\ttmp1 %d&quot;%tmp1, 2, 0)</span>

                <span class="c1"># process the result</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">processResult</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="c1">#Rebuild defect volumes...?</span>

                <span class="n">tmp2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">])</span>
                <span class="c1"># log(__name__, &quot;\ttmp2 %d&quot;%tmp2, 2, 0)</span>

                <span class="n">volNum</span> <span class="o">=</span> <span class="n">stop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1"># if low barrier, build reverse transition</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">tmp2</span><span class="o">-</span><span class="n">tmp1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">stop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">Prefactor</span><span class="o">.</span><span class="n">iniEVCalcjobName</span><span class="p">):</span> <span class="c1">#This line ensures that transition found is both unique and not a prefactor calculation</span>
                    <span class="k">assert</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volIndxs&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Result has no volIndx assigned!&quot;</span>
                    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinFlag&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">#Looking to see if transition is low barrier event</span>

                            <span class="c1"># Debug check</span>
                            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalHashkey&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinFlag&quot;</span><span class="p">]),</span> <span class="s2">&quot;finalHashkey list and basinFlag list in the resultsDict are not of the same length (</span><span class="si">%d</span><span class="s2"> and </span><span class="si">%d</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalHashkey&quot;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinFlag&quot;</span><span class="p">]))</span>

                            <span class="c1"># Low barrier processing section</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;volNum = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">volNum</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;map length = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;current states has </span><span class="si">%d</span><span class="s2"> defect volumes&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                            <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalHashkey&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="c1"># Initial low barrier processing assigns states to basins, creating the latter as necessary.</span>
                                <span class="n">status</span><span class="p">,</span> <span class="n">basinI</span><span class="p">,</span> <span class="n">volumeNumIni</span><span class="p">,</span> <span class="n">volumeNumFin</span><span class="p">,</span> <span class="n">dupFlagIni</span><span class="p">,</span> <span class="n">dupFlagFin</span><span class="p">,</span> <span class="n">newInitial</span><span class="p">,</span> <span class="n">newFinal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowBarrierProcessing</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">volNum</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">volumeNumIni</span> <span class="o">==</span> <span class="n">volumeNumFin</span><span class="p">:</span>
                                    <span class="n">status</span> <span class="o">=</span> <span class="mi">3</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">status</span> <span class="o">=</span> <span class="mi">2</span>

                            <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
                                <span class="c1"># This is where the pair of basin transitions are saved.</span>
                                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Proceeding to save transition pair: calling saveResultsToBasin.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="n">iniKey</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeHashkey&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">status</span><span class="p">,</span> <span class="n">alreadyInBasin</span><span class="p">,</span> <span class="n">extraReuse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveResultsToBasin</span><span class="p">(</span><span class="n">basinI</span><span class="p">,</span> <span class="n">volumeNumIni</span><span class="p">,</span> <span class="n">volumeNumFin</span><span class="p">,</span> <span class="n">dupFlagIni</span><span class="p">,</span> <span class="n">dupFlagFin</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">extraReuse</span><span class="p">,</span> <span class="n">volNum</span><span class="p">)</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
                                    <span class="c1"># Remove result from main results object</span>
                                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Transition is in a basin, removing from results object.&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                                    <span class="n">results</span><span class="o">.</span><span class="n">removeFromDict</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                                    <span class="n">results</span><span class="o">.</span><span class="n">NStoredTot</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">NStoredTot</span> <span class="o">-</span> <span class="mi">1</span>
                                <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Transition pair, </span><span class="si">%r</span><span class="s2"> to </span><span class="si">%r</span><span class="s2">, could not be added to basin </span><span class="si">%r</span><span class="s2"> by saveResultsToBasin, nor was it already stored.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">volumeNumIni</span><span class="p">,</span> <span class="n">volumeNumFin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">volNum</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

                                <span class="c1"># If a new basin state has been created, we must save all of its existing non-low barrier transitions to the basin as escaping transitions.</span>
                                <span class="k">if</span> <span class="n">newInitial</span><span class="p">:</span>
                                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;We have just discovered that the initial state is a basin state. Adding its escaping transitions now.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                                    <span class="n">addStatus</span><span class="p">,</span> <span class="n">extraReuse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addMissedEscapeTransitions</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">NStoredTot</span><span class="p">,</span> <span class="n">basinI</span><span class="p">,</span> <span class="n">volumeNumIni</span><span class="p">,</span> <span class="n">extraReuse</span><span class="p">,</span> <span class="n">iniKey</span><span class="p">,</span> <span class="n">volNum</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;WARNING: lowBarrierProcessing failed for transition pair, </span><span class="si">%r</span><span class="s2"> to </span><span class="si">%r</span><span class="s2">, (proposed basin was </span><span class="si">%r</span><span class="s2">).&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">volumeNumIni</span><span class="p">,</span> <span class="n">volumeNumFin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">volNum</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;WARNING: Final Hashkey is None! Reverse transition not built and result not added to a basin! (No call to lowBarrierProcessing made.)&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;WARNING: lowBarrierProcessing returned identical basin state indexes for initial and final. Deleting transition from dictionary.&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                                <span class="n">results</span><span class="o">.</span><span class="n">removeFromDict</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                                <span class="n">results</span><span class="o">.</span><span class="n">NStoredTot</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">NStoredTot</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Unknown status (</span><span class="si">%r</span><span class="s2">) encountered.&quot;</span> <span class="o">%</span> <span class="n">status</span><span class="p">)</span>

                            <span class="n">extraReuseSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">extraReuse</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

                        <span class="c1"># If the initial volume is a basin state and has a non-low barrier transition, that transition is an escape from the basin.</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">volNum</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinFlag&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;transIndex&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;We have encountered a new non-low barrier transition on volume </span><span class="si">%d</span><span class="s2"> (internal index </span><span class="si">%d</span><span class="s2">), escaping basin </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volNum</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">volNum</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">volNum</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalHashkey&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="c1"># Save the forward (i.e. basin escaping) transition to the basin.</span>
                                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Transition is a new escaping state from basin </span><span class="si">%d</span><span class="s2"> -- Proceeding to save it.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">volNum</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="n">status</span><span class="p">,</span> <span class="n">alreadyInBasin</span><span class="p">,</span> <span class="n">extraReuse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveResultsToBasin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">volNum</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">volNum</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">volNum</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">extraReuse</span><span class="p">,</span> <span class="n">volNum</span><span class="p">,</span> <span class="n">addPair</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
                                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Transition is in a basin, removing from results object.&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                                    <span class="n">results</span><span class="o">.</span><span class="n">removeFromDict</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                                    <span class="n">results</span><span class="o">.</span><span class="n">NStoredTot</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">NStoredTot</span> <span class="o">-</span> <span class="mi">1</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Transition from volume </span><span class="si">%d</span><span class="s2">, escaping basin </span><span class="si">%r</span><span class="s2">, could not be saved by saveResultsToBasin, nor was it already stored.&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">volNum</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">volNum</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Warning: Could not add escaping transition from basin </span><span class="si">%r</span><span class="s2">, volume </span><span class="si">%r</span><span class="s2">, because its final hashkey was </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">volNum</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">volNum</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalHashkey&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Removing from results dictionary to avoid undefined behavior.&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                                <span class="n">results</span><span class="o">.</span><span class="n">removeFromDict</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                                <span class="n">results</span><span class="o">.</span><span class="n">NStoredTot</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">NStoredTot</span> <span class="o">-</span> <span class="mi">1</span>

                <span class="c1"># if we have been told to stop this job</span>
                <span class="k">if</span> <span class="n">stop</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="c1"># do we really need to stop this volume</span>
                    <span class="n">needToStop</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">repeat</span><span class="p">[</span><span class="n">volNum</span><span class="p">]:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Finished searches and refinements: Repeat = </span><span class="si">%r</span><span class="s2">, StoreTrans = </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">repeat</span><span class="p">[</span><span class="n">volNum</span><span class="p">],</span><span class="n">storeTransIfSearching</span><span class="p">[</span><span class="n">volNum</span><span class="p">]),</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

                        <span class="c1"># add reuse to dict?</span>
                        <span class="k">if</span> <span class="n">storeTransIfSearching</span><span class="p">[</span><span class="n">volNum</span><span class="p">]:</span>
                            <span class="n">graphKey</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">[</span><span class="n">volNum</span><span class="p">]</span>
                            <span class="n">volTransObject</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">volumeTransitionsDict</span><span class="p">[</span><span class="n">volNum</span><span class="p">]</span>

                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">debugBasin</span><span class="p">:</span>
                                <span class="nb">print</span> <span class="s2">&quot;Hashkey information&quot;</span>
                                <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">volNum&quot;</span><span class="p">,</span> <span class="n">volNum</span>
                                <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">graphKey = </span><span class="si">%s</span><span class="se">\n</span><span class="s2">volTransObject.hashKey = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">graphKey</span><span class="p">,</span> <span class="n">volTransObject</span><span class="o">.</span><span class="n">hashKey</span><span class="p">)</span>
                                <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Other Keys&quot;</span>
                                <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">currentState.defectVolumesKeys&quot;</span>
                                <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">)):</span>
                                    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
                                <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">results.volumeTransitionsDict&quot;</span>
                                <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">volumeTransitionsDict</span><span class="p">:</span>
                                    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">volumeTransitionsDict</span><span class="p">[</span><span class="n">volume</span><span class="p">]</span><span class="o">.</span><span class="n">hashKey</span>
                                    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">results.volumeTransitionsDict[volume].transitionList&quot;</span>
                                    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">volumeTransitionsDict</span><span class="p">[</span><span class="n">volume</span><span class="p">]</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)):</span>
                                        <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">volumeTransitionsDict</span><span class="p">[</span><span class="n">volume</span><span class="p">]</span><span class="o">.</span><span class="n">transitionList</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">.</span><span class="n">finalHashkey</span>

                            <span class="c1">#Recombining the various transitions lists</span>
                            <span class="k">if</span> <span class="n">graphKey</span> <span class="ow">in</span> <span class="n">extraReuseSet</span><span class="p">:</span>
                                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;CALL TO MERGE in getTransitions (1)&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                                <span class="n">mergeNum</span><span class="p">,</span> <span class="n">tmpList</span> <span class="o">=</span> <span class="n">volTransObject</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">extraReuse</span><span class="p">[</span><span class="n">graphKey</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="s2">&quot;Merging_extraReuse_in_getTransitions(1)&quot;</span><span class="p">)</span>
                                <span class="n">extraReuse</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">graphKey</span><span class="p">)</span>
                                <span class="n">extraReuseSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">extraReuse</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

                                <span class="c1"># TODO: check if these wants deleting</span>
                                <span class="c1"># if mergeNum is not None:</span>
                                <span class="c1">#     volNum2 = []</span>
                                <span class="c1">#     for kk in range(len(currentState.defectVolumesKeys)):</span>
                                <span class="c1">#         if currentState.defectVolumesKeys[kk] == graphKey:</span>
                                <span class="c1">#             volNum2.append(kk)</span>
                                <span class="c1">#     results.addMergeResultToDict(mergeNum, volTransObject, volNum2)</span>

                                <span class="c1"># loop over all basin states, correct transIndex info</span>
                                <span class="k">for</span> <span class="n">basinI</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">volumeIJ</span> <span class="ow">in</span> <span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">:</span>

                                        <span class="c1"># check if primary hashkey</span>
                                        <span class="k">if</span> <span class="n">volumeIJ</span><span class="o">.</span><span class="n">hashkey</span> <span class="o">==</span> <span class="n">graphKey</span><span class="p">:</span>
                                            <span class="k">for</span> <span class="n">transIJK</span> <span class="ow">in</span> <span class="n">volumeIJ</span><span class="o">.</span><span class="n">transitions</span><span class="p">:</span>
                                                <span class="k">if</span> <span class="n">transIJK</span><span class="o">.</span><span class="n">dupRef</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                                    <span class="k">if</span> <span class="n">transIJK</span><span class="o">.</span><span class="n">reuseIndex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                                                        <span class="n">tmpIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">transIJK</span><span class="o">.</span><span class="n">reuseIndex</span>
                                                        <span class="k">if</span> <span class="n">tmpList</span><span class="p">[</span><span class="n">tmpIndex</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                                            <span class="n">transIJK</span><span class="o">.</span><span class="n">reuseIndex</span> <span class="o">=</span> <span class="n">tmpList</span><span class="p">[</span><span class="n">tmpIndex</span><span class="p">]</span>

                                                        <span class="k">else</span><span class="p">:</span>
                                                            <span class="n">tmptmpIndex</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">volTransObject</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)</span>
                                                            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tmpIndex</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmpList</span><span class="p">)):</span>
                                                                <span class="k">if</span> <span class="n">tmpList</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                                                    <span class="n">tmptmpIndex</span> <span class="o">-=</span> <span class="mi">1</span>
                                                            <span class="n">transIJK</span><span class="o">.</span><span class="n">reuseIndex</span> <span class="o">=</span> <span class="n">tmptmpIndex</span>

                                        <span class="c1"># check if duplicate hashkey</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">volumeIJ</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">)):</span>
                                                <span class="k">if</span> <span class="n">volumeIJ</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">==</span> <span class="n">graphKey</span><span class="p">:</span>
                                                    <span class="k">for</span> <span class="n">transIJK</span> <span class="ow">in</span> <span class="n">volumeIJ</span><span class="o">.</span><span class="n">transitions</span><span class="p">:</span>
                                                        <span class="k">if</span> <span class="n">transIJK</span><span class="o">.</span><span class="n">dupRef</span> <span class="o">==</span> <span class="n">d</span><span class="p">:</span>
                                                            <span class="k">if</span> <span class="n">transIJK</span><span class="o">.</span><span class="n">reuseIndex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                                                                <span class="n">tmpIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">transIJK</span><span class="o">.</span><span class="n">reuseIndex</span>
                                                                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Corrected reuseIndex via a duplicate hashkey&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                                                                <span class="k">if</span> <span class="n">tmpList</span><span class="p">[</span><span class="n">tmpIndex</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                                                    <span class="n">transIJK</span><span class="o">.</span><span class="n">reuseIndex</span> <span class="o">=</span> <span class="n">tmpList</span><span class="p">[</span><span class="n">tmpIndex</span><span class="p">]</span>

                                                                <span class="k">else</span><span class="p">:</span>
                                                                    <span class="n">tmptmpIndex</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">volTransObject</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)</span>
                                                                    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tmpIndex</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmpList</span><span class="p">)):</span>
                                                                        <span class="k">if</span> <span class="n">tmpList</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                                                            <span class="n">tmptmpIndex</span> <span class="o">-=</span> <span class="mi">1</span>
                                                                    <span class="n">transIJK</span><span class="o">.</span><span class="n">reuseIndex</span> <span class="o">=</span> <span class="n">tmptmpIndex</span>


                            <span class="n">NSaved</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">volumeTransitionsDict</span><span class="p">[</span><span class="n">volNum</span><span class="p">]</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)</span>
                            <span class="n">checkRate</span> <span class="o">=</span> <span class="kc">True</span>

                            <span class="c1"># if not enough transitions found, do another set of transitions -- TODO: DISABLED FOR NOW!</span>
                            <span class="c1"># if NSaved &lt; params.refineMinTransSavedForStorage:</span>
                            <span class="c1">#     if volTransObject.searchDone &lt; 2:</span>
                            <span class="c1">#         log(__name__, &quot;Not enough transitions (%d&lt;%d) found during searches, do more searches&quot; % (NSaved, params.refineMinTransSavedForStorage), 1, 1)</span>
                            <span class="c1">#</span>
                            <span class="c1">#         # add searches again</span>
                            <span class="c1">#         self.addSearches(volNum, storeTransIfSearching, transObjDict, fixSearchDict=fixSearchDict, volTransObject=volTransObject)</span>
                            <span class="c1">#         volTransObject.searchDone += 1</span>
                            <span class="c1">#</span>
                            <span class="c1">#         checkRate = False</span>
                            <span class="c1">#         needToStop = False</span>
                            <span class="c1">#</span>
                            <span class="c1">#     else:</span>
                            <span class="c1">#         log(__name__, &quot;Warning!: We have done 2 sets of searches, and still don&#39;t get enough transitions (%d&lt;%d). Probably those are only transitions we can find.&quot; % (NSaved,params.refineMinTransSavedForStorage), 1)</span>

                            <span class="c1"># check if we should be storing these results or not</span>
                            <span class="c1"># also check if other volumes depended on this one finishing</span>
                            <span class="k">if</span> <span class="n">checkRate</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">NStored</span><span class="p">[</span><span class="n">volNum</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">NSuccessful</span><span class="p">[</span><span class="n">volNum</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">volumeNItemsDict</span><span class="p">[</span><span class="n">volNum</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">.</span><span class="n">refineSuccessFracForStorage</span><span class="p">:</span>
                                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Removing volume from memory due to low success rate (</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">) </span><span class="si">%d</span><span class="s2"> stored.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">NSuccessful</span><span class="p">[</span><span class="n">volNum</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">volumeNItemsDict</span><span class="p">[</span><span class="n">volNum</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">NStored</span><span class="p">[</span><span class="n">volNum</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

                                    <span class="n">transObjDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">volNum</span><span class="p">)</span>

                                    <span class="c1"># check if something was waiting for this, run searches if was</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">depList</span> <span class="o">=</span> <span class="n">reuseDepDict</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span>

                                        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">depList</span><span class="p">):</span>
                                            <span class="n">volumeIndex</span> <span class="o">=</span> <span class="n">depList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">addSearches</span><span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">storeTransIfSearching</span><span class="p">,</span> <span class="n">transObjDict</span><span class="p">,</span> <span class="n">fixSearchDict</span><span class="o">=</span><span class="n">fixSearchDict</span><span class="p">)</span>

                                            <span class="k">if</span> <span class="n">storeTransIfSearching</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]:</span>
                                                <span class="k">break</span>

                                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                        <span class="k">pass</span>

                                <span class="k">elif</span> <span class="n">NSaved</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">(</span><span class="n">NSaved</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">volumeNItemsDict</span><span class="p">[</span><span class="n">volNum</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">.</span><span class="n">refineSavedFracForStorage</span><span class="p">:</span>
                                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Removing volume from memory due to low number saved (</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NSaved</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">volumeNItemsDict</span><span class="p">[</span><span class="n">volNum</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

                                    <span class="n">transObjDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">volNum</span><span class="p">)</span>


                                    <span class="c1"># check if something was waiting for this, run searches if was</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">depList</span> <span class="o">=</span> <span class="n">reuseDepDict</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span>

                                        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">depList</span><span class="p">):</span>
                                            <span class="n">volumeIndex</span> <span class="o">=</span> <span class="n">depList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">addSearches</span><span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">storeTransIfSearching</span><span class="p">,</span> <span class="n">transObjDict</span><span class="p">,</span> <span class="n">fixSearchDict</span><span class="o">=</span><span class="n">fixSearchDict</span><span class="p">)</span>

                                            <span class="k">if</span> <span class="n">storeTransIfSearching</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]:</span>
                                                <span class="k">break</span>

                                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                        <span class="k">pass</span>

                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">volTransObject</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">volumeTransitionsDict</span><span class="p">[</span><span class="n">volNum</span><span class="p">]</span>
                                    <span class="n">volTransObject</span><span class="o">.</span><span class="n">explored</span> <span class="o">=</span> <span class="kc">True</span>

                                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Storing </span><span class="si">%d</span><span class="s2"> transitions for reuse (</span><span class="si">%s</span><span class="s2">) (in memory)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">volTransObject</span><span class="o">.</span><span class="n">transitionList</span><span class="p">),</span> <span class="n">graphKey</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

                                    <span class="c1"># assign defect volume</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">volTransObject</span>

                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">reuseStats</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span>
                                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">reuseStats</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

                                    <span class="c1"># if something depended on this job finishing, add it (ie if BOTH storeTrans is True and in deps dict)</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">depList</span> <span class="o">=</span> <span class="n">reuseDepDict</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span>

                                        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">depList</span><span class="p">):</span>
                                            <span class="n">volumeIndex</span> <span class="o">=</span> <span class="n">depList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">addRefinement</span><span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">transObjDict</span><span class="p">)</span>

                                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                        <span class="k">pass</span>

                    <span class="k">if</span> <span class="n">volNum</span> <span class="ow">in</span> <span class="n">searchList</span> <span class="ow">or</span> <span class="n">volNum</span> <span class="ow">in</span> <span class="n">reuseAndSearchList</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">needToStop</span><span class="p">:</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Stopping repeating job (vol </span><span class="si">%d</span><span class="s2">, ID </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volNum</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">ID</span><span class="p">[</span><span class="n">volNum</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="n">server</span><span class="o">.</span><span class="n">stopJob</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">ID</span><span class="p">[</span><span class="n">volNum</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">needToStop</span><span class="p">:</span>
                        <span class="c1"># tell results object that we have stopped searches on this volume (ie shouldn&#39;t receive more results on it)</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">stopVolume</span><span class="p">(</span><span class="n">volNum</span><span class="p">)</span>

                    <span class="n">allFinished</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;WARNING: not all results are finished&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;key: </span><span class="si">%r</span><span class="s2">, value: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="n">allFinished</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>

                    <span class="k">if</span> <span class="n">allFinished</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;All extra reuse jobs completed&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">unfinishedRateCalculations</span><span class="p">):</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;We have some unfinished rate calculations&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="n">results</span><span class="o">.</span><span class="n">finishLeftRateCalculations</span><span class="p">()</span>

                        <span class="k">break</span>

            <span class="c1"># update status</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">lastStatusUpdate</span> <span class="o">&gt;</span> <span class="n">statusUpdateInterval</span><span class="p">:</span>
                <span class="n">statusObj</span><span class="o">.</span><span class="n">writeStatus</span><span class="p">()</span>
                <span class="n">lastStatusUpdate</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">flushSTDOUT</span><span class="p">:</span>
                    <span class="c1"># also flush stdout</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># add extraReuse back into defect volumes</span>
        <span class="k">for</span> <span class="n">graphKey</span> <span class="ow">in</span> <span class="n">extraReuseSet</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">graphKey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">extraReuse</span><span class="p">[</span><span class="n">graphKey</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;CALL TO MERGE in getTransitions (2)&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">extraReuse</span><span class="p">[</span><span class="n">graphKey</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="s2">&quot;Merging_extraReuse_in_getTransitions(2)&quot;</span><span class="p">)</span>
            <span class="n">extraReuse</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">graphKey</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">graphKey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reuseStats</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reuseStats</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">extraReuseSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">extraReuse</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># write modified volume transition objects</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Writing volume transition object files&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">transObjDict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">dirty</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Writing volume transition object file for volume </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%d</span><span class="s2"> transitions)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>


                <span class="c1"># send to writer</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">noStoreVolumes</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">debugBasin</span><span class="p">:</span>
                        <span class="c1"># hashkey consistency check</span>
                        <span class="n">cons</span> <span class="o">=</span> <span class="n">Graphs</span><span class="o">.</span><span class="n">consistentHashKeyCheck</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="n">obj</span><span class="o">.</span><span class="n">hashKey</span><span class="p">,</span><span class="n">obj</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">cons</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Hashkey stored incorrectly in getTransitions&quot;</span><span class="p">)</span>

                    <span class="n">outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">params</span><span class="o">.</span><span class="n">volumeDirectory</span><span class="p">)</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">writerItem</span><span class="p">(</span><span class="s2">&quot;WRITE&quot;</span><span class="p">,</span> <span class="n">dataType</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="p">,],</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">)</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">addCommand</span><span class="p">(</span><span class="s2">&quot;write&quot;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.vol&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">hashKey</span><span class="p">,)})</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

                <span class="c1"># set clean</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Not writing volume transition object file for volume </span><span class="si">%d</span><span class="s2"> (no change)&quot;</span> <span class="o">%</span> <span class="n">index</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># debugging server output</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">debugServer</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">debugJobsByRank</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">barrDebugTotalRates</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">rateDebuggingOutput</span><span class="p">()</span>

        <span class="c1"># search timing output</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">barrOutputSearchStats</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">searchTimingOutput</span><span class="p">()</span>

        <span class="c1"># clear uniqueness checking lists</span>
        <span class="n">server</span><span class="o">.</span><span class="n">clearUniquenessList</span><span class="p">()</span>

        <span class="c1"># check in nodes</span>
<span class="c1">#        server.checkInNodes()</span>

        <span class="c1"># finalise</span>
        <span class="n">results</span><span class="o">.</span><span class="n">finalise</span><span class="p">()</span>
        <span class="n">server</span><span class="o">.</span><span class="n">zipCombinedFiles</span><span class="p">(</span><span class="s2">&quot;Step</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">writeStatus</span><span class="p">()</span>

        <span class="c1"># store final status (should be a parameter)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">writeStatus</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;FinalStatus.html&quot;</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s2">&quot;Step</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">)</span>

        <span class="n">currentState</span><span class="o">.</span><span class="n">defectList</span> <span class="o">=</span> <span class="n">fullDefectList</span>

<span class="c1">#         log(__name__, &quot;Clearing data&quot;, 1)</span>
        <span class="c1"># clear data</span>
<span class="c1">#         server.clearData()</span>

        <span class="k">if</span> <span class="n">tempBRP</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tempBRP</span><span class="p">)</span>

<span class="c1">#         print &quot;DEBUG: SLEEPING A BIT&quot;</span>
        <span class="c1"># time.sleep(5)</span>

        <span class="k">return</span> <span class="mi">0</span></div>

<span class="c1">#############################################################</span>
<div class="viewcode-block" id="KMCRunner.readDefectVolumes"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.readDefectVolumes">[docs]</a>    <span class="k">def</span> <span class="nf">readDefectVolumes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read in volumes from the defect volumes directory</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Calling readDefectVolumes&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">voldir</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">volumeDirectory</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">voldir</span><span class="p">):</span>
            <span class="n">CWD</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">voldir</span><span class="p">)</span>

            <span class="c1"># obtain list of all hashkeys stored in DV directory</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">Utilities</span><span class="o">.</span><span class="n">findFiles</span><span class="p">(</span><span class="s2">&quot;*.vol&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">fn</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>

                <span class="c1"># create VTO for given hashkey</span>
                <span class="n">volumeTransitions</span> <span class="o">=</span> <span class="n">Defects</span><span class="o">.</span><span class="n">VolumeTransitionsObject</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                <span class="n">volumeTransitions</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">debugBasin</span><span class="p">:</span>
                    <span class="c1"># check if hashkeys are consistent</span>
                    <span class="n">cons</span> <span class="o">=</span> <span class="n">Graphs</span><span class="o">.</span><span class="n">consistentHashKeyCheck</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">volumeTransitions</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">cons</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Hashkey stored incorrectly in DefectVolumes&quot;</span><span class="p">)</span>


                <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">volumeTransitions</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reuseStats</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">CWD</span><span class="p">)</span></div>

<span class="c1">#############################################################</span>
<div class="viewcode-block" id="KMCRunner.updateRates"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.updateRates">[docs]</a>    <span class="k">def</span> <span class="nf">updateRates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Calling updateRates&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span>
            <span class="n">basinI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># calculate mean rate for each basin</span>
            <span class="n">rates</span> <span class="o">=</span> <span class="n">basinI</span><span class="o">.</span><span class="n">meanRate</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">rates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span><span class="s2">&quot;Mean rate calculation failed due to singular matrix&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1"># there must be sth wrong for this basin. skipp this basin</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span><span class="s2">&quot;Skipping basin </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span><span class="s2">&quot;Adding mean rates (basin </span><span class="si">%d</span><span class="s2">) back to resultDict&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)):</span>
                <span class="n">volumeIJ</span> <span class="o">=</span> <span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

                <span class="c1"># only add transitions from explored basin states</span>
                <span class="k">if</span> <span class="n">volumeIJ</span><span class="o">.</span><span class="n">explored</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">volumeIJ</span><span class="o">.</span><span class="n">transitions</span><span class="p">)):</span>
                        <span class="n">transIJK</span> <span class="o">=</span> <span class="n">volumeIJ</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

                        <span class="c1"># add the whole basin results back to the Dict</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">barrier</span><span class="p">)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volIndxs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">currentVolIndex</span><span class="p">)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;prefactors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fixedPrefactorVal</span><span class="p">)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;reverseBarriers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">reverseBarrier</span><span class="p">)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rates</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">totalRate</span> <span class="o">+=</span> <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;timing&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;externals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;reuseInfo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;debugSadSearch&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinFlag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">flag</span><span class="p">)</span>
                        <span class="c1"># ensure that we use the correct initial state if it&#39;s a duplicate</span>
                        <span class="k">if</span> <span class="n">transIJK</span><span class="o">.</span><span class="n">dupRef</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeHashkey&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volumeIJ</span><span class="o">.</span><span class="n">hashkey</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeHashkey&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volumeIJ</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">[</span><span class="n">transIJK</span><span class="o">.</span><span class="n">dupRef</span><span class="p">])</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;transIndex&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">reuseIndex</span><span class="p">)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalHashkey&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">finalHashkey</span><span class="p">)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalCOM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">finalCOM</span><span class="p">)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalMoment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">moment</span><span class="p">)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeCOM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volumeIJ</span><span class="o">.</span><span class="n">COM</span><span class="p">)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinNum&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="kc">False</span><span class="p">])</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalDVIndex&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">finalVolIndex</span><span class="p">)</span></div>

<span class="c1">#############################################################</span>
<div class="viewcode-block" id="KMCRunner.mapDVsToBasins"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.mapDVsToBasins">[docs]</a>    <span class="k">def</span> <span class="nf">mapDVsToBasins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an array mapping the current state&#39;s defect volumes to super-basins</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        self.basinList : list</span>
<span class="sd">            List of basin objects in the simulation</span>
<span class="sd">        self.currentState : lattice object</span>
<span class="sd">            Decribes the current state of the atoms in the simulation</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        map : List</span>
<span class="sd">        Array indicating the mapping of defect volumes to super-basins (&quot;returned&quot; as attribute on KMCRunner).</span>
<span class="sd">            * If a defect volume, i, in the current state, is not part of a super-basin Map[i] will be None.</span>
<span class="sd">        Otherwise,</span>
<span class="sd">            *    map[i][0] indicates the index of the super-basin that the defect volume, i, is part of.</span>
<span class="sd">            *    map[i][1] indicates the defect volume&#39;s index within the super-basin</span>
<span class="sd">            *    map[i][2] is True when the defect volume is a duplicate basin state, and is otherwise False.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">currentState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span>
        <span class="nb">max</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">map</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">preMap</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># search known basin associations first</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">):</span>
            <span class="c1"># Loop over defect volumes in the current state</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># DVnum, dupFlag, _ = self.basinList[j].whichDV(currentState, i, createFlag=False, explored=True)</span>
                    <span class="n">DVnum</span><span class="p">,</span> <span class="n">dupFlag</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">whichDV</span><span class="p">(</span><span class="n">currentState</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">createFlag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">explored</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">DVnum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;mapDVsToBasin: DV </span><span class="si">%d</span><span class="s2"> of the currentState has not changed basin&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">dupFlag</span><span class="p">:</span>
                            <span class="n">preMap</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">j</span><span class="p">,</span><span class="n">DVnum</span><span class="p">,</span><span class="kc">True</span><span class="p">])</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;---In basin </span><span class="si">%d</span><span class="s2">, defect volume </span><span class="si">%d</span><span class="s2"> (duplicate)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">DVnum</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">preMap</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">j</span><span class="p">,</span><span class="n">DVnum</span><span class="p">,</span><span class="kc">False</span><span class="p">])</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;---In basin </span><span class="si">%d</span><span class="s2">, defect volume </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">DVnum</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">preMap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">preMap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">preMap</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">))]</span>

        <span class="c1"># loop over defect volumes in the current state</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">preMap</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">preMap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">map</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">preMap</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">continue</span>

            <span class="c1"># print&quot;=&quot;*80</span>
            <span class="c1"># If there exist basins...</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">):</span>
                <span class="n">DVnum</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">dupFlag</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">matched</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># ...then loop over the list.</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span>
                    <span class="c1"># if the basin is not empty, call whichDV to discover if there is a match between the current state&#39;s DVs to the basin&#39;s DVs.</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">):</span>
                        <span class="c1"># DVnum, dupFlag, _ = self.basinList[j].whichDV(currentState, i, createFlag=False, explored=True)</span>
                        <span class="n">DVnum</span><span class="p">,</span> <span class="n">dupFlag</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">whichDV</span><span class="p">(</span><span class="n">currentState</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">createFlag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">explored</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="c1"># print DVnum, dupFlag</span>
                        <span class="k">if</span> <span class="n">DVnum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;mapDVsToBasin: DV </span><span class="si">%d</span><span class="s2"> of the current state, is DV number </span><span class="si">%d</span><span class="s2"> of a super-basin with index </span><span class="si">%d</span><span class="s2">.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">DVnum</span><span class="p">,</span><span class="n">j</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">dupFlag</span><span class="p">:</span>
                                <span class="nb">map</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">j</span><span class="p">,</span><span class="n">DVnum</span><span class="p">,</span><span class="kc">True</span><span class="p">])</span>
                                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;-- additionally, this defect volume is a duplicate hashkey states.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">map</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">j</span><span class="p">,</span><span class="n">DVnum</span><span class="p">,</span><span class="kc">False</span><span class="p">])</span>
                            <span class="n">matched</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
                    <span class="nb">map</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;mapDVsToBasin: DV </span><span class="si">%d</span><span class="s2"> of the current state does not match any existing basin.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">map</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;mapDVsToBasin: DV </span><span class="si">%d</span><span class="s2"> of the current state does not match any existing basin.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="nb">map</span>
        <span class="c1"># print &quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Updated map:&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">)):</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="se">\t</span><span class="si">%r</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">x</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># for b in range(len(self.basinList)):</span>
        <span class="c1">#     self.basinList[b].defectVolumes[self.basinList[b].currentDV].explored = copy.deepcopy(exploration[b])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">):</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Warning: Length of basin list is greater than number of defects volumes in the current state (</span><span class="si">%d</span><span class="s2"> &lt; </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></div>

<span class="c1">#############################################################</span>
<div class="viewcode-block" id="KMCRunner.lowBarrierProcessing"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.lowBarrierProcessing">[docs]</a>    <span class="k">def</span> <span class="nf">lowBarrierProcessing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">volNum</span><span class="p">,</span> <span class="n">dicIndex</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identifies the basin to which a transition should be added, including creating new basins where necessary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        result : result object</span>
<span class="sd">            The specific result (ie transition) that we are attempting to add</span>
<span class="sd">        volNum : Integer</span>
<span class="sd">            The index of the transition&#39;s initial state</span>

<span class="sd">        Returns:</span>
<span class="sd">        -----------</span>
<span class="sd">        status : int</span>
<span class="sd">            Returned as zero if no problems were encountered, otherwise reuturned as 1 (eg if finalHashkey is None).</span>
<span class="sd">        basinI : basin object</span>
<span class="sd">            The basin object we are attempting to add a transition to.</span>
<span class="sd">        volumeNumIni : int</span>
<span class="sd">            The basin index of the defect volume of the initital state</span>
<span class="sd">        volumeNumFin : int</span>
<span class="sd">            The basin index of the defect volume of the final state</span>
<span class="sd">        dupFlagIni : bool</span>
<span class="sd">            Has the initital state been flagged as a duplicate?</span>
<span class="sd">        dupFlagFin : bool</span>
<span class="sd">            Has the final state been flagged as a duplicate?</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">graphKey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalHashkey&quot;</span><span class="p">][</span><span class="n">dicIndex</span><span class="p">]</span>
        <span class="n">finalVolIndex</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">final</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">graphKey</span><span class="p">)</span>
        <span class="n">newInitial</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">newFinal</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">volNum</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Create new basin</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;volNum </span><span class="si">%d</span><span class="s2"> is not associated with any existing basin.&quot;</span><span class="o">%</span><span class="n">volNum</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;--Creating new basin for volNum </span><span class="si">%d</span><span class="s2">.&quot;</span><span class="o">%</span><span class="n">volNum</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="c1"># Create new basin object</span>
                <span class="n">basinI</span> <span class="o">=</span> <span class="n">Basin</span><span class="o">.</span><span class="n">BasinObject</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="c1"># Add initital state</span>
                <span class="n">basinI</span><span class="o">.</span><span class="n">createDV</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="p">,</span> <span class="n">volNum</span><span class="p">)</span>
                <span class="c1"># It&#39;s the current state, so it&#39;s explored</span>
                <span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">explored</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># Add the final state</span>
                <span class="n">basinI</span><span class="o">.</span><span class="n">createDV</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">final</span><span class="p">,</span> <span class="n">finalVolIndex</span><span class="p">)</span>
                <span class="c1"># Make sure correct currentDV is set for the new basin</span>
                <span class="n">basinI</span><span class="o">.</span><span class="n">currentDV</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># Store in basin list</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">basinI</span><span class="p">)</span>

                <span class="c1"># Flag that we have added new state</span>
                <span class="n">newInitial</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">newFinal</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># Update map</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;--Updating map with new basin/volume association.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">volNum</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;New map:&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">)):</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

                <span class="c1"># Information to pass to saveResultsToBasin</span>
                <span class="n">basinNum</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">volumeNumIni</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">dupFlagIni</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">volumeNumFin</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">dupFlagFin</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Find the basin to which this state belongs, and its internal reference &amp; duplicate status</span>
                <span class="n">basinNum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">volNum</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">volumeNumIni</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">volNum</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">dupFlagIni</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">volNum</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                <span class="c1"># Retrieve basin from the list</span>
                <span class="n">basinI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span>
                <span class="c1"># Back up the currentDV to prevent changes</span>
                <span class="n">currentDV</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">currentDV</span><span class="p">)</span>

                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;The initial volume, volNum </span><span class="si">%d</span><span class="s2">, is associated with basin </span><span class="si">%d</span><span class="s2">, and has index </span><span class="si">%d</span><span class="s2"> within it.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">volNum</span><span class="p">,</span><span class="n">basinNum</span><span class="p">,</span><span class="n">volumeNumIni</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;This volume has duplicate status, </span><span class="se">\&quot;</span><span class="si">%r</span><span class="se">\&quot;</span><span class="s2">.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">dupFlagIni</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;The basin&#39;s current state is </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">currentDV</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

                <span class="n">lastI</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># Look for the final state in the basin, adding it if required</span>
                <span class="n">volumeNumFin</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)):</span>
                    <span class="n">volumeNumFin</span><span class="p">,</span> <span class="n">dupFlagFin</span><span class="p">,</span> <span class="n">newFinal</span> <span class="o">=</span> <span class="n">basinI</span><span class="o">.</span><span class="n">whichDV</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">final</span><span class="p">,</span> <span class="n">finalVolIndex</span><span class="p">,</span> <span class="n">createFlag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">explored</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                    <span class="c1"># print i, volumeNumFin, dupFlagFin</span>
                    <span class="n">lastI</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="k">if</span> <span class="n">volumeNumFin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">volumeNumFin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">basinI</span><span class="o">.</span><span class="n">createDV</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">final</span><span class="p">,</span> <span class="n">finalVolIndex</span><span class="p">)</span>
                    <span class="n">volumeNumFin</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
                    <span class="n">dupFlagFin</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">newFinal</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># Make sure this basin&#39;s currentDV is not altered</span>
                <span class="n">basinI</span><span class="o">.</span><span class="n">currentDV</span> <span class="o">=</span> <span class="n">currentDV</span>

                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;The final volume is </span><span class="si">%d</span><span class="s2"> of basin, </span><span class="si">%d</span><span class="s2">, and has duplicate status, </span><span class="se">\&quot;</span><span class="si">%r</span><span class="se">\&quot;</span><span class="s2">.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">volumeNumFin</span><span class="p">,</span><span class="n">lastI</span><span class="p">,</span><span class="n">dupFlagFin</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;The basin&#39;s current state is </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">currentDV</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

                <span class="k">break</span>

            <span class="c1"># attempt to correct basins</span>
            <span class="n">again</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">basinNum</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">bIdv</span> <span class="o">=</span> <span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">basin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
                    <span class="n">inB</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1"># check if basin exists in the map</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">b</span><span class="p">:</span>
                                <span class="n">inB</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">break</span>

                    <span class="c1"># check if defect volume exists in basin</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">inB</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)):</span>
                            <span class="n">dv</span> <span class="o">=</span> <span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">bIdv</span> <span class="o">==</span> <span class="n">dv</span><span class="o">.</span><span class="n">hashkey</span> <span class="ow">or</span> <span class="n">bIdv</span> <span class="ow">in</span> <span class="n">dv</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">:</span>

                                <span class="c1"># check primary COM and moment first</span>
                                <span class="k">if</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">bIdv</span><span class="o">.</span><span class="n">COM</span><span class="p">,</span> <span class="n">dv</span><span class="o">.</span><span class="n">COM</span><span class="p">,</span> <span class="n">basin</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">basinCOMTol</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">bIdv</span><span class="o">.</span><span class="n">moment</span><span class="p">,</span> <span class="n">dv</span><span class="o">.</span><span class="n">moment</span><span class="p">,</span> <span class="n">basin</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">basinMomentTol</span><span class="p">:</span>
                                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Warning: lowBarrierProcessing erroneously attempted to create a new basin. Correcting mapping and removing false basin.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">bIdv</span> <span class="o">==</span> <span class="n">dv</span><span class="o">.</span><span class="n">hashkey</span><span class="p">:</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">volNum</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">volNum</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>

                                        <span class="c1"># remove basin</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                                        <span class="n">again</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="k">break</span>

                                <span class="c1"># check duplicate COM and moment</span>
                                <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">)):</span>
                                    <span class="k">if</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">bIdv</span><span class="o">.</span><span class="n">COM</span><span class="p">,</span> <span class="n">dv</span><span class="o">.</span><span class="n">dupCOM</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="n">basin</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">basinCOMTol</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">bIdv</span><span class="o">.</span><span class="n">moment</span><span class="p">,</span> <span class="n">dv</span><span class="o">.</span><span class="n">dupMoment</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="n">basin</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">basinMomentTol</span><span class="p">:</span>
                                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Warning: lowBarrierProcessing erroneously attempted to create a new basin. Correcting mapping and removing false basin.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">volNum</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>

                                            <span class="c1"># remove basin</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                                            <span class="n">again</span> <span class="o">=</span> <span class="kc">True</span>
                                            <span class="k">break</span>
                                <span class="k">if</span> <span class="n">again</span><span class="p">:</span>
                                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">again</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basinI</span><span class="p">,</span> <span class="n">volumeNumIni</span><span class="p">,</span> <span class="n">volumeNumFin</span><span class="p">,</span> <span class="n">dupFlagIni</span><span class="p">,</span> <span class="n">dupFlagFin</span><span class="p">,</span> <span class="n">newInitial</span><span class="p">,</span> <span class="n">newFinal</span></div>

<span class="c1">#############################################################</span>
<div class="viewcode-block" id="KMCRunner.saveResultsToBasin"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.saveResultsToBasin">[docs]</a>    <span class="k">def</span> <span class="nf">saveResultsToBasin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basinI</span><span class="p">,</span> <span class="n">volumeNumIni</span><span class="p">,</span> <span class="n">volumeNumFin</span><span class="p">,</span> <span class="n">dupFlagIni</span><span class="p">,</span> <span class="n">dupFlagFin</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">extraReuse</span><span class="p">,</span> <span class="n">volNum</span><span class="p">,</span> <span class="n">dicIndex</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">addPair</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Following a call to lowBarrierProcessing, this method saves a transition result to the appropriate basin, or otherwise reports if was already stored.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        basinI : basin object</span>
<span class="sd">            The basin object we are attempting to add a transition to.</span>
<span class="sd">        volumeNumIni : int</span>
<span class="sd">            The basin index of the defect volume of the initital state</span>
<span class="sd">        volumeNumFin : int</span>
<span class="sd">            The basin index of the defect volume of the final state</span>
<span class="sd">        dupFlagIni : bool</span>
<span class="sd">            Has the initital state been flagged as a duplicate?</span>
<span class="sd">        dupFlagFin : bool</span>
<span class="sd">            Has the final state been flagged as a duplicate?</span>
<span class="sd">        result : result object</span>
<span class="sd">            The specific result (ie transition) that we are attempting to add</span>
<span class="sd">        dicIndex : integer</span>
<span class="sd">            The index of the results dictionary to use. Default = -1</span>
<span class="sd">        addPair : bool</span>
<span class="sd">            Option to add transitions in pairs (True, default option), or to add only single transitions to the basin (False).</span>
<span class="sd">            The latter should only be used for transitions that escape the basin.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        status : int</span>
<span class="sd">            Returned as zero if transition was added sucessfully or if transition was already part of a basin, otherwise returned as 1.</span>
<span class="sd">        alreadyInBasin : bool</span>
<span class="sd">            Indicated if the transtions was already in the basin before the call to this method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">addPair</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Attempting to save a transition result pair to the basin (addPair = True).&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Attempting to save an escaping transition result to the basin (addPair = False).&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span>

        <span class="c1"># assign graphKeys</span>
        <span class="n">graphKey</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalHashkey&quot;</span><span class="p">][</span><span class="n">dicIndex</span><span class="p">]</span>
        <span class="n">graphKey2</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeHashkey&quot;</span><span class="p">][</span><span class="n">dicIndex</span><span class="p">]</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Initial hashkey = </span><span class="si">%s</span><span class="se">\t</span><span class="s2">Final hashkey = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">graphKey2</span><span class="p">,</span> <span class="n">graphKey</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">currentVolIndex</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">final</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">graphKey</span><span class="p">)</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;currentVolIndex = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">currentVolIndex</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">addPair</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Transition connecting basin states </span><span class="si">%r</span><span class="s2"> and </span><span class="si">%r</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">volumeNumIni</span><span class="p">,</span> <span class="n">volumeNumFin</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Escaping transition from basin states </span><span class="si">%r</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">volumeNumIni</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Basin Defect Volume Objects</span>
        <span class="n">volumeIJini</span> <span class="o">=</span> <span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volumeNumIni</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">addPair</span><span class="p">:</span>
            <span class="n">volumeIJfin</span> <span class="o">=</span> <span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volumeNumFin</span><span class="p">]</span>

        <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">alreadyInBasin</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">altGraphIni</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">altGraphFin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">forwardTransExist</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">reverseTransExist</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># initial state should be explored</span>
        <span class="n">volumeIJini</span><span class="o">.</span><span class="n">explored</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># saddle point properties</span>
        <span class="n">sadCOM</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sadMom</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrCompareSaddles</span><span class="p">:</span>
            <span class="n">sadCOM</span><span class="p">,</span> <span class="n">sadMom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saddleDetailsForBasin</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">currentVolIndex</span><span class="p">,</span> <span class="n">volumeIJini</span><span class="o">.</span><span class="n">BasinObject</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sadCOM</span> <span class="o">=</span> <span class="n">sadMom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="c1"># initial volume properties</span>
        <span class="n">iniPHash</span> <span class="o">=</span> <span class="n">volumeIJini</span><span class="o">.</span><span class="n">hashkey</span>
        <span class="n">iniPCOM</span> <span class="o">=</span> <span class="n">volumeIJini</span><span class="o">.</span><span class="n">COM</span>
        <span class="n">iniPMoment</span> <span class="o">=</span> <span class="n">volumeIJini</span><span class="o">.</span><span class="n">moment</span>

        <span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">addPair</span><span class="p">:</span>
            <span class="c1"># final volume properties</span>
            <span class="n">finPHash</span> <span class="o">=</span> <span class="n">volumeIJfin</span><span class="o">.</span><span class="n">hashkey</span>
            <span class="n">finPCOM</span> <span class="o">=</span> <span class="n">volumeIJfin</span><span class="o">.</span><span class="n">COM</span>
            <span class="n">finPMoment</span> <span class="o">=</span> <span class="n">volumeIJfin</span><span class="o">.</span><span class="n">moment</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">finPHash</span> <span class="o">=</span> <span class="n">graphKey</span>
            <span class="n">finPCOM</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalCOM&quot;</span><span class="p">][</span><span class="n">dicIndex</span><span class="p">]</span>
            <span class="n">finPMoment</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalMoment&quot;</span><span class="p">][</span><span class="n">dicIndex</span><span class="p">]</span>

        <span class="c1"># state verification and basin repairs:</span>
        <span class="c1">#######################################</span>

        <span class="c1"># check states of identical hashkey</span>
        <span class="c1"># TODO: is this part still needed? (bad state correction is not seen now and when it was seen if didn&#39;t work correctly)</span>
        <span class="k">if</span> <span class="n">finPHash</span> <span class="o">==</span> <span class="n">iniPHash</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">iniPCOM</span><span class="p">,</span> <span class="n">finPCOM</span><span class="p">,</span> <span class="n">basinI</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">basinCOMTol</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">iniPMoment</span><span class="p">,</span> <span class="n">finPMoment</span><span class="p">,</span> <span class="n">basinI</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">basinMomentTol</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">addPair</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Warning: An attempt was made to add a transition to the basin where the initial (</span><span class="si">%d</span><span class="s2">) and final (</span><span class="si">%d</span><span class="s2">) have the same hashkey (</span><span class="si">%s</span><span class="s2">), centre of mass (</span><span class="si">%r</span><span class="s2">), and momennt (</span><span class="si">%r</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volumeNumIni</span><span class="p">,</span> <span class="n">volumeNumFin</span><span class="p">,</span> <span class="n">iniPHash</span><span class="p">,</span> <span class="n">iniPCOM</span><span class="p">,</span> <span class="n">iniPMoment</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;The erroneous transition was low barrier.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;The final volume will be removed from the basin object, and transitions to it (if any) will be redirected to volume </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">volumeNumIni</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="c1"># if len(volumeIJfin.transitions):</span>
                        <span class="c1">#     log(__name__, &quot;It has %d transitions, which will be redirected to basin volume %d&quot; (len(volumeIJfin.transitions), volumeNumIni), 1, 1)</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">volumeNumIni</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transitions</span><span class="p">)):</span>
                                    <span class="k">if</span> <span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">finalDV</span> <span class="o">==</span> <span class="n">volumeNumIni</span><span class="p">:</span>
                                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Volume </span><span class="si">%d</span><span class="s2"> already has a transition (</span><span class="si">%d</span><span class="s2">) to </span><span class="si">%d</span><span class="s2">. Skipping redirection.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">volumeNumIni</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                                        <span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="k">break</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">skip</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transitions</span><span class="p">)):</span>
                                        <span class="k">if</span> <span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">finalDV</span> <span class="o">==</span> <span class="n">volumeIJfin</span><span class="p">:</span>
                                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Redirecting transition </span><span class="si">%d</span><span class="s2"> of volume </span><span class="si">%d</span><span class="s2"> from </span><span class="si">%d</span><span class="s2"> to </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">volumeNumFin</span><span class="p">,</span> <span class="n">volumeNumIni</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                                            <span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">finalDV</span> <span class="o">=</span> <span class="n">volumeNumIni</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">volumeNumFin</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Warning: An attempt was made to add a transition to the basin where the initial (</span><span class="si">%d</span><span class="s2">) and final (escaping) have the same hashkey (</span><span class="si">%s</span><span class="s2">), centre of mass (</span><span class="si">%r</span><span class="s2">), and momennt (</span><span class="si">%r</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volumeNumIni</span><span class="p">,</span> <span class="n">iniPHash</span><span class="p">,</span> <span class="n">iniPCOM</span><span class="p">,</span> <span class="n">iniPMoment</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;The erroneous transition was non-low barrier. Returning without adding it.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">extraReuse</span>
        <span class="k">if</span> <span class="n">addPair</span><span class="p">:</span>
            <span class="c1"># # Correct escaping transitions which are now internal # Now redundant</span>
            <span class="c1"># removed = False</span>
            <span class="c1"># for i in range(len(volumeIJini.transitions)):</span>
            <span class="c1">#     if (volumeIJini.transitions[i].finalHashkey == finPHash or finPHash in volumeIJini.transitions[i].dupHashkey) and not volumeIJini.transitions[i].partOfPair:</span>
            <span class="c1">#         if Vectors.separation(volumeIJini.transitions[i].finalCOM, finPCOM, basinI.cellDims) &lt; self.params.basinCOMTol:</span>
            <span class="c1">#             if Vectors.separation(volumeIJini.transitions[i].moment, finPMoment, basinI.cellDims) &lt; self.params.basinMomentTol:</span>
            <span class="c1">#                 log(__name__, &quot;Removing escaping transition %d of defect volume %d.&quot; % (i, volumeNumIni), 1, 3)</span>
            <span class="c1">#                 log(__name__, &quot;This will be replaced by an internal transition to defect volumes %d.&quot; % volumeNumFin, 1, 3)</span>
            <span class="c1">#                 if self.params.debugBasin:</span>
            <span class="c1">#                     self.basinReport(error=4)</span>
            <span class="c1">#                 volumeIJini.transitions.pop(i)</span>
            <span class="c1">#                 removed = True</span>
            <span class="c1">#                 break</span>
            <span class="c1"># if not removed:</span>
            <span class="c1">#     log(__name__, &quot;There are no old escaping transitions to be removed.&quot;, 1, 3)</span>
            <span class="c1"># else:</span>
            <span class="c1">#     self.basinReport(error=5)</span>

            <span class="c1"># Correct volumeNumFin</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hashkey</span> <span class="o">==</span> <span class="n">finPHash</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">volumeNumFin</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">COM</span><span class="p">,</span> <span class="n">finPCOM</span><span class="p">,</span> <span class="n">basinI</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">basinCOMTol</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">moment</span><span class="p">,</span> <span class="n">finPMoment</span><span class="p">,</span> <span class="n">basinI</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">basinMomentTol</span><span class="p">:</span>
                            <span class="n">ii</span> <span class="o">=</span> <span class="n">i</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Inconsistent transition pair detected:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Attempting to correct volumeNumFin from </span><span class="si">%d</span><span class="s2"> to </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volumeNumFin</span><span class="p">,</span> <span class="n">ii</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">debugBasin</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">basinReport</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ii</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ii</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span>  <span class="n">ii</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">ii</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volumeNumFin</span><span class="p">]</span><span class="o">.</span><span class="n">transitions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)):</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transitions</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">finalDV</span> <span class="o">==</span> <span class="n">ii</span><span class="p">:</span>
                                <span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transitions</span><span class="p">)):</span>
                            <span class="c1"># print i, j, basinI.defectVolumes[i].transitions[j].finalHashkey, finPHash</span>
                            <span class="k">if</span> <span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">finalDV</span> <span class="o">==</span> <span class="n">volumeNumFin</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">skip</span><span class="p">:</span>
                                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Removing transition </span><span class="si">%d</span><span class="s2"> of defect volume </span><span class="si">%d</span><span class="s2">, as it already has a transition to </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ii</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                                    <span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transitions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Correcting finalDV of transition </span><span class="si">%d</span><span class="s2"> of defect volume </span><span class="si">%d</span><span class="s2"> to </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ii</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                                    <span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">finalDV</span> <span class="o">=</span> <span class="n">ii</span>
                        <span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">volumeNumFin</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Removing defect volume </span><span class="si">%d</span><span class="s2"> from the basin (bad state)&quot;</span> <span class="o">%</span> <span class="n">volumeNumFin</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                        <span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">volumeNumFin</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">debugBasin</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">basinReport</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Warning: Bad volume </span><span class="si">%d</span><span class="s2"> not removed&quot;</span> <span class="o">%</span> <span class="n">volumeNumFin</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

                    <span class="c1"># assign final properties</span>
                    <span class="n">volumeNumFin</span> <span class="o">=</span> <span class="n">ii</span>
                    <span class="n">volumeIJfin</span> <span class="o">=</span> <span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volumeNumFin</span><span class="p">]</span>
                    <span class="n">finPHash</span> <span class="o">=</span> <span class="n">volumeIJfin</span><span class="o">.</span><span class="n">hashkey</span>
                    <span class="n">finPCOM</span> <span class="o">=</span> <span class="n">volumeIJfin</span><span class="o">.</span><span class="n">COM</span>
                    <span class="n">finPMoment</span> <span class="o">=</span> <span class="n">volumeIJfin</span><span class="o">.</span><span class="n">moment</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Volume </span><span class="si">%d</span><span class="s2"> has transitions - no changes made&quot;</span> <span class="o">%</span> <span class="n">volumeNumFin</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;No inconsistent transition pairs detected.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="c1">#######################################</span>

        <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;transIndex&quot;</span><span class="p">][</span><span class="n">dicIndex</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">iniPHash</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">addPair</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Blank foward result -- Cannot check if already exists in basin&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Blank escaping result -- Cannot check if already exists in basin&quot;</span><span class="p">)</span>

        <span class="c1"># Check if foward transitions already exists.</span>
        <span class="k">if</span> <span class="n">addPair</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;doesTransitionExist:</span><span class="se">\t</span><span class="s2">Forward&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;doesTransitionExist:</span><span class="se">\t</span><span class="s2">Escape&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">forwardTransExist</span><span class="p">,</span> <span class="n">transF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doesTransitionExist</span><span class="p">(</span><span class="n">volumeIJini</span><span class="p">,</span> <span class="n">finPHash</span><span class="p">,</span> <span class="n">volumeNumFin</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">][</span><span class="n">dicIndex</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;reverseBarriers&quot;</span><span class="p">][</span><span class="n">dicIndex</span><span class="p">],</span> <span class="n">sadCOM</span><span class="p">,</span> <span class="n">sadMom</span><span class="p">,</span> <span class="n">addPair</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">forwardTransExist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">addPair</span><span class="p">:</span>
                <span class="c1"># Flag as real basin event (is this line still necessary?)</span>
                <span class="n">transF</span><span class="o">.</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">alreadyInBasin</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">addPair</span><span class="p">:</span>
            <span class="c1"># Check if reverse transition already exists.</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;doesTransitionExist:</span><span class="se">\t</span><span class="s2">Reverse&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">reverseTransExist</span><span class="p">,</span> <span class="n">transR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doesTransitionExist</span><span class="p">(</span><span class="n">volumeIJfin</span><span class="p">,</span> <span class="n">iniPHash</span><span class="p">,</span> <span class="n">volumeNumIni</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;reverseBarriers&quot;</span><span class="p">][</span><span class="n">dicIndex</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">][</span><span class="n">dicIndex</span><span class="p">],</span> <span class="n">sadCOM</span><span class="p">,</span> <span class="n">sadMom</span><span class="p">,</span> <span class="n">addPair</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">reverseTransExist</span><span class="p">:</span>
                <span class="n">transR</span><span class="o">.</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># Flag as real basin event (is this line still necessary?)</span>

        <span class="c1"># Store reverse transition in extraReuse, to ensure detailed balance.</span>
        <span class="c1"># Also sets transIndexFin (reuseIndex)</span>
        <span class="n">transIndexFin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">addPair</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">forwardTransExist</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">reverseTransExist</span><span class="p">:</span>
            <span class="n">graphAtoms</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">final</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">currentVolIndex</span><span class="p">]</span><span class="o">.</span><span class="n">graphVol</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;saveResultsToBasin - graphAtoms is of length: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">graphAtoms</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

            <span class="c1"># create a VTO for reverse transition</span>
            <span class="n">volTransObj</span> <span class="o">=</span> <span class="n">Defects</span><span class="o">.</span><span class="n">VolumeTransitionsObject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">moreSearch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">searchDone</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">volTransObj</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">graphAtoms</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">final</span><span class="p">,</span> <span class="n">graphKey</span><span class="p">)</span>
            <span class="n">volTransObj</span><span class="o">.</span><span class="n">addTransition</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">saddle</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;reverseBarriers&quot;</span><span class="p">][</span><span class="n">dicIndex</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hashKey</span><span class="o">=</span><span class="n">graphKey</span><span class="p">,</span> <span class="n">volumeAtoms</span><span class="o">=</span><span class="n">graphAtoms</span><span class="p">,</span><span class="n">finalHashkey</span><span class="o">=</span><span class="n">graphKey2</span><span class="p">)</span>


            <span class="c1"># if already stored in extraReuse</span>
            <span class="n">test</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># merge reverse transition into extraReuse</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">extraReuse</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;CALL TO MERGE in saveResultsToBasin (1)&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">test</span><span class="p">,</span> <span class="n">tmpList</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">volTransObj</span><span class="p">,</span> <span class="n">er</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="s2">&quot;extraReuse_merge&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">test</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Isomorphism failed in first extraReuse section&quot;</span><span class="p">)</span><span class="c1">#(&quot;Moving on to next reuse section&quot;)</span>
                <span class="k">if</span> <span class="n">tmpList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1">#transIndexFin = -1-tmpList[0]</span>
                    <span class="n">transIndexFin</span> <span class="o">=</span> <span class="n">tmpList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># temporarily assign negative value, corrected later</span>
                    <span class="n">transIndexFin</span> <span class="o">=</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">extraReuse</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)</span>
            <span class="c1"># if not stored</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span><span class="c1">#, RuntimeError):</span>
                <span class="c1"># try defectVolumes</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># merge reverse transition into defect volume</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span>
                    <span class="c1"># extra debug stuff</span>
                    <span class="nb">print</span> <span class="s2">&quot;length of defectVolumes[</span><span class="si">%s</span><span class="s2">]Transitions: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">graphKey</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">transitionList</span><span class="p">))</span>
                    <span class="nb">print</span> <span class="s2">&quot;length of VTO.transitionList (should be 1)&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">volTransObj</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)</span>

                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;CALL TO MERGE in saveResultsToBasin (2) </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">graphKey</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                    <span class="n">test</span><span class="p">,</span> <span class="n">tmpList</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">volTransObj</span><span class="p">,</span> <span class="n">er</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="s2">&quot;defectVolumes_merge&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">test</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Isomorphism failed in second extraReuse section&quot;</span><span class="p">)</span><span class="c1">#(&quot;Moving on to next reuse section&quot;)</span>
                    <span class="k">if</span> <span class="n">tmpList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">transIndexFin</span> <span class="o">=</span> <span class="n">tmpList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Assigning transIndexFin to tmpList[0] (</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">transIndexFin</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">transIndexFin</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Assigning transIndexFin to length DV.trans (1)&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span><span class="c1">#, RuntimeError):</span>
                    <span class="k">if</span> <span class="n">test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># DV in currentDV?</span>
                        <span class="n">currentVolsSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">graphKey</span> <span class="ow">in</span> <span class="n">currentVolsSet</span><span class="p">:</span>
                            <span class="c1"># create extraReuse for reverse transition</span>
                            <span class="n">extraReuse</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">volTransObj</span>
                            <span class="c1"># temporarily assign negative value, corrected later</span>
                            <span class="n">transIndexFin</span> <span class="o">=</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">extraReuse</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Assigning transIndexFin to length extraReuse.trans (</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">transIndexFin</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># create defect volume for reverse transition</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">volTransObj</span>
                            <span class="n">transIndexFin</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Assigning transIndexFin to length DV.trans (2) &quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Warning: Could not merge VTOs due to isomorphism problems - extra reuse data not stored.&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;No problems encountered in extraReuse&quot;</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># End of extraReuse section.</span>

        <span class="c1"># Neither of these should exist without the other.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">addPair</span><span class="p">:</span>
            <span class="n">reverseTransExist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">forwardTransExist</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">reverseTransExist</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">forwardTransExist</span> <span class="ow">and</span> <span class="n">reverseTransExist</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">addPair</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Initial</span><span class="se">\t</span><span class="si">%d</span><span class="se">\t</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volumeNumIni</span><span class="p">,</span> <span class="n">iniPHash</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Final  </span><span class="se">\t</span><span class="si">%d</span><span class="se">\t</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volumeNumFin</span><span class="p">,</span> <span class="n">finPHash</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">log</span><span class="p">(</span><span class="s2">&quot;forwardTransExist = </span><span class="si">%r</span><span class="s2">, while reverseTransExist = </span><span class="si">%r</span><span class="s2">. (step </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">forwardTransExist</span><span class="p">,</span><span class="n">reverseTransExist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

                <span class="c1"># encountered problem: Dumping basin information to file.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">basinReport</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">forwardTransExist = </span><span class="si">%r</span><span class="s2">, while reverseTransExist = </span><span class="si">%r</span><span class="s2">. Is the sensible? (step </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">forwardTransExist</span><span class="p">,</span><span class="n">reverseTransExist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">))</span>
                <span class="n">alreadyInBasin</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">alreadyInBasin</span><span class="p">,</span> <span class="n">extraReuse</span>

        <span class="c1"># If the transition pair does indeed already exist, quit method with alreadyInBasin flag set to True.</span>
        <span class="k">elif</span> <span class="n">forwardTransExist</span> <span class="ow">and</span> <span class="n">reverseTransExist</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Transition pair is already stored in the basin, so we exit saveResultsToBasin with status = </span><span class="si">%d</span><span class="s2"> and alreadyInBasin = </span><span class="si">%r</span><span class="s2">.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">alreadyInBasin</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">alreadyInBasin</span><span class="p">,</span> <span class="n">extraReuse</span>
        <span class="k">if</span> <span class="n">forwardTransExist</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">addPair</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Escaping transition is already stored in the basin, so we exit saveResultsToBasin with status = </span><span class="si">%d</span><span class="s2"> and alreadyInBasin = </span><span class="si">%r</span><span class="s2">.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">alreadyInBasin</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">alreadyInBasin</span><span class="p">,</span> <span class="n">extraReuse</span>

        <span class="k">if</span> <span class="n">addPair</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Transition pair does not already exist -- proceeding.&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">dupFlagIni</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Constructing alternative graph volume for initial DV.&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                <span class="c1"># Reconstruct positions for forward transition.</span>
                <span class="n">altGraphIni</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">getIndicesFromPositions</span><span class="p">(</span><span class="n">volumeIJini</span><span class="o">.</span><span class="n">dvPos</span><span class="p">,</span> <span class="n">maxSep</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;New graph volume.&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">altGraphIni</span><span class="p">)):</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">altGraphIni</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">in</span> <span class="n">altGraphIni</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Invalid altGraphIni produced&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">dupFlagFin</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Constructing alternative graph volume for final DV.&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                <span class="c1"># Reconstruct positions for reverse transition.</span>
                <span class="n">altGraphFin</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">final</span><span class="o">.</span><span class="n">getIndicesFromPositions</span><span class="p">(</span><span class="n">volumeIJfin</span><span class="o">.</span><span class="n">dvPos</span><span class="p">,</span> <span class="n">maxSep</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;New graph volume.&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">altGraphFin</span><span class="p">)):</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">altGraphFin</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">in</span> <span class="n">altGraphFin</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Invalid altGraphFin produced&quot;</span><span class="p">)</span>

            <span class="c1"># Add transitions to reuse file. NB: Added by MiaoYu</span>
            <span class="c1"># rewrite volume file, send to writer</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">noStoreVolumes</span><span class="p">:</span>
                <span class="n">outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">volumeDirectory</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">writerItem</span><span class="p">(</span><span class="s2">&quot;WRITE&quot;</span><span class="p">,</span> <span class="n">dataType</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">graphKey</span><span class="p">],</span> <span class="p">],</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">)</span>
                    <span class="n">whichSave</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">writerItem</span><span class="p">(</span><span class="s2">&quot;WRITE&quot;</span><span class="p">,</span> <span class="n">dataType</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">extraReuse</span><span class="p">[</span><span class="n">graphKey</span><span class="p">],</span> <span class="p">],</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">)</span>
                    <span class="n">whichSave</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">debugBasin</span><span class="p">:</span>
                    <span class="c1"># do checks on consistent hashkeys when storing defect volumes</span>
                    <span class="k">if</span> <span class="n">whichSave</span><span class="p">:</span>
                        <span class="n">cons</span> <span class="o">=</span> <span class="n">Graphs</span><span class="o">.</span><span class="n">consistentHashKeyCheck</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span><span class="n">graphKey</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">graphKey</span><span class="p">])</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">cons</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Hashkey stored incorrectly in SaveResultsToBasin (1)&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cons</span> <span class="o">=</span> <span class="n">Graphs</span><span class="o">.</span><span class="n">consistentHashKeyCheck</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span><span class="n">graphKey</span><span class="p">,</span><span class="n">extraReuse</span><span class="p">[</span><span class="n">graphKey</span><span class="p">])</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">cons</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Hashkey stored incorrectly in SaveResultsToBasin (2)&quot;</span><span class="p">)</span>

                <span class="n">item</span><span class="o">.</span><span class="n">addCommand</span><span class="p">(</span><span class="s2">&quot;write&quot;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.vol&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">graphKey</span><span class="p">,)})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Escaping transition does not already exist -- proceeding.&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Now that we&#39;re happy with the transition, we may add it to the basin object.</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Happy to add transition now.&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Basin transition object takes arguments (barrier, reverseBarrier, rate, finalHashkey, finalCOM, reuseIndex, flag, finalDV, final, index, savePos=True, moment=None, currentVolIndex=None, altGraph=None)</span>
        <span class="c1"># Forward transition</span>
        <span class="k">if</span> <span class="n">addPair</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Attempting forward&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Attempting escape&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;transIndex&quot;</span><span class="p">][</span><span class="n">dicIndex</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Attempted to save a transition where results.resultsDict[</span><span class="se">\&quot;</span><span class="s2">transIndex</span><span class="se">\&quot;</span><span class="s2">] is None&quot;</span><span class="p">)</span>

        <span class="c1"># Find which duplciate this is</span>
        <span class="n">dupRef</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">dupFlagIni</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ky</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">volumeIJini</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">volumeIJini</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span> <span class="o">==</span> <span class="n">graphKey2</span><span class="p">:</span>
                    <span class="n">dupRef</span> <span class="o">=</span> <span class="n">ky</span>
                    <span class="k">break</span>

        <span class="c1"># create forward transition</span>
        <span class="n">volumeIJini</span><span class="o">.</span><span class="n">createTrans</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">][</span><span class="n">dicIndex</span><span class="p">],</span>
                                <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;reverseBarriers&quot;</span><span class="p">][</span><span class="n">dicIndex</span><span class="p">],</span>
                                <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">][</span><span class="n">dicIndex</span><span class="p">],</span>
                                <span class="n">finPHash</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalCOM&quot;</span><span class="p">][</span><span class="n">dicIndex</span><span class="p">],</span>
                                <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;transIndex&quot;</span><span class="p">][</span><span class="n">dicIndex</span><span class="p">],</span>
                                <span class="n">flag</span><span class="p">,</span> <span class="n">finalDV</span><span class="o">=</span><span class="n">volumeNumFin</span><span class="p">,</span> <span class="n">final</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">final</span><span class="p">,</span>
                                <span class="n">index</span><span class="o">=</span><span class="n">currentVolIndex</span><span class="p">,</span> <span class="n">savePos</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">moment</span><span class="o">=</span><span class="n">finPMoment</span><span class="p">,</span>
                                <span class="n">currentVolIndex</span><span class="o">=</span><span class="n">volNum</span><span class="p">,</span> <span class="n">altGraph</span><span class="o">=</span><span class="n">altGraphFin</span><span class="p">,</span> <span class="n">pair</span><span class="o">=</span><span class="n">addPair</span><span class="p">,</span>
                                <span class="n">dupRef</span><span class="o">=</span><span class="n">dupRef</span><span class="p">,</span> <span class="n">sadCOM</span><span class="o">=</span><span class="n">sadCOM</span><span class="p">,</span> <span class="n">sadMom</span><span class="o">=</span><span class="n">sadMom</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">verboseLevel</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">addPair</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Forward transition information:&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Escaping transition information:&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;Barrier:&quot;</span><span class="p">,</span> <span class="n">volumeIJini</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">barrier</span>
            <span class="nb">print</span> <span class="s2">&quot;Reverse barrier:&quot;</span><span class="p">,</span> <span class="n">volumeIJini</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reverseBarrier</span>
            <span class="nb">print</span> <span class="s2">&quot;Final basin reference:&quot;</span><span class="p">,</span> <span class="n">volumeIJini</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">finalDV</span>
            <span class="nb">print</span> <span class="s2">&quot;Final hashkey:&quot;</span><span class="p">,</span> <span class="n">volumeIJini</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">finalHashkey</span>
            <span class="nb">print</span> <span class="s2">&quot;Reuse File Index:&quot;</span><span class="p">,</span> <span class="n">volumeIJini</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reuseIndex</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">volumeIJini</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">):</span>
                <span class="nb">print</span> <span class="s2">&quot;Duplicate hashkey list:&quot;</span>
                <span class="k">for</span> <span class="n">dh</span> <span class="ow">in</span> <span class="nb">len</span><span class="p">(</span><span class="n">volumeIJini</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">):</span>
                    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">volumeIJini</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">[</span><span class="n">dh</span><span class="p">]</span>
            <span class="nb">print</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">addPair</span><span class="p">:</span>
            <span class="c1"># Reverse transition</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Attempting reverse&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># Find which duplciate this is</span>
            <span class="n">finRef</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">dupFlagFin</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ky</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">volumeIJfin</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">volumeIJfin</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">[</span><span class="n">ky</span><span class="p">]</span> <span class="o">==</span> <span class="n">graphKey</span><span class="p">:</span>
                        <span class="n">finRef</span> <span class="o">=</span> <span class="n">ky</span>
                        <span class="k">break</span>

            <span class="c1"># create reverse transition</span>
            <span class="n">volumeIJfin</span><span class="o">.</span><span class="n">createTrans</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;reverseBarriers&quot;</span><span class="p">][</span><span class="n">dicIndex</span><span class="p">],</span>
                                    <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">][</span><span class="n">dicIndex</span><span class="p">],</span>
                                    <span class="n">Rates</span><span class="o">.</span><span class="n">rateCalculation</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;reverseBarriers&quot;</span><span class="p">][</span><span class="n">dicIndex</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fixedPrefactorVal</span><span class="p">),</span>
                                    <span class="n">iniPHash</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeCOM&quot;</span><span class="p">][</span><span class="n">dicIndex</span><span class="p">],</span>
                                    <span class="n">transIndexFin</span><span class="p">,</span>
                                    <span class="n">flag</span><span class="p">,</span> <span class="n">finalDV</span><span class="o">=</span><span class="n">volumeNumIni</span><span class="p">,</span> <span class="n">final</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">oldState</span><span class="p">,</span>
                                    <span class="n">index</span><span class="o">=</span><span class="n">volNum</span><span class="p">,</span> <span class="n">savePos</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">moment</span><span class="o">=</span><span class="n">iniPMoment</span><span class="p">,</span>
                                    <span class="n">currentVolIndex</span><span class="o">=</span><span class="n">currentVolIndex</span><span class="p">,</span> <span class="n">altGraph</span><span class="o">=</span><span class="n">altGraphIni</span><span class="p">,</span> <span class="n">pair</span><span class="o">=</span><span class="n">addPair</span><span class="p">,</span>
                                    <span class="n">dupRef</span><span class="o">=</span><span class="n">finRef</span><span class="p">,</span> <span class="n">sadCOM</span><span class="o">=</span><span class="n">sadCOM</span><span class="p">,</span> <span class="n">sadMom</span><span class="o">=</span><span class="n">sadMom</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">verboseLevel</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;&quot;</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;DEBUG: Reverse transition information:&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="nb">print</span> <span class="s2">&quot;Barrier:&quot;</span><span class="p">,</span> <span class="n">volumeIJfin</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">barrier</span>
                <span class="nb">print</span> <span class="s2">&quot;Reverse barrier:&quot;</span><span class="p">,</span> <span class="n">volumeIJfin</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reverseBarrier</span>
                <span class="nb">print</span> <span class="s2">&quot;Final basin reference:&quot;</span><span class="p">,</span> <span class="n">volumeIJfin</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">finalDV</span>
                <span class="nb">print</span> <span class="s2">&quot;Final hashkey:&quot;</span><span class="p">,</span> <span class="n">volumeIJfin</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">finalHashkey</span>
                <span class="nb">print</span> <span class="s2">&quot;Reuse File Index:&quot;</span><span class="p">,</span> <span class="n">volumeIJfin</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reuseIndex</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">volumeIJfin</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">):</span>
                    <span class="nb">print</span> <span class="s2">&quot;Duplicate hashkey list:&quot;</span>
                    <span class="k">for</span> <span class="n">dh</span> <span class="ow">in</span> <span class="nb">len</span><span class="p">(</span><span class="n">volumeIJfin</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">):</span>
                        <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">volumeIJfin</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">[</span><span class="n">dh</span><span class="p">]</span>

            <span class="c1"># write out connectivity matrix in output</span>
            <span class="n">m</span><span class="p">,</span> <span class="n">inconsistent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinReportConnectivity</span><span class="p">(</span><span class="n">basinI</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">debugBasin</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">inconsistent</span><span class="p">):</span>
                <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Post pair addition connectivity:&quot;</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">[ &quot;</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                            <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;- &quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;]&quot;</span>
                    <span class="nb">print</span> <span class="n">line</span>
                <span class="nb">print</span> <span class="s2">&quot;&quot;</span>

            <span class="c1"># check for non-symmetric transitions</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inconsistent</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Connectivity is inconsistent</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inconsistent</span><span class="p">)):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">DV </span><span class="si">%d</span><span class="s2"> to </span><span class="si">%d</span><span class="s2"> linkage: </span><span class="si">%d</span><span class="s2"> forward, </span><span class="si">%d</span><span class="s2"> reverse</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">inconsistent</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">inconsistent</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                                               <span class="n">inconsistent</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">inconsistent</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">basinReport</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">saveResultsToBasin: New connectivity has </span><span class="si">%d</span><span class="s2"> inconsistent transitions.&quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">inconsistent</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">alreadyInBasin</span><span class="p">,</span> <span class="n">extraReuse</span></div>

<span class="c1">#############################################################</span>
<div class="viewcode-block" id="KMCRunner.doesTransitionExist"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.doesTransitionExist">[docs]</a>    <span class="k">def</span> <span class="nf">doesTransitionExist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">pHash</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">,</span> <span class="n">fBarrier</span><span class="p">,</span> <span class="n">rBarrier</span><span class="p">,</span> <span class="n">sadCOM</span><span class="p">,</span> <span class="n">sadMom</span><span class="p">,</span> <span class="n">addPair</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For a given basin defect volume, this method will search for a transition, and return whether it appears in it.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        volume : basin defect volume object</span>
<span class="sd">            The defect volume to search in</span>
<span class="sd">        transIndex : int</span>
<span class="sd">            The index of the transition to search for</span>
<span class="sd">        pHash : string</span>
<span class="sd">            The hash key of the primary (non-duplicate) final defect volume of the transition</span>
<span class="sd">        volumeNum : int</span>
<span class="sd">            The basin index of the defect volume of the final state</span>
<span class="sd">        sadCOM : list</span>
<span class="sd">            The saddle point&#39;s centre of mass</span>
<span class="sd">        sadMom : list</span>
<span class="sd">            The saddle point&#39;s moment</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        transExist : bool</span>
<span class="sd">            Returned as True if the transition is found to exist, othrwise False.</span>
<span class="sd">        trans : Transition object</span>
<span class="sd">            The matching transition.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO: NEEDS COMMENTING</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;doesTransitionExist: Given existing volume has </span><span class="si">%d</span><span class="s2"> transitions&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">transitions</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">transExist</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">transitions</span><span class="p">)):</span>
            <span class="n">trans</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="c1"># if self.params.debugBasin:</span>
            <span class="c1">#     print &quot;flag&quot;, trans.flag</span>
            <span class="c1">#     print &quot;trans.barrier&quot;, trans.barrier, &quot;\t&quot;, &quot;test (f) barrier&quot;, fBarrier</span>
            <span class="c1">#     print &quot;trans.reverseBarrier&quot;, trans.reverseBarrier, &quot;\t&quot;, &quot;test (r) barrier&quot;, rBarrier</span>
            <span class="c1">#     print &quot;trans.finalDV&quot;, trans.finalDV, &quot;\tvolumeNum&quot;, volumeNum</span>
            <span class="c1">#     print &quot;trans.finalHashkey&quot;, trans.finalHashkey, &quot;\tpHash&quot;, pHash</span>

            <span class="k">if</span> <span class="n">trans</span><span class="o">.</span><span class="n">finalDV</span> <span class="o">==</span> <span class="n">volumeNum</span> <span class="ow">and</span> <span class="n">trans</span><span class="o">.</span><span class="n">finalDV</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">volumeNum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">transExist</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Found transition final with matching basin defect volume&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">pHash</span> <span class="o">==</span> <span class="n">trans</span><span class="o">.</span><span class="n">finalHashkey</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">volume</span><span class="o">.</span><span class="n">COM</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">trans</span><span class="o">.</span><span class="n">finalCOM</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">COM</span><span class="p">,</span> <span class="n">trans</span><span class="o">.</span><span class="n">finalCOM</span><span class="p">,</span> <span class="n">volume</span><span class="o">.</span><span class="n">BasinObject</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">basinCOMTol</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">volume</span><span class="o">.</span><span class="n">moment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">trans</span><span class="o">.</span><span class="n">moment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">momentSep</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">moment</span><span class="p">,</span> <span class="n">trans</span><span class="o">.</span><span class="n">moment</span><span class="p">,</span> <span class="n">volume</span><span class="o">.</span><span class="n">BasinObject</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">momentSep</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">basinMomentTol</span><span class="p">:</span>
                                <span class="n">transExist</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Found transition final with matching hashkey, COM, and moment&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Transition </span><span class="si">%d</span><span class="s2">:</span><span class="se">\t</span><span class="s2">Match = </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">transExist</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">transExist</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Transition found - breaking loop&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">transExist</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrCompareSaddles</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">trans</span><span class="o">.</span><span class="n">barrier</span><span class="p">,</span> <span class="n">trans</span><span class="o">.</span><span class="n">reverseBarrier</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">basinLowBarrier</span> <span class="ow">and</span> <span class="nb">min</span><span class="p">(</span><span class="n">fBarrier</span><span class="p">,</span> <span class="n">rBarrier</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">basinLowBarrier</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sepCOM</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">trans</span><span class="o">.</span><span class="n">sadCOM</span><span class="p">,</span> <span class="n">sadCOM</span><span class="p">,</span> <span class="n">volume</span><span class="o">.</span><span class="n">BasinObject</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
                <span class="n">sepMom</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">trans</span><span class="o">.</span><span class="n">sadMom</span><span class="p">,</span> <span class="n">sadMom</span><span class="p">,</span> <span class="n">volume</span><span class="o">.</span><span class="n">BasinObject</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sepCOM</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">basinCOMTol</span> <span class="ow">or</span> <span class="n">sepMom</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">basinMomentTol</span><span class="p">:</span>
                    <span class="n">transExist</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Transitions have different saddles, treating separately&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">transExist</span> <span class="ow">and</span> <span class="n">addPair</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">trans</span><span class="o">.</span><span class="n">partOfPair</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;This escaping transition which must be removed to make way for an internal transition&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basinReport</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">volume</span><span class="o">.</span><span class="n">transitions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basinReport</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">transExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">trans</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span></div>

<span class="c1">#############################################################</span>
<div class="viewcode-block" id="KMCRunner.saddleDetailsForBasin"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.saddleDetailsForBasin">[docs]</a>    <span class="k">def</span> <span class="nf">saddleDetailsForBasin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">volIndex</span><span class="p">,</span> <span class="n">cellDims</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds COM and moment for saddle points in their own frame of reference.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        result : ClientServerInterface.Result</span>
<span class="sd">            Result object with the saddle of interest</span>
<span class="sd">        volIndex : int</span>
<span class="sd">            The defect volume number of the final</span>
<span class="sd">        cellDims : np.array</span>
<span class="sd">            Dimentions of the simulation cell</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        com : list</span>
<span class="sd">            Saddle centre of mass</span>
<span class="sd">        moment : list</span>
<span class="sd">            Saddle moment</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO: NEEDS COMMENTING</span>
        <span class="n">pdf</span> <span class="o">=</span> <span class="n">Defects</span><span class="o">.</span><span class="n">PointDefectFinder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="n">defectsObj</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">findDefects</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">saddle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refState</span><span class="p">)</span>
        <span class="n">dvb</span> <span class="o">=</span> <span class="n">Defects</span><span class="o">.</span><span class="n">DefectVolumesBuilder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="n">dvb</span><span class="o">.</span><span class="n">buildDefectVolumes</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">saddle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refState</span><span class="p">,</span> <span class="n">defectsObj</span><span class="p">)</span>

        <span class="n">minSep</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">saddle</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">com</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">final</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volIndex</span><span class="p">]</span><span class="o">.</span><span class="n">com</span><span class="p">,</span> <span class="n">cellDims</span><span class="p">)</span>
        <span class="n">nearest</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">saddle</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)):</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">saddle</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">com</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">final</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volIndex</span><span class="p">]</span><span class="o">.</span><span class="n">com</span><span class="p">,</span> <span class="n">cellDims</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sep</span> <span class="o">&lt;</span> <span class="n">minSep</span><span class="p">:</span>
                <span class="n">minSep</span> <span class="o">=</span> <span class="n">sep</span>
                <span class="n">nearest</span> <span class="o">=</span> <span class="n">i</span>

        <span class="n">com</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">saddle</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">nearest</span><span class="p">]</span><span class="o">.</span><span class="n">com</span>
        <span class="n">moment</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">saddle</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">nearest</span><span class="p">]</span><span class="o">.</span><span class="n">moment</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Found saddle point volume with COM [</span><span class="si">%.5f</span><span class="s2"> , </span><span class="si">%.5f</span><span class="s2"> , </span><span class="si">%.5f</span><span class="s2">] and moment [</span><span class="si">%.5f</span><span class="s2"> , </span><span class="si">%.5f</span><span class="s2"> , </span><span class="si">%.5f</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">com</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">com</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">com</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">moment</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">moment</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">moment</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">com</span><span class="p">,</span> <span class="n">moment</span></div>


<span class="c1">#############################################################</span>
<div class="viewcode-block" id="KMCRunner.addMissedEscapeTransitions"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.addMissedEscapeTransitions">[docs]</a>    <span class="k">def</span> <span class="nf">addMissedEscapeTransitions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resultsMaxIndex</span><span class="p">,</span> <span class="n">basinI</span><span class="p">,</span> <span class="n">basinVolumeNum</span><span class="p">,</span> <span class="n">extraReuse</span><span class="p">,</span> <span class="n">hashkey</span><span class="p">,</span> <span class="n">generalVolNum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When a new basin state is created, one needs to call this method to add the escaping transitions, found earlier in the search process, to the basin.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        resultsMaxIndex : integer</span>
<span class="sd">            The number of transitions in the results dictionary when the method is called</span>
<span class="sd">        basinI : basin object</span>
<span class="sd">            The basin to which we are adding escape transitions</span>
<span class="sd">        basinVolumeNum : integer</span>
<span class="sd">            The internal reference of the Initial defect volume within basinI</span>
<span class="sd">        extraReuse : list of &#39;volTransObj&#39;s</span>
<span class="sd">            Should not be altered in anyway, can probably be removed from this method, but take care with calls to saveResultsToBasin</span>
<span class="sd">        hashkey : string</span>
<span class="sd">            The hashkey of the initial state</span>
<span class="sd">        generalVolNum : internal</span>
<span class="sd">            The reference of the Initial defect in the housekeeping of the general (non-basin) code.</span>


<span class="sd">        Returns:</span>
<span class="sd">        -----------</span>
<span class="sd">        addStatus : int</span>
<span class="sd">            The number of transition that could not be added to the basin</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create a local instance of the results dictionary</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span>

        <span class="n">addStatus</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">removeList</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Searching results dictionary for escaping transitions to add to the new basin state with hashkey, </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">hashkey</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Loop over transitions stored in the dictionary below the given value (resultsMaxIndex)</span>
        <span class="k">for</span> <span class="n">trans</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">resultsMaxIndex</span><span class="p">):</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;addMissedEscapeTransitions: Transition </span><span class="si">%d</span><span class="s2"> of </span><span class="si">%d</span><span class="s2"> has properties:&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">resultsMaxIndex</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">verboseLevel</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;results.resultsDict[</span><span class="se">\&quot;</span><span class="s2">volIndxs</span><span class="se">\&quot;</span><span class="s2">][trans]&quot;</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volIndxs&quot;</span><span class="p">][</span><span class="n">trans</span><span class="p">]</span>
                <span class="nb">print</span> <span class="s2">&quot;generalVolNum&quot;</span><span class="p">,</span> <span class="n">generalVolNum</span>
                <span class="nb">print</span> <span class="s2">&quot;results.resultsDict[</span><span class="se">\&quot;</span><span class="s2">basinFlag</span><span class="se">\&quot;</span><span class="s2">][trans]&quot;</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinFlag&quot;</span><span class="p">][</span><span class="n">trans</span><span class="p">]</span>
                <span class="nb">print</span> <span class="s2">&quot;results.resultsDict[</span><span class="se">\&quot;</span><span class="s2">transIndex</span><span class="se">\&quot;</span><span class="s2">][trans]&quot;</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;transIndex&quot;</span><span class="p">][</span><span class="n">trans</span><span class="p">]</span>
                <span class="nb">print</span> <span class="s2">&quot;barriers&quot;</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">][</span><span class="n">trans</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;reverseBarriers&quot;</span><span class="p">][</span><span class="n">trans</span><span class="p">]</span>

            <span class="c1"># If this transition&#39;s initial state matches that given, and does not have the low-barrier flag, it is an escape transition that we need to save.</span>
            <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volIndxs&quot;</span><span class="p">][</span><span class="n">trans</span><span class="p">]</span> <span class="o">==</span> <span class="n">generalVolNum</span> <span class="ow">and</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinFlag&quot;</span><span class="p">][</span><span class="n">trans</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;transIndex&quot;</span><span class="p">][</span><span class="n">trans</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalHashkey&quot;</span><span class="p">][</span><span class="n">trans</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Warning: Transition with no final hashkey: Skipping.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">addStatus</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>

                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Found escaping transition, with barrier </span><span class="si">%f</span><span class="s2">, to volume of hashkey, </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">][</span><span class="n">trans</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalHashkey&quot;</span><span class="p">][</span><span class="n">trans</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Create an object to store the final, such as may be parsed to saveResultsToBasin.</span>
                <span class="c1"># result = tempResult(final=copy.deepcopy(results.resultsDict[&quot;finals&quot;][trans]))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrCompareSaddles</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">tempResult</span><span class="p">(</span><span class="n">final</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finals&quot;</span><span class="p">][</span><span class="n">trans</span><span class="p">],</span> <span class="n">saddle</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;saddles&quot;</span><span class="p">][</span><span class="n">trans</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">tempResult</span><span class="p">(</span><span class="n">final</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finals&quot;</span><span class="p">][</span><span class="n">trans</span><span class="p">])</span>

                <span class="c1"># Save the escape transition.</span>
                <span class="n">status</span><span class="p">,</span> <span class="n">alreadyInBasin</span><span class="p">,</span> <span class="n">extraReuse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveResultsToBasin</span><span class="p">(</span><span class="n">basinI</span><span class="p">,</span> <span class="n">basinVolumeNum</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">extraReuse</span><span class="p">,</span> <span class="n">generalVolNum</span><span class="p">,</span> <span class="n">dicIndex</span><span class="o">=</span><span class="n">trans</span><span class="p">,</span> <span class="n">addPair</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
                    <span class="c1"># Success</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Added escaping transition to a basin, adding to list of transitions to remove from results object.</span><span class="se">\t</span><span class="s2">(</span><span class="si">%d</span><span class="s2">)&quot;</span><span class="o">%</span><span class="n">trans</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">removeList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Failure</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Transition from volume </span><span class="si">%d</span><span class="s2">, escaping basin </span><span class="si">%r</span><span class="s2">, could not be saved by saveResultsToBasin, nor was it already stored.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">basinVolumeNum</span><span class="p">,</span> <span class="n">basinI</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">addStatus</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Print warning to indicate number of saving failures.</span>
        <span class="k">if</span> <span class="n">addStatus</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;WARNING: </span><span class="si">%d</span><span class="s2"> escaping transitions could not be be added by addMissedEscapeTransitions method&quot;</span> <span class="o">%</span> <span class="n">addStatus</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Take transitions out of the results dictionary -- they belong to the basin now.</span>
        <span class="n">numberRemoved</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">removeList</span><span class="p">):</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Removing escaping transitions from results dictionary (indexes are updated during this process, so don&#39;t worry if you see repeats).&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">exTrans</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">removeList</span><span class="p">)):</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Removing transition from dictionary with index </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">removeList</span><span class="p">[</span><span class="n">exTrans</span><span class="p">]</span> <span class="o">-</span> <span class="n">numberRemoved</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">removeFromDict</span><span class="p">(</span><span class="n">removeList</span><span class="p">[</span><span class="n">exTrans</span><span class="p">]</span> <span class="o">-</span> <span class="n">numberRemoved</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">NStoredTot</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">NStoredTot</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">numberRemoved</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">addStatus</span><span class="p">,</span> <span class="n">extraReuse</span></div>

<span class="c1">#############################################################</span>
<div class="viewcode-block" id="KMCRunner.writeAllTrans"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.writeAllTrans">[docs]</a>    <span class="k">def</span> <span class="nf">writeAllTrans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prints out all results available in selectEvent for debug</span>

<span class="sd">        TODO: May wish to be deleted in future</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;All transitions available to selectEvent&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">])):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;reverseBarriers&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volIndxs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span><span class="mi">4</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> Barrier:  </span><span class="si">%r</span><span class="s2"> (</span><span class="si">%r</span><span class="s2">) </span><span class="se">\t</span><span class="s2"> volIndex: </span><span class="si">%r</span><span class="s2"> </span><span class="se">\t</span><span class="s2"> BarrierOrigin: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">),</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> error for result (index or key error)&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> non basin events of </span><span class="si">%d</span><span class="s2"> total&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">])),</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span></div>

<span class="c1">#############################################################</span>
<div class="viewcode-block" id="KMCRunner.basinReport"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.basinReport">[docs]</a>    <span class="k">def</span> <span class="nf">basinReport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">writeVolumes</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes current information about existng basins in a human friendly format</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        error : int</span>
<span class="sd">        Signifies the output file label</span>
<span class="sd">            * 0 : Ordinary output after getTransitions (default)</span>
<span class="sd">            * 1 : Dump of data after inconsistent pair is discovered in saveResultsToBasin</span>
<span class="sd">            * 2 : Report on state of affairs before attempting to fix inconsistent pairs in saveResultsToBasin</span>
<span class="sd">            * 3 : Dump of data after irreparable current defect volume is encountered</span>
<span class="sd">            * 4 : Report on state of affairs before removing an escaping transition from a basin because it needs to be replaced with a new internal transition.</span>
<span class="sd">            * 5 : Report for basins after a repair has been actioned</span>
<span class="sd">            * 6 : Pre-integrity check. Removed if no corrections made.</span>
<span class="sd">            * 7 : Temporary basin report made at the beginning of a step</span>
<span class="sd">        writeVolumes : bool</span>
<span class="sd">            Controls whether basin defect volume are written to file (default is False)</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        self.uts : int</span>
<span class="sd">            The unix timestamp at the start of the simulation. Used to create a unique directory.</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        fPath :  string</span>
<span class="sd">            Path to basin report file. Only returned if method is called in with error=6.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fPath</span> <span class="o">=</span> <span class="n">lPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;BasinReports_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">uts</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fPath</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">fPath</span><span class="p">)</span>

        <span class="c1"># TODO: remove writeVolumes option</span>
        <span class="k">if</span> <span class="n">writeVolumes</span><span class="p">:</span>
            <span class="n">lPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lPath</span><span class="p">,</span> <span class="s2">&quot;BasinDefectVolumes_Step</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">)</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Writing the basins&#39; defect volumes to file at </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">lPath</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">lPath</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">lPath</span><span class="p">)</span>

        <span class="c1"># TODO: NEEDS COMMENTING!</span>
        <span class="k">if</span> <span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">repeats</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">negative</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fPath</span><span class="p">,</span> <span class="s2">&quot;reuseIndexProblem_</span><span class="si">%04d</span><span class="s2">.txt&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">)</span>
            <span class="n">rReport</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">rPath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span>
                <span class="n">basin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)):</span>
                    <span class="n">defectVolume</span> <span class="o">=</span> <span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
                    <span class="n">repeats</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">negative</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">defectVolume</span><span class="o">.</span><span class="n">transitions</span><span class="p">)):</span>
                        <span class="n">transition</span> <span class="o">=</span> <span class="n">defectVolume</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">defectVolume</span><span class="o">.</span><span class="n">transitions</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="n">tc</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">c</span> <span class="o">=</span> <span class="n">defectVolume</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">tc</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">reuseIndex</span> <span class="o">==</span> <span class="n">transition</span><span class="o">.</span><span class="n">reuseIndex</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">dupRef</span> <span class="o">==</span> <span class="n">transition</span><span class="o">.</span><span class="n">dupRef</span><span class="p">:</span>
                                <span class="n">repeats</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">t</span><span class="p">,</span> <span class="n">tc</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">reuseIndex</span><span class="p">])</span>
                                <span class="n">repeatFound</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">transition</span><span class="o">.</span><span class="n">reuseIndex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">negative</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">reuseIndex</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">repeats</span><span class="p">)):</span>
                        <span class="n">rReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Basin </span><span class="si">%02d</span><span class="se">\t</span><span class="s2">Defect Volume </span><span class="si">%02d</span><span class="se">\t</span><span class="s2">Transitions </span><span class="si">%02d</span><span class="s2"> and </span><span class="si">%02d</span><span class="s2"> have an identical reuseIndex of </span><span class="si">%02d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">repeats</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">repeats</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">repeats</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">negative</span><span class="p">)):</span>
                        <span class="n">rReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Basin </span><span class="si">%02d</span><span class="se">\t</span><span class="s2">Defect Volume </span><span class="si">%02d</span><span class="se">\t</span><span class="s2">Transition </span><span class="si">%02d</span><span class="s2"> has a negative reuseIndex of </span><span class="si">%02d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">negative</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">negative</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">rReport</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">repeats</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">negative</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">rPath</span><span class="p">)</span>
            <span class="n">fPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fPath</span><span class="p">,</span> <span class="s2">&quot;BasinReport_</span><span class="si">%04d</span><span class="s2">.txt&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">error</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fPath</span><span class="p">,</span> <span class="s2">&quot;BasinReport_</span><span class="si">%04d</span><span class="s2">_</span><span class="si">%d</span><span class="s2">_Error_InconsistentPairDump.txt&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())))</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;encountered problem - Dumping basin information to file:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fPath</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">error</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">fPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fPath</span><span class="p">,</span> <span class="s2">&quot;BasinReport_</span><span class="si">%04d</span><span class="s2">_</span><span class="si">%d</span><span class="s2">_PreFixPair.txt&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())))</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Writing basin report before attempting to fix inconsistent pair, file at:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fPath</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">error</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">fPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fPath</span><span class="p">,</span> <span class="s2">&quot;BasinReport_</span><span class="si">%04d</span><span class="s2">_</span><span class="si">%d</span><span class="s2">_Error_BadCurrentDV.txt&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())))</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;A basin had a bad currentDV. Dumping basin information to file:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fPath</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">error</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">fPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fPath</span><span class="p">,</span> <span class="s2">&quot;BasinReport_</span><span class="si">%04d</span><span class="s2">_</span><span class="si">%d</span><span class="s2">_PreRemoveEscape.txt&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())))</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Writing basin report before removing old escape transition, file at:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fPath</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">error</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">fPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fPath</span><span class="p">,</span> <span class="s2">&quot;BasinReport_</span><span class="si">%04d</span><span class="s2">_</span><span class="si">%d</span><span class="s2">_PostFix.txt&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())))</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Writing basin report after fixing basin, file at:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fPath</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">error</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">fPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fPath</span><span class="p">,</span> <span class="s2">&quot;BasinReport_</span><span class="si">%04d</span><span class="s2">_</span><span class="si">%d</span><span class="s2">_PreIntegrityCheck.txt&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())))</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Writing basin report before running integrity check, file at:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fPath</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;See normal basin report for outcome</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">error</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">fPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fPath</span><span class="p">,</span> <span class="s2">&quot;TEMP_BasinReport_</span><span class="si">%04d</span><span class="s2">_</span><span class="si">%d</span><span class="s2">.txt&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())))</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Writing temporary basin report beggining of step, file at:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fPath</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Warning: Unknown basin report type (</span><span class="si">%d</span><span class="s2">). No report written.&quot;</span> <span class="o">%</span> <span class="n">error</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">BasinReport</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fPath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

        <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
        <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Basin Map:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">)):</span>
            <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Basin: </span><span class="si">%02d</span><span class="s2">    Internal Ref: </span><span class="si">%02d</span><span class="s2">    Primary State&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Basin: </span><span class="si">%02d</span><span class="s2">    Internal Ref: </span><span class="si">%02d</span><span class="s2">    Duplicate State&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Non-Basin State&quot;</span><span class="p">)</span>
            <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
        <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;1 Basin&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> Basins&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">):</span>
            <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">Warning: More basins than defect volumes in the current state (</span><span class="si">%d</span><span class="s2">)!&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">))</span>

        <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span>
            <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Basin </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">b</span><span class="p">)</span>
            <span class="n">basin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
            <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Current Defect Volume </span><span class="si">%r</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">basin</span><span class="o">.</span><span class="n">currentDV</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">1 Defect Volume</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%d</span><span class="s2"> Defect Volumes</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">))</span>

            <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Connectivity Matrix:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">m</span><span class="p">,</span> <span class="n">inconsistent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinReportConnectivity</span><span class="p">(</span><span class="n">basin</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)):</span>
                <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">j</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]:</span>
                            <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;- &quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
                <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inconsistent</span><span class="p">):</span>
                <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Connectivity is inconsistent</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inconsistent</span><span class="p">)):</span>
                    <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">DV </span><span class="si">%d</span><span class="s2"> to </span><span class="si">%d</span><span class="s2"> linkage: </span><span class="si">%d</span><span class="s2"> forward, </span><span class="si">%d</span><span class="s2"> reverse</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">inconsistent</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                                                                           <span class="n">inconsistent</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                                                           <span class="n">inconsistent</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                                                                                           <span class="n">inconsistent</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span>
                <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)):</span>
                <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Defect Volume </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">d</span><span class="p">)</span>
                <span class="n">defectVolume</span> <span class="o">=</span> <span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
                <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">Primary Hashkey:</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">defectVolume</span><span class="o">.</span><span class="n">hashkey</span><span class="p">)</span>
                <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">COM: [</span><span class="si">%.5f</span><span class="s2">, </span><span class="si">%.5f</span><span class="s2">, </span><span class="si">%.5f</span><span class="s2">]</span><span class="se">\t</span><span class="s2">Moment: [</span><span class="si">%.5f</span><span class="s2">, </span><span class="si">%.5f</span><span class="s2">, </span><span class="si">%.5f</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">defectVolume</span><span class="o">.</span><span class="n">COM</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                                                 <span class="n">defectVolume</span><span class="o">.</span><span class="n">COM</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                                                                 <span class="n">defectVolume</span><span class="o">.</span><span class="n">COM</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                                                                                 <span class="n">defectVolume</span><span class="o">.</span><span class="n">moment</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                                                 <span class="n">defectVolume</span><span class="o">.</span><span class="n">moment</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                                                                 <span class="n">defectVolume</span><span class="o">.</span><span class="n">moment</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

                <span class="k">if</span> <span class="n">defectVolume</span><span class="o">.</span><span class="n">explored</span><span class="p">:</span>
                    <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">Explored</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">Not Explored</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">defectVolume</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">)):</span>
                    <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">Duplicate hashkey </span><span class="si">%d</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">defectVolume</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">[</span><span class="n">s</span><span class="p">]))</span>
                    <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2">COM: [</span><span class="si">%.5f</span><span class="s2">, </span><span class="si">%.5f</span><span class="s2">, </span><span class="si">%.5f</span><span class="s2">]</span><span class="se">\t</span><span class="s2">Moment: [</span><span class="si">%.5f</span><span class="s2">, </span><span class="si">%.5f</span><span class="s2">, </span><span class="si">%.5f</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">defectVolume</span><span class="o">.</span><span class="n">dupCOM</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">defectVolume</span><span class="o">.</span><span class="n">dupCOM</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">defectVolume</span><span class="o">.</span><span class="n">dupCOM</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">defectVolume</span><span class="o">.</span><span class="n">dupMoment</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">defectVolume</span><span class="o">.</span><span class="n">dupMoment</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">defectVolume</span><span class="o">.</span><span class="n">dupMoment</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">defectVolume</span><span class="o">.</span><span class="n">transitions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">1 Transition</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="si">%d</span><span class="s2"> Transitions</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">defectVolume</span><span class="o">.</span><span class="n">transitions</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">defectVolume</span><span class="o">.</span><span class="n">transitions</span><span class="p">)):</span>
                    <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">Transition </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">t</span><span class="p">)</span>
                    <span class="n">transition</span> <span class="o">=</span> <span class="n">defectVolume</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">transition</span><span class="o">.</span><span class="n">partOfPair</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2">Internal Transition</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">transition</span><span class="o">.</span><span class="n">partOfPair</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2">Escaping Transition</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2">Warning: No type stored</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2">Barriers:</span><span class="se">\t</span><span class="s2">Forward = </span><span class="si">%0.5f</span><span class="s2"> eV</span><span class="se">\t</span><span class="s2">Reverse = </span><span class="si">%0.5f</span><span class="s2"> eV</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">transition</span><span class="o">.</span><span class="n">barrier</span><span class="p">,</span> <span class="n">transition</span><span class="o">.</span><span class="n">reverseBarrier</span><span class="p">))</span>

                    <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2">Final Hashkey:</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">transition</span><span class="o">.</span><span class="n">finalHashkey</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">transition</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">)):</span>  <span class="c1"># redundant</span>
                        <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2">Duplicate Final Hashkey </span><span class="si">%d</span><span class="s2">:</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">transition</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">[</span><span class="n">s</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrCompareSaddles</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">transition</span><span class="o">.</span><span class="n">sadCOM</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">transition</span><span class="o">.</span><span class="n">sadMom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2">Saddle COM: [</span><span class="si">%.5f</span><span class="s2">, </span><span class="si">%.5f</span><span class="s2">, </span><span class="si">%.5f</span><span class="s2">]</span><span class="se">\t</span><span class="s2">Moment: [</span><span class="si">%.5f</span><span class="s2">, </span><span class="si">%.5f</span><span class="s2">, </span><span class="si">%.5f</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                              <span class="n">transition</span><span class="o">.</span><span class="n">sadCOM</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">transition</span><span class="o">.</span><span class="n">sadCOM</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">transition</span><span class="o">.</span><span class="n">sadCOM</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                              <span class="n">transition</span><span class="o">.</span><span class="n">sadMom</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">transition</span><span class="o">.</span><span class="n">sadMom</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">transition</span><span class="o">.</span><span class="n">sadMom</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2">Either the Saddle COM or  Moment is None!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2">Reuse File Index:</span><span class="se">\t</span><span class="si">%r</span><span class="s2">  &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">transition</span><span class="o">.</span><span class="n">reuseIndex</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">transition</span><span class="o">.</span><span class="n">dupRef</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;(Primary hashkey)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;(Duplicate hashkey </span><span class="si">%d</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">transition</span><span class="o">.</span><span class="n">dupRef</span><span class="p">))</span>
                    <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2">Final DV Basin Index:</span><span class="se">\t</span><span class="si">%r</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">transition</span><span class="o">.</span><span class="n">finalDV</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">verboseLevel</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2">DV Index within Initial State:</span><span class="se">\t</span><span class="si">%r</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">transition</span><span class="o">.</span><span class="n">currentVolIndex</span><span class="p">))</span>
                        <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2">DV Index within Final State:</span><span class="se">\t</span><span class="si">%r</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">transition</span><span class="o">.</span><span class="n">finalVolIndex</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">transition</span><span class="o">.</span><span class="n">altGraph</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">BasinReport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2">This transition uses an alternative graph volume</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">writeVolumes</span><span class="p">:</span>
                    <span class="n">bPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lPath</span><span class="p">,</span> <span class="s2">&quot;Basin</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">b</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bPath</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">bPath</span><span class="p">)</span>

                    <span class="n">bPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bPath</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">_</span><span class="si">%s</span><span class="s2">.dat&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">defectVolume</span><span class="o">.</span><span class="n">hashkey</span><span class="p">))</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Writing basin </span><span class="si">%d</span><span class="s2">, defect volume </span><span class="si">%d</span><span class="s2">, to file at:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">bPath</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

                    <span class="c1"># Create dummy lattice with the defect volume&#39;s graph atoms</span>
                    <span class="n">NAtoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">defectVolume</span><span class="o">.</span><span class="n">graphVol</span><span class="p">)</span>
                    <span class="n">DVspecies</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">defectVolume</span><span class="o">.</span><span class="n">graphVol</span><span class="p">:</span>
                        <span class="n">DVspecies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">specie</span><span class="p">[</span><span class="n">spec</span><span class="p">])</span>
                    <span class="n">DVLattice</span> <span class="o">=</span> <span class="n">Dummy</span><span class="o">.</span><span class="n">DummyLattice</span><span class="p">(</span><span class="n">NAtoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">DVspecies</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">specieList</span><span class="p">,</span> <span class="n">defectVolume</span><span class="o">.</span><span class="n">dvPos</span><span class="p">)</span>

                    <span class="c1"># Write lattice</span>
                    <span class="n">DVLattice</span><span class="o">.</span><span class="n">writeLattice</span><span class="p">(</span><span class="n">bPath</span><span class="p">)</span>

        <span class="n">BasinReport</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">error</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">or</span> <span class="n">error</span><span class="o">==</span><span class="mi">7</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fPath</span></div>

<span class="c1">#############################################################</span>
<div class="viewcode-block" id="KMCRunner.basinReportConnectivity"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.basinReportConnectivity">[docs]</a>    <span class="k">def</span> <span class="nf">basinReportConnectivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns simple connectivity matrix designed for human readabilty.</span>
<span class="sd">        Not to be confused with the more complex version created by buildConnectivity.</span>
<span class="sd">        Additionally returns a list of inconsistent (i.e. asymetries) in the basin.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        basin : basin object</span>
<span class="sd">            The basin whose connectivity matrix one wants to seee</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        connectivity : list</span>
<span class="sd">            For N states, this is an N by N matrix of direct connections within the basin.</span>
<span class="sd">        inconsistent : list</span>
<span class="sd">            A list of all asymetries in the bain.</span>
<span class="sd">            Each element is itself a length four list of the two states, and the respective inconsistent connections.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO: NEEDS COMMENTING</span>
        <span class="n">connectivity</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">))]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">))]</span>
        <span class="n">inconsistent</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">transitions</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">finalDV</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">connectivity</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">finalDV</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">connectivity</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">connectivity</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="n">connectivity</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">inconsistent</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">connectivity</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">connectivity</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]])</span>

        <span class="k">return</span> <span class="n">connectivity</span><span class="p">,</span> <span class="n">inconsistent</span></div>

<span class="c1">#############################################################</span>
<div class="viewcode-block" id="KMCRunner.consistentBasinReuseCheck"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.consistentBasinReuseCheck">[docs]</a>    <span class="k">def</span> <span class="nf">consistentBasinReuseCheck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currentOnly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bTol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">lowBarrier</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compares explored basin states to the reuse defect volumes to check consistency. Writes findings to file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        currentOnly : bool</span>
<span class="sd">            Limit the check to only the current state of basins (Default = True)</span>
<span class="sd">        bTol : float</span>
<span class="sd">            The tolarance barriers are allow to differ by given as a ratio (Default = 0.1, i.e 10%)</span>
<span class="sd">        lowBarrier : float</span>
<span class="sd">            The maxiuam height a barrier has to be to be exempt from the tolarance check (Default = 0.1 eV)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Loop over list of basins</span>
        <span class="k">for</span> <span class="n">bas</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span>
            <span class="c1"># Determine if basin is currently in use (ie appears in the map)</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">bas</span><span class="p">:</span>
                        <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">basin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">bas</span><span class="p">]</span>
            <span class="c1"># Loop over this basin&#39;s defect volumes</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)):</span>
                <span class="n">bDV</span> <span class="o">=</span> <span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
                <span class="c1"># Not interested in non-explored states</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">bDV</span><span class="o">.</span><span class="n">explored</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># If this state is not the current dv and we only want to look at the current DV, skip it.</span>
                <span class="k">if</span> <span class="n">basin</span><span class="o">.</span><span class="n">currentDV</span> <span class="o">!=</span> <span class="n">d</span> <span class="ow">and</span> <span class="n">currentOnly</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Initially set to empty arrays</span>
                <span class="n">rDVbMap</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">rDVbMap</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

                <span class="c1"># Create array for original hashkey</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">bDV</span><span class="o">.</span><span class="n">hashkey</span><span class="p">]</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)):</span>
                    <span class="n">rDVbMap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="kc">False</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">bDV</span><span class="o">.</span><span class="n">hashkey</span><span class="p">])</span>

                <span class="c1"># Add arrays for duplicate hashkeys</span>
                <span class="k">for</span> <span class="n">dup</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bDV</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">)):</span>
                    <span class="n">rDVbMap</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">bDV</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">[</span><span class="n">dup</span><span class="p">]]</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)):</span>
                            <span class="n">rDVbMap</span><span class="p">[</span><span class="n">dup</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="kc">False</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">bDV</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">[</span><span class="n">dup</span><span class="p">]])</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">rDVbMap</span><span class="p">[</span><span class="n">dup</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;WARNING: Key </span><span class="si">%r</span><span class="s2"> not found in defect volumes. May be new duplciate state -- Skipping&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">bDV</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">[</span><span class="n">dup</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

                <span class="c1"># Loop over all transitions in basin DV</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bDV</span><span class="o">.</span><span class="n">transitions</span><span class="p">)):</span>
                    <span class="n">bTrans</span> <span class="o">=</span> <span class="n">bDV</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
                    <span class="n">rDV</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="c1"># If duplicate exists</span>
                    <span class="k">if</span> <span class="n">bTrans</span><span class="o">.</span><span class="n">dupRef</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">rDV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">bDV</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">[</span><span class="n">bTrans</span><span class="o">.</span><span class="n">dupRef</span><span class="p">]]</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">bTrans</span><span class="o">.</span><span class="n">dupRef</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">rDV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">bDV</span><span class="o">.</span><span class="n">hashkey</span><span class="p">]</span>

                    <span class="k">assert</span> <span class="n">bTrans</span><span class="o">.</span><span class="n">reuseIndex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">rTrans</span> <span class="o">=</span> <span class="n">rDV</span><span class="o">.</span><span class="n">transitionList</span><span class="p">[</span><span class="n">bTrans</span><span class="o">.</span><span class="n">reuseIndex</span><span class="p">]</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">):</span>
                        <span class="nb">print</span> <span class="s2">&quot;DEBUG: length of rDV transitions: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rDV</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)</span>
                        <span class="nb">print</span> <span class="s2">&quot;DEBUG: reuseIndex with error: &quot;</span><span class="p">,</span> <span class="n">bTrans</span><span class="o">.</span><span class="n">reuseIndex</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Reference made to reuse transition that does not exist in VTO&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Basin transition </span><span class="si">%d</span><span class="s2"> (volume </span><span class="si">%d</span><span class="s2">) does not exist in volume file. ReuseIndex: </span><span class="si">%r</span><span class="se">\n\n</span><span class="s2">If you see this error upon resuming a simulation, it may mean that basin and VTO files were interrupted during writing.</span><span class="se">\n</span><span class="s2">Try deleting the last step and trying again.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">bTrans</span><span class="o">.</span><span class="n">reuseIndex</span><span class="p">))</span>


                    <span class="c1"># Check barriers are within a tolarance</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">bTrans</span><span class="o">.</span><span class="n">barrier</span> <span class="o">&gt;</span> <span class="n">rTrans</span><span class="o">.</span><span class="n">barrier</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">bTol</span><span class="p">)</span> <span class="ow">or</span> <span class="n">rTrans</span><span class="o">.</span><span class="n">barrier</span> <span class="o">&gt;</span> <span class="n">bTrans</span><span class="o">.</span><span class="n">barrier</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">bTol</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">bTrans</span><span class="o">.</span><span class="n">barrier</span><span class="p">,</span> <span class="n">rTrans</span><span class="o">.</span><span class="n">barrier</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">lowBarrier</span><span class="p">:</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;WARNING: [</span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">] Barriers differ by more than 10</span><span class="si">%%</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">bTrans</span><span class="o">.</span><span class="n">reuseIndex</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;--Barriers are </span><span class="si">%0.5f</span><span class="s2"> eV and </span><span class="si">%0.5f</span><span class="s2"> eV&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bTrans</span><span class="o">.</span><span class="n">barrier</span><span class="p">,</span> <span class="n">rTrans</span><span class="o">.</span><span class="n">barrier</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

                    <span class="c1"># If first time this transition is used, update data</span>
                    <span class="k">if</span> <span class="n">rDVbMap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">rDVbMap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bTrans</span><span class="o">.</span><span class="n">reuseIndex</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="n">rDVbMap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bTrans</span><span class="o">.</span><span class="n">reuseIndex</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">rDVbMap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bTrans</span><span class="o">.</span><span class="n">reuseIndex</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bTrans</span><span class="o">.</span><span class="n">barrier</span>
                            <span class="n">rDVbMap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bTrans</span><span class="o">.</span><span class="n">reuseIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">rTrans</span><span class="o">.</span><span class="n">barrier</span>
                        <span class="c1"># Else, add extra data of multipe uses</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">rDVbMap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bTrans</span><span class="o">.</span><span class="n">reuseIndex</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">bTrans</span><span class="o">.</span><span class="n">barrier</span><span class="p">,</span> <span class="n">rTrans</span><span class="o">.</span><span class="n">barrier</span><span class="p">])</span>

                <span class="nb">print</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rDVbMap</span><span class="p">)):</span>
                    <span class="nb">print</span> <span class="n">rDVbMap</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
                <span class="nb">print</span> <span class="s2">&quot;&quot;</span>

                <span class="c1"># Create consistency report for debugging</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;ReuseVsBasinReport_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">uts</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Step</span><span class="si">%04d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;B</span><span class="si">%d</span><span class="s2">_D</span><span class="si">%d</span><span class="s2">.txt&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bas</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>

                <span class="n">rvb</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">fs</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rDVbMap</span><span class="p">)):</span>
                    <span class="n">rvb</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;DV </span><span class="si">%d</span><span class="s2">: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">bDV</span><span class="o">.</span><span class="n">hashkey</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">rDVbMap</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">rvb</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; None&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rDVbMap</span><span class="p">[</span><span class="n">a</span><span class="p">])):</span>
                        <span class="n">rvb</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">[</span><span class="si">%r</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">rDVbMap</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">rDVbMap</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">ts</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fs</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">rvb</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                        <span class="n">rvb</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%0.5f</span><span class="s2">, </span><span class="si">%0.5f</span><span class="s2">, </span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rDVbMap</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                                          <span class="n">rDVbMap</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                                                          <span class="n">rDVbMap</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span>

                        <span class="k">if</span> <span class="n">rDVbMap</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">rDVbMap</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">rDVbMap</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">rDVbMap</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">bTol</span><span class="p">)</span> <span class="ow">or</span> <span class="n">rDVbMap</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">rDVbMap</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">bTol</span><span class="p">)):</span>
                                <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">rDVbMap</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">rDVbMap</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">lowBarrier</span><span class="p">:</span>
                                    <span class="n">rvb</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">*&quot;</span><span class="p">)</span>
                        <span class="n">rvb</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rDVbMap</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rDVbMap</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">):</span>
                                <span class="n">rvb</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="si">%0.5f</span><span class="s2">, </span><span class="si">%0.5f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rDVbMap</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="n">c</span><span class="o">+</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">rDVbMap</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="n">c</span><span class="o">+</span><span class="mi">4</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">rDVbMap</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="n">c</span><span class="o">+</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">rDVbMap</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="n">c</span><span class="o">+</span><span class="mi">4</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">bTol</span><span class="p">)</span> <span class="ow">or</span> <span class="n">rDVbMap</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="n">c</span><span class="o">+</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">rDVbMap</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="n">c</span><span class="o">+</span><span class="mi">4</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">bTol</span><span class="p">)):</span>
                                    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">rDVbMap</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="n">c</span><span class="o">+</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">rDVbMap</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="n">c</span><span class="o">+</span><span class="mi">4</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">lowBarrier</span><span class="p">:</span>
                                        <span class="n">rvb</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">*&quot;</span><span class="p">)</span>
                                <span class="n">rvb</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="n">rvb</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> True</span><span class="se">\t</span><span class="si">%r</span><span class="s2"> False</span><span class="se">\t</span><span class="si">%r</span><span class="s2"> Total</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="p">(</span><span class="n">ts</span><span class="o">+</span><span class="n">fs</span><span class="p">)))</span>

                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Checking transition consistency in basin and reuse file. Basin </span><span class="si">%d</span><span class="s2">, DV </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bas</span><span class="p">,</span><span class="n">d</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Number of positive matches: </span><span class="si">%d</span><span class="s2"> out of </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="n">ts</span><span class="o">+</span><span class="n">fs</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>


                <span class="k">if</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">ts</span><span class="o">+</span><span class="n">fs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">maxReuseFailFrac</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ts</span><span class="o">+</span><span class="n">fs</span><span class="o">&gt;</span> <span class="mi">5</span><span class="p">):</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;WARNING: LOW FRACTION OF SUCCESS IN REUSE: </span><span class="si">%0.5f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">ts</span><span class="o">+</span><span class="n">fs</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Consider changing refinement parameters!&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span></div>

<span class="c1">#############################################################</span>
<div class="viewcode-block" id="KMCRunner.verifyBasinCurrentDV"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.verifyBasinCurrentDV">[docs]</a>    <span class="k">def</span> <span class="nf">verifyBasinCurrentDV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basin</span><span class="p">,</span> <span class="n">fatal</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensure correct current DV for basin</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        basin : basin object</span>
<span class="sd">            The basin whose currentDV one wishes to verify</span>
<span class="sd">        fatal : bool</span>
<span class="sd">            Crash on repair failure</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        True</span>
<span class="sd">            If changes to currentDV are made</span>
<span class="sd">        False</span>
<span class="sd">            If no changes are mare to currentDV</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO: NEEDS COMMENTING</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">match</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">CDVs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">CDVs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">graphKey</span> <span class="o">==</span> <span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">basin</span><span class="o">.</span><span class="n">currentDV</span><span class="p">]</span><span class="o">.</span><span class="n">hashkey</span> <span class="ow">or</span> <span class="n">CDVs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">graphKey</span> <span class="ow">in</span> <span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">basin</span><span class="o">.</span><span class="n">currentDV</span><span class="p">]</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">CDVs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">com</span><span class="p">,</span> <span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">basin</span><span class="o">.</span><span class="n">currentDV</span><span class="p">]</span><span class="o">.</span><span class="n">COM</span><span class="p">,</span> <span class="n">basin</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">basinCOMTol</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">CDVs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">moment</span><span class="p">,</span> <span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">basin</span><span class="o">.</span><span class="n">currentDV</span><span class="p">]</span><span class="o">.</span><span class="n">moment</span><span class="p">,</span> <span class="n">basin</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">basinMomentTol</span><span class="p">:</span>
                        <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">basin</span><span class="o">.</span><span class="n">currentDV</span><span class="p">]</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">CDVs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">com</span><span class="p">,</span> <span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">basin</span><span class="o">.</span><span class="n">currentDV</span><span class="p">]</span><span class="o">.</span><span class="n">dupCOM</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">basin</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">basinCOMTol</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">CDVs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">moment</span><span class="p">,</span> <span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">basin</span><span class="o">.</span><span class="n">currentDV</span><span class="p">]</span><span class="o">.</span><span class="n">dupMoment</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">basin</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">basinMomentTol</span><span class="p">:</span>
                            <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>

            <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;verifyBasinCurrentDV - currentDV ok&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;verifyBasinCurrentDV - currentDV does not match currentState. Attempting to repair.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">debugBasin</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">currentState defectVolumes:&quot;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)):</span>
                <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">CDVs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">graphKey</span><span class="p">,</span> <span class="n">CDVs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">com</span><span class="p">,</span> <span class="n">CDVs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">moment</span>
            <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">basin defectVolumes&quot;</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)):</span>
                <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">hashkey</span><span class="p">,</span> <span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">COM</span><span class="p">,</span> <span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">moment</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">)):</span>
                    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="nb">print</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)):</span>
                <span class="n">BVDj</span> <span class="o">=</span> <span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">CDVs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">graphKey</span> <span class="o">==</span> <span class="n">BVDj</span><span class="o">.</span><span class="n">hashkey</span> <span class="ow">or</span> <span class="n">CDVs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">graphKey</span> <span class="ow">in</span> <span class="n">BVDj</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">CDVs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">com</span><span class="p">,</span> <span class="n">BVDj</span><span class="o">.</span><span class="n">COM</span><span class="p">,</span> <span class="n">basin</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">basinCOMTol</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">CDVs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">moment</span><span class="p">,</span> <span class="n">BVDj</span><span class="o">.</span><span class="n">moment</span><span class="p">,</span> <span class="n">basin</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">basinMomentTol</span><span class="p">:</span>
                            <span class="n">match</span> <span class="o">=</span> <span class="n">j</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">BVDj</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">CDVs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">com</span><span class="p">,</span> <span class="n">BVDj</span><span class="o">.</span><span class="n">dupCOM</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">basin</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">basinCOMTol</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">CDVs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">moment</span><span class="p">,</span> <span class="n">BVDj</span><span class="o">.</span><span class="n">dupMoment</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">basin</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">basinMomentTol</span><span class="p">:</span>
                                    <span class="n">match</span> <span class="o">=</span> <span class="n">j</span>
                                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fatal</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mapDVsToBasins</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">basinReport</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">verifyBasinCurrentDV found incorect currentDV for a basin and could not find a match in the currentState&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basinReport</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;verifyBasinCurrentDV: correcting basin currentDV from </span><span class="si">%r</span><span class="s2"> to </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">basin</span><span class="o">.</span><span class="n">currentDV</span><span class="p">,</span> <span class="n">match</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">basin</span><span class="o">.</span><span class="n">currentDV</span> <span class="o">=</span> <span class="n">match</span>
            <span class="k">return</span> <span class="kc">True</span></div>

<span class="c1">#############################################################</span>
<div class="viewcode-block" id="KMCRunner.removeBasin"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.removeBasin">[docs]</a>    <span class="k">def</span> <span class="nf">removeBasin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basinNum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes basins from the basin list and updates the map accordingly</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        basinNum : int</span>
<span class="sd">            The index of the basin to remove</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Removing basin </span><span class="si">%d</span><span class="s2"> from the basin list&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">basinNum</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">basinNum</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">basinNum</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span></div>

<span class="c1">#############################################################</span>
<div class="viewcode-block" id="KMCRunner.purgeBasins"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.purgeBasins">[docs]</a>    <span class="k">def</span> <span class="nf">purgeBasins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes any basins not currently in use.</span>
<span class="sd">        A basin may have been escaped without the selection of an escaping transition event. Possible causes include:</span>
<span class="sd">            * Two defect volumes have migrated within graph radius of each other, changing the final hashkey and causing the system to be in a state not recognised as part of a basin. While not ideal that we have to delete the basin and build a new one, this is correct behavior.</span>
<span class="sd">            * A basin transition has been excuted improperly, leading the system to be in a new state, not recognised as part of an existing basin. This is improper behavior, and if you observe that it happening, you have a problem.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">used</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;WARNING: Basin </span><span class="si">%d</span><span class="s2"> is defunct. Deleting now.&quot;</span> <span class="o">%</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;You may wish to investigate further. Defect volumes may have merged, or transition final may have minimised into a different state.&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">removeBasin</span><span class="p">(</span><span class="n">j</span><span class="p">)</span></div></div>


<span class="c1">################################################################################</span>

<div class="viewcode-block" id="runKMCNew"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.runKMCNew">[docs]</a><span class="k">def</span> <span class="nf">runKMCNew</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run new version of KMC.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kmcRunner</span> <span class="o">=</span> <span class="n">KMCRunner</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">kmcRunner</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<span class="c1">#############################################################</span>

<div class="viewcode-block" id="commandLineArgs"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.commandLineArgs">[docs]</a><span class="k">def</span> <span class="nf">commandLineArgs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse command line arguments</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">argparse</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run KMC simulation.&quot;</span><span class="p">)</span>

<span class="c1">#    parser.add_argument(&#39;inputFile&#39;, help=&quot;The input lattice file.&quot;)</span>
<span class="c1">#    parser.add_argument(&#39;refFile&#39;, help=&quot;The reference lattice file.&quot;)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;paramFile&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;lkmcInput.IN&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;LKMC input file (default=lkmcInput.IN)&quot;</span><span class="p">)</span>
<span class="c1">#    parser.add_argument(&#39;-P&#39;, action=&quot;store_true&quot;, default=False, dest=&quot;profileCode&quot;, help=&quot;Profile the code using the hotshot module (not for production) (default=False)&quot;)</span>
<span class="c1">#    parser.add_argument(&#39;-p&#39;, dest=&quot;statsFile&quot;, default=None, help=&quot;File for dumping profiling stats to (default=None)&quot;)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;statsFile&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;profile.dat&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;File for dumping profiling stats to (default=None)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-V&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;visPerform&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Visualise the profiling of the code&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-P&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;profileCode&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Profile the code using the hotshot module (not for production) (default=False)&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span></div>

<span class="c1">################################################################################</span>

<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># handle command line args</span>
    <span class="n">progargs</span> <span class="o">=</span> <span class="n">commandLineArgs</span><span class="p">()</span>

    <span class="c1"># read the input parameters</span>
    <span class="n">Input</span><span class="o">.</span><span class="n">readGlobals</span><span class="p">(</span><span class="n">inputFile</span><span class="o">=</span><span class="n">progargs</span><span class="o">.</span><span class="n">paramFile</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">Input</span><span class="o">.</span><span class="n">getLKMCParams</span><span class="p">(</span><span class="n">inputFile</span><span class="o">=</span><span class="n">progargs</span><span class="o">.</span><span class="n">paramFile</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">,</span> <span class="s2">&quot;launch.dat&quot;</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">,</span> <span class="s2">&quot;launch.dat.gz&quot;</span><span class="p">)))</span>
            <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">,</span> <span class="s2">&quot;ref.dat&quot;</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">,</span> <span class="s2">&quot;ref.dat.gz&quot;</span><span class="p">)))):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;ERROR: ref.dat and launch.dat must exist in input directory (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">params</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">)</span>

    <span class="c1"># run</span>
    <span class="n">kmcRunner</span> <span class="o">=</span> <span class="n">KMCRunner</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">progargs</span><span class="o">.</span><span class="n">profileCode</span> <span class="ow">or</span> <span class="n">progargs</span><span class="o">.</span><span class="n">visPerform</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Profiling</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">stats</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">kmcRunner</span> <span class="o">=</span> <span class="n">Profiling</span><span class="o">.</span><span class="n">profileMethod</span><span class="p">(</span><span class="n">kmcRunner</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">printStats</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">statsFile</span><span class="o">=</span><span class="n">progargs</span><span class="o">.</span><span class="n">statsFile</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">progargs</span><span class="o">.</span><span class="n">visPerform</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;python ~/git/scripts/gprof2dot.py -f pstats </span><span class="si">%s</span><span class="s2"> | dot -Tpng -o output.png&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">progargs</span><span class="o">.</span><span class="n">statsFile</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">progargs</span><span class="o">.</span><span class="n">profileCode</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">progargs</span><span class="o">.</span><span class="n">statsFile</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">kmcRunner</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="tempResult"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.tempResult">[docs]</a><span class="k">class</span> <span class="nc">tempResult</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An object to temporarily hold a final state and a saddle state during addMergeResultToDict, so as to be passed to saveResultsToBasin</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    final : lattice object</span>
<span class="sd">        A lattice object hold the final state</span>
<span class="sd">    saddle : lattice object</span>
<span class="sd">        A lattice object hold the saddle state</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">final</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">saddle</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final</span> <span class="o">=</span> <span class="n">final</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saddle</span> <span class="o">=</span> <span class="n">saddle</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">LKMC 150623-1236-g1254817 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, Chris Scott, Tomas Lazauskas, Miao Yu.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.5.
    </div>
  </body>
</html>