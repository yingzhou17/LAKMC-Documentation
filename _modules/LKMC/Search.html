<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>LKMC.Search &mdash; LKMC 150623-1236-g1254817 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '150623-1236-g1254817',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="LKMC 150623-1236-g1254817 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">LKMC 150623-1236-g1254817 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for LKMC.Search</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Transition search module</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Algebra</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">ART</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">ClientServerInterface</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Defects</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Dimer</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Globals</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Input</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Lanczos</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Lattice</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Minimise</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">MinModeFollower</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">NEB</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Prefactor</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">RAT</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Rates</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Vectors</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">TransitionCalculatorBase</span>

<span class="kn">from</span> <span class="nn">.Utilities</span> <span class="k">import</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">.hooks</span> <span class="k">import</span> <span class="n">hook_utils</span>


<span class="c1">################################################################################</span>
<div class="viewcode-block" id="TransitionSearcher"><a class="viewcode-back" href="../../LKMC/LKMC.Search.html#LKMC.Search.TransitionSearcher">[docs]</a><span class="k">class</span> <span class="nc">TransitionSearcher</span><span class="p">(</span><span class="n">TransitionCalculatorBase</span><span class="o">.</span><span class="n">TransitionFinder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transition searcher.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">storeTransForReuse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TransitionSearcher</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">setupComplete</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobID</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ratesListLock</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratesListProxy</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">barrCalcFailSymbol</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimiseExtendSymbol</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">storeTransForReuse</span> <span class="o">=</span> <span class="n">storeTransForReuse</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">refState</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searchTimingDict</span> <span class="o">=</span> <span class="kc">None</span>
    
<div class="viewcode-block" id="TransitionSearcher.setup"><a class="viewcode-back" href="../../LKMC/LKMC.Search.html#LKMC.Search.TransitionSearcher.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initialState</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refPos</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup the transition searcher.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimisersNames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimisers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searcher</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculators</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># minimisers</span>
        <span class="c1"># main minimser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimiser</span> <span class="o">=</span> <span class="n">Minimise</span><span class="o">.</span><span class="n">getMinimiser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">jobID</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">)</span>
        
        <span class="c1"># final/saddle minimiser (extended call)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrMinFinalMinimiser</span><span class="p">):</span>
            <span class="n">minList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrMinFinalMinimiser</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minimiseExtendSymbol</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">minimiser</span> <span class="ow">in</span> <span class="n">minList</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">minimisersNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">minimiser</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">minimiser</span> <span class="o">==</span> <span class="s2">&quot;LBFGSDownHill&quot;</span><span class="p">:</span>
                    <span class="n">lanczosLooseSubParams</span> <span class="o">=</span> <span class="n">Lanczos</span><span class="o">.</span><span class="n">initialiseLanczosMinParams</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">searchMd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">looseMd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">looseIterMax</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                    <span class="n">lanczosMinDownHill</span> <span class="o">=</span> <span class="n">Lanczos</span><span class="o">.</span><span class="n">LanczosLBFGSMinimiserDownHill</span><span class="p">(</span><span class="n">lanczosLooseSubParams</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">minimisers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lanczosMinDownHill</span><span class="p">)</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">minimiser</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;SUB-&quot;</span><span class="p">:</span>
                        <span class="n">minParams</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
                        <span class="n">minParams</span><span class="o">.</span><span class="n">minimizationType</span> <span class="o">=</span> <span class="n">minimiser</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
                        <span class="n">minParams</span><span class="o">.</span><span class="n">minimizationExclusion</span> <span class="o">=</span> <span class="mi">666</span>
                    
                    <span class="k">elif</span> <span class="n">minimiser</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;OUT-&quot;</span><span class="p">:</span>
                        <span class="n">minParams</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
                        <span class="n">minParams</span><span class="o">.</span><span class="n">minimizationType</span> <span class="o">=</span> <span class="n">minimiser</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
                        <span class="n">minParams</span><span class="o">.</span><span class="n">minimizationExclusion</span> <span class="o">=</span> <span class="mi">777</span>
                    
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">minParams</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
                        <span class="n">minParams</span><span class="o">.</span><span class="n">minimizationType</span> <span class="o">=</span> <span class="n">minimiser</span>
                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">minimisers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Minimise</span><span class="o">.</span><span class="n">getMinimiser</span><span class="p">(</span><span class="n">minParams</span><span class="p">,</span> <span class="n">jobID</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">))</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minimisers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Minimise</span><span class="o">.</span><span class="n">getMinimiser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">jobID</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">))</span>
                
        <span class="c1"># searchers</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrSearchAlgorithm</span> <span class="o">==</span> <span class="s2">&quot;ART&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">searcher</span> <span class="o">=</span> <span class="n">ART</span><span class="o">.</span><span class="n">ARTNMethod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrSearchAlgorithm</span> <span class="o">==</span> <span class="s2">&quot;DIMER&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">searcher</span> <span class="o">=</span> <span class="n">Dimer</span><span class="o">.</span><span class="n">Dimer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrSearchAlgorithm</span> <span class="o">==</span> <span class="s2">&quot;RAT&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">searcher</span> <span class="o">=</span> <span class="n">RAT</span><span class="o">.</span><span class="n">RAT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrSearchAlgorithm</span> <span class="o">==</span> <span class="s2">&quot;MINMODE&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">searcher</span> <span class="o">=</span> <span class="n">MinModeFollower</span><span class="o">.</span><span class="n">MinModeFollower</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        
        <span class="c1"># calculators</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrEstimator</span><span class="p">):</span>
            <span class="n">calculatorsIDList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrEstimator</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">barrCalcFailSymbol</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">calcID</span> <span class="ow">in</span> <span class="n">calculatorsIDList</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">calcID</span> <span class="o">==</span> <span class="s2">&quot;NEB&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">calculators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NEB</span><span class="o">.</span><span class="n">NEB</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">calculators</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">setJobID</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">)</span>
                
                <span class="k">elif</span> <span class="n">calcID</span> <span class="o">==</span> <span class="s2">&quot;STRING&quot;</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;NOT READY YET&quot;</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;UNRECOGNISED BARRIER CALCULATOR&quot;</span>
        
        <span class="c1"># create list of hooks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postTransitionHookList</span> <span class="o">=</span> <span class="n">hook_utils</span><span class="o">.</span><span class="n">makeHookList</span><span class="p">(</span><span class="s2">&quot;postFoundTransitionHooks&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">setupComplete</span> <span class="o">=</span> <span class="kc">True</span></div>
    
<div class="viewcode-block" id="TransitionSearcher.setRefState"><a class="viewcode-back" href="../../LKMC/LKMC.Search.html#LKMC.Search.TransitionSearcher.setRefState">[docs]</a>    <span class="k">def</span> <span class="nf">setRefState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refState</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the initial state.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">refState</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">refState</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="TransitionSearcher.setInitialState"><a class="viewcode-back" href="../../LKMC/LKMC.Search.html#LKMC.Search.TransitionSearcher.setInitialState">[docs]</a>    <span class="k">def</span> <span class="nf">setInitialState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initialState</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the initial state.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initialState</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="TransitionSearcher.setInitialData"><a class="viewcode-back" href="../../LKMC/LKMC.Search.html#LKMC.Search.TransitionSearcher.setInitialData">[docs]</a>    <span class="k">def</span> <span class="nf">setInitialData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataDict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initial data.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">initialState</span> <span class="o">=</span> <span class="n">dataDict</span><span class="p">[</span><span class="s2">&quot;initialState&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setInitialState</span><span class="p">(</span><span class="n">initialState</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">refState</span> <span class="o">=</span> <span class="n">dataDict</span><span class="p">[</span><span class="s2">&quot;refState&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setRefState</span><span class="p">(</span><span class="n">refState</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refState</span> <span class="o">=</span> <span class="kc">None</span>
                    
        <span class="k">return</span> <span class="n">status</span></div>
    
<div class="viewcode-block" id="TransitionSearcher.setJobID"><a class="viewcode-back" href="../../LKMC/LKMC.Search.html#LKMC.Search.TransitionSearcher.setJobID">[docs]</a>    <span class="k">def</span> <span class="nf">setJobID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobID</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set job ID.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobID</span> <span class="o">=</span> <span class="n">jobID</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setupComplete</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">searcher</span><span class="p">,</span> <span class="s2">&quot;setJobID&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">searcher</span><span class="o">.</span><span class="n">setJobID</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="TransitionSearcher.setRatesList"><a class="viewcode-back" href="../../LKMC/LKMC.Search.html#LKMC.Search.TransitionSearcher.setRatesList">[docs]</a>    <span class="k">def</span> <span class="nf">setRatesList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ratesListLock</span><span class="p">,</span> <span class="n">ratesListProxy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rates list etc.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratesListLock</span> <span class="o">=</span> <span class="n">ratesListLock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratesListProxy</span> <span class="o">=</span> <span class="n">ratesListProxy</span></div>
    
<div class="viewcode-block" id="TransitionSearcher.setRank"><a class="viewcode-back" href="../../LKMC/LKMC.Search.html#LKMC.Search.TransitionSearcher.setRank">[docs]</a>    <span class="k">def</span> <span class="nf">setRank</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rank</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set rank of running process.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="n">rank</span></div>
    
<div class="viewcode-block" id="TransitionSearcher.run"><a class="viewcode-back" href="../../LKMC/LKMC.Search.html#LKMC.Search.TransitionSearcher.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currentVolumeIndex</span><span class="p">,</span> <span class="n">fixSearchObj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run transition search.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">setupComplete</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;ERROR: transition searcher was not setup&quot;</span>
            <span class="k">return</span> <span class="n">ClientServerInterface</span><span class="o">.</span><span class="n">Result</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;FAILED&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;ERROR: must set initial state&quot;</span>
            <span class="k">return</span> <span class="n">ClientServerInterface</span><span class="o">.</span><span class="n">Result</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;FAILED&quot;</span><span class="p">)</span>
        
        <span class="c1"># initialise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="c1"># initial state</span>
        <span class="n">currentState</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="p">)</span>
        
        <span class="c1"># set job IDs</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">searcher</span><span class="p">,</span> <span class="s2">&quot;setJobID&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">searcher</span><span class="o">.</span><span class="n">setJobID</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">searchTimingDict</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># current defect volume</span>
        <span class="n">currentState</span><span class="o">.</span><span class="n">currentDefectVolume</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">currentVolumeIndex</span><span class="p">]</span>
        <span class="n">currentState</span><span class="o">.</span><span class="n">currentVolumeIndex</span> <span class="o">=</span> <span class="n">currentVolumeIndex</span>
            
        <span class="c1"># local references</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        
        <span class="c1"># initial</span>
        <span class="n">initial</span> <span class="o">=</span> <span class="n">currentState</span>
        
        <span class="n">prefactorMainIdx</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">prefactorIclIdx</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Creating lists for eigenvalue calculations</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">fixedPrefactor</span><span class="p">:</span>
            <span class="n">prefactorMainIdx</span> <span class="o">=</span> <span class="n">initial</span><span class="o">.</span><span class="n">buildSubLattice</span><span class="p">(</span><span class="n">initial</span><span class="o">.</span><span class="n">currentDefectVolume</span><span class="o">.</span><span class="n">searchInitialVol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prefactorRadius</span><span class="p">)</span>
            <span class="n">prefactorIclIdx</span> <span class="o">=</span> <span class="n">initial</span><span class="o">.</span><span class="n">buildSubLattice</span><span class="p">(</span><span class="n">prefactorMainIdx</span><span class="p">,</span> <span class="n">Globals</span><span class="o">.</span><span class="n">subLatticeIncludeRadius</span><span class="p">)</span>
        
        <span class="c1"># method lists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methodRunList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methodTimeList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methodSuccList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FEvalList</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">volumeAtoms</span> <span class="o">=</span> <span class="n">initial</span><span class="o">.</span><span class="n">currentDefectVolume</span><span class="o">.</span><span class="n">graphVol</span>
        <span class="n">volumeKey</span> <span class="o">=</span> <span class="n">initial</span><span class="o">.</span><span class="n">currentDefectVolume</span><span class="o">.</span><span class="n">graphKey</span>
        <span class="n">volumeIndex</span> <span class="o">=</span> <span class="n">initial</span><span class="o">.</span><span class="n">currentVolumeIndex</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;New search on volume: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">volumeIndex</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">barrDebugMode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">searchINFOString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">searchINFOString</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># run saddle search</span>
        <span class="n">saddle</span><span class="p">,</span> <span class="n">barrier</span><span class="p">,</span> <span class="n">searchFailReason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saddleSearch</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">fixSearchObj</span><span class="o">=</span><span class="n">fixSearchObj</span><span class="p">)</span>
        
        <span class="n">jobStatus</span> <span class="o">=</span> <span class="n">ClientServerInterface</span><span class="o">.</span><span class="n">checkJobStatus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">)</span>
        
        <span class="c1"># failure?</span>
        <span class="k">if</span> <span class="n">saddle</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">barrier</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">jobStatus</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">searchFailReason</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">searchFailReason</span> <span class="o">=</span> <span class="s2">&quot;Saddle search method failed (reason unspecified)&quot;</span>
            
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createFailResult</span><span class="p">(</span><span class="n">currentVolIndex</span><span class="o">=</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">failedReason</span><span class="o">=</span><span class="n">searchFailReason</span><span class="p">,</span> <span class="n">fixObject</span><span class="o">=</span><span class="n">fixSearchObj</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        
        <span class="n">searchBarrier</span> <span class="o">=</span> <span class="n">barrier</span>
        
        <span class="c1"># check saddle separated from initial</span>
        <span class="n">iniSadMMIndex</span><span class="p">,</span> <span class="n">maxMove</span><span class="p">,</span> <span class="n">avgMove</span><span class="p">,</span> <span class="n">separation</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">maxMovement</span><span class="p">(</span><span class="n">initial</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">saddle</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">initial</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
        
        <span class="n">failed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">maxMove</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">.</span><span class="n">barrMinMaxMoveToSaddle</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;FAILED: max move to saddle &lt; </span><span class="si">%f</span><span class="s2"> (</span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">barrMinMaxMoveToSaddle</span><span class="p">,</span> <span class="n">maxMove</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">failed</span> <span class="o">=</span> <span class="s2">&quot;Filter: Max move to saddle too small&quot;</span>
        
        <span class="k">elif</span> <span class="n">separation</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">.</span><span class="n">barrMinSepToSaddle</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;FAILED: separation to saddle &lt; </span><span class="si">%f</span><span class="s2"> (</span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">barrMinSepToSaddle</span><span class="p">,</span> <span class="n">separation</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">failed</span> <span class="o">=</span> <span class="s2">&quot;Filter: separation to saddle too small&quot;</span>
        
        <span class="k">if</span> <span class="n">failed</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createFailResult</span><span class="p">(</span><span class="n">currentVolIndex</span><span class="o">=</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">failedReason</span><span class="o">=</span><span class="n">failed</span><span class="p">,</span> <span class="n">fixObject</span><span class="o">=</span><span class="n">fixSearchObj</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        
        <span class="c1"># check saddle is unique</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">barrCompareSaddles</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitionsListsSet</span><span class="p">:</span>
                <span class="n">unique</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkTransitionUnique</span><span class="p">(</span><span class="n">saddle</span><span class="p">,</span> <span class="n">barrier</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">unique</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                
                <span class="k">elif</span> <span class="n">unique</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createDuplicateResult</span><span class="p">(</span><span class="n">currentVolIndex</span><span class="o">=</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">fixObject</span><span class="o">=</span><span class="n">fixSearchObj</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">result</span>
        
        <span class="c1"># step backwards test?</span>
        <span class="c1"># it is implemented directly in the dimer method</span>
        
        <span class="c1"># step forwards</span>
        <span class="n">final</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepForwards</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">saddle</span><span class="p">)</span>
        
        <span class="n">jobStatus</span> <span class="o">=</span> <span class="n">ClientServerInterface</span><span class="o">.</span><span class="n">checkJobStatus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">)</span>
        
        <span class="c1"># failure</span>
        <span class="k">if</span> <span class="n">final</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">jobStatus</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createFailResult</span><span class="p">(</span><span class="n">currentVolIndex</span><span class="o">=</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">failedReason</span><span class="o">=</span><span class="s2">&quot;Step forwards failed&quot;</span><span class="p">,</span> <span class="n">fixObject</span><span class="o">=</span><span class="n">fixSearchObj</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        
        <span class="n">sepIniFin</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">final</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">initial</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">initial</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
        <span class="n">sepSadFin</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">final</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">saddle</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">initial</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
        <span class="n">sepIniSad</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">initial</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">saddle</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">initial</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>

        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;DEBUGSEP: INIFIN </span><span class="si">%f</span><span class="s2">, INISAD </span><span class="si">%f</span><span class="s2">, SADFIN </span><span class="si">%F</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sepIniFin</span><span class="p">,</span> <span class="n">sepIniSad</span><span class="p">,</span> <span class="n">sepSadFin</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># check separated from initial</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">final</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">initial</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">initial</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
        <span class="c1">#TODO: probably should create new parameter for this</span>
        <span class="k">if</span> <span class="n">sep</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrUniqueMinSep</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;FAILED: ini - fin sep less than unique min sep (</span><span class="si">%f</span><span class="s2"> &lt; </span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrUniqueMinSep</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createFailResult</span><span class="p">(</span><span class="n">currentVolIndex</span><span class="o">=</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">failedReason</span><span class="o">=</span><span class="s2">&quot;Filter: initial to final separation too small&quot;</span><span class="p">,</span> <span class="n">fixObject</span><span class="o">=</span><span class="n">fixSearchObj</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        
        <span class="c1"># calculate reverse barrier</span>
        <span class="n">saddle</span><span class="o">.</span><span class="n">calcForce</span><span class="p">(</span><span class="n">correctTE</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># not sure if need these calcForces</span>
        <span class="n">final</span><span class="o">.</span><span class="n">calcForce</span><span class="p">(</span><span class="n">correctTE</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">reverseBarrier</span> <span class="o">=</span> <span class="n">saddle</span><span class="o">.</span><span class="n">totalEnergy</span> <span class="o">-</span> <span class="n">final</span><span class="o">.</span><span class="n">totalEnergy</span>
        <span class="k">if</span> <span class="n">reverseBarrier</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">barrier</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;INFO: reverse barrier less than 0.1*barrier: </span><span class="si">%f</span><span class="s2"> (</span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reverseBarrier</span><span class="p">,</span> <span class="n">barrier</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">reverseBarrier</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;INFO: VERY SMALL REVERSE BARRIER: </span><span class="si">%f</span><span class="s2"> (forward </span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reverseBarrier</span><span class="p">,</span> <span class="n">barrier</span><span class="p">)</span>
        
        <span class="c1"># testing</span>
        <span class="n">ediff</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">final</span><span class="o">.</span><span class="n">totalEnergy</span> <span class="o">-</span> <span class="n">saddle</span><span class="o">.</span><span class="n">totalEnergy</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;DEBUGSADFIN: </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ediff</span><span class="p">,</span> <span class="n">sepSadFin</span><span class="p">)</span>
        
        <span class="n">pushAgain</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">ediff</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="ow">and</span> <span class="n">sepSadFin</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;INFO: EDIFF AND SEP SMALL: PUSHING AGAIN (</span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ediff</span><span class="p">,</span> <span class="n">sepSadFin</span><span class="p">)</span>
            <span class="n">pushAgain</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">if</span> <span class="n">reverseBarrier</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">barrier</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;INFO: reverseBarrier small: PUSHING AGAIN (</span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reverseBarrier</span><span class="p">,</span> <span class="n">barrier</span><span class="p">)</span>
            <span class="n">pushAgain</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="c1"># try without this one!</span>
        <span class="n">MMSep</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">saddle</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">iniSadMMIndex</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">iniSadMMIndex</span><span class="o">+</span><span class="mi">3</span><span class="p">],</span> <span class="n">final</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">iniSadMMIndex</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">iniSadMMIndex</span><span class="o">+</span><span class="mi">3</span><span class="p">],</span> <span class="n">saddle</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;DEBUG: MMSEP </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MMSep</span>
<span class="c1">#         if MMSep &lt; 0.5:</span>
<span class="c1">#             print &quot;DEBUG: MAX MOVE NOT MOVED MUCH BETWEEN SADDLE AND FINAL (%f): PUSHING AGAIN&quot; % MMSep</span>
<span class="c1">#             pushAgain = True</span>
        
        <span class="k">if</span> <span class="n">pushAgain</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;DEBUGFINALTOOCLOSE: pushing again&quot;</span>
            <span class="n">final</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepForwards</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">final</span><span class="p">)</span>
            
            <span class="c1"># failure</span>
            <span class="k">if</span> <span class="n">final</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createFailResult</span><span class="p">(</span><span class="n">currentVolIndex</span><span class="o">=</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">failedReason</span><span class="o">=</span><span class="s2">&quot;Second push forwards failed&quot;</span><span class="p">,</span> <span class="n">fixObject</span><span class="o">=</span><span class="n">fixSearchObj</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span>
            
            <span class="c1"># calculate reverse barrier</span>
            <span class="n">final</span><span class="o">.</span><span class="n">calcForce</span><span class="p">(</span><span class="n">correctTE</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># might not need this</span>
            <span class="n">reverseBarrier</span> <span class="o">=</span> <span class="n">saddle</span><span class="o">.</span><span class="n">totalEnergy</span> <span class="o">-</span> <span class="n">final</span><span class="o">.</span><span class="n">totalEnergy</span>
            <span class="k">if</span> <span class="n">reverseBarrier</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">barrier</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;WARNING: reverse barrier STILL less than 0.1*barrier: </span><span class="si">%f</span><span class="s2"> (</span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reverseBarrier</span><span class="p">,</span> <span class="n">barrier</span><span class="p">)</span>
        
        <span class="n">sepIniFin</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">final</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">initial</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">initial</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
        <span class="n">sepSadFin</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">final</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">saddle</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">initial</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
        <span class="n">sepIniSad</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">initial</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">saddle</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">initial</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;DEBUGSEP2: INIFIN </span><span class="si">%f</span><span class="s2">, INISAD </span><span class="si">%f</span><span class="s2">, SADFIN </span><span class="si">%F</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sepIniFin</span><span class="p">,</span> <span class="n">sepIniSad</span><span class="p">,</span> <span class="n">sepSadFin</span><span class="p">)</span>
        
        <span class="n">MMSep</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">saddle</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">iniSadMMIndex</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">iniSadMMIndex</span><span class="o">+</span><span class="mi">3</span><span class="p">],</span> <span class="n">final</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">iniSadMMIndex</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">iniSadMMIndex</span><span class="o">+</span><span class="mi">3</span><span class="p">],</span> <span class="n">saddle</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">MMSep</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;DEBUG: WARNING MAX MOVE SEP BETWEEN INI-SADDLE STILL LOW: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MMSep</span>
<span class="c1">#            result = self.createFailResult(currentVolIndex=volumeIndex)</span>
<span class="c1">#            return result</span>
        
        <span class="c1"># check for duplicate</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">barrCompareSaddles</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitionsListsSet</span><span class="p">:</span>
                <span class="n">unique</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkTransitionUnique</span><span class="p">(</span><span class="n">final</span><span class="p">,</span> <span class="n">barrier</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">unique</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                
                <span class="k">elif</span> <span class="n">unique</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createDuplicateResult</span><span class="p">(</span><span class="n">currentVolIndex</span><span class="o">=</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">fixObject</span><span class="o">=</span><span class="n">fixSearchObj</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">result</span>
        
        <span class="c1"># check max move atom is from within primary volume?</span>
        <span class="n">maxMoveIndex</span><span class="p">,</span> <span class="n">maxMove</span><span class="p">,</span> <span class="n">avgMove</span><span class="p">,</span> <span class="n">separation</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">maxMovement</span><span class="p">(</span><span class="n">final</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">initial</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">initial</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
        <span class="n">storeTrans</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">volumeIndex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">storeTrans</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="k">if</span> <span class="n">storeTrans</span> <span class="ow">and</span> <span class="n">maxMoveIndex</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">initial</span><span class="o">.</span><span class="n">currentDefectVolume</span><span class="o">.</span><span class="n">graphVol</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;WARNING: MAX MOVE (</span><span class="si">%d</span><span class="s2">) NOT FROM GRAPH LIST: </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maxMoveIndex</span><span class="p">,</span> <span class="n">maxMove</span><span class="p">,</span> <span class="n">avgMove</span><span class="p">,</span> <span class="n">separation</span><span class="p">)</span>
            <span class="c1"># if max move is high prop of total move then don&#39;t store this transition?</span>
            <span class="n">storeTrans</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># if max move small throw away</span>
        <span class="k">if</span> <span class="n">maxMove</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">.</span><span class="n">barrMinMaxMove</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;WARNING: max move &lt; </span><span class="si">%f</span><span class="s2"> (</span><span class="si">%f</span><span class="s2">): throwing away&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">barrMinMaxMove</span><span class="p">,</span> <span class="n">maxMove</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createFailResult</span><span class="p">(</span><span class="n">currentVolIndex</span><span class="o">=</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">failedReason</span><span class="o">=</span><span class="s2">&quot;Filter: max move too small&quot;</span><span class="p">,</span> <span class="n">fixObject</span><span class="o">=</span><span class="n">fixSearchObj</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        
        <span class="n">NSmallMoves</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">smallMove</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">final</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">):</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">initial</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">],</span> <span class="n">final</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">],</span> <span class="n">initial</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sep</span> <span class="o">&gt;</span> <span class="n">smallMove</span><span class="p">:</span>
                <span class="n">NSmallMoves</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">NSmallMovesSad</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">final</span><span class="o">.</span><span class="n">NAtoms</span><span class="p">):</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">initial</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">],</span> <span class="n">saddle</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">],</span> <span class="n">initial</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sep</span> <span class="o">&gt;</span> <span class="n">smallMove</span><span class="p">:</span>
                <span class="n">NSmallMovesSad</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;search.output&quot;</span><span class="p">):</span>
            <span class="n">saddle</span><span class="o">.</span><span class="n">writeLattice</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;search.output&quot;</span><span class="p">,</span> <span class="s2">&quot;saddle.dat&quot;</span><span class="p">))</span>
            <span class="n">final</span><span class="o">.</span><span class="n">writeLattice</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;search.output&quot;</span><span class="p">,</span> <span class="s2">&quot;final.dat&quot;</span><span class="p">))</span>
        
        <span class="c1"># fix search index</span>
        <span class="k">if</span> <span class="n">fixSearchObj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fixIndex</span> <span class="o">=</span> <span class="n">fixSearchObj</span><span class="o">.</span><span class="n">index</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fixIndex</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># calculate defect volumes and hash keys on final state</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refState</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">final</span><span class="o">.</span><span class="n">findDefects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refState</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        
        <span class="c1"># return result if don&#39;t need calculator</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calculators</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createSuccessResult</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">saddle</span><span class="p">,</span> <span class="n">final</span><span class="p">,</span> <span class="n">barrier</span><span class="p">,</span> <span class="n">storeTrans</span><span class="p">,</span> <span class="n">searchBarrier</span><span class="o">=</span><span class="n">searchBarrier</span><span class="p">,</span> 
                                              <span class="n">currentVolIndex</span><span class="o">=</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">reverseBarrier</span><span class="o">=</span><span class="n">reverseBarrier</span><span class="p">,</span> 
                                              <span class="n">NSmallMoves</span><span class="o">=</span><span class="n">NSmallMoves</span><span class="p">,</span> <span class="n">fixIndex</span><span class="o">=</span><span class="n">fixIndex</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">result</span>
        
        <span class="c1"># calculate barrier</span>
        <span class="n">calcTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">barrier</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">saddle</span><span class="p">,</span> <span class="n">final</span><span class="p">,</span> <span class="n">finalMoved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculateBarrier</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">saddle</span><span class="p">,</span> <span class="n">final</span><span class="p">)</span>
        <span class="n">calcTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">calcTime</span>
        
        <span class="k">if</span> <span class="n">final</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createFailResult</span><span class="p">(</span><span class="n">currentVolIndex</span><span class="o">=</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">fixObject</span><span class="o">=</span><span class="n">fixSearchObj</span><span class="p">,</span> <span class="n">failedReason</span><span class="o">=</span><span class="s2">&quot;Barrier calculator failed (final is None)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        
        <span class="k">elif</span> <span class="n">barrier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createFailResult</span><span class="p">(</span><span class="n">currentVolIndex</span><span class="o">=</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">fixObject</span><span class="o">=</span><span class="n">fixSearchObj</span><span class="p">,</span> <span class="n">failedReason</span><span class="o">=</span><span class="s2">&quot;Barrier calculator failed (barrier is None)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        
        <span class="k">elif</span> <span class="n">saddle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createFailResult</span><span class="p">(</span><span class="n">currentVolIndex</span><span class="o">=</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">fixObject</span><span class="o">=</span><span class="n">fixSearchObj</span><span class="p">,</span> <span class="n">failedReason</span><span class="o">=</span><span class="s2">&quot;Barrier calculator failed (saddle is None)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">methodRunList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Barrier Calculator&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methodTimeList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calcTime</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methodSuccList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># if the final has moved we need to check for duplicate again</span>
        <span class="k">if</span> <span class="n">finalMoved</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">barrCompareSaddles</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitionsListsSet</span><span class="p">:</span>
                <span class="n">unique</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkTransitionUnique</span><span class="p">(</span><span class="n">final</span><span class="p">,</span> <span class="n">barrier</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">unique</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                
                <span class="k">elif</span> <span class="n">unique</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createDuplicateResult</span><span class="p">(</span><span class="n">currentVolIndex</span><span class="o">=</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">fixObject</span><span class="o">=</span><span class="n">fixSearchObj</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">result</span>
        
        <span class="c1"># barrier</span>
        <span class="n">calculatorBarrier</span> <span class="o">=</span> <span class="n">barrier</span>
        <span class="n">reverseBarrier</span> <span class="o">=</span> <span class="n">saddle</span><span class="o">.</span><span class="n">totalEnergy</span> <span class="o">-</span> <span class="n">final</span><span class="o">.</span><span class="n">totalEnergy</span>
        
        <span class="c1"># find defects on final state, if final has moved</span>
        <span class="k">if</span> <span class="n">finalMoved</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">refState</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">final</span><span class="o">.</span><span class="n">findDefects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refState</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        
        <span class="c1"># return success</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createSuccessResult</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">saddle</span><span class="p">,</span> <span class="n">final</span><span class="p">,</span> <span class="n">barrier</span><span class="p">,</span> <span class="n">storeTrans</span><span class="p">,</span> <span class="n">images</span><span class="o">=</span><span class="n">images</span><span class="p">,</span> <span class="n">searchBarrier</span><span class="o">=</span><span class="n">searchBarrier</span><span class="p">,</span>
                                          <span class="n">calculatorBarrier</span><span class="o">=</span><span class="n">calculatorBarrier</span><span class="p">,</span> <span class="n">currentVolIndex</span><span class="o">=</span><span class="n">volumeIndex</span><span class="p">,</span> 
                                          <span class="n">reverseBarrier</span><span class="o">=</span><span class="n">reverseBarrier</span><span class="p">,</span> <span class="n">fixIndex</span><span class="o">=</span><span class="n">fixIndex</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span></div>
            
<div class="viewcode-block" id="TransitionSearcher.checkCalcPrefactor"><a class="viewcode-back" href="../../LKMC/LKMC.Search.html#LKMC.Search.TransitionSearcher.checkCalcPrefactor">[docs]</a>    <span class="k">def</span> <span class="nf">checkCalcPrefactor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">barrier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if we need to calculate the prefactor for this transition.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratesListLock</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">checkTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="c1"># get lock on rates list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratesListLock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        
        <span class="n">ratio</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># get the current total rate</span>
            <span class="n">currentTotalRate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratesListProxy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">print</span> <span class="s2">&quot;DEBUGPREFACTOR: CURRENT TOTAL RATE = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">currentTotalRate</span>
            
            <span class="c1"># now estimate the rate of this process using standard prefactor</span>
            <span class="n">estimatedEventRate</span> <span class="o">=</span> <span class="n">Rates</span><span class="o">.</span><span class="n">calculateRate</span><span class="p">(</span><span class="n">barrier</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> 
                <span class="n">calcPrefactor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">jobID</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">)</span>
            
            <span class="nb">print</span> <span class="s2">&quot;DEBUGPREFACTOR: estimated event rate = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">estimatedEventRate</span>
            
            <span class="c1"># calculate ratio of estimated to total</span>
            <span class="k">if</span> <span class="n">currentTotalRate</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="n">estimatedEventRate</span> <span class="o">/</span> <span class="n">currentTotalRate</span>
            <span class="nb">print</span> <span class="s2">&quot;DEBUGPREFACTOR: ratio = </span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ratio</span>
        
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ratesListLock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        
        <span class="n">checkTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">checkTime</span>
        
        <span class="nb">print</span> <span class="s2">&quot;DEBUGPREFACTOR: time taken to check: </span><span class="si">%f</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="n">checkTime</span>
        
        <span class="k">return</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">checkTime</span></div>
    
<div class="viewcode-block" id="TransitionSearcher.saddleSearch"><a class="viewcode-back" href="../../LKMC/LKMC.Search.html#LKMC.Search.TransitionSearcher.saddleSearch">[docs]</a>    <span class="k">def</span> <span class="nf">saddleSearch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputState</span><span class="p">,</span> <span class="n">searchInfoString</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fixSearchObj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run searcher, eg. Dimer.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">parameters</span>
        
        <span class="c1"># running saddle point search</span>
        <span class="n">sadTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searcher</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">inputState</span><span class="p">,</span> <span class="n">fixSearchObj</span><span class="o">=</span><span class="n">fixSearchObj</span><span class="p">)</span>
        <span class="n">sadTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">sadTime</span>
        
        <span class="n">saddle</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">barrier</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sadDebugInfo</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">failReason</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">failReason</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">failReason</span><span class="p">):</span>
                <span class="n">failReason</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">failReason</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">searchTimingDict</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="nb">print</span> <span class="s2">&quot;DEBUGSTD: adding searchTimingDict&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;DEBUGSTD: not adding searchTimingDict&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">methodRunList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrSearchAlgorithm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methodTimeList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sadTime</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">saddle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">methodSuccList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">methodSuccList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrDebugMode</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sadDebugInfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">searchINFOString</span> <span class="o">+=</span> <span class="n">sadDebugInfo</span><span class="o">.</span><span class="n">getInfoString</span><span class="p">()</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">searchINFOString</span> <span class="o">+=</span> <span class="s2">&quot;BARRIER SEARCH = &quot;</span> <span class="o">+</span> <span class="n">parameters</span><span class="o">.</span><span class="n">barrSearchAlgorithm</span> <span class="o">+</span> <span class="s2">&quot;:</span><span class="se">\n</span><span class="s2">&quot;</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">searchINFOString</span> <span class="o">+=</span> <span class="s2">&quot;  Saddle found = &quot;</span>
                <span class="k">if</span> <span class="n">saddle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">searchINFOString</span> <span class="o">+=</span> <span class="s2">&quot;FALSE&quot;</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">searchINFOString</span> <span class="o">+=</span> <span class="s2">&quot;TRUE&quot;</span>
                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">searchINFOString</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Barrier height = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">barrier</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; eV&quot;</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">searchINFOString</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">searchINFOString</span> <span class="o">+=</span> <span class="s2">&quot;  Time elapsed = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sadTime</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; s.</span><span class="se">\n</span><span class="s2">&quot;</span>
                
                <span class="k">if</span> <span class="n">saddle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">searchINFOString</span> <span class="o">+=</span> <span class="s2">&quot;  Force evals used = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">saddle</span><span class="o">.</span><span class="n">saddleSearchFEvalCount</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">searchINFOString</span> <span class="o">+=</span> <span class="s2">&quot;  Steps used = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">saddle</span><span class="o">.</span><span class="n">saddleSearchStepCount</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="k">if</span> <span class="n">saddle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># check that we converged to rank 1 saddle</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">fixedPrefactor</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Checking we are at a rank 1 saddle&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">rankStatus</span><span class="p">,</span> <span class="n">saddle</span> <span class="o">=</span> <span class="n">MinModeFollower</span><span class="o">.</span><span class="n">checkSaddleRank</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">saddle</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">barrConvergeToRank1Saddle</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">rankStatus</span><span class="p">:</span>
                    <span class="n">saddle</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">barrier</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">failReason</span> <span class="o">=</span> <span class="s2">&quot;Saddle Rank &gt; 1&quot;</span>
            
            <span class="c1"># not sure why we need this but leaving it here for consistency with previous versions</span>
<span class="c1">#             saddle.currentDefectVolume = copy.deepcopy(inputState.currentDefectVolume)</span>
<span class="c1">#             saddle.defectSubSystemFull = copy.deepcopy(inputState.defectSubSystemFull)</span>
<span class="c1">#             saddle.defectSubSystem = copy.deepcopy(inputState.defectSubSystem)</span>
<span class="c1">#             saddle.defectSubSystemSmall = copy.deepcopy(inputState.defectSubSystemSmall)</span>
        
        <span class="k">return</span> <span class="n">saddle</span><span class="p">,</span> <span class="n">barrier</span><span class="p">,</span> <span class="n">failReason</span></div>
    
<div class="viewcode-block" id="TransitionSearcher.checkSaddleConnected"><a class="viewcode-back" href="../../LKMC/LKMC.Search.html#LKMC.Search.TransitionSearcher.checkSaddleConnected">[docs]</a>    <span class="k">def</span> <span class="nf">checkSaddleConnected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check saddle connected to initial.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
    
<div class="viewcode-block" id="TransitionSearcher.runMinimisers"><a class="viewcode-back" href="../../LKMC/LKMC.Search.html#LKMC.Search.TransitionSearcher.runMinimisers">[docs]</a>    <span class="k">def</span> <span class="nf">runMinimisers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">pushForwards</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the extended minimise call on obj.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Running minimisers to final state&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1">#seps = [Vectors.separation(self.initialState.pos, obj.pos, obj.cellDims),]</span>
        <span class="k">for</span> <span class="n">minimiser</span><span class="p">,</span> <span class="n">minName</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">izip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minimisers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimisersNames</span><span class="p">):</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Running minimiser &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">minimiser</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">minTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            
            <span class="n">mode666</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">mode777</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">minimiser</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">minimizationExclusion</span> <span class="o">==</span> <span class="mi">666</span><span class="p">:</span>
                <span class="c1"># mode666 means sub-lattice minimisation</span>
                <span class="n">mode666</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">minimiser</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">minimizationExclusion</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="n">minimiser</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">minimizationTolerance</span> <span class="o">=</span> <span class="mf">0.1</span>
                
                <span class="n">defectSubSystemBackup</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">defectSubSystem</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">buildSubLattice</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">saddleConvergeRadius</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">minimiser</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">minimizationExclusion</span> <span class="o">==</span> <span class="mi">777</span><span class="p">:</span>
                <span class="c1"># mode777 means minimise inverse of sub-lattice</span>
                <span class="n">mode777</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">minimiser</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">minimizationExclusion</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">minimiser</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">minimizationTolerance</span> <span class="o">=</span> <span class="mf">0.1</span>
                <span class="n">defectSubSystemBackup</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">defectSubSystemBackup</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">minimiser</span><span class="o">.</span><span class="n">setJobID</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">)</span>
            
            <span class="n">status</span> <span class="o">=</span> <span class="n">minimiser</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">mode666</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="n">defectSubSystemBackup</span>
                <span class="n">minimiser</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">minimizationExclusion</span> <span class="o">=</span> <span class="mi">666</span>
            
            <span class="k">elif</span> <span class="n">mode777</span><span class="p">:</span>
                <span class="n">minimiser</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">minimizationExclusion</span> <span class="o">=</span> <span class="mi">777</span>
            
            <span class="n">minTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">minTime</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;DEGUBMINTIME: Minimisation took </span><span class="si">%f</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="n">minTime</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            
            <span class="c1"># store in timing dict</span>
            <span class="k">if</span> <span class="n">pushForwards</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchTimingDict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;Min to final - &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">minName</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">searchTimingDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">minTime</span>
            
            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;DEBUGMINTOFINAL: FAILED&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">mode666</span><span class="p">,</span> <span class="n">mode777</span>
                <span class="k">break</span>
            <span class="c1">#seps.append(Vectors.separation(self.initialState.pos, obj.pos, obj.cellDims))</span>
        
        <span class="k">return</span> <span class="n">status</span></div>
    
<div class="viewcode-block" id="TransitionSearcher.stepForwards"><a class="viewcode-back" href="../../LKMC/LKMC.Search.html#LKMC.Search.TransitionSearcher.stepForwards">[docs]</a>    <span class="k">def</span> <span class="nf">stepForwards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">saddle</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Step forward and minimise to get the final.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        
        <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">barrMinFinal</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">barrEstimator</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># push forwards</span>
            <span class="n">final</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">pushSystem</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">saddle</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            
            <span class="c1"># copy volumes to final</span>
            <span class="n">final</span><span class="o">.</span><span class="n">currentDefectVolume</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initial</span><span class="o">.</span><span class="n">currentDefectVolume</span><span class="p">)</span>
            <span class="n">final</span><span class="o">.</span><span class="n">defectSubSystemFull</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initial</span><span class="o">.</span><span class="n">defectSubSystemFull</span><span class="p">)</span>
            <span class="n">final</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initial</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">)</span>
            <span class="n">final</span><span class="o">.</span><span class="n">defectSubSystemSmall</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initial</span><span class="o">.</span><span class="n">defectSubSystemSmall</span><span class="p">)</span>
            
            <span class="c1"># run minimisers</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runMinimisers</span><span class="p">(</span><span class="n">final</span><span class="p">,</span> <span class="n">pushForwards</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;DEBUG: MIN TO FINAL FAILED&quot;</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">final</span></div>
    
<div class="viewcode-block" id="TransitionSearcher.stepBackwards"><a class="viewcode-back" href="../../LKMC/LKMC.Search.html#LKMC.Search.TransitionSearcher.stepBackwards">[docs]</a>    <span class="k">def</span> <span class="nf">stepBackwards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">saddle</span><span class="p">,</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Step forward and minimise to get the final.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        
        <span class="n">final</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">pushSystem</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">saddle</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1">#         final.currentSearchInitialVolume = copy.deepcopy(initial.currentSearchInitialVolumeInitialVolume)</span>
        <span class="n">final</span><span class="o">.</span><span class="n">currentDefectVolume</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initial</span><span class="o">.</span><span class="n">currentDefectVolume</span><span class="p">)</span>
        <span class="n">final</span><span class="o">.</span><span class="n">defectSubSystemFull</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initial</span><span class="o">.</span><span class="n">defectSubSystemFull</span><span class="p">)</span>
        <span class="n">final</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initial</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">)</span>
        <span class="n">final</span><span class="o">.</span><span class="n">defectSubSystemSmall</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">initial</span><span class="o">.</span><span class="n">defectSubSystemSmall</span><span class="p">)</span>

        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runMinimisers</span><span class="p">(</span><span class="n">final</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">final</span></div>
        
<div class="viewcode-block" id="TransitionSearcher.calculateBarrier"><a class="viewcode-back" href="../../LKMC/LKMC.Search.html#LKMC.Search.TransitionSearcher.calculateBarrier">[docs]</a>    <span class="k">def</span> <span class="nf">calculateBarrier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">saddle</span><span class="p">,</span> <span class="n">final</span><span class="p">,</span> <span class="n">numProcessors</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the barrier.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;barrCalc.debug&quot;</span><span class="p">):</span>
            <span class="n">debugOutput</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">debugOutput</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># timings</span>
        <span class="n">totalTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        
        <span class="c1"># run the calculators</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">minimiser</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">finalMoved</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">barrCalculatorIndex</span><span class="p">,</span> <span class="n">barrCalculator</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calculators</span><span class="p">):</span>
            <span class="n">thisTotal</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            
            <span class="c1"># create the saddle converge volume (search move vol plus saddle converge)</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Length of subsystem: old </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">initial</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">initial</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="n">initial</span><span class="o">.</span><span class="n">currentDefectVolume</span><span class="o">.</span><span class="n">searchMoveVol</span>
            <span class="n">initial</span><span class="o">.</span><span class="n">defectSubSystem</span> <span class="o">=</span> <span class="n">initial</span><span class="o">.</span><span class="n">buildSubLattice</span><span class="p">(</span><span class="n">initial</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">saddleConvergeRadius</span><span class="p">)</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;New length of subsystem for NEB: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">initial</span><span class="o">.</span><span class="n">defectSubSystem</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
            
<span class="c1">#             status = barrCalculator.run(initial, final, saddleState=saddle, maxBarrier=self.params.dimerMaxBarrier)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">barrCalculator</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">final</span><span class="p">,</span> <span class="n">NProcs</span><span class="o">=</span><span class="n">numProcessors</span><span class="p">)</span>
            <span class="n">CalcNForceCalls</span> <span class="o">=</span> <span class="n">barrCalculator</span><span class="o">.</span><span class="n">NForceCalls</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span><span class="s2">&quot;Total Calculator Force Calls: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">CalcNForceCalls</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">ClientServerInterface</span><span class="o">.</span><span class="n">checkJobStatus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">debugOutput</span><span class="p">:</span>
                    <span class="n">_cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;barrCalc.debug&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
                        <span class="n">barrCalculator</span><span class="o">.</span><span class="n">plotBarrierSeparation</span><span class="p">(</span><span class="s2">&quot;pathway&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Band&quot;</span><span class="p">)</span>
                        <span class="n">barrCalculator</span><span class="o">.</span><span class="n">visualisePathwayLattice</span><span class="p">()</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">_cwd</span><span class="p">)</span>
                
                <span class="c1"># refine pathway</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrRefinePathway</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Checking if we need to refine Barrier Calculator pathway&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    
                    <span class="c1"># analyse pathway</span>
                    <span class="n">transOK</span><span class="p">,</span> <span class="n">newFinalIndex</span> <span class="o">=</span> <span class="n">barrCalculator</span><span class="o">.</span><span class="n">analysePathway</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrRefinePathwayTol</span><span class="p">)</span>
                    
                    <span class="c1"># loop</span>
                    <span class="n">newFinal</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="p">(</span><span class="ow">not</span> <span class="n">transOK</span><span class="p">)</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrRefinePathwayMaxIter</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Pathway check failed; re-running Barrier Calculator using image </span><span class="si">%d</span><span class="s2"> as new final&quot;</span> <span class="o">%</span> <span class="n">newFinalIndex</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        
                        <span class="c1"># new final</span>
                        <span class="n">newFinal</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">barrCalculator</span><span class="o">.</span><span class="n">returnImageAsLattice</span><span class="p">(</span><span class="n">newFinalIndex</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">newFinal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Error: new final is None: index = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">newFinalIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchTimingDict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">totalTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">totalTime</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">searchTimingDict</span><span class="p">[</span><span class="s2">&quot;Calculator total time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">totalTime</span>
                                <span class="n">thisTotal</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">thisTotal</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">searchTimingDict</span><span class="p">[</span><span class="s2">&quot;Calculator </span><span class="si">%d</span><span class="s2"> time&quot;</span> <span class="o">%</span> <span class="n">barrCalculatorIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">thisTotal</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">searchTimingDict</span><span class="p">[</span><span class="s2">&quot;Calculator </span><span class="si">%d</span><span class="s2"> attempts&quot;</span> <span class="o">%</span> <span class="n">barrCalculatorIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                        
                        <span class="c1"># minimiser</span>
                        <span class="k">if</span> <span class="n">minimiser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">minimiser</span> <span class="o">=</span> <span class="n">Minimise</span><span class="o">.</span><span class="n">getMinimiser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">)</span>
                        
                        <span class="c1"># minimise final</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="n">minimiser</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">newFinal</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">ClientServerInterface</span><span class="o">.</span><span class="n">checkJobStatus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">):</span>
                            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Minimising new final state failed!&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="k">break</span>
                        
                        <span class="c1"># check that the new final is separated from the initial</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">maxMove</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">maxMovement</span><span class="p">(</span><span class="n">newFinal</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">initial</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">initial</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">sep</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrUniqueMinSep</span> <span class="ow">or</span> <span class="n">maxMove</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrMinMaxMove</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">sep</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrUniqueMinSep</span><span class="p">:</span>
                                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Separation between new final and initial is too small; reverting to previous intiial&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">maxMove</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrMinMaxMove</span><span class="p">:</span>
                                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Max move between new final and initial is too small; reverting to previous intiial&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            
                            <span class="n">newFinal</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">transOK</span> <span class="o">=</span> <span class="kc">True</span>
                            
                            <span class="k">break</span>
                        
                        <span class="c1"># run calculator again</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="n">barrCalculator</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">newFinal</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                            <span class="k">break</span>
                        
                        <span class="k">if</span> <span class="n">debugOutput</span><span class="p">:</span>
                            <span class="n">_cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;barrCalc.debug&quot;</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,))</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,))</span>
                                <span class="n">barrCalculator</span><span class="o">.</span><span class="n">plotBarrierSeparation</span><span class="p">(</span><span class="s2">&quot;pathway&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Band&quot;</span><span class="p">)</span>
                                <span class="n">barrCalculator</span><span class="o">.</span><span class="n">visualisePathwayLattice</span><span class="p">()</span>
                            <span class="k">finally</span><span class="p">:</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">_cwd</span><span class="p">)</span>
                        
                        <span class="c1"># analyse pathway</span>
                        <span class="n">transOK</span><span class="p">,</span> <span class="n">newFinalIndex</span> <span class="o">=</span> <span class="n">barrCalculator</span><span class="o">.</span><span class="n">analysePathway</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrRefinePathwayTol</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="n">ClientServerInterface</span><span class="o">.</span><span class="n">checkJobStatus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">):</span>
                            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                        
                        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">transOK</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Could not refine Barrier Calculator pathway&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchTimingDict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">thisTotal</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">thisTotal</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">searchTimingDict</span><span class="p">[</span><span class="s2">&quot;Calculator </span><span class="si">%d</span><span class="s2"> time&quot;</span> <span class="o">%</span> <span class="n">barrCalculatorIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">thisTotal</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrRefinePathway</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">searchTimingDict</span><span class="p">[</span><span class="s2">&quot;Calculator </span><span class="si">%d</span><span class="s2"> attempts&quot;</span> <span class="o">%</span> <span class="n">barrCalculatorIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="k">continue</span>
                    
                    <span class="k">if</span> <span class="n">newFinal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Replacing final state with new version from barrier calculator pathway refinement&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">final</span> <span class="o">=</span> <span class="n">newFinal</span>
                        <span class="n">finalMoved</span> <span class="o">=</span> <span class="kc">True</span>
                
                <span class="c1"># only gets this far if it was successful</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">newSaddle</span> <span class="o">=</span> <span class="n">barrCalculator</span><span class="o">.</span><span class="n">getMaxEnergyImage</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="n">newSaddle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">maxMoveIndex</span><span class="p">,</span> <span class="n">maxMove</span><span class="p">,</span> <span class="n">avgMove</span><span class="p">,</span> <span class="n">separation</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">maxMovement</span><span class="p">(</span><span class="n">newSaddle</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">saddle</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">saddle</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
                    <span class="nb">print</span> <span class="s2">&quot;NEB SAD COMP&quot;</span><span class="p">,</span> <span class="n">maxMoveIndex</span><span class="p">,</span> <span class="n">maxMove</span><span class="p">,</span> <span class="n">avgMove</span><span class="p">,</span> <span class="n">separation</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchTimingDict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">thisTotal</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">thisTotal</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">searchTimingDict</span><span class="p">[</span><span class="s2">&quot;Calculator </span><span class="si">%d</span><span class="s2"> time&quot;</span> <span class="o">%</span> <span class="n">barrCalculatorIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">thisTotal</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrRefinePathway</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">searchTimingDict</span><span class="p">[</span><span class="s2">&quot;Calculator </span><span class="si">%d</span><span class="s2"> attempts&quot;</span> <span class="o">%</span> <span class="n">barrCalculatorIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
                
                <span class="k">break</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchTimingDict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">thisTotal</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">thisTotal</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">searchTimingDict</span><span class="p">[</span><span class="s2">&quot;Calculator </span><span class="si">%d</span><span class="s2"> time&quot;</span> <span class="o">%</span> <span class="n">barrCalculatorIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">thisTotal</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">barrRefinePathway</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">searchTimingDict</span><span class="p">[</span><span class="s2">&quot;Calculator </span><span class="si">%d</span><span class="s2"> attempts&quot;</span> <span class="o">%</span> <span class="n">barrCalculatorIndex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchTimingDict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">totalTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">totalTime</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">searchTimingDict</span><span class="p">[</span><span class="s2">&quot;Calculator total time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">totalTime</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">searchTimingDict</span><span class="p">[</span><span class="s2">&quot;Calculator Force Calcs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CalcNForceCalls</span>
        
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">barrier</span> <span class="o">=</span> <span class="n">barrCalculator</span><span class="o">.</span><span class="n">barrier</span>
            <span class="k">return</span> <span class="n">barrier</span><span class="p">,</span> <span class="n">barrCalculator</span><span class="p">,</span> <span class="n">newSaddle</span><span class="p">,</span> <span class="n">final</span><span class="p">,</span> <span class="n">finalMoved</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">final</span><span class="p">,</span> <span class="n">finalMoved</span></div>
    
<div class="viewcode-block" id="TransitionSearcher.createFailResult"><a class="viewcode-back" href="../../LKMC/LKMC.Search.html#LKMC.Search.TransitionSearcher.createFailResult">[docs]</a>    <span class="k">def</span> <span class="nf">createFailResult</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currentVolIndex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">failedReason</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fixObject</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create fail result.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">barrElapsedTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">methodRunList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;BARRIERSEARCH&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methodTimeList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">barrElapsedTime</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methodSuccList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">timeLog</span> <span class="o">=</span> <span class="n">ClientServerInterface</span><span class="o">.</span><span class="n">TimeLog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">methodRunList</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">methodTimeList</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">methodSuccList</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">fixObject</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fixIndex</span> <span class="o">=</span> <span class="n">fixObject</span><span class="o">.</span><span class="n">index</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fixIndex</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">ClientServerInterface</span><span class="o">.</span><span class="n">Result</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;BARRIERSEARCH&quot;</span><span class="p">,</span> <span class="s2">&quot;FAILED&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="n">timing</span><span class="o">=</span><span class="n">timeLog</span><span class="p">,</span> <span class="n">infoString</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">searchINFOString</span><span class="p">,</span>
                                              <span class="n">currentVolIndex</span><span class="o">=</span><span class="n">currentVolIndex</span><span class="p">,</span> <span class="n">jobID</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">,</span> <span class="n">failedReason</span><span class="o">=</span><span class="n">failedReason</span><span class="p">,</span> <span class="n">fixIndex</span><span class="o">=</span><span class="n">fixIndex</span><span class="p">,</span>
                                              <span class="n">searchTimingDict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">searchTimingDict</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span></div>
    
<div class="viewcode-block" id="TransitionSearcher.createDuplicateResult"><a class="viewcode-back" href="../../LKMC/LKMC.Search.html#LKMC.Search.TransitionSearcher.createDuplicateResult">[docs]</a>    <span class="k">def</span> <span class="nf">createDuplicateResult</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currentVolIndex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fixObject</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create duplicate result notification.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">barrElapsedTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">methodRunList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;BARRIERSEARCH&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methodTimeList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">barrElapsedTime</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methodSuccList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">timeLog</span> <span class="o">=</span> <span class="n">ClientServerInterface</span><span class="o">.</span><span class="n">TimeLog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">methodRunList</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">methodTimeList</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">methodSuccList</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">fixObject</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fixIndex</span> <span class="o">=</span> <span class="n">fixObject</span><span class="o">.</span><span class="n">index</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fixIndex</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">ClientServerInterface</span><span class="o">.</span><span class="n">Result</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;BARRIERSEARCH&quot;</span><span class="p">,</span> <span class="s2">&quot;DUPLICATE&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="n">timing</span><span class="o">=</span><span class="n">timeLog</span><span class="p">,</span> <span class="n">infoString</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">searchINFOString</span><span class="p">,</span>
                                              <span class="n">currentVolIndex</span><span class="o">=</span><span class="n">currentVolIndex</span><span class="p">,</span> <span class="n">jobID</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">,</span> <span class="n">fixIndex</span><span class="o">=</span><span class="n">fixIndex</span><span class="p">,</span> 
                                              <span class="n">searchTimingDict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">searchTimingDict</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span></div>
    
<div class="viewcode-block" id="TransitionSearcher.checkVolForCombinedTransition"><a class="viewcode-back" href="../../LKMC/LKMC.Search.html#LKMC.Search.TransitionSearcher.checkVolForCombinedTransition">[docs]</a>    <span class="k">def</span> <span class="nf">checkVolForCombinedTransition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saddle</span><span class="p">,</span> <span class="n">final</span><span class="p">,</span> <span class="n">checkCombinedVolume</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a transition from a combined volume belongs to a lone individual volume</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Checking if combined vol transition belongs to lone volume&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># get list of atoms that have moved (some threshold?)</span>
        <span class="c1"># work out where they come from</span>
        
        <span class="c1"># parameters</span>
        <span class="n">movedThreshold</span> <span class="o">=</span> <span class="mf">0.1</span>
        
        <span class="c1"># find max move</span>
        <span class="n">maxMoveIndex</span><span class="p">,</span> <span class="n">maxMove</span><span class="p">,</span> <span class="n">avgMove</span><span class="p">,</span> <span class="n">separation</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">maxMovement</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">final</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">final</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Max move index: </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maxMoveIndex</span><span class="p">,</span> <span class="n">maxMove</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># loop over all non-combined-volumes</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">checkCombinedVolume</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">volIndex</span><span class="p">,</span> <span class="n">dv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dv</span><span class="o">.</span><span class="n">combinedVol</span> <span class="ow">and</span> <span class="n">maxMoveIndex</span> <span class="ow">in</span> <span class="n">dv</span><span class="o">.</span><span class="n">searchInitialVol</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Max move belongs to vol </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">volIndex</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">volMM</span> <span class="o">=</span> <span class="n">volIndex</span>
                    <span class="n">match</span> <span class="o">+=</span><span class="mi">1</span> 
            
            <span class="c1"># if match move does not belong to a primary vol we stop here and leave trans in combined vol</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Max move atom not in any primary volume; transition belongs to combined vol&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span>
            
            <span class="k">if</span> <span class="n">match</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Max move atom belongs to multiple primary volumes (</span><span class="si">%d</span><span class="s2">); transition belongs to combined vol&quot;</span> <span class="o">%</span> <span class="n">match</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="c1"># loop over all combined-volumes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">volIndex</span><span class="p">,</span> <span class="n">dv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">dv</span><span class="o">.</span><span class="n">combinedVol</span> <span class="ow">and</span> <span class="n">maxMoveIndex</span> <span class="ow">in</span> <span class="n">dv</span><span class="o">.</span><span class="n">searchInitialVol</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Max move belongs to Combined vol </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">volIndex</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">volMM</span> <span class="o">=</span> <span class="n">volIndex</span>
                    <span class="n">match</span> <span class="o">+=</span><span class="mi">1</span> 
            
            <span class="c1"># if match move does not belong to a primary vol, Something wrong, it should belongs to a combined vol (</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;ERROR: Max move atom not in any CV&#39;s primary volume&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">999</span>
            
            <span class="k">if</span> <span class="n">match</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;ERROR: Max move atom belongs to multiple CV&#39;s primary volumes (</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">match</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">999</span>
        
        <span class="c1"># find atoms that have moved at least a small amount</span>
        <span class="n">thresh</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">maxMove</span>
        <span class="k">if</span> <span class="n">thresh</span> <span class="o">&lt;</span> <span class="n">movedThreshold</span><span class="p">:</span>
            <span class="n">thresh</span> <span class="o">=</span> <span class="n">movedThreshold</span>
        <span class="n">movedIndexes</span> <span class="o">=</span> <span class="n">final</span><span class="o">.</span><span class="n">findMovedAtoms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">thresh</span><span class="p">)</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> atoms moved more than </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">movedIndexes</span><span class="p">),</span> <span class="n">thresh</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># find atoms that have moved at least half as far as max move</span>
        <span class="n">threshMM</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">maxMove</span>
        <span class="n">movedIndexesMM</span> <span class="o">=</span> <span class="n">final</span><span class="o">.</span><span class="n">findMovedAtoms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshMM</span><span class="p">)</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> atoms moved more than </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">movedIndexesMM</span><span class="p">),</span> <span class="n">threshMM</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># check that all (or most?) moved atoms come from same vol as maxMove</span>
        <span class="c1"># allow some to come from outside as long as they don&#39;t belong to primary of another vol!</span>
        <span class="n">primVolMM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volMM</span><span class="p">]</span><span class="o">.</span><span class="n">searchInitialVol</span>
        
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Checking if big move atoms are in same primary vol as max move&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">failCountMM</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">movedIndexesMM</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">primVolMM</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Big moved atom not in same primary volume as max move (</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">index</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">failCountMM</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> atoms that moved a lot are in same primary vol as max move&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">movedIndexesMM</span><span class="p">)</span> <span class="o">-</span> <span class="n">failCountMM</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">movedIndexesMM</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># decide what to do...</span>
        <span class="k">if</span> <span class="n">failCountMM</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">checkCombinedVolume</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Some atoms that moved a lot are not in same primary vol; transition belongs to combined vol&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">elif</span> <span class="n">failCountMM</span> <span class="ow">and</span> <span class="n">checkCombinedVolume</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Some atoms that moved a lot are not in same CV&#39;s primary vol; Something wrong&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">999</span>
<span class="c1">#         log(__name__, &quot;Checking if all move atoms are in same primary vol as max move&quot;, 2, 1)</span>
<span class="c1">#         failCount = 0</span>
<span class="c1">#         for index in movedIndexes:</span>
<span class="c1">#             if index not in primVolMM:</span>
<span class="c1">#                 log(__name__, &quot;Moved atom not in same primary volume as max move (%d)&quot; % index, 2, 2)</span>
<span class="c1">#                 failCount += 1</span>
<span class="c1">#         </span>
<span class="c1">#         log(__name__, &quot;%d/%d atoms that moved are in same primary vol as max move&quot; % (len(movedIndexes) - failCount, len(movedIndexes)), 2, 1)</span>
        
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Checking if all move atoms are in same graph vol as max move&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="n">graphVolMM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volMM</span><span class="p">]</span><span class="o">.</span><span class="n">graphVol</span>
        <span class="n">failCountG</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">movedIndexes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graphVolMM</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Moved atom not in same graph volume as max move (</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">index</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">failCountG</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> atoms that moved are in same graph vol as max move&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">movedIndexes</span><span class="p">)</span> <span class="o">-</span> <span class="n">failCountG</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">movedIndexes</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># decide what to do...</span>
        <span class="k">if</span> <span class="n">failCountG</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">checkCombinedVolume</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Some atoms that moved are not in same graph vol; transition belongs to combined vol&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">failCountG</span> <span class="ow">and</span> <span class="n">checkCombinedVolume</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Some atoms that moved are not in same CV&#39;s graph vol; something wrong&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">999</span>
        
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Making sure all move atoms do not belong to another primary vol&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># make sure moved atoms not in other primary vol</span>
        <span class="n">failCount</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">checkCombinedVolume</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">movedIndexes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">primVolMM</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">volIndex</span><span class="p">,</span> <span class="n">dv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">volIndex</span> <span class="o">==</span> <span class="n">volMM</span> <span class="ow">or</span> <span class="n">dv</span><span class="o">.</span><span class="n">combinedVol</span><span class="p">:</span>
                            <span class="k">continue</span>
                        
                        <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">dv</span><span class="o">.</span><span class="n">searchInitialVol</span><span class="p">:</span>
                            <span class="n">failCount</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Moved atom belongs to another primary vol (</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">volIndex</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="k">break</span>
            
            <span class="k">if</span> <span class="n">failCount</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Some moved atoms belong to other primary vols (</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">); transition belongs to combined vol&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">failCount</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">movedIndexes</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">movedIndexes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">primVolMM</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">volIndex</span><span class="p">,</span> <span class="n">dv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">volIndex</span> <span class="o">==</span> <span class="n">volMM</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">dv</span><span class="o">.</span><span class="n">combinedVol</span><span class="p">):</span>
                            <span class="k">continue</span>
                        
                        <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">dv</span><span class="o">.</span><span class="n">searchInitialVol</span><span class="p">:</span>
                            <span class="n">failCount</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Moved atom belongs to another primary vol (</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">volIndex</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="k">break</span>
            
            <span class="k">if</span> <span class="n">failCount</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Some moved atoms belong to other CV&#39;s primary vols (</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">); something wrong here&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">failCount</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">movedIndexes</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">999</span>
        
        <span class="c1"># transition should be part of individual vol</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Transition belong to individual volume (index </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">volMM</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">volMM</span></div>
    
<div class="viewcode-block" id="TransitionSearcher.calcPreFactor"><a class="viewcode-back" href="../../LKMC/LKMC.Search.html#LKMC.Search.TransitionSearcher.calcPreFactor">[docs]</a>    <span class="k">def</span> <span class="nf">calcPreFactor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saddle</span><span class="p">,</span> <span class="n">prefactorMainIdx</span><span class="p">,</span> <span class="n">prefactorIclIdx</span><span class="p">,</span> <span class="n">jobID</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prefactor calculation</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">status</span><span class="p">,</span> <span class="n">saddleEigenValues</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Algebra</span><span class="o">.</span><span class="n">getSystemsImplicitEigenvalues</span><span class="p">(</span><span class="n">saddle</span><span class="p">,</span> <span class="n">prefactorMainIdx</span><span class="p">,</span> <span class="n">prefactorIclIdx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">noEigenVects</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">includeMasses</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">jobID</span><span class="o">=</span><span class="n">jobID</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">Prefactor</span><span class="o">.</span><span class="n">countNegativeValues</span><span class="p">(</span><span class="n">saddleEigenValues</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="kc">None</span>
        
        <span class="n">saddleSumLogEVs</span> <span class="o">=</span> <span class="n">Prefactor</span><span class="o">.</span><span class="n">eigenvalues2Frequencies</span><span class="p">(</span><span class="n">saddleEigenValues</span><span class="p">,</span> <span class="n">ignoreFirst</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">saddleSumLogEVs</span></div>
        
    
<div class="viewcode-block" id="TransitionSearcher.createSuccessResult"><a class="viewcode-back" href="../../LKMC/LKMC.Search.html#LKMC.Search.TransitionSearcher.createSuccessResult">[docs]</a>    <span class="k">def</span> <span class="nf">createSuccessResult</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">saddle</span><span class="p">,</span> <span class="n">final</span><span class="p">,</span> <span class="n">barrier</span><span class="p">,</span> <span class="n">storeTrans</span><span class="p">,</span> <span class="n">images</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sadSearchDebugInfo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">volumeObject</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                            <span class="n">searchBarrier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">calculatorBarrier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">currentVolIndex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">reverseBarrier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">NSmallMoves</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">calcPrefactor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">saddleSumLogEVs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fixIndex</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create success result.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># first run any hooks</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;initial&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="p">,</span> <span class="s2">&quot;saddle&quot;</span><span class="p">:</span> <span class="n">saddle</span><span class="p">,</span> <span class="s2">&quot;final&quot;</span><span class="p">:</span> <span class="n">final</span><span class="p">,</span> <span class="s2">&quot;barrier&quot;</span><span class="p">:</span> <span class="n">barrier</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">postTransitionHookList</span><span class="p">:</span>
            <span class="n">hookres</span> <span class="o">=</span> <span class="n">hook</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">hookres</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;DEBUGGING: throwing away transition (hook </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">hook</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">createFailResult</span><span class="p">(</span><span class="n">currentVolIndex</span><span class="o">=</span><span class="n">currentVolIndex</span><span class="p">)</span>
        
        <span class="c1"># only if we are storing individual volumes that are part of a combined vol...</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">combinedVolStoreIndividual</span><span class="p">:</span>
            <span class="c1"># if combinedVol we check if it belongs to an individual volume</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">currentVolIndex</span><span class="p">]</span><span class="o">.</span><span class="n">combinedVol</span><span class="p">:</span>
                <span class="n">storeVolIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkVolForCombinedTransition</span><span class="p">(</span><span class="n">saddle</span><span class="p">,</span> <span class="n">final</span><span class="p">)</span>
            
            <span class="c1"># if max move not belongs to current vol, either belongs to another individual volume</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">storeTrans</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">currentVolIndex</span><span class="p">]</span><span class="o">.</span><span class="n">combinedVol</span><span class="p">:</span>
                <span class="n">storeVolIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkVolForCombinedTransition</span><span class="p">(</span><span class="n">saddle</span><span class="p">,</span> <span class="n">final</span><span class="p">)</span>
                <span class="c1"># or belongs to combined volume</span>
                <span class="k">if</span> <span class="n">storeVolIndex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">storeVolIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkVolForCombinedTransition</span><span class="p">(</span><span class="n">saddle</span><span class="p">,</span> <span class="n">final</span><span class="p">,</span> <span class="n">checkCombinedVolume</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">storeVolIndex</span> <span class="o">=</span> <span class="kc">None</span>
                
        <span class="c1"># if we are NOT storing individual volumes that are part of a combined vol.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># for the case current trans from combinedVol, no need to check if it belongs to an individual volume</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">currentVolIndex</span><span class="p">]</span><span class="o">.</span><span class="n">combinedVol</span><span class="p">:</span>
                <span class="n">storeVolIndex</span> <span class="o">=</span> <span class="kc">None</span>
                
            <span class="c1"># trans from part of combinedVol</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">storeTrans</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">currentVolIndex</span><span class="p">]</span><span class="o">.</span><span class="n">combinedVol</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">currentVolIndex</span><span class="p">]</span><span class="o">.</span><span class="n">partOfCombinedVol</span><span class="p">:</span>
                <span class="c1"># if NOT storing combined volume, no need to check</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">reuseCombinedVolumes</span><span class="p">:</span>
                    <span class="n">storeVolIndex</span> <span class="o">=</span> <span class="kc">None</span>
                
                <span class="c1"># check if it belongs to a combined volume</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">storeVolIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkVolForCombinedTransition</span><span class="p">(</span><span class="n">saddle</span><span class="p">,</span> <span class="n">final</span><span class="p">,</span> <span class="n">checkCombinedVolume</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    
            <span class="k">else</span><span class="p">:</span>
                <span class="n">storeVolIndex</span> <span class="o">=</span> <span class="kc">None</span>
                
        
        <span class="k">if</span> <span class="n">storeVolIndex</span> <span class="o">==</span> <span class="mi">999</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Throwing away transition&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">createFailResult</span><span class="p">(</span><span class="n">currentVolIndex</span><span class="o">=</span><span class="n">currentVolIndex</span><span class="p">)</span>
            
        <span class="c1"># calculate prefactor </span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fixedPrefactor</span><span class="p">:</span>
            <span class="c1"># calc-pre-facotr if vol changes OR not calculated yet.</span>
            <span class="k">if</span> <span class="n">storeVolIndex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">volIndex</span> <span class="o">=</span> <span class="n">storeVolIndex</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">volIndex</span> <span class="o">=</span> <span class="n">currentVolIndex</span>
                
            <span class="n">currentState</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="p">)</span>
            <span class="c1"># current defect volume</span>
            <span class="n">currentState</span><span class="o">.</span><span class="n">currentDefectVolume</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volIndex</span><span class="p">]</span>
            <span class="n">currentState</span><span class="o">.</span><span class="n">currentVolumeIndex</span> <span class="o">=</span> <span class="n">volIndex</span>
            
            <span class="n">prefactorMainIdx</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">prefactorIclIdx</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="c1"># Creating lists for eigenvalue calculations</span>
            <span class="n">prefactorMainIdx</span> <span class="o">=</span> <span class="n">initial</span><span class="o">.</span><span class="n">buildSubLattice</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">currentDefectVolume</span><span class="o">.</span><span class="n">searchInitialVol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">prefactorRadius</span><span class="p">)</span>
            <span class="n">prefactorIclIdx</span> <span class="o">=</span> <span class="n">initial</span><span class="o">.</span><span class="n">buildSubLattice</span><span class="p">(</span><span class="n">prefactorMainIdx</span><span class="p">,</span> <span class="n">Globals</span><span class="o">.</span><span class="n">subLatticeIncludeRadius</span><span class="p">)</span>
            
            <span class="c1"># calculate eigenvalues for the prefactor</span>
            <span class="n">status</span><span class="p">,</span> <span class="n">saddleSumLogEVs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcPreFactor</span><span class="p">(</span><span class="n">saddle</span><span class="p">,</span> <span class="n">prefactorMainIdx</span><span class="p">,</span> <span class="n">prefactorIclIdx</span><span class="p">,</span> <span class="n">jobID</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createFailResult</span><span class="p">(</span><span class="n">currentVolIndex</span><span class="o">=</span><span class="n">currentVolIndex</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span>
                
        
        <span class="c1"># make transition object</span>
        <span class="n">transitionObject</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">storeTrans</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">storeTransForReuse</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">storeVolIndex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">volumeAtoms</span> <span class="o">=</span> <span class="n">initial</span><span class="o">.</span><span class="n">currentDefectVolume</span><span class="o">.</span><span class="n">graphVol</span>
                <span class="n">volumeKey</span> <span class="o">=</span> <span class="n">initial</span><span class="o">.</span><span class="n">currentDefectVolume</span><span class="o">.</span><span class="n">graphKey</span>
<span class="c1">#                 volumeIndex = initial.currentVolumeIndex</span>
                
                <span class="n">transitionObject</span> <span class="o">=</span> <span class="n">Defects</span><span class="o">.</span><span class="n">TransitionObject</span><span class="p">(</span><span class="n">saddle</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">final</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">barrier</span><span class="p">,</span> <span class="n">hashKey</span><span class="o">=</span><span class="n">volumeKey</span><span class="p">,</span> <span class="n">volumeAtoms</span><span class="o">=</span><span class="n">volumeAtoms</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">volumeAtoms</span> <span class="o">=</span> <span class="n">initial</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">storeVolIndex</span><span class="p">]</span><span class="o">.</span><span class="n">graphVol</span>
                <span class="n">volumeKey</span> <span class="o">=</span> <span class="n">initial</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">storeVolIndex</span><span class="p">]</span><span class="o">.</span><span class="n">graphKey</span>
                
                <span class="c1"># full object required for merging...</span>
                <span class="n">transitionObject</span> <span class="o">=</span> <span class="n">Defects</span><span class="o">.</span><span class="n">TransitionObjectFull</span><span class="p">(</span><span class="n">final</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">final</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> <span class="n">final</span><span class="o">.</span><span class="n">specieList</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> 
                                                                <span class="n">saddle</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">final</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">barrier</span><span class="p">,</span> <span class="n">hashKey</span><span class="o">=</span><span class="n">volumeKey</span><span class="p">,</span> <span class="n">volumeAtoms</span><span class="o">=</span><span class="n">volumeAtoms</span><span class="p">)</span>
        
        <span class="c1"># if max move not belongs to current vol</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">storeTrans</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">storeTransForReuse</span> <span class="ow">and</span> <span class="n">storeVolIndex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">volumeAtoms</span> <span class="o">=</span> <span class="n">initial</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">storeVolIndex</span><span class="p">]</span><span class="o">.</span><span class="n">graphVol</span>
            <span class="n">volumeKey</span> <span class="o">=</span> <span class="n">initial</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">storeVolIndex</span><span class="p">]</span><span class="o">.</span><span class="n">graphKey</span>
            
            <span class="c1"># full object required for merging...</span>
            <span class="n">transitionObject</span> <span class="o">=</span> <span class="n">Defects</span><span class="o">.</span><span class="n">TransitionObjectFull</span><span class="p">(</span><span class="n">final</span><span class="o">.</span><span class="n">cellDims</span><span class="p">,</span> <span class="n">final</span><span class="o">.</span><span class="n">specie</span><span class="p">,</span> <span class="n">final</span><span class="o">.</span><span class="n">specieList</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> 
                                                            <span class="n">saddle</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">final</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">barrier</span><span class="p">,</span> <span class="n">hashKey</span><span class="o">=</span><span class="n">volumeKey</span><span class="p">,</span> <span class="n">volumeAtoms</span><span class="o">=</span><span class="n">volumeAtoms</span><span class="p">)</span>
        
        <span class="n">barrElapsedTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">methodRunList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;BARRIERSEARCH&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methodTimeList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">barrElapsedTime</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methodSuccList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">timeLog</span> <span class="o">=</span> <span class="n">ClientServerInterface</span><span class="o">.</span><span class="n">TimeLog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">methodRunList</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">methodTimeList</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">methodSuccList</span><span class="p">)</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">ClientServerInterface</span><span class="o">.</span><span class="n">Result</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;BARRIERSEARCH&quot;</span><span class="p">,</span> <span class="s2">&quot;SUCCESS&quot;</span><span class="p">,</span> <span class="n">saddle</span><span class="o">=</span><span class="n">saddle</span><span class="p">,</span> <span class="n">barrier</span><span class="o">=</span><span class="n">barrier</span><span class="p">,</span> <span class="n">final</span><span class="o">=</span><span class="n">final</span><span class="p">,</span> <span class="n">images</span><span class="o">=</span><span class="n">images</span><span class="p">,</span> 
                                              <span class="n">timing</span><span class="o">=</span><span class="n">timeLog</span><span class="p">,</span> <span class="n">infoString</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">searchINFOString</span><span class="p">,</span> <span class="n">sadSearchDebugInfo</span><span class="o">=</span><span class="n">sadSearchDebugInfo</span><span class="p">,</span> 
                                              <span class="n">volumeObject</span><span class="o">=</span><span class="n">volumeObject</span><span class="p">,</span> <span class="n">searchBarrier</span><span class="o">=</span><span class="n">searchBarrier</span><span class="p">,</span> <span class="n">calculatorBarrier</span><span class="o">=</span><span class="n">calculatorBarrier</span><span class="p">,</span>
                                              <span class="n">transitionObject</span><span class="o">=</span><span class="n">transitionObject</span><span class="p">,</span> <span class="n">currentVolIndex</span><span class="o">=</span><span class="n">currentVolIndex</span><span class="p">,</span> <span class="n">jobID</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jobID</span><span class="p">,</span>
                                              <span class="n">reverseBarrier</span><span class="o">=</span><span class="n">reverseBarrier</span><span class="p">,</span> <span class="n">NSmallMoves</span><span class="o">=</span><span class="n">NSmallMoves</span><span class="p">,</span> <span class="n">calcPrefactor</span><span class="o">=</span><span class="n">calcPrefactor</span><span class="p">,</span>
                                              <span class="n">rate</span><span class="o">=</span><span class="n">rate</span><span class="p">,</span> <span class="n">saddleSumLogEVs</span><span class="o">=</span><span class="n">saddleSumLogEVs</span><span class="p">,</span> <span class="n">fixIndex</span><span class="o">=</span><span class="n">fixIndex</span><span class="p">,</span> <span class="n">storeVolIndex</span><span class="o">=</span><span class="n">storeVolIndex</span><span class="p">,</span>
                                              <span class="n">searchTimingDict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">searchTimingDict</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span></div></div>


<span class="c1">################################################################################</span>
<div class="viewcode-block" id="commandLineArgs"><a class="viewcode-back" href="../../LKMC/LKMC.Search.html#LKMC.Search.commandLineArgs">[docs]</a><span class="k">def</span> <span class="nf">commandLineArgs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse command line arguments</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">argparse</span>
    
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run full transition search.&quot;</span><span class="p">)</span>
    
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;inputFile&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The input lattice file.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;refFile&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The reference lattice file.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;paramFile&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;lkmcInput.IN&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;LKMC input file (default=lkmcInput.IN)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-P&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;profileCode&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Profile the code using the hotshot module (not for production) (default=False)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;statsFile&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;profile.dat&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;File for dumping profiling stats to (default=None)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-V&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;visPerform&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Visualise the profiling of the code&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-I&quot;</span><span class="p">,</span> <span class="s2">&quot;--volume-index&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;volumeIndex&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Index of the defect volume to search (default=0)&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span></div>


<span class="c1">################################################################################</span>
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../LKMC/LKMC.Search.html#LKMC.Search.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    
    <span class="c1"># get command line args</span>
    <span class="n">progargs</span> <span class="o">=</span> <span class="n">commandLineArgs</span><span class="p">()</span>
    
    <span class="c1"># read parameters</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">Input</span><span class="o">.</span><span class="n">getLKMCParams</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">progargs</span><span class="o">.</span><span class="n">paramFile</span><span class="p">)</span>
    <span class="n">Input</span><span class="o">.</span><span class="n">readGlobals</span><span class="p">(</span><span class="n">progargs</span><span class="o">.</span><span class="n">paramFile</span><span class="p">)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">printInputParameters</span><span class="p">()</span>
    
    <span class="c1"># read lattices</span>
    <span class="n">inputLattice</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">readLattice</span><span class="p">(</span><span class="n">progargs</span><span class="o">.</span><span class="n">inputFile</span><span class="p">)</span>
    <span class="n">refLattice</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">readLattice</span><span class="p">(</span><span class="n">progargs</span><span class="o">.</span><span class="n">refFile</span><span class="p">)</span>
    
    <span class="c1"># check input lattice is minimised</span>
    <span class="nb">print</span> <span class="s2">&quot;---------- MINIMISING INPUT LATTICE ----------&quot;</span>
    <span class="n">minimiser</span> <span class="o">=</span> <span class="n">Minimise</span><span class="o">.</span><span class="n">getMinimiser</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">minimiser</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">inputLattice</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Input lattice minimisation failed&quot;</span><span class="p">)</span>
    
    <span class="c1"># find defects</span>
    <span class="nb">print</span> <span class="s2">&quot;---------- FINDING DEFECTS ----------&quot;</span>
    <span class="n">inputLattice</span><span class="o">.</span><span class="n">findDefects</span><span class="p">(</span><span class="n">refLattice</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">progargs</span><span class="o">.</span><span class="n">volumeIndex</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">progargs</span><span class="o">.</span><span class="n">volumeIndex</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputLattice</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Specified defect volume does not exist (</span><span class="si">%d</span><span class="s2">; num vols </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">progargs</span><span class="o">.</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputLattice</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)))</span>
    
    <span class="c1"># run search</span>
    <span class="n">transitionSearcher</span> <span class="o">=</span> <span class="n">TransitionSearcher</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">transitionSearcher</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
    <span class="n">transitionSearcher</span><span class="o">.</span><span class="n">setInitialState</span><span class="p">(</span><span class="n">inputLattice</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">progargs</span><span class="o">.</span><span class="n">profileCode</span> <span class="ow">or</span> <span class="n">progargs</span><span class="o">.</span><span class="n">visPerform</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Profiling</span>
        
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">stats</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">Profiling</span><span class="o">.</span><span class="n">profileMethod</span><span class="p">(</span><span class="n">transitionSearcher</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">printStats</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">statsFile</span><span class="o">=</span><span class="n">progargs</span><span class="o">.</span><span class="n">statsFile</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">progargs</span><span class="o">.</span><span class="n">visPerform</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;python ~/git/scripts/gprof2dot.py -f pstats </span><span class="si">%s</span><span class="s2"> | dot -Tpng -o output.png&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">progargs</span><span class="o">.</span><span class="n">statsFile</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">progargs</span><span class="o">.</span><span class="n">profileCode</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">progargs</span><span class="o">.</span><span class="n">statsFile</span><span class="p">)</span>
            
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">transitionSearcher</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;SUCCESS&quot;</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;SUCCESS&quot;</span>
        <span class="nb">print</span> <span class="s2">&quot;SEARCH BARRIER&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">searchBarrier</span>
        <span class="nb">print</span> <span class="s2">&quot;CALCUL BARRIER&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">calculatorBarrier</span>
        
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">calculatorBarrier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;NEB BARRIER&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">calculatorBarrier</span>
        
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;search.output&quot;</span><span class="p">):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">final</span><span class="o">.</span><span class="n">writeLattice</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;search.output&quot;</span><span class="p">,</span> <span class="s2">&quot;search_final.dat&quot;</span><span class="p">))</span>
            <span class="n">result</span><span class="o">.</span><span class="n">saddle</span><span class="o">.</span><span class="n">writeLattice</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;search.output&quot;</span><span class="p">,</span> <span class="s2">&quot;search_saddle.dat&quot;</span><span class="p">))</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">LKMC 150623-1236-g1254817 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, Chris Scott, Tomas Lazauskas, Miao Yu.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.5.
    </div>
  </body>
</html>